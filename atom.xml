<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[點燈坊]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://oomusou.io/"/>
  <updated>2016-07-04T14:30:32.000Z</updated>
  <id>http://oomusou.io/</id>
  
  <author>
    <name><![CDATA[真 OO無双]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[實作模式讀書會 (Motivation)]]></title>
    <link href="http://oomusou.io/ip/ip-motivation/"/>
    <id>http://oomusou.io/ip/ip-motivation/</id>
    <published>2016-07-04T12:23:43.000Z</published>
    <updated>2016-07-04T14:30:32.000Z</updated>
    <content type="html"><![CDATA[<p>以軟體成本的角度，闡明使用模式除了可以增加程式可讀性，還可大幅降低維護成本。<br><a id="more"></a></p>
<h2 id="Motivation">Motivation</h2><hr>
<p>本文為 Kent Beck 的 <a href="https://www.amazon.com/Implementation-Patterns-Kent-Beck/dp/0321413091" target="_blank" rel="external">Implementation Patterns</a> 一書的讀書筆記，主要是整理給自己複習用，並加上自己的腦補。</p>
<h2 id="軟體整體成本">軟體整體成本</h2><hr>
<p><img src="/images/ip/ip-motivation/mot000.png" alt=""></p>
<p>軟體整體成本 = 開發成本 + 維護成本。</p>
<blockquote><p>Once the industry gained experience with software development, it was a big surprise to many that the cost of maintenance is much higher than than the cost of initial development.</p>
<p>當業界累積了軟體開發經驗後，才驚覺軟體的維護成本源遠高於它的開發成本。</p>
</blockquote>
<p>大部分人覺得軟體成本在於開發成本，只要開發完成後，維護成本很低，其實剛好相反，軟體最大的成本是在維護。</p>
<blockquote><p>Maintenance is expensive because understanding existing code is time-cosuming and error-prone. Making changes is generally easy when you know what needs changing. Learning what the current code does is the expensive part. Once the changes are made, they need to be tested and deployed.</p>
<p>軟體的昂貴維護成本在於理解既有的程式碼非常耗時，而且容易出錯。當你知道要在哪裡修改之後，維護反而是輕而易舉的事情。理解目前的程式碼是最昂貴的維護成本。修改之後，還必須進行測試與部署。</p>
</blockquote>
<p><img src="/images/ip/ip-motivation/mot001.png" alt=""></p>
<p>軟體維護成本 = 理解程式碼 + 修改程式碼 + 測試程式碼 + 部署程式碼</p>
<p>其中最昂貴的成本是<code>理解程式碼</code>。</p>
<h2 id="降低軟體成本">降低軟體成本</h2><hr>
<blockquote><p>One strategy for reducing overall cost is to invest more in initial development in hope of reducing or eliminating the need for maintenance. Such efforts have generally failed to reduce overall costs. When code needs to change in unanticipated ways, no amount of forethought can perfectly prepare the code for change.</p>
<p>其中一種降低軟體整體成本的策略是「在開發初期花更多時間制定規格與瞭解需求，設計萬全的架構，減少將來維護的成本」，但這種方式往往會失敗。當「計畫趕不上變化時」，之前所做的萬全準備都派不上用場。</p>
</blockquote>
<p>硬體因為規格明確，常常使用大量的 over design 來應付未來變化；但軟體的規格常伴隨著需求而變動，因此即時 over design 也常常用不到。</p>
<blockquote><p>The premature attemps to make the code general enough to meet future needs often interfere with unacticipated changes that turn out to be necessary.</p>
<p>人們可能為了防備將來發生變化，而過早的考慮程式碼的通用性，但如果出現了沒有預料而又勢在必行的變化，先前的做法往往就會與現實發生衝突。</p>
</blockquote>
<p>假如 over design 而將來能用到還沒關係，就怕 over design 還是趕不上需求的變化。</p>
<blockquote><p>My strategy for reducing overall costs is to ask all programmers to address the cost of understanding code during the maintenance phase by focusing on communicating, programmer-to-programmer. The immediate benefits of clear code are fewer defects, easier sharing of code, and smoother development.</p>
<p>我用來減少整體成本的策略是注重程式可讀性，減少理解程式碼成本。其立即的收益是程式碼 bug 更少、程式碼更易於共用、開發曲線也更為平坦。</p>
</blockquote>
<p>軟體維護成本中最昂貴的就是理解程式碼，從程式可讀性下手，將可最快有效降低軟體維護成本。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>軟體最大的成本在於維護，而維護最大的成本就是理解程式碼，使用模式可幫助程式可讀性，可以立即有效降低軟體成本。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p>Kent Beck, <a href="https://www.amazon.com/Implementation-Patterns-Kent-Beck/dp/0321413091" target="_blank" rel="external">Implementation Patterns</a></p>
]]></content>
    <summary type="html">
    <![CDATA[Ch.4 Motivation]]>
    
    </summary>
    
      <category term="Implementation Pattern" scheme="http://oomusou.io/tags/Implementation-Pattern/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[實作模式讀書會 (A Theory of Programming)]]></title>
    <link href="http://oomusou.io/ip/ip-theory/"/>
    <id>http://oomusou.io/ip/ip-theory/</id>
    <published>2016-07-01T12:23:43.000Z</published>
    <updated>2016-07-04T14:27:47.000Z</updated>
    <content type="html"><![CDATA[<p>此章討論<code>程式設計理論</code>，提出了 3 條<code>程式設計價值觀</code>與 6 條<code>程式設計原則</code>，這些都是所有程式語言都能使用的普世價值觀與原則，當我們遇到一個全新的問題，沒有模式可以使用時，可以轉而思考這些價值觀與原則；當我們學習新的程式語言時，也可以藉由這些價值觀與原則為起點，一樣可以寫出優秀的程式碼。</p>
<a id="more"></a>
<h2 id="Motivation">Motivation</h2><hr>
<p>本文為 Kent Beck 的 <a href="https://www.amazon.com/Implementation-Patterns-Kent-Beck/dp/0321413091" target="_blank" rel="external">Implementation Patterns</a> 一書的讀書筆記，主要是整理給自己複習用，並加上自己的腦補。</p>
<h2 id="程式設計理論">程式設計理論</h2><hr>
<blockquote><p>No lists of patterns, no matter how exhaustive, can cover every situation that comes up while programming. Eventually (or even frequently) you’ll come upon a situation where none of the cookie cutters fits. This need for general approaches to unique problems is one reason to study the theory of programming. Another is the sense of mastery that comes of knowing both what to do and why.</p>
<p>無論蒐集多麼完整的模式，也無法涵蓋所有的需求。最終你會遇到沒有任何模式適用的情況，因此你需要通用的解決問題方法，這也是我們為什麼要學習程式設計理論的原因，其次是「知其然，亦知其所以然」所帶來的成就感。</p>
</blockquote>
<blockquote><p>Each pattern carries with it a little bit of theory. There are larger and more pervasive forces at work in programming than covered in individual patterns. They are divided into two types : values and principles.</p>
<p>每個模式都有一些理論基礎，在程式設計中有一些更基礎的理論，不是單一模式可以涵蓋的，那就是<code>程式設計價值觀</code>與<code>程式設計原則</code>。</p>
</blockquote>
<h2 id="程式設計價值觀">程式設計價值觀</h2><hr>
<blockquote><p>Three values that are consistent with excellence in programming are communication, simplicity, and flexibility. While these three sometimes conflict, more often they are complement each other. The best programs offer many options for future extension, contain no extraneous elements, and are easy to read and understand.</p>
<p>有三種價值觀與優秀程式設計是一脈相承的，他們分別是<code>程式可讀性</code>、<code>程式簡潔性</code>、<code>程式靈活性</code>，雖然他們有時候會有所衝突，但更多時候，他們是互補的。好的程式是容易閱讀與理解，不包含多餘的元素，且為將來擴充提供眾多選項。</p>
</blockquote>
<p>通常程式靈活性與程式簡潔性會有所衝突，這也是為什麼在設計模式中，常會發現很多 interface 存在，雖然成就了靈活性，卻讓架構比較複雜，所以才有 TDD 讓我們不 over design。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>稍後將以 AWS 與阿里雲的雲端服務為例解釋。</span></span></span></p>
<h3 id="程式可讀性">程式可讀性</h3><hr>
<blockquote><p>Code communicates well when a reader can understand it, modify it, or use it.</p>
<p>當閱讀者能理解某段程式碼，並進一步修改它或使用它，那麼這段程式碼就是可讀性高的程式碼。</p>
</blockquote>
<p>程式的可讀性是可維護性的首要條件，要修改或新增功能，首先必須要讀懂原來的程式碼，才能在適當的地方修改或增加程式。</p>
<blockquote><p>While programming it’s tempting to think only of the computer. However, good things happen when I think of others while I program. I get cleaner code that is easier to read, it is more cost-effective, my thinking is clearer, I give myself a fresh perspective, my stress level drops, and I meet some of my social needs.</p>
<p>在設計程式時，我們很容易從電腦的角度進行思考，但只有一面進行程式設計，一面考慮其他閱讀者是否能讀懂我寫的程式，才能寫出容易閱讀的程式碼。在這種前提下寫出來的程式碼，將更容易閱讀、更有效率、更能清晰地展現出我的想法，它給了我全新的視野、減輕了我的壓力，且社會需求也得到滿足。</p>
</blockquote>
<ul>
<li><strong>幫助思考</strong></li>
</ul>
<p>達成程式可讀性的另外一個法門，就是採用 TDD 方式開發，由於先寫測試，我們會以可測試性的角度去思考，而不是從電腦的角度去思考。</p>
<p>可測試性高通常代表 3 件事情 :</p>
<ul>
<li>API 好用，所以好測試，符合需求且貼近現實。</li>
<li>測試案例好寫，表示你的設計符合<strong>單一職責</strong>原則。</li>
<li><p>容易隔離測試與 mock，表示你的程式耦合度低。</p>
</li>
<li><p><strong>容易閱讀</strong></p>
</li>
</ul>
<p>當測試好寫，就代表你的 method 與 API 好用好理解，也就是程式可讀性高。</p>
<ul>
<li><strong>減輕壓力</strong></li>
</ul>
<p><img src="/images/ip/ip-theory/theory003.png" alt=""></p>
<p><img src="/images/ip/ip-theory/theory000.png" alt=""></p>
<p>傳統方式開發必須同時考慮眾多需求，腦筋容易打結，但 TDD 要你一次只專心一件事情 : <code>把紅燈變綠燈</code>，減輕開發時的壓力。</p>
<ul>
<li><strong>社會需求</strong></li>
</ul>
<p>人類是社會性的物種，明確的完成「其他人閱讀程式碼」的需求，而不是「悶著頭自己寫程式」，完成每個人的社會需求。</p>
<blockquote><p>Every time a bit of logic was a little hard to explain, it was easier to rewrite the code than explain why the code was hard to understand.</p>
<p>每次遇到難以解釋的邏輯，將程式重新改寫，會比去理解它容易。</p>
</blockquote>
<p>其實遇到難以解釋的邏輯，只要<code>重構</code>即可，不需重寫，只要我們有測試做保障，就能將原來難以解釋的邏輯重構成容易閱讀的程式碼。</p>
<blockquote><p>The majority of the cost of software is incurred after the software has been first deployed.</p>
<p>絕大部分的軟體成本，都是在軟體第一次部署後才產生。</p>
</blockquote>
<p>Kent Beck 在書中的程式可讀性與程式靈活性都提到這句話。</p>
<p>軟體第一次部署後，使用者才開始使用，有使用才會有新的需求，才需要去維護程式。</p>
<ul>
<li>必須先閱讀程式</li>
<li>然後才去修改程式</li>
<li>最後確保是否會改A壞B</li>
</ul>
<p>這才是軟體絕大部分的成本。</p>
<p>若程式可讀性不高，維護程式的第一步就卡關了，這也是最大的維護成本。</p>
<h3 id="程式簡潔性">程式簡潔性</h3><hr>
<blockquote><p>Eliminating excess complexity enables those reading, using, and modifying programs to understand them more quickly. It is this excess complexity that removes value from software, both by making the software less likely to run correctly and more difficult to change sucessfully in the future.</p>
<p>去除多餘的複雜性可以讓那些閱讀、使用與修改程式碼的人更容易理解。多餘的複雜性降低了軟體的價值，一方面<br>降低了軟體正確執行的可能性，另一方面也增加了將來維護程式碼的難度。</p>
</blockquote>
<p>要去除程式碼的複雜度，可以跑測試的 coverage，若 coverage 沒有 100%，就有幾種可能 :</p>
<ol>
<li>有些程式碼永遠跑不到，也就是沒有任何需求，卻有這些程式碼，這就增加了複雜性。</li>
<li>也有可能是測試案例不完全，導致程式碼沒有執行到。</li>
</ol>
<p>不論是哪一種，寫測試都可以幫著我們達成程式簡潔性。</p>
<blockquote><p>Apply simplicity at all level.</p>
<ul>
<li>Format code so no code can be deleted without losing information.</li>
<li>Design with no extraneous elements.</li>
<li>Challenge requirements to find those that are essential.</li>
</ul>
<p>Eliminating excess complexity illuminates the remaining code.</p>
<p>在程式碼的各個層次都要達到程式簡潔性。</p>
<ul>
<li>對程式碼重新排版與重構，刪除沒有必要的程式碼。</li>
<li>不要沒有需求的部分做 over design。</li>
<li>對需求提出質疑，找出真正不可或缺的需求。</li>
</ul>
<p>將程式碼中多餘的複雜度去除後，你的程式碼將會<code>閃亮亮</code>。</p>
</blockquote>
<blockquote><p>However, I find a simplication that would make a program harder to understand. I choose communication over simplicity in these case.</p>
<p>有時候，當我發現程式簡潔性會造成程式碼難以理解時，我會選擇程式可讀性。</p>
</blockquote>
<p>重構的 <code>Inline Temp</code> 與 <code>Replace Temp with Query</code>，雖然會讓程式碼行數變少，但有時候用過頭，會讓程式過長，導致橫向發展，程式碼雖然看起來簡潔了，但卻變得難以閱讀，應以程式可讀性為優先考量。</p>
<p><code>eval()</code> 的使用也要小心，有時雖然程式碼簡潔了，但卻很容易喪失可讀性。</p>
<h3 id="程式靈活性">程式靈活性</h3><hr>
<blockquote><p>Of the three values listed here, flexibility is the justification used for the most ineffective coding and design practices</p>
<p>三種價值觀中，程式靈活性是最常用來判斷程式碼與設計好壞的指標。</p>
</blockquote>
<blockquote><p>Why all the complexibility? Flexibility. Programs should be flexible, but only in ways the change. If the constant never changes, all the complexibility is cost without benefit.</p>
<p>為什麼要將程式變得這麼複雜呢? 常常是為了程式靈活性，但某些需求常常改變時，程式碼才需要這樣寫；假如某些需求從來沒改變過，為了程式靈活性而犧牲程式簡潔性，將沒有任何意義。</p>
</blockquote>
<p>如使用雲端服務，若需求只有 AWS，其實直接使用 AWS 亦未嘗不可，雖然耦合性較高，但畢竟<code>需求</code>就是這樣，若需求可能同一個網站會放在 AWS 與阿里雲，且分別使用各自的雲端服務，則應該使用 interface 切開，由使用者的需求觀點定義 interface，再以實踐該 interface 的 class 去使用 AWS 與 阿里雲的 API，而不是在 controller 內直接使用 AWS 或阿里雲的雲端服務，如此 controller 會使用相同的一份 code 去使用雲端服務，只要 service provider 一開使去 <code>app::bind()</code> AWS 或阿里雲的 class 即可。</p>
<p>這種方式的程式靈活性雖高，但缺犧牲了程式簡潔性，多了 interface，還多了 service provider，因此物件導向才要搭配 TDD 與重構，一開始需求很單純時，只求 <span class="label label-success">綠燈</span> 即可，儘管耦合性較高，但符合程式簡潔性，將來需求出現，再重構成 interface，也要繼續 <span class="label label-success">綠燈</span>，達成程式靈活性，TDD與重構使得程式在程式靈活性與程式簡潔性取得一個平衡點，而不必一開始就 over design 使用 interface，在沒有需求的前提下提早放棄<code>程式簡潔性</code>。</p>
<p>程式靈活性與程式簡潔性雖然衝突，寫程式應該先考慮程式簡潔性，除非是有<code>需求</code>，才會考慮程式靈活性。</p>
<blockquote><p>The majority of the cost of software is incurred after the software has been first deployed, programs should be easy to change.</p>
<p>絕大部分的軟體成本，都是在軟體第一次部署後才產生。程式碼必須能容易被修改。</p>
</blockquote>
<p>除了在程式可讀性提到這句話外，在程式靈活性又再次提到這句話。</p>
<p>軟體第一次部署後，使用者才開始使用，有使用才會有新的需求，才需要去維護程式。</p>
<ul>
<li>必須先閱讀程式</li>
<li>然後才去修改程式</li>
<li>最後確保是否會改A壞B</li>
</ul>
<p>這才是軟體絕大部分的成本。</p>
<p>若<code>程式可讀性</code>很高，第一關過了。</p>
<p>但有於設計的耦合度太高，可能造成程式碼很難修改，或者只要修改就要改很多地方，而造成到處改A壞B，這就會造成很嚴重的維護成本。</p>
<p>所以程式碼必須要設計的容易被修改來降低維護成本。</p>
<blockquote><p>The flexibility I imagine will be needed tomorrow, though, is likely to be not what I need when I change the code. That’s why the flexibility of simplicity and extensive tests is more effective than the flexibility offered by speculative design. </p>
<p>「憑空想像而非真正需求」的 over design，與「為了程式好修改」的程式靈活性是兩碼子事。這也就是為什麼「程式簡潔導致程式好修改與完整的測試」比「為了憑空想像的需求所設計的靈活性」更為有效的原因。</p>
</blockquote>
<p>很多人會以「若將來有這個需求」為前提，提早使用某個模式，開始大量使用 interface，問題連<code>需求</code>都沒有，也無從寫測試案例作測試，這種就是 over design，提早增加複雜度，這就是「憑空想像的需求所設計的靈活性」。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>中譯本是翻譯成 : 這就是「簡單性和大規模測試所帶來的靈活性」比「專門設計出來的靈活性」更為有效的原因。我個人認為 flexibility of simplicity 是由<code>簡單所導致的靈活</code>，而非由<code>測試所帶來的靈活</code>。</span></span></span></p>
<blockquote><p>Choose patterns that encourage flexibility and bring immediate benefites. For patterns with immediate costs and only deferred benefits, often patience is the best strategy. Put theme back in the bag until they are needed. Then you can apply them in precisely the way they are needed.</p>
<p>先選擇那些能增加<code>程式靈活性</code>與立即幫助的模式。有些模式複雜度較高，可能需大規模更改架構而增加成本，而其收益卻要一段時間才能看的到，對於這類模式，可能需要些耐心<code>讓子彈飛一下</code>，將這些模式以學習的角度先放在自己的工具箱裡，等到真正有<code>需求</code>，或你能精確地駕馭這些模式時再拿出來用。</p>
</blockquote>
<div class="alert alert-info"><i class="fa fa-info"></i>  程式可讀性 > 程式簡潔性 > 程式靈活性</div>
<p>若三個價值觀相衝突 :</p>
<ul>
<li>優先考慮程式可讀性，不能因為程式簡潔性而喪失程式可讀性。</li>
<li>若無<code>需求</code>，優先考慮程式簡潔性，若有<code>需求</code>，則允許喪失些程式簡潔性換取程式靈活性，但程式可讀性則無從妥協。</li>
</ul>
<h2 id="程式設計原則">程式設計原則</h2><hr>
<blockquote><p>The principles described here aren’t as far-reaching or pervasive as the values, but each one is expressed by many of the patterns. The principles bridged the values, which are universal but often difficult to apply directly, and the patterns, which are clear to apply but specific.</p>
<p><code>程式設計原則</code>不像<code>程式設計價值觀</code>那般意義深遠與遙不可及，但每個原則都在許多模式中都可以看得到。程式價值觀具有普世價值，但卻往往難以實現；模式雖然可以直接應用，但卻是只能針對某些需求。程式設計原則剛好介於價值觀與模式之間，扮演橋樑的角色。</p>
</blockquote>
<p> 每一個模式都在某種程度實現了程式可讀性、程式簡潔性與程式靈活性的價值觀，但價值觀較偏人的角度思考，但程式設計原則則是以程式碼的角度思考。</p>
<blockquote><p>I have found it valuable to make the principles explicit for those situations where no patterns applies, or when two mutually exclusive patterns apply equally.</p>
<p>我發現程式設計原則的可貴之處在於那些「沒有模式可用」或「模式之間互相矛盾」的場合，如果把程式設計原則弄清楚，對解決疑難雜症很有幫助。</p>
</blockquote>
<p>當模式之間互相矛盾時，最好的方式就是讓程式設計原則說話，而不是讓模式之間爭來爭去。</p>
<p>如果遇到獨一無二的新需求，因而沒有模式可用時，可以轉而思考程式設計原則，甚至可以因此想出新的模式。</p>
<blockquote><p>When I encounter a new programming language I use my understanding of principles to develop an effective style of programming. I don’t have to ap existing style or, worse, cling to my style in some other programming language. Understanding principles give me a chance to learn quickly and act with integrity in novel situations.</p>
<p>當我使用新的程式語言時，我可以根據自己對程式設計原則的理解發展出有效的程式設計風格，不必盲目模仿現有的程式語言風格，更不用拘泥於將其他語言風格帶入新的程式語言，對於程式設計原則的徹底理解，能快速地學習新語言，即時在全新的語言也能寫出符合程式設計原則的好程式。</p>
</blockquote>
<p><img src="/images/ip/ip-theory/theory001.png" alt=""></p>
<p><img src="/images/ip/ip-theory/theory002.png" alt=""></p>
<p>程式設計原則講的是程式設計中，普世的原則，一個程式語言可能有盛有衰，你也可能因為換了工作而換了其他程式語言，無論你使用任何程式語言，最後都會用到這些原則。</p>
<h3 id="避免_Side_Effect">避免 Side Effect</h3><blockquote><p>Structure the code so changes have local consequences. If a change here can cause a problem there, then the cost of the changes rises dramatically.</p>
<p>設計程式架構時，要使得修改程式碼所產生的影響不至於改A壞B。如果這裡修改，會造其他地方出問題，如此將造成巨大的維護成本。</p>
</blockquote>
<p>有幾個具體方法，可以避免改 A 壞 B 所造成的 side effect:</p>
<ul>
<li>減少使用全域變數。</li>
<li>減少使用 pass by reference，盡量使用 pass by value。</li>
<li>符合 SOLID 的<code>單一職責原則</code>，不會什麼修改都會影響到我。</li>
<li>符合 SOLID 的<code>開放封閉原則</code>，原來的程式不再修改，確保原來的程式不再出錯。</li>
<li>符合 SOLID 的<code>最小知識原則</code>，盡量減少 public method。</li>
<li>符合 SOLID 的<code>依賴反轉原則</code>，將低耦合度。</li>
<li>寫測試，若真的還是改 A 壞 B，可以馬上發現。</li>
</ul>
<h3 id="避免程式碼重複">避免程式碼重複</h3><blockquote><p>A principle that contribute to keeping consequences local is to minimize repetition.</p>
<p>避免程式碼重複亦有助於避免改A壞B。</p>
</blockquote>
<p>當你有相同的程式碼散落在專案各處，當需求改變，需要變更邏輯時，就必須每個地方去改，但維護的人可能不知道這段邏輯也出現在其他地方，因此而沒改到。</p>
<blockquote><p>Copied code is only one form of repetition. Parallel class hierarchies are also repetitive.</p>
<p>複製貼上的程式碼只是其中一種的程式碼重複，平行的 class 架構也是程式碼重複。</p>
</blockquote>
<p><img src="/images/ip/ip-theory/theory004.png" alt=""></p>
<p>當你在某一個 class 繼承架構下新增 class 時，你發現還必須手動在另外一個 class 繼承架構下新增 class，但問題維護的人可能並不知道，因此而造成修改後的程式錯誤。</p>
<p>由於這兩個 class 繼承架構的相似度很高，才會導致平行 class 架構，應該使用重構的 <code>Move Field</code> 與 <code>Move Method</code> 整合成一個 class 繼承架構。</p>
<blockquote><p>Duplication is not always abvious until after it has been created, and sometimes not for a while even then. Having seen it I can’t always think of a good way to eliminate it. Dupilcation isn’t evil, it just raises the cost of making changes.</p>
<p>程式碼重複在開發時不太容易被發現，有時候要在一段時間後才會被察覺。即使發現了程式碼有重複之處，我也不見得每次都能將重複程式碼拿掉。程式碼重複並不是罪過，只是會增加程式碼維護時的成本。</p>
</blockquote>
<p>對於程式碼重複，可使用重構的 <code>Extract Method</code> 與 <code>Extract Class</code>，將相同的程式碼抽取出來。</p>
<p>對於平行 class 架構，可使用重構的 <code>Move Field</code> 與 <code>Move Method</code> 整合成單一 class。<span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>中譯本並沒有將 <code>Having seen it I can&#39;t always think of a good way to eliminate it.</code> 這句加以翻譯。</span></span></span></p>
<blockquote><p>One of the ways to remove duplication is to break programs up into many small pieces – small statements, small methods, small objects, small packages. Large peices of logic tend to duplicate parts of other large pieces of logic.</p>
<p>其中一個避免程式碼重複的手段，就是將程式拆成更多更小部分 : <code>更短的敘述、更小的方法、更小的物件、更小的套件</code>，一大段的程式碼邏輯很容易與其他程式碼邏輯重複。</p>
</blockquote>
<p>一個很長的 method，很難看出重複的部分，但是短短的 method，就很容易看出重複的部分。</p>
<p>重構也是鼓勵大家使用 <code>Extract Method</code> 將程式拆成眾多短短的 method，除了可讀性高外，也更能避免程式碼重複。</p>
<p>使用 TDD 開發也可以避免程式碼重複，為了測試案例明確，為了好測試，所寫出的 method 都是短短的，因為一個 method 太長，就會很難寫測試案例，也會違反 SOLID 的 <code>單一職責原則</code>。</p>
<p>有幾個具體方法，可以避免程式碼重複</p>
<ul>
<li>符合 SOLID 的<code>單一職責原則</code>，避免在單一 method 內寫很長的邏輯。</li>
<li>符合 SOLID 的<code>介面隔離原則</code>，職責明確的 interface 有助於寫出<code>單一職責</code>的 class。</li>
</ul>
<p>在使用MVC架構時，以下為初學者常犯的錯 :</p>
<ul>
<li><p><strong>重複的資料庫邏輯</strong><br>將資料庫邏輯寫在 controller 內，若其他 controller 也使用相同的邏輯，直接將資料庫邏輯複製貼上到其他 controller 內，導致相同的資料庫邏輯散佈在不同 controller。建議改用 Repository 模式，將資料庫邏輯統一寫在 repository 內，當需要使用相同的資料庫邏輯時，只要使用依賴注入到 controller 即可。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>關於 Repository 模式，詳細請參考<a href="/laravel/laravel-repository/">如何使用 Repository 模式?</a></span></span></span></p>
</li>
<li><p><strong>重複的商業邏輯</strong><br>將商業邏輯寫在 controller 內，若其他 controller 也使用相同的邏輯，由於無法 A controller 呼叫 B controller，因此直接將商業邏輯複製貼上到其他 controller 內，導致相同的商業邏輯散佈在不同 controller。建議改用 Service 模式，將商業邏輯統一寫在 service 內，當需要使用相同的商業邏輯時，只要使用依賴注入到 controller 即可。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>關於 Service 模式，詳細請參考<a href="/laravel/laravel-service/">如何使用 Service 模式?</a></span></span></span></p>
</li>
<li><p><strong>重複的顯示邏輯</strong><br>講顯示邏輯寫在 blade 內，若其他 blade 也使用相同的邏輯，直接將顯示邏輯複製貼上到其他 blade 內，導致相同的顯示邏輯散佈在不同 blade。建議改用 Presenter 模式，將顯示邏輯統一寫在 presenter 內，當需使用相同的顯示邏輯時，只要使用依賴注入到 blade 即可。<span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>關於 Presenter 模式，詳細請參考<a href="/laravel/laravel-presenter/">如何使用 Presenter 模式?</a></span></span></span></p>
</li>
</ul>
<h3 id="將資料與邏輯封裝在一起">將資料與邏輯封裝在一起</h3><blockquote><p>Another principle corollary to the principle of local consequence is keeping logic and data together. Put logic and the data it operates on near each other, in the same method if posible, or the same object, or at least the same package.</p>
<p>為了避免 Side Effect 的另一個方法就是將資料與邏輯封裝在一起，盡量放在同一個 method 中，或者退而求其次，在同一物件內，最少也要是同一 package 裡。</p>
</blockquote>
<p>將資料與行為封裝在一起，也是物件導向的<code>繼承</code>、 <code>封裝</code>、<code>多型</code>中最基本的特性之一的<code>封裝</code>，通常需求發生變化時，資料與邏輯行為都是一起變化，將其封裝在一起，可將程式碼修改所產生的副作用侷限在 method 中，或者在同一個物件內。<span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>這裡的 package，並不是 PHP 所認知的 package，而是如 C# 的 Dll 與 Assembly，有特別提供 <code>internal</code> 作用域，其 scope 只侷限在此 Dll 與 Assembly，只有該 Dll 與 Assembly 可以存取。</span></span></span></p>
<blockquote><p>It’s not always obvious at first where logic or data should go to satisfy this principle. I may be writing code in A and realize I need data from B. It’s only after I have the code working that I notice that it is too far from the data.</p>
<p>在一開始寫程式時，我們往往不太清楚資料與邏輯該放在哪裡。我可能在 A 寫邏輯，才意識到需要 B 的資料。直到程式碼真正執行一段時間之後，我才意識到資料與邏輯太遠了，應該將他們封裝在一起。</p>
</blockquote>
<p>連 Kent Beck 都不太確定資料與邏輯一開始要寫在哪裡，所以一開始寫程式時，不用太拘泥於資料與邏輯該放在哪個 class 才適當，只要當下思考過放在哪個 class 最適合、TDD 能 <span class="label label-success">綠燈</span> 即可，之後再不斷的重構，靠 <code>Move Field</code> 與  <code>Move Method</code> 將資料與邏輯慢慢的搬到最適合的 class 即可。</p>
<p>此外，原來資料與邏輯放在 A class 適合，也可能隨著<code>需求</code>的改變，變成放在 B class 更適合，此時只要繼續地靠 <code>Move Field</code> 與 <code>Move Method</code> 將資料與邏輯從 A class 重構到 B class即可，也就是<code>持續重構</code>的概念。</p>
<h3 id="程式碼一致性">程式碼一致性</h3><blockquote><p>Symmetry in code is where the same idea is expressed the same way everywhere it appears in the code.</p>
<p>無論在什麼地方，相同的概念都應該以相同的形式呈現。</p>
</blockquote>
<p>如此閱讀者只需理解一部份的程式碼，就能以推理的方式去理解其他部份的程式碼。<span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>中譯本將 Symmetry 翻譯成<code>對稱性</code>，個人覺得不妥，翻譯成<code>一致性</code>比較符合程式設計師的用語。</span></span></span></p>
<ul>
<li><strong>以一致性的參數使用類似的方法</strong></li>
</ul>
<p>在 Laravel 的 Collection 中，絕大部分 method 的參數都是以 <code>$value</code>, <code>$key</code> 的順序</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$collection</span>-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>, <span class="variable">$key</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="comment">/* some condition */</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$collection</span>-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>, <span class="variable">$key</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span> * <span class="number">2</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$collection</span>-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>, <span class="variable">$key</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span> &gt; <span class="number">2</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但有些卻是 <code>$key</code>, <code>$value</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$collection</span>-&gt;contains(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$key</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span> &gt; <span class="number">5</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$collection</span>-&gt;first(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$key</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span> &gt; <span class="number">2</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>這種 API 設計就違反了程式碼一致性。</p>
<ul>
<li><strong>以一致性的觀點替方法命名</strong></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    input();</span><br><span class="line">    count++;</span><br><span class="line">    output();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>input()</code> 與 <code>output()</code> 都是以<code>需求</code>角度命名，但 <code>count++</code> 卻是實作，程式可讀性也不高，需加以重構。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    input();</span><br><span class="line">    incrementCount();</span><br><span class="line">    output();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將 <code>count++</code> 重構成 <code>incrementCount()</code> 之後，程式可讀性提高，但卻是以<code>實作</code>角度命名，與 <code>input()</code> 與 <code>output()</code> 以<code>需求</code>角度命名不一樣，違反程式碼一致性。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    input();</span><br><span class="line">    tally();</span><br><span class="line">    output();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>tally()</code> 為計算，是以<code>需求</code>角度命名，程式可讀性更高，且符合程式碼一致性要求。</p>
<h3 id="使用宣告式編程">使用宣告式編程</h3><blockquote><p>Express as much of my intention as possible declaratively. Imperative programming is powerful and flexible, but to read it requires that you follow the thread of execution. For those parts of a program that are more like simple facts, without sequence or conditionals, it is easier to read code that is simply declarative.</p>
<p>盡可能以<code>宣告式編程</code>方式表達你的需求，<code>命令式編程</code>功能強大且靈活，但是閱讀時你必須以電腦的思維，跟著執行的流程去思考，程式碼較不易閱讀；宣告式編程只是陳述簡單的需求，並沒有考慮程式流程與程式判斷，完全是以需求的角度去思考，程式碼就容易閱讀。</p>
</blockquote>
<p>假如我們的需求是 : <code>計算今天全部訂單金額</code>。</p>
<p>若使用傳統命令式編程 (Imperative Programming)，我們會這樣寫 :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$totalAmount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$orders</span> <span class="keyword">as</span> <span class="variable">$order</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$order</span>-&gt;order_date == Carbon::now()) &#123;</span><br><span class="line">        <span class="variable">$totalAmount</span> = <span class="variable">$totalAmount</span> + <span class="variable">$order</span>-&gt;quantity * <span class="variable">$order</span>-&gt;price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$totalAmount</span>;</span><br></pre></td></tr></table></figure>
<p>我們會使用 <code>foreach</code> 繞迴圈，使用 <code>if</code> 做判斷，使用暫存變數 <code>$totalAmount</code>，這種是典型以電腦思考為角度去寫程式，而不是以<code>需求</code>的角度去寫程式。</p>
<p>若以宣告式編程 (Declarative Programming) 方式思考 :</p>
<ul>
<li><strong>找出今天的訂單</strong> : <code>filter()</code>。</li>
<li><strong>計算每一筆訂單金額</strong> : <code>map()</code>。</li>
<li><strong>加總訂單金額</strong> : <code>sum()</code>。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable">$orders</span>-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$value</span>-&gt;order_date == Carbon::now();</span><br><span class="line">            &#125;)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">            &#125;)-&gt;sum();</span><br></pre></td></tr></table></figure>
<p>宣告式編程將不再以電腦思考角度使用 <code>foreach</code>、<code>if</code> 與暫存變數，完全以<code>需求</code>的角度去寫程式，程式碼的可讀性更高。<span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>關於宣告式編程，請參考 <a href="http://adamwathan.me/refactoring-to-collections/" target="_blank" rel="external">Refactoring to Collections</a></span></span></span></p>
<h3 id="將相同變化頻率的資料與邏輯封裝在一起">將相同變化頻率的資料與邏輯封裝在一起</h3><blockquote><p>Put logic or data that changes at the same rate together and seperate logic or data that changes at difference rate. These rates of change are a form of temporal symmetry.</p>
<p>將具有相同變化頻率的資料與邏輯封裝在同一個 class 或 method，將不同變化頻率的資料與邏輯抽離出不同 class 或 method。這符合相同變化頻率的程式碼一致性。</p>
</blockquote>
<ul>
<li><strong>分離不同變化頻率的邏輯</strong></li>
</ul>
<p>Kent Beck 在書中舉的例子是，如果開發一套稅務軟體，他會將計算<strong>通用稅金</strong>的程式碼，與計算<strong>每年特定稅金</strong>的程式碼拆成不同 class，因為通用稅金不會變，但每年特定稅金會因為每年的稅務計算公式而改變，分離這兩類程式碼，可以確保每年特定稅金程式碼修改，絕對不會影響到通用稅金，可以避免 side effect 發生。</p>
<ul>
<li><strong>封裝相同變化頻率的資料</strong></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$price</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$currency</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setAmount</span><span class="params">(int <span class="variable">$price</span>, int <span class="variable">$currency</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;price = <span class="variable">$price</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;currency = <span class="variable">$currency</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Order class</code> 有 <code>$price</code> (產品定價) 與 <code>$currency</code> (匯率) 資料，但實際上這兩個資料的變化頻率是一致的，也就是匯率一改變，產品定價就會跟著改變。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Money */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$money</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setAmount</span><span class="params">(int <span class="variable">$price</span>, int <span class="variable">$currency</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">    	<span class="variable">$this</span>-&gt;money = <span class="keyword">new</span> Money(<span class="variable">$price</span>, <span class="variable">$currency</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建議將 <code>$price</code> 與 <code>$currency</code> 封裝成 <code>Money</code> class。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Money */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$money</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setAmount</span><span class="params">(Money <span class="variable">$money</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">    	<span class="variable">$this</span>-&gt;money = <span class="variable">$money</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以進一步重構成直接以 <code>$money</code> 物件傳入。</p>
<p>如此相同變化頻率的 <code>$price</code> 與 <code>$currency</code> 都會被封裝在 <code>Money</code>，而不是在 <code>Order</code>，符合程式碼一致性的要求。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>程式設計價值觀與程式設計理論是所有程式語言都成立的，只要能打通此任督二脈，將來學什麼新程式語言都很快。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p>Kent Beck, <a href="https://www.amazon.com/Implementation-Patterns-Kent-Beck/dp/0321413091" target="_blank" rel="external">Implementation Patterns</a></p>
]]></content>
    <summary type="html">
    <![CDATA[Ch.3 A Theory of Programming]]>
    
    </summary>
    
      <category term="Implementation Pattern" scheme="http://oomusou.io/tags/Implementation-Pattern/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[實作模式讀書會 (Patterns)]]></title>
    <link href="http://oomusou.io/ip/ip-patterns/"/>
    <id>http://oomusou.io/ip/ip-patterns/</id>
    <published>2016-06-30T12:23:43.000Z</published>
    <updated>2016-07-04T13:44:00.000Z</updated>
    <content type="html"><![CDATA[<p>將<strong>模式</strong>做更深入的探討，包含其起源、特性與影響，讓我們更能接受模式這個概念。</p>
<a id="more"></a>
<h2 id="Motivation">Motivation</h2><hr>
<p>本文為 Kent Beck 的 <a href="https://www.amazon.com/Implementation-Patterns-Kent-Beck/dp/0321413091" target="_blank" rel="external">Implementation Patterns</a> 一書的讀書筆記，主要是整理給自己複習用，並加上自己的腦補。</p>
<h2 id="模式的起源">模式的起源</h2><hr>
<blockquote><p>Many decisions in programming are unique. However, as the decisions become more and more purely technical, a sense of familiarity sets in.</p>
<p>程式設計中，有許多決策是獨一無二的。然而，當決策內容越接近技術層面，其相似性會越多。</p>
</blockquote>
<p>以程式設計師天天要面對的<code>迴圈</code>為例，天天都要思考該用 <code>for</code>寫呢? 還是該用 <code>while</code> 寫呢？或者該用多執行緒的 <code>foreach</code>? 還是該使用 <code>collection</code>呢? 當思考寫迴圈時，大部分與 domain knowledge 有關的東西都已經拋諸腦後，只留下純粹技術問題。</p>
<blockquote><p>Each pattern illustrates a point of view about the relative priorities of the forces.</p>
<p>每個模式都代表一種「對於需求的相對的優先順序排序」的觀點。</p>
</blockquote>
<p>而需求可能有以下幾點 :</p>
<ul>
<li><strong>忠實呈現演算法</strong>。</li>
<li><strong>效能優先</strong>。</li>
<li><strong>容易閱讀</strong>。</li>
</ul>
<p>若需求是<code>忠實呈現演算法</code>，則可使用 <code>for</code> 或 <code>while</code> 的模式，會比較能夠忠實呈現原本演算法特性。</p>
<p>若需求是<code>效能優先</code>，則可使用多執行緒的<code>Parallel.Foreach()</code> 的模式，每個 closure 都會有在自己的執行緒執行，可充分發揮多核心硬體威力。</p>
<p>若需求是<code>容易閱讀</code>，則可使用 <code>Collection</code> 的模式，使用 <code>map().filter().reduce()</code> 寫法可讀性較佳。</p>
<blockquote><p>Most patterns come with a little essay about the alternatives for solving the problem and why the recommended solution is superior. Revealing the reasoning behind the advice in a pattern invites readers to decide for themselves how they want to approach a recurring problem.</p>
<p>大部分模式都會有一小段敘述，描述解決問題的各種方法，以及解釋此模式的優點在哪裡。探討模式背後的理論，有助於幫助讀者自行判斷應該如何解決這類一再出現的問題。</p>
</blockquote>
<p>以設計模式這本書為例 :</p>
<ul>
<li><strong>Motivation</strong> : 列出解決問題的各種方法。</li>
<li><strong>Applicability</strong> : 列出此模式適合的情境。</li>
<li><strong>Consequences</strong> : 列出此模式的優點與缺點。</li>
<li><strong>Implementation</strong> : 探討其背後的實作方法。</li>
</ul>
<p>如此可幫助讀者判斷此模式是否能解決需求。</p>
<blockquote><p>Patterns bridge from abstract principles to practice. Patterns help you write code.</p>
<p>模式是抽象原則與具體實踐間的橋樑，模式可幫助你寫出符合物件導向原則的程式碼。</p>
</blockquote>
<p>如降龍十八掌的心法是剛柔並濟，但就算你參悟了的心法，你還是很難打出降龍十八掌，因此才有了招式，如亢龍有悔、飛龍在天、神龍擺尾..，讓你可以一招一式去學習。</p>
<p>模式就類似<code>招式</code>一樣，在模式之前，談的大都是物件導向原則，如繼承、封裝、多型，就算你參悟了這些原則，你還是很難寫出物件導向程式，因此才有了模式，讓你可以一招一式去學習。</p>
<h2 id="模式的特性">模式的特性</h2><hr>
<h3 id="模式可彼此合作">模式可彼此合作</h3><blockquote><p>Patterns work together.</p>
<p>並不是一次只能使用一個模式，而是多個模式一起使用。</p>
</blockquote>
<p>如根據需求選擇了 <code>for 迴圈</code> 模式，又可能必須搭配 <code>替迴圈變數命名</code> 模式，而不是單一模式包山包海，將所有議題都放在單一模式中。</p>
<h3 id="實作抽象化">實作抽象化</h3><blockquote><p>As a pattern becomes habit I find I appreciate not having to raise a debate just to write a loop. If the whole team becomes dissatisfied with a pattern, they can discuss their options for introducing a new pattern.</p>
<p>當使用模式成為習慣之後，我很開心團隊不必再為「如何撰寫一個迴圈」的細節而討論，大家對 for 迴圈模式已經有共識，大家如果對 for 迴圈不滿意，也可以整個模式替換掉，如換成 Collection 模式。</p>
</blockquote>
<p>模式俗稱程式設計師的<code>黑話</code>，如當你說<code>工廠模式</code>，大家都知道你在講什麼，就不需再細部討論要有什麼 class，各 class 該怎麼互動，這就是將實作抽象化，讓大家的討論層級可以拉高，將重心放在如何解決問題，完成需求，而不是在細部的實作。</p>
<h3 id="沒有萬能模式">沒有萬能模式</h3><blockquote><p>No one set of patterns will work in all programming situations.</p>
<p>沒有任何一個模式可以適用於所有的需求。</p>
</blockquote>
<p>模式是解決特定問題的方法，只有在某些特定需求下適用，因此慎選模式很重要，沒有一個模式能解決所有需求，也不要為了要為了使用模式而硬套模式。</p>
<h3 id="協助人們做決定">協助人們做決定</h3><blockquote><p>Patterns work best as aids to human decision making.</p>
<p>模式最大的作用是幫助人們做決定。</p>
</blockquote>
<p>模式是前人與大師們經驗與智慧的結晶，因此很多時候我們不必每次都重新思考與踩雷，可以站在巨人的肩膀上。</p>
<h3 id="模式可能成為語言新功能">模式可能成為語言新功能</h3><blockquote><p>Some of the implementation patterns will eventually make their way into programming languages.</p>
<p>有些實作模式最後可能成為語言的一部份。</p>
</blockquote>
<p>有人說模式就是幫程式語言擦屁股用，就是因為程式語言沒有這些機制，因此我們必須使用模式來彌補，若最終成為程式語言或 framework 的一部份，就該改用程式語言或 framework 的新功能，不必太執著於一定要使用模式，因為通常程式語言或 framework 的方法都比模式更漂亮更乾淨。</p>
<h2 id="模式的影響">模式的影響</h2><hr>
<blockquote><p>Using patterns helps programmers write reasonable solutions to common problems, leaving more time, energy, and creativity to apply to the truly unique problems.</p>
<p>使用模式能幫助程式設計師使用更合理的方式解決常見問題，將更多時間、更多精力與創造力用於解決真正獨一無二的問題。</p>
</blockquote>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>模式是具體的招式法門，也是前人留下的經驗與智慧結晶，讓我們可以站在巨人的肩膀上，使用模式來處理常見的問題，將更多時間與精力用來解決真正的問題。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p>Kent Beck, <a href="https://www.amazon.com/Implementation-Patterns-Kent-Beck/dp/0321413091" target="_blank" rel="external">Implementation Patterns</a></p>
]]></content>
    <summary type="html">
    <![CDATA[Ch.2 Patterns]]>
    
    </summary>
    
      <category term="Implementation Pattern" scheme="http://oomusou.io/tags/Implementation-Pattern/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[實作模式讀書會 (Introduction)]]></title>
    <link href="http://oomusou.io/ip/ip-intro/"/>
    <id>http://oomusou.io/ip/ip-intro/</id>
    <published>2016-06-29T12:23:43.000Z</published>
    <updated>2016-07-04T13:20:01.000Z</updated>
    <content type="html"><![CDATA[<p>介紹本書主要的目標、章節安排，心法與學習方式，並對<strong>模式</strong>一詞下了定義，也針對實作模式與設計模式的差異加以討論。</p>
<a id="more"></a>
<h2 id="Motivation">Motivation</h2><hr>
<p>本文為 Kent Beck 的 <a href="https://www.amazon.com/Implementation-Patterns-Kent-Beck/dp/0321413091" target="_blank" rel="external">Implementation Patterns</a> 一書的讀書筆記，主要是整理給自己複習用，並加上自己的腦補。</p>
<h2 id="本書目標">本書目標</h2><blockquote><p>The goal of the book is to help you communicate your intentions through your code.</p>
<p>本書是教你寫容易閱讀、容易維護的程式碼。</p>
</blockquote>
<h2 id="本書架構">本書架構</h2><hr>
<ul>
<li><strong>程式設計與模式概論</strong> : Ch.2 ~ Ch.4。</li>
<li><strong>實作模式</strong> : Ch.5 ~ Ch.8</li>
<li><strong>Collection</strong> : Ch.9</li>
<li><strong>Framework</strong> : Ch.10</li>
</ul>
<p>整本書以 <strong>Communication</strong> 貫穿，也就是寫出<code>容易閱讀</code>、<code>容易維護</code>的程式碼。</p>
<h2 id="實作模式心法">實作模式心法</h2><hr>
<h3 id="保持頭腦清醒並放慢腳步">保持頭腦清醒並放慢腳步</h3><blockquote><p>Even though programming decisions came smoothly and quickly to me, I couldn’t explain why I was so sure a method should be called such-and-so, or that a bit of logic belonged in this object over here.</p>
<p>儘管我能在程式設計中快速的做決定，但我仍無法解釋一些我很確定的東西，如「這個 method 為什麼該這樣被呼叫?」或 「這段邏輯為什麼屬於這個物件?」這種基本問題。</p>
</blockquote>
<p>這是連 Kent Beck 也會犯的錯，也是我們常常忽略的點，只求會用其他 class，卻沒認真去想過為什麼要這樣設計。</p>
<blockquote><p>The first step towards communicating was slowing down long enough to become aware of what I was thinking, to stop pretending that I coded by instinct.</p>
<p>寫出容易閱讀的程式碼的第一步，就是將腳步慢下來，搞清楚自己在寫什麼，而不是一切都是理所當然。</p>
</blockquote>
<p>寫程式並不是寫的快就是好，Kent Beck 教我們將腳步放慢，細細去品味其他 class 為什麼要這樣設計。</p>
<h3 id="程式碼是要給其他人閱讀的">程式碼是要給其他人閱讀的</h3><blockquote><p>Before I could write communicative code I needed to believe that other people was as important as I was. Programming is hardly ever a solitary communication between one man and one machine.</p>
<p>程式並不是只寫給電腦看而已，你必須先相信程式碼是用來給其他人閱讀的。</p>
</blockquote>
<p>程式並不是讓電腦看得懂會動就好，重點是要讓自己與其他人看得懂，寫出容易閱讀的程式碼，才能進一步容易維護。</p>
<h3 id="使用實作模式">使用實作模式</h3><blockquote><p>I use the implementation patterns here to program consciously and for others as well as myself.</p>
<p>在此我介紹實作模式，寫出更容易閱讀的程式碼，不只是給其他人閱讀，也是給自己閱讀。</p>
</blockquote>
<h2 id="學習方式">學習方式</h2><hr>
<h3 id="需求學習法">需求學習法</h3><blockquote><p>I suggest skipping right to chapter 5 and skimming through to the end, then keeping the book by you as you program. After you’ve used many of the patterns, you can come back to the introductory material for the philosophical background behind the ideas you’ve been using.</p>
<p>我建議直接跳到 Ch.5 ~ Ch.8，快速地掃過後續章節，然後將本書放在手邊，有需要時隨時翻閱。當你使用過許多實作模式之後，可以再回到 Ch.2 ~ Ch.4，了解實作模式背後的設計理論。</p>
</blockquote>
<h3 id="理論學習法">理論學習法</h3><blockquote><p>If you are interested in a through understanding of the material here, you can read straight through from the beginning.</p>
<p>如果你想對實作模式徹底了解，可依本書章節從頭讀到尾，先從 Ch.2 ~ Ch.4 學習實作模式背後的理論，再由 Ch.5 ~ Ch.8 學習實作模式。</p>
</blockquote>
<p>這兩種方法沒有好壞與對錯，有的人習慣先學理論，再學實作；也有人習慣先學實作，回來悟得理論。</p>
<p>也可以是兩種學習方法的綜合體 : 先學理論，再學實作，再由不斷的實作，驗證理論，不斷地調整實作，讓實作符合需求，卻又不違背理論。</p>
<h2 id="模式定義">模式定義</h2><hr>
<blockquote><p>Most decisions in programming are similar to decisions that have come before. … The decision and its constraints repeat even though you might create different name each time.</p>
<p>在程式設計時，大部分的思考決策都很類似，而且曾經出現過 … 儘管每次實作結果不相同，但相同的決策與情境總是一再地出現。</p>
</blockquote>
<p>而這些一再重複出現的思考決策與情境，而且被證明是有效的處裡方式，就會被高手歸納成為<strong>模式</strong>，讓初學者可以遵循前人所留下來的智慧結晶，來處理這些一再重複出現的需求。</p>
<blockquote><p>This book contains 77 explicitly named patterns, each covering some aspect of writing readable code. In addition, there are many smaller patterns or variants of patterns that I mention in passing. My goal with this book is to offer advice for how to approach most common, daily coding tasks so as to help futuer readers understand what the code is supposed to do.</p>
<p>本書包含 77 個有命名的實作模式，每一個實作模式都在某種程度實現容易閱讀程式碼的目標。此外，還有一些較小的無名模式或者模式的變形。本書的目的是給程式設計師一些建議，告訴他們在每天的開發程式過程中，能寫出容易閱讀的程式碼。</p>
</blockquote>
<h2 id="實作模式與設計模式的差異">實作模式與設計模式的差異</h2><hr>
<blockquote><p>This book fits somewhere between Design Patterns and a Java language manual. Design Patterns talks about decisions you might make a few times a day while developing, typically decisions that regulate the interaction between objects. You apply an implementation pattern every few seconds while programming.</p>
<p>本書是介於設計模式與 Java 手冊之間的書籍。設計模式討論的是開發過程中，每天要做個幾次的決策，通常是物件之間的互動。但實作模式則關心更細微的實作部分，可能每幾秒鐘就會用到一個實作模式。</p>
</blockquote>
<p>設計模式是教你特定需求下的物件導向解決方式，而實作模式教你的是實現物件導向的基本功。</p>
<blockquote><p>While language manuals are good at describing what you can do with Java, they don’t talk much about why you would use a certain construct or what someone reading your code is likely to conclude form it.</p>
<p>Java 語言手冊會教你 Java 能做些什麼，但不會教你「這個 method 為什麼該這樣被呼叫?」或 「這段邏輯為什麼屬於這個物件?」，也不會教你如何寫出容易閱讀的程式碼，而這正是實作模式的重點所在。</p>
</blockquote>
<p>程式語言手冊教你的是程式語言的語法及功能，而實作模式教你的是駕馭這個語言並寫出容易閱讀的程式碼。</p>
<h2 id="本書不包含的主題">本書不包含的主題</h2><hr>
<ul>
<li>Concurrency。</li>
<li>Software Process。</li>
<li>Java 的新功能。</li>
</ul>
<h2 id="本書章節概述">本書章節概述</h2><hr>
<ul>
<li><strong>Introduction</strong> : Ch.2 ~ Ch.4，探討容易閱讀程式碼的重要性與價值，以及實作模式背後的設計理論。</li>
<li><strong>Class</strong> : Ch.5，與 class 先關的實作模式，如「如何設計 class?」、「如何將邏輯封裝在 class?」。</li>
<li><strong>State</strong> : Ch.6，與 state 存取相關的實作模式</li>
<li><strong>Behavior</strong> : Ch.7，與邏輯相關的實作模式，如「當你有很多方式實現相同邏輯時」。</li>
<li><strong>Methods</strong> : Ch.8，與 metohd 相關的實作模式，如「解耦合與命名方面」。</li>
<li><strong>Collections</strong> : Ch.9，與 collection 使用相關的實作模式。</li>
<li><strong>Frameworks</strong> : Ch.10，開發 framework 時，該如何使用實作模式。</li>
</ul>
<p><img src="/images/ip/ip-intro/intro000.png" alt=""></p>
<ul>
<li>Patterns / Values / Principles / Motivation (實作模式理論)</li>
<li>class (以 class 為中心設計)。</li>
<li>Behavior (相似邏輯) -&gt; Methods (解耦合)。</li>
<li>State (不同資料) -&gt; Collections (同類型資料)</li>
<li>Frameworks (全部統整)。</li>
</ul>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>語言手冊只會教你語法與功能，無法教你寫出容易閱讀的程式碼。</li>
<li>設計模式只有在特定需求才用得到，但實作模式是隨時都在用。</li>
<li>不用解釋的程式，就是好程式。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p>Kent Beck, <a href="https://www.amazon.com/Implementation-Patterns-Kent-Beck/dp/0321413091" target="_blank" rel="external">Implementation Patterns</a></p>
]]></content>
    <summary type="html">
    <![CDATA[Ch.1 Introduction]]>
    
    </summary>
    
      <category term="Implementation Pattern" scheme="http://oomusou.io/tags/Implementation-Pattern/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 PhpStorm 將專案發佈到 GitHub?]]></title>
    <link href="http://oomusou.io/phpstorm/phpstorm-github/"/>
    <id>http://oomusou.io/phpstorm/phpstorm-github/</id>
    <published>2016-06-29T04:23:43.000Z</published>
    <updated>2016-06-30T07:46:05.000Z</updated>
    <content type="html"><![CDATA[<p>若要將專案發佈到 GitHub，實務上除了先在本機建立 local git repository 外，還要在 GitHub 建立 remote git repository，然後建立 remote branch，最後才能 push 到 GitHub，這些動作都可以在 PhpStorm 內簡單的完成。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0<br>Laravel 5.2.39<br>PhpStorm 2016.1.2</p>
<h2 id="Motivation">Motivation</h2><hr>
<p>之前要將專案發佈到 GitHub，都是乖乖的下指令，但指令實在記不起來，只能複製貼上，在<a href="/azure/azure_phpstorm_deploy/">如何使用 PhpStorm 部署 Laravel 到 Azure?</a> 一文中，發現 PhpStorm 亦提供完整的圖形介面支援 Git 與 GitHub，讓我們可以使用更直覺的方式完成。</p>
<h2 id="建立_Laravel_專案">建立 Laravel 專案</h2><hr>
<p><img src="/images/azure/azure_phpstorm_deploy/azure000.png" alt=""></p>
<p>啟動 PhpStorm，選擇 <code>Create New Project</code> 建立新專案。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure001.png" alt=""></p>
<ul>
<li><strong>專案類型</strong> :  <code>Composer Project</code>。</li>
<li><strong>Location</strong> : Laravel 專案路徑與專案名稱</li>
<li><strong>composer.phar</strong> : 選擇 <code>Use existing composer.phar</code>，輸入 <code>/usr/local/bin/composer</code>。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>選擇 <code>Download composer.phar from getcomposer.org</code> 亦可，這種方式在 OS X 本機並不需要事先安裝 Composer，PhpStorm 會自動將 Composer 下載到目錄專案跟目錄下，唯此種方式安裝 package 將無法使用到 cache，必須從網路上下載，安裝時間較長，所以實務上建議使用 <code>Use existing composer.phar</code>。</span></span></span></li>
<li><strong>Filter packages</strong> : 輸入 <code>laravel/laravel</code>，此為 Laravel 專案的 package 名稱。</li>
</ul>
<p><img src="/images/azure/azure_phpstorm_deploy/azure002.png" alt=""></p>
<p>將畫面向下卷，還有其他設定。</p>
<ul>
<li><strong>Version to install</strong> : 選擇 Laravel 版本，<code>&lt;default&gt;</code> 為 Laravel 最新版本。</li>
<li><strong>Path to PHP executable</strong> : 指定 PHP 執行檔路徑，主要為了執行 Composer。</li>
<li><strong>Command line parameters</strong> : Composer 參數，輸入 <code>prefer-dist</code>。</li>
</ul>
<p><img src="/images/azure/azure_phpstorm_deploy/azure003.png" alt=""></p>
<p>建立 Laravel 專案中，由於 Composer 需解析 package 相依性，需要一些時間。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure004.png" alt=""></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan serve</span><br></pre></td></tr></table></figure>
<p>執行 PHP 內建 Http Server。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure005.png" alt=""></p>
<p>Laravel 已經順利在 OS X 本機執行。</p>
<h2 id="建立_Local_Git_Repository">建立 Local Git Repository</h2><hr>
<p>實務上開發 Laravel 會搭配 Git 做版本控制，先在本機建立 local repository。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure006.png" alt=""></p>
<p><strong><em>VCS -&gt; Import ino Version Control -&gt; Create Git Repository</em></strong></p>
<p>建立 Git repository。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>相當於 <code>git init</code>。</span></span></span></p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure007.png" alt=""></p>
<p>選擇 local repository 目錄，也就是目前專案目錄。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure008.png" alt=""></p>
<p>下方出現 <code>Version Control</code>，並顯示有檔案尚未受 Git 管理，按 <code>browse</code> 顯示檔案。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure009.png" alt=""></p>
<p>選擇專案目錄，按 <code>+</code> (Add to VCS) 將檔案加入 stage。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>相當於 <code>git add .</code>。</span></span></span></p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure010.png" alt=""></p>
<p>綠色檔案為加入 stage 的檔案，按 <code>VCS</code> (Commit Changes)。<br><img src="/images/azure/azure_phpstorm_deploy/azure011.png" alt=""></p>
<ul>
<li>不要選擇 <code>Perform code analysis</code>。</li>
<li><strong>Commit Message</strong> : Initial commit。</li>
</ul>
<p>按 <code>Commit</code> 寫檔案寫入 local repository。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>相當於 <code>git commit -m &quot;Initial commit&quot;</code>。</span></span></span></p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure012.png" alt=""></p>
<p>Commit 成功後，下方會顯示 <code>xx files committed : initial commit</code>。</p>
<h2 id="建立_Remote_GitHub_Repository">建立 Remote GitHub Repository</h2><hr>
<p>將 local repository 上傳至 GitHub 建立 remote repository。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure017.png" alt=""></p>
<p><strong><em>PhpStorm -&gt; Preferences -&gt; Version Control -&gt; GitHub</em></strong></p>
<p>設定 GitHub 帳號。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure013.png" alt=""></p>
<p><strong><em>VCS -&gt; Import into Version Control -&gt; Share Project on GitHub</em></strong></p>
<p>將專案發佈到 GitHub。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure014.png" alt=""></p>
<p>預設會使用專案名稱為 remote GitHub repository 名稱。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure015.png" alt=""></p>
<p>在 GitHub 建立成功。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure016.png" alt=""></p>
<p>在 GitHub 已經看到剛剛上傳的專案。</p>
<h2 id="修改並_Push_到_GitHub">修改並 Push 到 GitHub</h2><hr>
<p><img src="/images/azure/azure_phpstorm_deploy/azure052.png" alt=""></p>
<p>將 <code>welcome.blade.php</code> 加以修改，由 <code>Laravel 5</code> 改成 <code>Hello Laravel</code>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure053.png" alt=""></p>
<p>點擊下方的 <code>Version control</code> 標籤，按 <code>VCS</code> 將此次變更加以 commit。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure054.png" alt=""></p>
<p>填入 commit message 後，按 <code>Commit and Push</code>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure055.png" alt=""></p>
<p>按 <code>Push</code> 將直接 push 到 GitHub。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure056.png" alt=""></p>
<p>Push 到 GitHub 成功。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>PhpStorm 所提供的 Git 與 GitHub 支援或許不夠完整，但對於日常使用足足有餘，可大幅提高開發效率。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52PhpStormAzure_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<ul>
<li>Mikhail Vink, <a href="https://confluence.jetbrains.com/display/PhpStorm/Working+with+Windows+Azure+from+within+PhpStorm" target="_blank" rel="external">Working with Windows Azure from within PhpStorm</a></li>
<li>KevinAtStout, <a href="https://www.youtube.com/watch?v=48moauj0KtE" target="_blank" rel="external">Connecting PhpStorm to Your Azure Web Server</a></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[直接在 PhpStorm 內 push 到 GitHub]]>
    
    </summary>
    
      <category term="Git" scheme="http://oomusou.io/tags/Git/"/>
    
      <category term="GitHub" scheme="http://oomusou.io/tags/GitHub/"/>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 PhpStorm 部署 Laravel 到 Azure?]]></title>
    <link href="http://oomusou.io/azure/azure_phpstorm_deploy/"/>
    <id>http://oomusou.io/azure/azure_phpstorm_deploy/</id>
    <published>2016-06-28T12:23:43.000Z</published>
    <updated>2016-06-29T04:01:38.000Z</updated>
    <content type="html"><![CDATA[<p>Azure 是微軟的雲端平台，也可以跑 PHP 與 Laravel，本文將以 PhpStorm 為工具，與 GitHub 結合，將來程式有任何變更，只要 push 到 GitHub，就會自動更新到 Azure，還可透過 PhpStorm 內建的工具管理 Azure。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0<br>Laravel 5.2.39<br>PhpStorm 2016.1.2</p>
<h2 id="Motivation">Motivation</h2><hr>
<p>Azure Portal 提供友善的管理介面，讓我們可以很方便在雲端建立 Web App，而 Visual Studio 亦內建工具，可以簡單地將 ASP.NET 部署到 Azure，因此很好奇 PhpStorm 是否提供類似的方式，讓我們更有效率部署 Laravel。</p>
<h2 id="建立_Laravel_專案">建立 Laravel 專案</h2><hr>
<p><img src="/images/azure/azure_phpstorm_deploy/azure000.png" alt=""></p>
<p>啟動 PhpStorm，選擇 <code>Create New Project</code> 建立新專案。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure001.png" alt=""></p>
<ul>
<li><strong>專案類型</strong> :  <code>Composer Project</code>。</li>
<li><strong>Location</strong> : Laravel 專案路徑與專案名稱</li>
<li><strong>composer.phar</strong> : 選擇 <code>Use existing composer.phar</code>，輸入 <code>/usr/local/bin/composer</code>。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>選擇 <code>Download composer.phar from getcomposer.org</code> 亦可，這種方式在 OS X 本機並不需要事先安裝 Composer，PhpStorm 會自動將 Composer 下載到目錄專案跟目錄下，唯此種方式安裝 package 將無法使用到 cache，必須從網路上下載，安裝時間較長，所以實務上建議使用 <code>Use existing composer.phar</code>。</span></span></span></li>
<li><strong>Filter packages</strong> : 輸入 <code>laravel/laravel</code>，此為 Laravel 專案的 package 名稱。</li>
</ul>
<p><img src="/images/azure/azure_phpstorm_deploy/azure002.png" alt=""></p>
<p>將畫面向下卷，還有其他設定。</p>
<ul>
<li><strong>Version to install</strong> : 選擇 Laravel 版本，<code>&lt;default&gt;</code> 為 Laravel 最新版本。</li>
<li><strong>Path to PHP executable</strong> : 指定 PHP 執行檔路徑，主要為了執行 Composer。</li>
<li><strong>Command line parameters</strong> : Composer 參數，輸入 <code>prefer-dist</code>。</li>
</ul>
<p><img src="/images/azure/azure_phpstorm_deploy/azure003.png" alt=""></p>
<p>建立 Laravel 專案中，由於 Composer 需解析 package 相依性，需要一些時間。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure004.png" alt=""></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan serve</span><br></pre></td></tr></table></figure>
<p>執行 PHP 內建 Http Server。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure005.png" alt=""></p>
<p>Laravel 已經順利在 OS X 本機執行。</p>
<h2 id="建立_Local_Git_Repository">建立 Local Git Repository</h2><hr>
<p>實務上開發 Laravel 會搭配 Git 做版本控制，先在本機建立 local repository。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure006.png" alt=""></p>
<p><strong><em>VCS -&gt; Import ino Version Control -&gt; Create Git Repository</em></strong></p>
<p>建立 Git repository。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>相當於 <code>git init</code>。</span></span></span></p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure007.png" alt=""></p>
<p>選擇 local repository 目錄，也就是目前專案目錄。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure008.png" alt=""></p>
<p>下方出現 <code>Version Control</code>，並顯示有檔案尚未受 Git 管理，按 <code>browse</code> 顯示檔案。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure009.png" alt=""></p>
<p>選擇專案目錄，按 <code>+</code> (Add to VCS) 將檔案加入 stage。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>相當於 <code>git add .</code>。</span></span></span></p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure010.png" alt=""></p>
<p>綠色檔案為加入 stage 的檔案，按 <code>VCS</code> (Commit Changes)。<br><img src="/images/azure/azure_phpstorm_deploy/azure011.png" alt=""></p>
<ul>
<li>不要選擇 <code>Perform code analysis</code>。</li>
<li><strong>Commit Message</strong> : Initial commit。</li>
</ul>
<p>按 <code>Commit</code> 寫檔案寫入 local repository。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>相當於 <code>git commit -m &quot;Initial commit&quot;</code>。</span></span></span></p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure012.png" alt=""></p>
<p>Commit 成功後，下方會顯示 <code>xx files committed : initial commit</code>。</p>
<h2 id="建立_Remote_GitHub_Repository">建立 Remote GitHub Repository</h2><hr>
<p>將 local repository 上傳至 GitHub 建立 remote repository。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure017.png" alt=""></p>
<p><strong><em>PhpStorm -&gt; Preferences -&gt; Version Control -&gt; GitHub</em></strong></p>
<p>設定 GitHub 帳號。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure013.png" alt=""></p>
<p><strong><em>VCS -&gt; Import into Version Control -&gt; Share Project on GitHub</em></strong></p>
<p>將專案發佈到 GitHub。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure014.png" alt=""></p>
<p>預設會使用專案名稱為 remote GitHub repository 名稱。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure015.png" alt=""></p>
<p>在 GitHub 建立成功。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure016.png" alt=""></p>
<p>在 GitHub 已經看到剛剛上傳的專案。</p>
<h2 id="建立_Azure_Web_App">建立 Azure Web App</h2><hr>
<p>之前都在 PhpStorm 操作，現在開始要在 <a href="http://protal.azure.com" target="_blank" rel="external">Azure portal</a> 操作了。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure018.png" alt=""></p>
<p><strong><em>New -&gt; Web + Mobile -&gt; Web App</em></strong></p>
<p>在 Azure 建立 Web App。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure019.png" alt=""></p>
<ul>
<li><strong>App name</strong> : 將來可以使用網址 <code>https://appname.azurewebsites.net</code> 連過來。</li>
<li><strong>Resource Group</strong> : 可以新建 group，也可以使用目前既有 group，使用 group 的優點是方便管理，若要刪除可以整個 group 一起刪除。</li>
</ul>
<p>按 <code>App Service plan/location</code> 繼續設定。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure020.png" alt=""></p>
<p>預設的 App Service plan 是在美國，並不適合我們，我們應該選離我們最近的主機，所以選擇 <code>Create New</code> 建立新的 App Service plan。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure021.png" alt=""></p>
<ul>
<li><strong>App Service plan</strong> : 替 App Service plan 選個名稱。</li>
<li><strong>Location</strong> : 選擇主機位置，離我們最近的是 <code>East Asia</code>，位在香港。</li>
<li><strong>Pricing tier</strong> : 預設為 <code>D1 Shared</code>，需要收費，由於我們只是測試用，可以選擇 <code>0</code> 元的方案。</li>
</ul>
<p><img src="/images/azure/azure_phpstorm_deploy/azure022.png" alt=""></p>
<p>預設只會顯示 <code>Recommended</code> 方案，按 <code>View all</code> 顯示全部方案。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure023.png" alt=""></p>
<p>選擇 <code>0</code> 元的 <code>F1 Free</code> 方案。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure024.png" alt=""></p>
<p>Pricing tier 改成 <code>F1 Free</code>，按 <code>OK</code> 繼續。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure025.png" alt=""></p>
<p>App Service plan/location 改成我們想要的 <code>Laravel (East Asia)</code>。</p>
<p>按 <code>Create</code> 開始建立 Web App。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure026.png" alt=""></p>
<p>Azure 正在建立 Web App 中，需要一點時間。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure027.png" alt=""></p>
<p>Web App 建立完成，會顯示 <code>Running</code>。</p>
<h2 id="設定_PHP_版本">設定 PHP 版本</h2><hr>
<p>Web App 預設的版本為 PHP 5.4，無法執行 Laravel，必須另外設定。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure028.png" alt=""></p>
<p>選擇剛剛建立的 <code>Laravel52PhpStormAzure</code> Web App。</p>
<p><strong><em>Settings -&gt; Application settings</em></strong>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure029.png" alt=""></p>
<ul>
<li><strong>PHP version</strong> : 選擇 <code>5.6</code> 或 <code>7.0</code>。</li>
</ul>
<p>最後記得按上方的 <code>Save</code> 存檔。</p>
<h2 id="安裝_Composer">安裝 Composer</h2><hr>
<p>Laravel 預設的 <code>.gitignore</code> 有排除 <code>vendor</code> 目錄，使得上傳到 GitHub 不包含 <code>vendor</code> ，所以將來 Azure 從 GitHub 所抓下來的檔也沒有 <code>vendor</code> 目錄。</p>
<p>這使得 Azure 要自己下 <code>composer install</code> 安裝 <code>vendor</code> 下的 package，因此必須另外在 Azure 安裝 Composer。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure030.png" alt=""></p>
<p><strong><em>Tools -&gt; Extensions</em></strong>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure031.png" alt=""></p>
<p>按 <code>Add</code> 新增 extension。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure032.png" alt=""></p>
<p>選 <code>Choose Extension</code> 與 <code>Composer</code>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure033.png" alt=""></p>
<p>成功安裝 Composer。</p>
<h2 id="設定_Deployment_Source">設定 Deployment Source</h2><hr>
<p>設定 Azure 從 GitHub 抓資料，只要有任何 push 到 GitHub，Azure 都會自動更新。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure034.png" alt=""></p>
<p><strong><em>Setting -&gt; Deployment source</em></strong>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure035.png" alt=""></p>
<p> <strong><em>Choose Source -&gt; GitHub</em></strong></p>
<p>Azure 支援多種 deployment source，本文以 GitHub 為例。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure036.png" alt=""></p>
<p>選擇 GitHub 上的 <code>project</code> 與 <code>branch</code>。<span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>第一次連上 GitHub，會需要設定 authentication。</span></span></span></p>
<p>按 <code>OK</code> 後，開始第一次從 GitHub 部署到 Azure。</p>
<p>由於第一次部署，<code>composer install</code> 要重新安裝 <code>vendor</code> 目錄，需要一點時間。</p>
<h2 id="設定_Remote_Host">設定 Remote Host</h2><hr>
<p>設定 Web App 一定得設定虛擬目錄，但是之前的部署皆由 Azure 自動完成，到底 Azure 將我們的專案下載到什麼目錄下呢?</p>
<p>讓我們再回到 PhpStorm。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure037.png" alt=""></p>
<p><strong><em>PhpStorm -&gt; Preferences -&gt; Build, Execution Development -&gt; Deployment</em></strong></p>
<p>按 <code>+</code> 新增。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure038.png" alt=""></p>
<p>輸入自訂 server 名稱，選擇 type 為 <code>FTP</code>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure039.png" alt=""></p>
<p>需要輸入 <code>FTP host</code>、<code>User name</code> 與 <code>Web server root url</code>。</p>
<p>但此時我們還不知道該輸入什麼。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure040.png" alt=""></p>
<p>回到 <a href="http://protal.azure.com" target="_blank" rel="external">Azure portal</a>。</p>
<p><strong><em>Settings -&gt; Properties</em></strong>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure044.png" alt=""></p>
<ul>
<li><code>URL</code> 為 <code>Web server root url</code>。</li>
</ul>
<p><img src="/images/azure/azure_phpstorm_deploy/azure041.png" alt=""></p>
<ul>
<li><code>FTP/DEPLOYMENT USER</code> 為 <code>User name</code>。</li>
<li><code>FTP HOST NAME</code> 為 <code>FTP host</code>。</li>
</ul>
<p><img src="/images/azure/azure_phpstorm_deploy/azure042.png" alt=""></p>
<p>再回到 PhpStorm，將 <code>FTP host</code>、<code>User name</code> 與 <code>Web server root url</code> 補上。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure043.png" alt=""></p>
<p><strong><em>Tools -&gt; Deployment -&gt; Browse Remote Host</em></strong></p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure045.png" alt=""></p>
<p>由 <code>Remote Host</code> 視窗，我們發現 Laravel 專案是放在 <code>site/wwwroot</code> 底下，所以 virtual root 應該設定在 <code>site/wwwroot/public</code>。</p>
<h2 id="設定_Virtual_Root">設定 Virtual Root</h2><hr>
<p><img src="/images/azure/azure_phpstorm_deploy/azure046.png" alt=""></p>
<p>再回到 <a href="http://protal.azure.com" target="_blank" rel="external">Azure portal</a>。</p>
<p><strong><em>Settings -&gt; Application settings</em></strong>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure047.png" alt=""></p>
<p>在 <code>Virtual application and directories</code> 下，將 virtual root 改成 <code>site\wwwroot\public</code>。</p>
<p>最後記得按上方的 <code>Save</code> 存檔。</p>
<h2 id="設定_-env">設定 .env</h2><hr>
<p>Laravel 提供了 <code>.env</code>，可以設定些敏感資訊，如資料庫連線。預設 <code>.gitignore</code>有排除 <code>.env</code>，所以並沒有上 GitHub，因此也不會上 Azure。</p>
<p>但 <code>.env</code> 的 <code>APP_KEY</code> 又是 Laravel 執行時所必要資訊，必須加以補上。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure046.png" alt=""></p>
<p><strong><em>Settings -&gt; Application settings</em></strong>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure048.png" alt=""></p>
<p>將本機的 <code>.env</code> 的 <code>APP_KEY</code> 內容加以複製。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure049.png" alt=""></p>
<p>在 <code>App settings</code> 下新增 <code>APP_KEY</code>，將 <code>.env</code> 的 <code>APP_KEY</code> 值貼上。<span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>實務上 <code>.env</code> 的設定，都可以改設定在 Azure 的 <code>App settings</code>。</span></span></span></p>
<p>最後記得按上方的 <code>Save</code> 存檔。</p>
<h2 id="第一次在_Azure_執行_Laravel">第一次在 Azure 執行 Laravel</h2><hr>
<p><img src="/images/azure/azure_phpstorm_deploy/azure050.png" alt=""></p>
<p>點擊 <code>URL</code>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure051.png" alt=""></p>
<p>在 Azure 的網址上正確執行 Laravel。</p>
<h2 id="修改並_Push_到_GitHub">修改並 Push 到 GitHub</h2><hr>
<p><img src="/images/azure/azure_phpstorm_deploy/azure052.png" alt=""></p>
<p>將 <code>welcome.blade.php</code> 加以修改，由 <code>Laravel 5</code> 改成 <code>Hello Laravel</code>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure053.png" alt=""></p>
<p>點擊下方的 <code>Version control</code> 標籤，按 <code>VCS</code> 將此次變更加以 commit。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure054.png" alt=""></p>
<p>填入 commit message 後，按 <code>Commit and Push</code>。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure055.png" alt=""></p>
<p>按 <code>Push</code> 將直接 push 到 GitHub。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure056.png" alt=""></p>
<p>Push 到 GitHub 成功。</p>
<p><img src="/images/azure/azure_phpstorm_deploy/azure057.png" alt=""></p>
<p>Azure 會自動從 GitHub 更新。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>本文以 GitHub 為例，實務上你可以搭配你習慣的版本控制系統。</li>
<li>透過 <a href="http://protal.azure.com" target="_blank" rel="external">Azure portal</a> 與 PhpStorm，您不需要下任何一行指令，就可以經鬆的將 Laravel 部署到 Azure。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52PhpStormAzure_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<ul>
<li>Cephas, <a href="https://azure.microsoft.com/zh-tw/documentation/articles/app-service-web-php-get-started/" target="_blank" rel="external">建立、設定和部署 PHP Web 應用程式至 Azure</a></li>
<li>Robert McMurray, <a href="https://azure.microsoft.com/zh-tw/documentation/articles/web-sites-php-configure/" target="_blank" rel="external">在 Azure App Service Web Apps 中設定 PHP</a></li>
<li>Mikhail Vink, <a href="https://confluence.jetbrains.com/display/PhpStorm/Working+with+Windows+Azure+from+within+PhpStorm" target="_blank" rel="external">Working with Windows Azure from within PhpStorm</a></li>
<li>KevinAtStout, <a href="https://www.youtube.com/watch?v=48moauj0KtE" target="_blank" rel="external">Connecting PhpStorm to Your Azure Web Server</a></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[使用有效率的工具部署 Laravel]]>
    
    </summary>
    
      <category term="Azure" scheme="http://oomusou.io/tags/Azure/"/>
    
      <category term="Git" scheme="http://oomusou.io/tags/Git/"/>
    
      <category term="GitHub" scheme="http://oomusou.io/tags/GitHub/"/>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 PhpStorm 對 Collection 除錯?]]></title>
    <link href="http://oomusou.io/phpstorm/phpstorm-collection-debug/"/>
    <id>http://oomusou.io/phpstorm/phpstorm-collection-debug/</id>
    <published>2016-06-19T12:23:43.000Z</published>
    <updated>2016-06-20T03:12:52.000Z</updated>
    <content type="html"><![CDATA[<p>Laravel 的 <code>Collection</code> 在實務上非常好用，除了 Eloquent 直接回傳 <code>Collection</code> 外，還擴充了很多 method，讓我們可以使用 higher order function 與 fluent 風格開發，讓程式可讀性更高。不過 <code>Collection</code> 的除錯就比較麻煩，本文使用 PhpStorm 內建的 <strong>Watches</strong>，讓我們可以在不用修改程式碼的前提下，快速對 <code>Collection</code> 除錯。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>Laravel 5.2.39<br>PhpStorm 2016.1.2</p>
<h2 id="Motivation">Motivation</h2><hr>
<p>在看了 Adam Wathan 的 <a href="http://adamwathan.me/refactoring-to-collections/" target="_blank" rel="external">Refactoring to Collections</a> 之後，發現這種 declarative 式的程式風格，不僅程式碼更精簡，可讀性更高，也符合 SOLID 原則的單一職責，因此開始大量使用 <code>Collection</code> 內建的 method 來寫程式。</p>
<p>但由於是 fluent 風格的程式，因此在 debug 時面臨困難，必須修改程式碼，加上很多暫存變數，設定中斷點後，透過 <strong>Variables</strong> 去觀察暫存變數，等除錯完後，再透過重構的 <code>Inline Variable</code> 去合併變數。</p>
<p>在 Freek Van der Herten 的 <a href="https://murze.be/2016/06/debugging-collections/" target="_blank" rel="external">Debugging collections</a> 一文中，提出了使用了 Collection Macro 配合 <code>dd()</code> 的方式，這種方式就不需要增加暫存變數，只要在要 debug 的 method 之後加上 <code>-&gt;dd()</code> 即可，非常方便。</p>
<p>不過唯一小小的可惜是，這種方式仍然需要去修改程式碼去加上 <code>-&gt;dd()</code>，是否可能在完全不需修改程式碼的前提下，快速對 <code>Collection</code> 除錯呢?</p>
<h2 id="實際案例">實際案例</h2><hr>
<p>我們將以 <code>Order</code> model 為例，顯示<code>今天全部訂單金額</code>，並寫單元測試判斷結果是否如預期。</p>
<h2 id="單元測試">單元測試</h2><hr>
<p>以 TDD 方式開發，因此必須先寫單元測試。</p>
<p><strong>OrderServiceTest.php</strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo/commit/a74e7cc1327e79f0a47e967d225cbaf5c88197f5" target="_blank" rel="external">單元測試 : 今天全部訂單金額</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/OrderServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Order</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">OrderService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 今天全部訂單金額<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** Arrange */</span></span><br><span class="line">        Carbon::setTestNow(Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>));</span><br><span class="line"></span><br><span class="line">        Order::create([</span><br><span class="line">            <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">17</span>),</span><br><span class="line">            <span class="string">'quantity'</span>   =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'price'</span>      =&gt; <span class="number">100</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        Order::create([</span><br><span class="line">            <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>),</span><br><span class="line">            <span class="string">'quantity'</span>   =&gt; <span class="number">2</span>,</span><br><span class="line">            <span class="string">'price'</span>      =&gt; <span class="number">200</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        Order::create([</span><br><span class="line">            <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>),</span><br><span class="line">            <span class="string">'quantity'</span>   =&gt; <span class="number">3</span>,</span><br><span class="line">            <span class="string">'price'</span>      =&gt; <span class="number">300</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">1300</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Act */</span></span><br><span class="line">        <span class="variable">$actual</span> = app(OrderService::class)-&gt;calculateTodayTotalAmount();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>16 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Carbon::setTestNow(Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>));</span><br></pre></td></tr></table></figure></p>
<p>由於需求是<code>今天全部訂單金額</code>，勢必使用 <code>Carbon::now()</code> 回傳今天日期，但 <code>Carbon::now()</code> 回傳的每天的真實日期，並不是個固定值，這將造成測試困難，因此 Carbon 提供了 <code>setTestNow()</code> 讓我們自行設定測試用的日期，讓  <code>Carbon::now()</code> 回傳我們預期的日期，這是寫單元測試常用的手法。</p>
<p>18 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Order::create([</span><br><span class="line">    <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">17</span>),</span><br><span class="line">    <span class="string">'quantity'</span>   =&gt; <span class="number">1</span>,</span><br><span class="line">    <span class="string">'price'</span>      =&gt; <span class="number">100</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">Order::create([</span><br><span class="line">    <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>),</span><br><span class="line">    <span class="string">'quantity'</span>   =&gt; <span class="number">2</span>,</span><br><span class="line">    <span class="string">'price'</span>      =&gt; <span class="number">200</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">Order::create([</span><br><span class="line">    <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>),</span><br><span class="line">    <span class="string">'quantity'</span>   =&gt; <span class="number">3</span>,</span><br><span class="line">    <span class="string">'price'</span>      =&gt; <span class="number">300</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>由於我們是使用 SQLite in Memory 做測試，每個測試案例執行完就會釋放記憶體，所以除了需要重新 migration 外，還要重新塞假資料進資料庫。</p>
<p>由於我們要測試的日期為 <code>2016, 6, 18</code>，除了塞兩筆 <code>2016, 6, 18</code> 資料外，還多塞了一筆 <code>2016, 6, 17</code>，目的要測試日期時間有沒有抓錯。</p>
<p>36 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$expected</span> = <span class="number">1300</span>;</span><br></pre></td></tr></table></figure></p>
<p>根據我們所塞的假資料，人工計算其期望值為 <code>1300</code>，將以此值與測試所得的實際值做 assertion。</p>
<p>38 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Act */</span></span><br><span class="line"><span class="variable">$actual</span> = app(OrderService::class)-&gt;calculateTodayTotalAmount();</span><br></pre></td></tr></table></figure></p>
<p>實際建立 <code>OrderService</code> 物件，並測試 <code>calculateTodayTotalAmount()</code>。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>此時 <code>OrderService</code> 與 <code>calculateTodayTotalAmount()</code> 都還沒建立，TDD 會等待測試亮 <span class="label label-danger">紅燈</span> 時，才去新增 <code>OrderService</code> 與 <code>calculateTodayTotalAmount()</code>。</span></span></span></p>
<p>除了使用 <code>app()</code> helper function 外，也可以使用 Facade 版本的 <code>App::make()</code>，但不建議使用 <code>new</code>，因為實務上待測物件可能會搭配依賴注入，若使用 <code>new</code> 必須自己在 constructor 輸入參數，非常麻煩，使用 <code>app()</code> 或 <code>App::make()</code> 後， Laravel 會自行依照 constructor 的 type hint 依賴注入，非常方便。</p>
<p>41 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Assert */</span></span><br><span class="line"><span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br></pre></td></tr></table></figure></p>
<p>最後使用 <code>assertEquals()</code> 判斷期望值與實際值是否相等。</p>
<h2 id="OrderService">OrderService</h2><hr>
<p>實際跑測試，會得到第 1 個 <span class="label label-danger">紅燈</span>，PHPUnit 抱怨 <code>OrderService</code> 與 <code>calculateTodayTotalAmount()</code> 尚未建立，須趕快補上。</p>
<p><strong>OrderService.php</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo/commit/e5112c689f60ceded162e52ac4dd91a783c42a6c" target="_blank" rel="external">建立 foreach 版本 OrderService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/OrderService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Order</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Order */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * OrderService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Order $order</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Order <span class="variable">$order</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算今天全部訂單金額</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$totalAmount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$orders</span> = <span class="variable">$this</span>-&gt;order-&gt;all();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$orders</span> <span class="keyword">as</span> <span class="variable">$order</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$order</span>-&gt;order_date == Carbon::now()) &#123;</span><br><span class="line">                <span class="variable">$totalAmount</span> = <span class="variable">$totalAmount</span> + <span class="variable">$order</span>-&gt;quantity * <span class="variable">$order</span>-&gt;price;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$totalAmount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第 8 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> Order */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * OrderService constructor.</span><br><span class="line"> * <span class="doctag">@param</span> Order $order</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Order <span class="variable">$order</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 constructor injection 注入 <code>Order</code> model。</p>
<p>20 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 計算今天全部訂單金額</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$totalAmount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$orders</span> = <span class="variable">$this</span>-&gt;order-&gt;all();</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$orders</span> <span class="keyword">as</span> <span class="variable">$order</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$order</span>-&gt;order_date == Carbon::now()) &#123;</span><br><span class="line">            <span class="variable">$totalAmount</span> = <span class="variable">$totalAmount</span> + <span class="variable">$order</span>-&gt;quantity * <span class="variable">$order</span>-&gt;price;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$totalAmount</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由於需求是<code>今天全部訂單金額</code>，我們先建立一個 <code>$totalAmout</code> 初始變數，再由 <code>$this-&gt;orders-&gt;all()</code> 傳回資料庫目前所有訂單。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>實務上不會直接使用 <code>$this-&gt;order-&gt;all()</code> 的方式回傳 <code>Order</code> model 的所有資料，這裡只是為了範例便宜行事，應該從 <code>OrderRepository</code> 傳回必要的資料即可，這樣才不會造成 MySQL 與 PHP 的負擔。</span></span></span></p>
<p>接著使用 <code>foreach</code> 對全部 <code>orders</code> 判斷，只有 <code>order_date</code> 為 <code>今天</code>，也就是等於 <code>Carbon::now()</code> 才加以計算。</p>
<p>訂單金額並沒有直接一個欄位，需要使用 <code>$order-&gt;quantity</code> * <code>$order-&gt;price</code> 加以計算，才能與 <code>$totalAmount</code> 相加。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug000.png" alt=""></p>
<p>得到第 1 個 <span class="label label-success">綠燈</span>，完成 <code>OrderService</code>。</p>
<h2 id="使用_Collection_重構">使用 Collection 重構</h2><hr>
<p>以上為典型的 <strong>Imperative Programming</strong> 寫法，透過暫存變數 <code>$totalAmount</code>，迴圈 <code>foreach()</code> 與判斷式 <code>if</code> 的方式寫程式，這也是過去我們習慣的 PHP 風格。</p>
<p>這種方式的缺點是程式可讀性較差，當你在 trace <code>calculateTodayTotalAmount()</code> 時，需馬上與一堆變數、迴圈與判斷式纏鬥，而不能一眼就看出程式所有表達的意思。</p>
<p><strong>OrderService.php</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo/commit/517181e2b84f0483bc0574dd796a3cac3ae44781" target="_blank" rel="external">建立 Collection 版本的 OrderService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/OrderService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Order</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Order */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * OrderService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Order $order</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Order <span class="variable">$order</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算今天全部訂單金額</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;order-&gt;all()</span><br><span class="line">            -&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$value</span>-&gt;order_date == Carbon::now();</span><br><span class="line">            &#125;)</span><br><span class="line">            -&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">            &#125;)</span><br><span class="line">            -&gt;reduce(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$carry</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$carry</span> + <span class="variable">$value</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>20 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 計算今天全部訂單金額</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;order-&gt;all()</span><br><span class="line">        -&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$value</span>-&gt;order_date == Carbon::now();</span><br><span class="line">        &#125;)</span><br><span class="line">        -&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">        &#125;)</span><br><span class="line">        -&gt;reduce(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$carry</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$carry</span> + <span class="variable">$value</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>需求為 <code>今天全部訂單金額</code>，因此有以下幾個重點 :</p>
<ul>
<li><strong>今天</strong> : 必須先過濾出<code>今天</code>的資料。</li>
<li><strong>金額</strong> : 必須先由 <code>$order-&gt;quantity</code> * <code>$order-&gt;price</code> 計算<code>金額</code>。</li>
<li><strong>全部訂單</strong> : 必須由 <code>$totalAmout</code> 計算<code>全部訂單</code>金額。</li>
</ul>
<p><code>$this-&gt;order-&gt;all()</code> 回傳的為 <code>Collection</code>，事實上 Laravel 的 <code>Collection</code> 內建非常多的 method，可直接使用。<span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>詳細請參考 Laravel 的官方文件 : <a href="https://laravel.com/docs/master/collections#available-methods" target="_blank" rel="external">Collections</a></span></span></span></p>
<p>若使用 <code>Collection</code> 的 method，可改寫成 :</p>
<ul>
<li><strong>filter()</strong> : 由 <code>filter()</code> 過濾出<code>今天</code>的資料。</li>
<li><strong>map()</strong> : 由 <code>map()</code> 計算出 <code>$order-&gt;quantity</code> * <code>$order-&gt;price</code>。</li>
<li><strong>reduce()</strong> : 由 <code>reduce()</code> 計算出 <code>$totalAmount</code>。</li>
</ul>
<p>27 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="variable">$value</span>-&gt;order_date == Carbon::now();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p><code>filter()</code> 要求傳入一個 closure，第 1 個參數為 <code>$value</code>，第 2 個參數為 <code>$key</code>，只要在 closure 內 return <code>filter()</code> 所需要的布林條件式即可。<span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>詳細請參考 Laravel 官方文件 : <a href="https://laravel.com/docs/master/collections#method-filter" target="_blank" rel="external">filter()</a></span></span></span></p>
<p>以本例來說，<code>$value</code> 就是 <code>foreach</code> 中 <code>$orders</code> 的 <code>$order</code>，所以其 <code>filter()</code> 條件為 <code>$value-&gt;order_date == Carbon::now()</code>。</p>
<p>30 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p><code>map()</code> 要求傳傳入一個 closure，第 1 個參數為 <code>$value</code>，第 2 個參數為 <code>$key</code>，只要在 closure 內 return <code>map()</code> 要成為的新值即可。<span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>詳細請參考 Laravel 官方文件 : <a href="https://laravel.com/docs/master/collections#method-map" target="_blank" rel="external">map()</a></span></span></span></p>
<p>以本例來說，<code>$value</code> 就是 <code>foreach</code> 中 <code>$orders</code> 的 <code>$order</code>，<code>map()</code> 之後的新值為 <code>$order-&gt;quantity</code> * <code>$order-&gt;price</code>。</p>
<p>33 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;reduce(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$carry</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$carry</span> + <span class="variable">$value</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><code>reduce()</code> 要求傳傳入一個 closure，第 1 個參數為 <code>$carry</code>，第 2 個參數為 <code>$value</code>，其中 <code>$carry</code> 為下一次執行 <code>reduce()</code> 時的累加值，只要在 closure 內 return 下一次執行 <code>reduce()</code> 時 <code>$carry</code> 的新值即可。<span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>詳細請參考 Laravel 官方文件 : <a href="https://laravel.com/docs/master/collections#method-reduce" target="_blank" rel="external">reduce()</a></span></span></span></p>
<p>以本例來說，<code>$value</code> 就是 <code>foreach</code> 中 <code>$orders</code> 的 <code>$order</code>，而 <code>$carry</code> 就是 <code>$totalAmount</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug001.png" alt=""></p>
<p>得到第 2 個 <span class="label label-success">綠燈</span>，使用 <code>Collection</code> 重構 <code>OrderService</code>。</p>
<h2 id="將_Closure_加以重構">將 Closure 加以重構</h2><hr>
<p>使用 <code>filter()</code>、<code>map()</code> 與 <code>reduce()</code> 搭配 closure 的寫法，已經比 Imperative Programming 寫法精簡，但 closure 部分可讀性還不是很高，需要進一步重構。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug002.png" alt=""></p>
<p>選擇 <code>filter()</code> 內部的 closure，按熱鍵 &#8963; + T，出現 <code>Refactor This</code> 選單，選擇 <code>7.Method</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug003.png" alt=""></p>
<p>Visibility 選擇 <code>Private</code>，在函式名稱輸入 <code>filterToToday</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug004.png" alt=""></p>
<p>PhpStorm 會替我們將 closure 重構出新的 <code>filterToToday()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug005.png" alt=""></p>
<p>重構後趕快跑單元測試，確認 PhpStorm 有沒有改壞。</p>
<p>將 <code>map()</code> 與 <code>reduce()</code> 的 closure 也依照以上方式加以重構成 private method。</p>
<p><strong>OrderService.php</strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo/commit/38bc52878707f137f5ce87a41ad9c3fd4b90057d" target="_blank" rel="external">將 Closure 加以重構</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/OrderService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Order</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Order */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * OrderService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Order $order</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Order <span class="variable">$order</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算今天全部訂單金額</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;order-&gt;all()</span><br><span class="line">            -&gt;filter(<span class="variable">$this</span>-&gt;filterToToday())</span><br><span class="line">            -&gt;map(<span class="variable">$this</span>-&gt;mapToAmount())</span><br><span class="line">            -&gt;reduce(<span class="variable">$this</span>-&gt;reduceToTotalAmount());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 只有今天的訂單</span><br><span class="line">     * <span class="doctag">@return</span> Closure</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterToToday</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$value</span>-&gt;order_date == Carbon::now();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 換算成金額</span><br><span class="line">     * <span class="doctag">@return</span> Closure</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">mapToAmount</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 換算成總金額</span><br><span class="line">     * <span class="doctag">@return</span> Closure</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">reduceToTotalAmount</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$carry</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$carry</span> + <span class="variable">$value</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>22 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 計算今天全部訂單金額</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;order-&gt;all()</span><br><span class="line">        -&gt;filter(<span class="variable">$this</span>-&gt;filterToToday())</span><br><span class="line">        -&gt;map(<span class="variable">$this</span>-&gt;mapToAmount())</span><br><span class="line">        -&gt;reduce(<span class="variable">$this</span>-&gt;reduceToTotalAmount());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最後程式碼會重構成這樣，可讀性很高，就跟口語敘述一樣直覺。</p>
<ol>
<li>先由 <code>Order</code> model 傳回所有資料。</li>
<li>再透過 <code>filter()</code> 過濾<code>今天</code>的資料。</li>
<li>再透過 <code>map()</code> 計算出<code>金額</code>。</li>
<li>最後由 <code>reduce()</code> 計算出<code>總金額</code>。</li>
</ol>
<p>至於怎麼<code>過濾</code>、<code>計算</code>，那是 closure 的事情，若有必要再繼續 trace 下去，不需一開始就面臨一堆變數、迴圈與判斷，這就是所謂的 Declarative Programming 只重視 <code>我們要做什麼，而不是要如何做</code>。</p>
<p>44 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 換算成金額</span><br><span class="line"> * <span class="doctag">@return</span> Closure</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">mapToAmount</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">   &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由 closure 所重構出來的 method，也都符合 SOLID 的單一職責原則，將來若有需要，可以再進一步的重構成 interface 與 trait。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug006.png" alt=""></p>
<p>重構後趕快跑單元測試，確認 PhpStorm 有沒有改壞。</p>
<h2 id="使用_Watches_除錯">使用 Watches 除錯</h2><hr>
<p>使用 Declarative Programming 方式，程式可讀性雖然高，但除錯則面臨很大的挑戰，由於其 fluent 風格，基本上程式只有一行，因此無從下中斷點觀察變數，只能在除錯時加上很多暫存變數觀察。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug007.png" alt=""></p>
<p>加了 <code>$aa</code>、<code>$bb</code> … <code>$dd</code> 等暫存變數，雖然可以在 Debug Window 的 Variables 加以觀察，但必須修改程式碼，雖然之後可以靠重構的 <code>Inline Variable</code> 加以還原，但還是很麻煩。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug008.png" alt=""></p>
<p>比較理想的方式是使用 Debug Windw 的 Watches，比如說我們只想除錯 <code>$this-&gt;order-&gt;all()</code>，用滑鼠選擇 <code>$this-&gt;order-&gt;all()</code>，按滑鼠右鍵選擇 <code>Add to Watches</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug009.png" alt=""></p>
<p><code>$this-&gt;order-&gt;all()</code> 將會新增到右側下方的 Watches，可直接展開觀察結果。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug010.png" alt=""></p>
<p>同理若要除錯 <code>$this-&gt;orders-&gt;all()-&gt;filter($this-&gt;filterToToday())</code>，可將 <code>$this-&gt;orders-&gt;all()-&gt;filter($this-&gt;filterToToday())</code> 選起來，按滑鼠右鍵選擇 <code>Add to Watches</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug012.png" alt=""></p>
<p><code>$this-&gt;orders-&gt;all()-&gt;filter($this-&gt;filterToToday())</code> 將會新增到右側下方的 Watches，可直接展開觀察結果。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug011.png" alt=""></p>
<p>你也可以將 <code>Collection</code> 的每個過程全部加到 Watches，且只要你不刪除，Watches 就永遠存在，將來除錯還可以繼續用，這樣就可以達到不用修改程式碼，又可以對 <code>Collection</code> 除錯的目的。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Declarative 比 Imperative 方式更精簡，程式可讀性更高，也更符合單一職責原則。</li>
<li>Laravel 的 <code>Collection</code> 非常好用，但除錯一直是大家的夢靨，透過 PhpStorm 的 Watches，不僅不用修改程式碼，也可以繼續使用中斷點的除錯方式。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<ul>
<li>Adam Watham, <a href="http://adamwathan.me/refactoring-to-collections/" target="_blank" rel="external">Refactoring to Collections</a></li>
<li>Freek Van der Herten, <a href="https://murze.be/2016/06/debugging-collections/" target="_blank" rel="external">Debugging collections</a></li>
<li>Taylor Otwell, <a href="https://laravel.com/docs/master/collections#available-methods" target="_blank" rel="external">Laravel Collections</a></li>
<li>PhpStorm 2016.1 Help, <a href="https://www.jetbrains.com/help/phpstorm/2016.1/debug-tool-window-watches.html" target="_blank" rel="external">Debug Tool Window.Watches</a></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[使用 Watches 替 Collection 除錯]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
      <category term="Refactoring" scheme="http://oomusou.io/tags/Refactoring/"/>
    
      <category term="TDD" scheme="http://oomusou.io/tags/TDD/"/>
    
      <category term="Xdebug" scheme="http://oomusou.io/tags/Xdebug/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何對 Collection 做 assertion?]]></title>
    <link href="http://oomusou.io/tdd/tdd-collection-assertion/"/>
    <id>http://oomusou.io/tdd/tdd-collection-assertion/</id>
    <published>2016-06-13T12:23:43.000Z</published>
    <updated>2016-06-19T07:07:34.000Z</updated>
    <content type="html"><![CDATA[<p><code>Collection</code> 並非 PHP 原生的型別，是 Laravel 所擴充，因此 PHPUnit 並無法直接對其做 assertion，必須先透過 <code>toArray()</code> 轉成陣列，再透過 PHPUnit 的 <code>assertArrayXXX()</code> 系列做 assertion。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>Laravel 5.2.37</p>
<h2 id="實際案例">實際案例</h2><hr>
<p>我們將以 <code>Post</code> model 為例，顯示<code>所有文章</code>，並寫單元測試判斷結果是否如預期。</p>
<h2 id="單元測試">單元測試</h2><hr>
<p>無論是對 repository 或 service 做單元測試，當其 field 或 method 回傳值為 <code>Collection</code>時，就必須面對如何 assertion 的問題。</p>
<p><strong>PostServiceTest.php</strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo/commit/9f422f2f9a376f0d9e3aea11ae3f7bbde6f3b741" target="_blank" rel="external">單元測試 : 建立 PostServiceTest.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/PostServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">PostService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 顯示所有文章<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$expected</span> = [</span><br><span class="line">            [<span class="string">'title'</span> =&gt; <span class="string">'title1'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc1'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>],</span><br><span class="line">            [<span class="string">'title'</span> =&gt; <span class="string">'title2'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc2'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>],</span><br><span class="line">            [<span class="string">'title'</span> =&gt; <span class="string">'title3'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc3'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content3'</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        collect(<span class="variable">$expected</span>)-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            Post::create(<span class="variable">$value</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = app(PostService::class)-&gt;displayAllPosts()-&gt;toArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertArraySubset(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>13 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** arrange */</span></span><br><span class="line"><span class="variable">$expected</span> = [</span><br><span class="line">   [<span class="string">'title'</span> =&gt; <span class="string">'title1'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc1'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>],</span><br><span class="line">   [<span class="string">'title'</span> =&gt; <span class="string">'title2'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc2'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>],</span><br><span class="line">   [<span class="string">'title'</span> =&gt; <span class="string">'title3'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc3'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content3'</span>],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">collect(<span class="variable">$expected</span>)-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    Post::create(<span class="variable">$value</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>由於單元測試是使用 SQLite in Memory 為資料庫，只要測試一結束，記憶體就會釋放，因此每次測試都要重新新增資料。</p>
<p>使用 <code>Collection-&gt;each()</code> 將 <code>$expected</code> 中的資料透過 <code>Post::create()</code> 新增。</p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="variable">$actual</span> = app(PostService::class)-&gt;displayAllPosts()-&gt;toArray();</span><br></pre></td></tr></table></figure></p>
<p>測試 <code>PostService-&gt;displayAllPosts()</code>。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>此時 <code>PostService</code> 與 <code>displayAllPost()</code> 都還沒建立，TDD 會等待測試亮 <span class="label label-danger">紅燈</span> 時，才去新增 <code>PostService</code> 與 <code>displayAllPost()</code>。</span></span></span></p>
<p><code>displayAllPosts()</code> 回傳的是 <code>Collection</code>，但 PHPUnit 無法對 <code>Collection</code> 做 assertion，必須先轉成 array。</p>
<p>26 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** assert */</span></span><br><span class="line"><span class="variable">$this</span>-&gt;assertArraySubset(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br></pre></td></tr></table></figure></p>
<p>這裡不能使用 <code>assertEquals()</code>，因為 <code>posts</code> table 還包含 <code>created_at</code> 與 <code>updated_at</code> 兩個欄位，若使用 <code>assertEquals()</code> 一定失敗，必須改用 <code>assertArraySubset()</code>。</p>
<p>也就是說，<code>$expected</code> 並不用包含 <code>Collection</code> 的所有欄位，只要包含你想測試的欄位即可。</p>
<p>剩下的 <code>PostService</code> 與 <code>PostRepository</code> 就以 TDD 的方式建立，在此不再贅述。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>若對剩下的步驟有興趣，詳細請參考 <a href="/phpstorm/phpstorm-refactor-namespace/">如何使用 PhpStorm 重構 Namespace?</a></span></span></span></p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>PHPUnit 無法直接對 <code>Collection</code> 做 assertion，需先使用 <code>toArray()</code> 轉成陣列。</li>
<li><code>Collection</code> 最典型的測試方式，就是在 <code>$expected</code> 準備好想測試的欄位與資料，最後使用 PHPUnit 的 <code>assertArraySubset()</code> 做 assertion。 </li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[使用 assertArrayXXX() 替 Collection 做 assertion]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="PHPUnit" scheme="http://oomusou.io/tags/PHPUnit/"/>
    
      <category term="TDD" scheme="http://oomusou.io/tags/TDD/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 PhpStorm 重構 Namespace?]]></title>
    <link href="http://oomusou.io/phpstorm/phpstorm-refactor-namespace/"/>
    <id>http://oomusou.io/phpstorm/phpstorm-refactor-namespace/</id>
    <published>2016-06-12T12:23:43.000Z</published>
    <updated>2016-06-19T02:28:44.000Z</updated>
    <content type="html"><![CDATA[<p>在 TDD 開發流程，為了第一個 <span class="label label-success">綠燈</span>，一開始可能在同一個 namespace 下只有一個 class，但隨著重構的進行，可能重構出更多的 class 與 interface，為了更加的<strong>高內聚，低耦合</strong>，我們可能會將更相關的 class 與 interface 重構到其他 namespace，導致相依的 class 也必須修改，在重構 namepsace 時，PhpStorm 可以幫我們將相依的 class 一併修改，非常方便。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>Laravel 5.2.37</p>
<h2 id="實際案例">實際案例</h2><hr>
<p>我們將以經典的 service + repository 模式為例，以 <code>PostService</code> 處理商業邏輯，以 <code>PostRepository</code> 處理資料庫邏輯，將全部 post 顯示在網頁上。</p>
<p>最後使用 PhpStorm 重構 <code>PostService</code> 與 <code>PostRepository</code>。</p>
<h2 id="單元測試">單元測試</h2><hr>
<p>以 TDD 方式開發，因此必須先寫單元測試。</p>
<p><strong>PostServiceTest.php</strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo/commit/9f422f2f9a376f0d9e3aea11ae3f7bbde6f3b741" target="_blank" rel="external">單元測試 : 建立 PostServiceTest.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/PostServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">PostService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 顯示所有文章<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$expected</span> = [</span><br><span class="line">            [<span class="string">'title'</span> =&gt; <span class="string">'title1'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc1'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>],</span><br><span class="line">            [<span class="string">'title'</span> =&gt; <span class="string">'title2'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc2'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>],</span><br><span class="line">            [<span class="string">'title'</span> =&gt; <span class="string">'title3'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc3'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content3'</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        collect(<span class="variable">$expected</span>)-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            Post::create(<span class="variable">$value</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = app(PostService::class)-&gt;displayAllPosts()-&gt;toArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertArraySubset(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>13 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** arrange */</span></span><br><span class="line"><span class="variable">$expected</span> = [</span><br><span class="line">   [<span class="string">'title'</span> =&gt; <span class="string">'title1'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc1'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>],</span><br><span class="line">   [<span class="string">'title'</span> =&gt; <span class="string">'title2'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc2'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>],</span><br><span class="line">   [<span class="string">'title'</span> =&gt; <span class="string">'title3'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc3'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content3'</span>],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">collect(<span class="variable">$expected</span>)-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    Post::create(<span class="variable">$value</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>由於單元測試是使用 SQLite in Memory 為資料庫，只要測試一結束，記憶體就會釋放，因此每次測試都要重新新增資料。</p>
<p>使用 <code>Collection-&gt;each()</code> 將 <code>$expected</code> 中的資料透過 <code>Post::create()</code> 新增。</p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="variable">$actual</span> = app(PostService::class)-&gt;displayAllPosts()-&gt;toArray();</span><br></pre></td></tr></table></figure></p>
<p>測試 <code>PostService-&gt;displayAllPosts()</code>。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>此時 <code>PostService</code> 與 <code>displayAllPost()</code> 都還沒建立，TDD 會等待測試亮 <span class="label label-danger">紅燈</span> 時，才去新增 <code>PostService</code> 與 <code>displayAllPost()</code>。</span></span></span></p>
<p><code>displayAllPosts()</code> 回傳的是 <code>Collection</code>，但 PHPUnit 無法對 <code>Collection</code> 做 assertion，必須先轉成 array。</p>
<p>26 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** assert */</span></span><br><span class="line"><span class="variable">$this</span>-&gt;assertArraySubset(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br></pre></td></tr></table></figure></p>
<p>這裡不能使用 <code>assertEquals()</code>，因為 <code>posts</code> table 還包含 <code>created_at</code> 與 <code>updated_at</code> 兩個欄位，若使用 <code>assertEquals()</code> 一定失敗，必須改用 <code>assertArraySubset()</code>。</p>
<h2 id="PostService">PostService</h2><hr>
<p>實際跑測試，會得到第 1 個 <span class="label label-danger">紅燈</span>，PHPUnit 抱怨 <code>PostService</code> 與 <code>displayAllPosts()</code> 尚未建立，須趕快補上。</p>
<p><strong>PostService.php</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo/commit/ee587bd2a6e0cad4c94c024f6cdfdcd3ab46eb26" target="_blank" rel="external">建立 PostService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPosts</span><span class="params">()</span> : <span class="title">Collection</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第 8 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@var</span> PostRepository</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * PostService constructor.</span><br><span class="line"> * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因為 <code>PostService</code> 須使用到 <code>PostRepository</code>，使用 constructor injection 注入 <code>PostRepository</code>。</p>
<p>22 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> Collection</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPosts</span><span class="params">()</span> : <span class="title">Collection</span></span><br><span class="line"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>呼叫 <code>PostRepository</code> 的 <code>getAllPosts()</code>, 回傳 <code>Collection</code>。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>此時 <code>PostRepository</code> 與 <code>getAllPosts()</code> 都還沒建立，TDD 會等待測試亮 <span class="label label-danger">紅燈</span> 時，才去新增 <code>PostRepository</code> 與 <code>getAllPosts()</code>。</span></span></span></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  為什麼 <strong>PostService</strong> 只有呼叫 <strong>PostRepository</strong> 而已?</div>
<p>實務上 <code>PostService</code> 除了呼叫 <code>PostRepository</code> 外，還會有自己的商業邏輯要寫，本文因為重點在   <strong>namespace 重構</strong>，所以簡化了 <code>PostService</code>，關於 Service 模式，詳細請參考<a href="/laravel/laravel-service/">如何使用 Service 模式?</a></p>
<h2 id="PostRepository">PostRepository</h2><hr>
<p>實際跑測試，會得到第 2 個 <span class="label label-danger">紅燈</span>，PHPUnit 抱怨 <code>PostRepository</code> 與 <code>getAllPosts()</code> 尚未建立，須趕快補上。</p>
<p><strong>PostRepository.php</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo/commit/175ca8490d72e5f8994833eceffe59b2bbda7fe6" target="_blank" rel="external">建立 PostRepository</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/PostRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllPosts</span><span class="params">()</span> : <span class="title">Collection</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Post::all();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>為簡化起見，回傳 <code>post</code> table 所有資料。</p>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace000.png" alt=""></p>
<p>得到第 1 個 <span class="label label-success">綠燈</span>，完成 <code>PostService</code> 與 <code>PostRepository</code>。</p>
<h2 id="整合測試">整合測試</h2><hr>
<p>單元測試目的是寫出 service 與 repository，我們要繼續寫整合測試，將 route、controller 與 view 補上。</p>
<p><strong>PostApplicationTest.php</strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo/commit/9be08ef0d8afea91e51057c59948d7f8abc39e88" target="_blank" rel="external">整合測試 : 建立 PostApplicationTest</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/PostServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostApplicationTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 顯示所有文章<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$expected</span> = [</span><br><span class="line">            [<span class="string">'title'</span> =&gt; <span class="string">'title1'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc1'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>],</span><br><span class="line">            [<span class="string">'title'</span> =&gt; <span class="string">'title2'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc2'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>],</span><br><span class="line">            [<span class="string">'title'</span> =&gt; <span class="string">'title3'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc3'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content3'</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        collect(<span class="variable">$expected</span>)-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            Post::create(<span class="variable">$value</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;visit(<span class="string">'/post'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        collect(<span class="variable">$expected</span>)-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;see(<span class="variable">$value</span>[<span class="string">'title'</span>]);</span><br><span class="line">            <span class="variable">$this</span>-&gt;see(<span class="variable">$value</span>[<span class="string">'description'</span>]);</span><br><span class="line">            <span class="variable">$this</span>-&gt;see(<span class="variable">$value</span>[<span class="string">'content'</span>]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第 9 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** arrange */</span></span><br><span class="line"><span class="variable">$expected</span> = [</span><br><span class="line">   [<span class="string">'title'</span> =&gt; <span class="string">'title1'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc1'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content1'</span>],</span><br><span class="line">   [<span class="string">'title'</span> =&gt; <span class="string">'title2'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc2'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content2'</span>],</span><br><span class="line">   [<span class="string">'title'</span> =&gt; <span class="string">'title3'</span>, <span class="string">'description'</span> =&gt; <span class="string">'desc3'</span>, <span class="string">'content'</span> =&gt; <span class="string">'content3'</span>],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">collect(<span class="variable">$expected</span>)-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    Post::create(<span class="variable">$value</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>由於單元測試是使用 SQLite in Memory 為資料庫，只要測試一結束，記憶體就會釋放，因此每次測試都要重新新增資料。</p>
<p>使用 <code>Collection-&gt;each()</code> 將 <code>$expected</code> 中的資料透過 <code>Post::create()</code> 新增。</p>
<p>22 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="variable">$this</span>-&gt;visit(<span class="string">'/post'</span>);</span><br></pre></td></tr></table></figure></p>
<p>實際測試 <code>/post</code> URI。<span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>此時 route 都還沒建立，TDD 會等待測試亮 <span class="label label-danger">紅燈</span> 時，才去新增 route。</span></span></span></p>
<p>27 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** assert */</span></span><br><span class="line">collect(<span class="variable">$expected</span>)-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;see(<span class="variable">$value</span>[<span class="string">'title'</span>]);</span><br><span class="line">    <span class="variable">$this</span>-&gt;see(<span class="variable">$value</span>[<span class="string">'description'</span>]);</span><br><span class="line">    <span class="variable">$this</span>-&gt;see(<span class="variable">$value</span>[<span class="string">'content'</span>]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>期望在網頁上看到 <code>title</code>、<code>description</code> 與 <code>content</code> 等資料。 </p>
<p>使用 <code>Collection-&gt;each()</code> 將 <code>$expected</code> 中的資料透過 <code>$this-&gt;see()</code> 做 assertion。<span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>此時 view 都還沒建立，TDD 會等待測試亮 <span class="label label-danger">紅燈</span> 時，才去新增 view。</span></span></span>    </p>
<h2 id="Routes">Routes</h2><hr>
<p>實際跑測試，會得到第 1 個 <span class="label label-danger">紅燈</span>，PHPUnit 抱怨找不到 <code>http://localhost/post</code>，因為 route 尚未建立，須趕快補上。</p>
<p><strong>routes.php</strong><span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo/commit/3d1077e9750cba89d6117b94779634c07e167293" target="_blank" rel="external">建立 routes</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Http/routes.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">'welcome'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">'/post'</span>, [</span><br><span class="line">    <span class="string">'as'</span>   =&gt; <span class="string">'post'</span>,</span><br><span class="line">    <span class="string">'uses'</span> =&gt; <span class="string">'PostController@index'</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>新增 route <code>/post</code>，並指定其 controller 為 <code>PostController@index</code>。<span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>此時 <code>PostController</code> 都還沒建立，TDD 會等待測試亮 <span class="label label-danger">紅燈</span> 時，才去新增 <code>PostController</code>。</span></span></span>    </p>
<h2 id="PostController">PostController</h2><hr>
<p>實際跑測試，會得到第 2 個 <span class="label label-danger">紅燈</span>，PHPUnit 抱怨 <code>PostController</code> 尚未建立，須趕快補上。</p>
<p><strong>PostController.php</strong><span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo/commit/af0121d61484ba6980a51ba6ee954071eb3bc85b" target="_blank" rel="external">建立 PostController</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Http/Controllers/PostController.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">PostService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Display a listing of the resource.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> \Illuminate\Http\Response</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">'posts'</span>] = app(PostService::class)-&gt;displayAllPosts();</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'post.index'</span>, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>app()</code> 建立 <code>PostService</code>，並呼叫其 <code>displayAllPosts()</code>。</p>
<p>回傳 <code>post.index</code> view。<span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>此時 <code>post.index</code> view 都還沒建立，TDD 會等待測試亮 <span class="label label-danger">紅燈</span> 時，才去新增 <code>post.index</code> view。</span></span></span>    </p>
<h2 id="Post-Index_Blade">Post.Index Blade</h2><hr>
<p>實際跑測試，會得到第 3 個 <span class="label label-danger">紅燈</span>，PHPUnit 抱怨 <code>post.index</code> view 尚未建立，須趕快補上。</p>
<p><strong>index.blade.php</strong><span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo/commit/d8ad575a285dcc0895a28e343ab38a30eb75e709" target="_blank" rel="external">建立 post.index view</a></span></span></span><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">title</span>&gt;</span>Posts<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">@foreach($posts as $post)</span><br><span class="line">    <span class="tag">&lt;<span class="title">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">h2</span>&gt;</span>&#123;&#123; $post-&gt;title &#125;&#125;<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">h2</span>&gt;</span>&#123;&#123; $post-&gt;description &#125;&#125;<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">h2</span>&gt;</span>&#123;&#123; $post-&gt;content &#125;&#125;<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">hr</span>&gt;</span></span><br><span class="line">@endforeach</span><br><span class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>簡單使用 <code>@foreach</code> 與 binding 將資料顯示。</p>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace001.png" alt=""></p>
<p>得到第 1 個 <span class="label label-success">綠燈</span>，完成 <code>routes</code> 與 <code>PostController</code> 與 <code>post.index</code> view。</p>
<h2 id="重構_PostService">重構 PostService</h2><hr>
<p>到目前為止，已經 <span class="label label-success">綠燈</span> 達成需求，但發現將 <code>PostService</code> 放在 <code>app/Services</code> 下似乎不妥，想將 <code>PostServie</code> 重構放在 <code>app/Services/Post</code> 目錄下。</p>
<p>根據 <code>PSR-4</code>，PHP 的 namespace 必須與目錄相同，也就是說除了將 <code>PostService</code> 放到 <code>app/Services/Post</code> 目錄下外，以下程式碼必須修改 :</p>
<ul>
<li><code>PostService</code> 的 namespace 必須修改。</li>
<li>單元測試的 <code>PostServiceTest</code> 的 <code>use</code> 必須修改。</li>
<li>Controller 的 <code>PostController</code> 的 <code>use</code> 必須修改。</li>
</ul>
<p>本文只是很簡單的範例，已經要改 3 個地方，實務上會更複雜，要改的地方會更多，還可能沒改到或改錯。</p>
<p>這時候就要使用 PhpStorm 的重構了。</p>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace002.png" alt=""></p>
<p>將滑鼠游標放在要重構的 <code>PostService</code> 的 class 名稱上，按熱鍵 &#8963; + T，選擇 <code>Move</code>。</p>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace003.png" alt=""></p>
<p>顯示 <code>Move Class</code> 對話框。</p>
<ul>
<li>在 <code>Move Class PostService to namespace</code> 填入新的 namespace : <code>App\Services\Post</code>，PhpStorm 會自動在 <code>Target destination directory</code> 加上 <code>Post</code>目錄。</li>
<li>將 <code>Search in comments and strings</code> 與  <code>Search for text occurrences</code> 都打勾。</li>
<li>按下 <code>Preview</code> 可以先看一下 PhpStorm 將做哪些重構，按 <code>Refactor</code> 則直接重構。</li>
</ul>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace004.png" alt=""></p>
<p>PhpStorm 預告將對 <code>PostController</code>、<code>PostServiceTest</code> 與 <code>PostService</code> 做重構，與我們的預期相同。</p>
<p>若發現 PhpStorm 失去水準判斷錯誤，可以將其選擇按右鍵將其 <code>Excluded</code> 或 <code>Remove</code> 掉。</p>
<p>最後按 <code>Do Refactor</code> 開始重構。</p>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace005.png" alt=""></p>
<p>重構完趕快跑單元測試與整合測試，確認 PhpStorm 沒有改壞。</p>
<h2 id="重構_PostRepository">重構 PostRepository</h2><hr>
<p>前一個例子，是將 <code>PostService</code> 單一 class 重構其 namespace，實務上還有另外一種應用，是將一個目錄下所有 class 重構成另外一個 namespace。</p>
<p>目前想將 <code>app/Repositories</code> 下所有的 class 重構到 <code>app/Repositories/Post</code> 目錄下。</p>
<p>根據 <code>PSR-4</code>，PHP 的 namespace 必須與目錄相同，也就是說除了將 <code>PostRepository</code> 放到 <code>app/Repositories/Post</code> 目錄下外，以下程式碼必須修改 :</p>
<ul>
<li><code>PostRepository</code> 的 namespace 必須修改。</li>
<li>Service 的 <code>PostService</code> 的 <code>use</code> 必須修改。</li>
</ul>
<p>若目錄下有很多 class，要改的地方會更多，還可能沒改到或改錯。</p>
<p>這時候就要使用 PhpStorm 的重構了。</p>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace006.png" alt=""></p>
<p>選擇要重構目錄下的其中一個檔案開啟，本例 <code>app/Repositories</code> 目錄下只有 <code>PostRepository</code>。</p>
<p>將滑鼠游標放在要重構的 <code>PostRepository</code> 的 namespace 名稱上，按熱鍵 &#8963; + T，選擇 <code>Move</code>。</p>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace007.png" alt=""></p>
<p>顯示 <code>Move Namespace</code> 對話框。</p>
<ul>
<li>在 <code>New Namespace name</code> 填入新的 namespace : <code>App\Repositories\Post</code>，PhpStorm 會自動在 <code>Target destination directory</code> 加上 <code>Post</code>目錄。</li>
<li>將 <code>Search in comments and strings</code> 與  <code>Search for text occurrences</code> 都打勾。</li>
<li>按下 <code>Preview</code> 可以先看一下 PhpStorm 將做哪些重構，按 <code>Refactor</code> 則直接重構。</li>
</ul>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace008.png" alt=""></p>
<p>PhpStorm 預告將對 <code>PostRepository</code> 與 <code>PostService</code> 做重構，與我們的預期相同。</p>
<p>若發現 PhpStorm 失去水準判斷錯誤，可以將其選擇按右鍵將其 <code>Excluded</code> 或 <code>Remove</code> 掉。</p>
<p>最後按 <code>Do Refactor</code> 開始重構。</p>
<p><img src="/images/phpstorm/phpstorm-refactor-namespace/namespace009.png" alt=""></p>
<p>重構完趕快跑單元測試與整合測試，確認 PhpStorm 沒有改壞。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>重構單一 class，是將游標放在 class 名稱上。</li>
<li>重構一目錄下所有 class，是將游標放在 namespace 名稱上。</li>
<li>Laravel 5 大量使用 namespace 後，只要改 namespace 就是大家永遠的痛，透過 PhpStorm 的重構，與自己寫的單元測試與整合測試保護後，再也不用害怕改 namespace 了。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52RefactorNamespace_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[使用 PhpStorm 自動幫我們重構 Namespace]]>
    
    </summary>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
      <category term="Refactoring" scheme="http://oomusou.io/tags/Refactoring/"/>
    
      <category term="TDD" scheme="http://oomusou.io/tags/TDD/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 PhpStorm 對 Laravel 除錯?]]></title>
    <link href="http://oomusou.io/phpstorm/phpstorm-xdebug/"/>
    <id>http://oomusou.io/phpstorm/phpstorm-xdebug/</id>
    <published>2016-06-11T12:23:43.000Z</published>
    <updated>2016-06-12T02:45:15.000Z</updated>
    <content type="html"><![CDATA[<p>傳統 PHP 大都使用 <code>echo()</code>、<code>var_dump()</code> 或 <code>dd()</code> 除錯，此種方式必須破壞原本程式碼，而且所能觀察的變數有限，也無法明確得知程式執行的流程。PhpStorm 支援 Xdebug，允許我們設定中斷點，程式將停在中斷點設定之處，讓我們透過 Step Into、Step Over、Step Out 的方式除錯，非常方便。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>Laravel 5.2.37<br>MAMP PRO 3.5<br>PhpStorm 2016.1.2</p>
<h2 id="設定_Xdebug">設定 Xdebug</h2><hr>
<p>MAMP PRO 預設已經有安裝 Xdebug，只是在 <code>php.ini</code> 並沒有啟動，必須手動啟動後，再加上一些設定。</p>
<figure class="highlight php"><figcaption><span>/Applications/MAMP/bin/php/php7.0.0/conf/php.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[xdebug]</span><br><span class="line">zend_extension=<span class="string">"/Applications/MAMP/bin/php/php7.0.0/lib/php/extensions/no-debug-non-zts-20151012/xdebug.so"</span></span><br><span class="line">xdebug.remote_enable=<span class="number">1</span></span><br><span class="line">xdebug.remote_port=<span class="number">9000</span></span><br><span class="line">xdebug.profiler_enable=<span class="number">1</span></span><br><span class="line">xdebug.profiler_output_dir=<span class="string">"/Applications/MAMP/tmp"</span></span><br></pre></td></tr></table></figure>
<p>MAMP PRO 預設將 PHP 安裝在<code>/Applications/MAMP/bin/php/phpX.X.XX/conf/php.ini</code>，選擇版本加以修改<code>php.ini</code>。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>若不知道該改哪一個<code>php.ini</code>，可下<code>php --ini</code>指令，看看目前系統正在使用哪一個<code>php.ini</code>。</span></span></span></p>
<p>其中 <code>[xdebug]</code> 位於 <code>php.ini</code> 的最後一行，預設使用 <code>;</code> 註解，將 <code>;</code> 拿掉，並加上以上的 Xdebug 設定。</p>
<p>存檔後須重新啟動MAMP。</p>
<h2 id="設定_Hosts">設定 Hosts</h2><hr>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug007.png" alt=""></p>
<p>在 MAMP PRO 設定新 host。</p>
<ul>
<li><strong>PHP version</strong> : 7.0.0。</li>
<li><strong>Document root</strong> : <code>/Users/oomusou/Code/Demo/Laravel52Xdebug_demo/public</code>。</li>
</ul>
<p>存檔後須重新啟動MAMP。</p>
<h2 id="啟動_PHP_外掛">啟動 PHP 外掛</h2><hr>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug000.png" alt=""></p>
<p><strong><em>PhpStorm -&gt; Preferences -&gt; Plugins</em></strong></p>
<ul>
<li>PhpStorm 預設已經安裝並啟動 PHP 外掛，確認此外掛已經啟動。</li>
</ul>
<h2 id="設定_Interpreter">設定 Interpreter</h2><hr>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug001.png" alt=""></p>
<p><strong><em>PhpStorm -&gt; Preferences -&gt; Language &amp; Frameworks -&gt; PHP</em></strong></p>
<ul>
<li><strong>PHP language level</strong> : <code>7</code>。</li>
<li><strong>Interpreter</strong> : 按 <code>...</code> 設定PHP interpreter。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>PHP Interpreter 每個專案都要重新設定一遍。</span></span></span></li>
</ul>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug002.png" alt=""></p>
<p>選擇 <code>PHP 7.0.0</code> 的路徑 : <code>/Applications/MAMP/bin/php/php7.0.0/bin/php</code>。</p>
<p>若路徑正確，PhpStorm 會抓到 PHP 與 Xdebug 的版本。</p>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug003.png" alt=""></p>
<p>從原本的 <code>&lt;no interpreter&gt;</code> 變成明確的 <code>PHP7 (7.0.0)</code>。</p>
<h2 id="產生_Bookmarklets">產生 Bookmarklets</h2><hr>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug004.png" alt=""></p>
<p><strong><em>PhpStorm -&gt; Preferences -&gt; Language &amp; Frameworks -&gt; PHP -&gt; Debug</em></strong></p>
<ul>
<li>按下 <code>Use debugger bookmarklets to initiate debugging form your favorite browser</code>，將會使用你預設的瀏覽器開啟 <code>https://www.jetbrains.com/phpstorm/marklets/</code>。</li>
</ul>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug005.png" alt=""></p>
<p>在左側的 Xdebug 部分，按下 <code>Generate</code>。</p>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug006.png" alt=""></p>
<p>將產生 <code>Start debugger</code>，<code>Stop Debugger</code> 與 <code>Debug this page</code>。</p>
<p>將這 3 個連結拖拉到上方的 Bookmarks Bar。</p>
<ul>
<li><strong>Start debugger</strong> : 啟動 Xdebug 除錯。</li>
<li><strong>Stop debugger</strong> : 停止 Xdebug 除錯。</li>
<li><strong>Debug this page</strong> : 啟動 Xdebug，並重新載入目前網頁。</li>
</ul>
<h2 id="設定中斷點">設定中斷點</h2><hr>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug008.png" alt=""></p>
<p>在 <code>app/Http/routes.php</code> 的 14 行的最左側點一下，設定中斷點。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>實務上你可以在任何你想要除錯的 PHP 程式碼中設定中斷點，本範例是以 Laravel 預設專案的 <code>routes.php</code> 為例。</span></span></span></p>
<h2 id="傾聽_Xdebug">傾聽 Xdebug</h2><hr>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug009.png" alt=""></p>
<p>按下上方的 <code>電話筒</code> 圖示，綠色表示開始傾聽 Xdebug，可在所設定的中斷點停止。</p>
<h2 id="啟動_Xdebug">啟動 Xdebug</h2><hr>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug010.png" alt=""></p>
<p>開啟瀏覽器，按下 <code>Start debugger</code>，在網址列輸入 <code>http://laravel52xdebug:8888</code>。</p>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug011.png" alt=""></p>
<p>PhpStorm 會跳出 <code>Incoming Connection From Xdebug</code> 視窗，按 <code>Accept</code> 繼續。</p>
<p><img src="/images/phpstorm/phpstorm-xdebug/xdebug012.png" alt=""></p>
<p>程式執行將停在剛剛設定的中斷點。</p>
<p>下方會出現 Debugger 視窗，提供除錯的詳細資訊。</p>
<ul>
<li>左側綠色三角形為 <code>Resume Program</code>，表示將繼續執行，直到下一個中斷點停止。</li>
<li>左側紅色方形為 <code>Stop</code>，表示停止目前程式執行。</li>
<li>上方第一個圖示為 <code>Step Over</code>，表示將跳過目前函式。</li>
<li>上方第二個圖示為 <code>Step Into</code>，表示將執行目前函式內部的程式碼。</li>
<li>上方第三個圖示為 <code>Force Step Into</code>，表示將強制執行目前函式內部的程式碼。</li>
<li>上方第四個圖示為 <code>Step Out</code>，表示將跳出目前函式內部的程式碼。</li>
<li>上方第五個圖示為 <code>Run to Cursor</code>，表示將快速執行到目前游標處停止。</li>
<li><code>Variables</code> 為目前 scope 所有的變數值。</li>
<li><code>Watches</code> 可自行新增想觀察的變數。</li>
</ul>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>使用這種方式之後，我再也沒用過 <code>echo()</code>、<code>var_dump()</code> 或 <code>dd()</code> 來除錯，只要在認為有問題的程式碼之處，設定中斷點，就可以觀察當時所有變數的值，並且觀察程式實際執行的流程。</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[以中斷點方式替 Laravel 除錯]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="MAMP" scheme="http://oomusou.io/tags/MAMP/"/>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
      <category term="Xdebug" scheme="http://oomusou.io/tags/Xdebug/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何設定 PhpStorm 的 Directories?]]></title>
    <link href="http://oomusou.io/phpstorm/phpstorm-directories/"/>
    <id>http://oomusou.io/phpstorm/phpstorm-directories/</id>
    <published>2016-06-10T12:23:43.000Z</published>
    <updated>2016-06-17T07:30:40.000Z</updated>
    <content type="html"><![CDATA[<p>PhpStorm 最強的三個功能為 : Refactoring、Debugging、與 Inspection，但由於 PHP 生態是眾多 framework，而每個 framework 的目錄架構也不太一樣，因此必須先在 PhpStorm 設定 directories，才能發揮 PhpStorm 的強悍功能，而不只是文字編輯器而已。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Laravel 5.2.36</p>
<h2 id="提示設定_Directories">提示設定 Directories</h2><hr>
<p><img src="/images/phpstorm/phpstorm-directories/dir000.png" alt=""></p>
<p>當使用 PhpStorm 開啟 Laravel 專案時，一開始會對專案做 indexing，之後就會出現 <code>Detect PSR-0 namespace roots</code> 的提示，要求你設定 Directories。</p>
<p>很多初學者因為不知道設定 Directories 的重要性，就直接將對話框關閉，這是非常可惜的，這將喪失很多 PhpStorm 重要的功能。</p>
<h2 id="手動設定_Directories">手動設定 Directories</h2><hr>
<p><img src="/images/phpstorm/phpstorm-directories/dir001.png" alt=""></p>
<p>按 <code>Settings | Directories</code> 手動設定 <code>Directories</code>。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  不建議使用 <strong>automatically</strong> 由 PhpStorm 自動設定 directories，這將導致 <strong>vendor</strong> 目錄被設定在 <strong>Excluded</strong> 下，導致 Laravel 與其他 package 的語法提示不正常。</div>
<p><img src="/images/phpstorm/phpstorm-directories/dir002.png" alt=""></p>
<p>進入設定 Directories 視窗，若第一次沒由 <code>Detect PSR-0 namespaces roots</code> 設定也沒關係，日後只要在此設定即可。</p>
<p><strong><em> PhpStorm -&gt; Preferences -&gt; Directories </em></strong></p>
<p>接下來要設定 <code>Tests</code>、<code>Sources</code>、<code>Excluded</code> 與 <code>Resource Root</code> 4 個目錄。</p>
<h2 id="Sources">Sources</h2><hr>
<p>設定 <code>PSR-0 namespace roots</code> 的主目錄，也就是 Laravel 的 <code>app</code> 目錄。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir003.png" alt=""></p>
<p>選擇 <code>app</code> 目錄，按上方的 <code>Sources</code>，會在右側出現 <code>Source Folders app</code>。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir004.png" alt=""></p>
<p>按 <code>P</code> 設定該目錄的 property。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir005.png" alt=""></p>
<p>在 <code>Package prefix</code> 輸入 <code>App</code>，因為 <code>app</code> 目錄對應的正是 Laravel 的 namespace <code>App</code>。</p>
<p>這是所有 directories 設定中最重要的一個，在 Laravel 5 之後，全面使用 namespace，管理 namespace 成為很多人的惡夢，但只要設定了 <code>Sources</code> 之後，將來 PhpStorm 會幫我們管理 namespace。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir006.png" alt=""></p>
<p>設定了 <code>Sources</code> 之後，在 project windows 的 <code>app</code> 會顯示藍色。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir007.png" alt=""></p>
<p>假如我們想在自己建立的 <code>Services</code> 目錄下，建立其他 class 寫商業邏輯。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>關於 Service 模式，詳細請參考<a href="/laravel/laravel-service/">如何使用 Service 模式?</a></span></span></span></p>
<p>選擇 <code>Services</code> 目錄，按熱鍵 &#8984; + N，顯示 <code>New</code> 視窗，選擇 <code>PHP Class</code>。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir008.png" alt=""></p>
<p>自行輸入 class 名稱，值得注意的是，PhpStorm 已經自動幫我們準備好 namespace，不必我們操心。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir009.png" alt=""></p>
<p>程式碼也幫我們管理好 namespace 了。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52Directories_demo/commit/81257eedf3819dd685911dd90f04ce7207b3ea34" target="_blank" rel="external">建立 OrderService</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-directories/dir010.png" alt=""></p>
<p>若想要注入其他物件，可在 constructor 的參數以 type hint 方式注入。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>關於依賴注入，詳細請參考<a href="/tdd/tdd-di/">深入探討依賴注入</a></span></span></span></p>
<p>如我們想注入 <code>User</code>，但 PhpStorm 已經反白警告找不到 <code>User</code> class。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir011.png" alt=""></p>
<p>選擇反白的 <code>User</code>，按熱鍵 &#8997; + &#8617;，選擇 <code>Import class</code>。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir012.png" alt=""></p>
<p>若整個專案只有一個同名的 class，PhpStorm 會自動 import，否則會出現視窗讓你決定要 import 哪一個 class。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir013.png" alt=""></p>
<p>PhpStorm 自動幫我們 use 了 <code>App\User</code>。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52Directories_demo/commit/8a4d3267723e5b9d3be63767503d1f399a85c6a9" target="_blank" rel="external">注入 User</a></span></span></span></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  無論是建立 namespace，或者引用 namespace，完全由 PhpStorm 自動幫我們處理，不用擔心 namespace 大小寫寫錯，也不用擔心 namespace 的完整路徑為何。</div>
<h2 id="Tests">Tests</h2><hr>
<p>設定測試程式的主目錄，也就是 Laravel 的 <code>tests</code> 目錄。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir014.png" alt=""></p>
<p>選擇 <code>tests</code> 目錄，按上方的 <code>Tests</code>，會在右側出現 <code>Test Source Folders tests</code>。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir015.png" alt=""></p>
<p>設定了 <code>Tests</code> 之後，在 project windows 的 <code>tests</code> 會顯示綠色。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir016.png" alt=""></p>
<p>可在 project windows 選擇 <code>Tests</code>。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir017.png" alt=""></p>
<p>將只顯示所有測試程式，方便測試時使用。</p>
<h2 id="Resource_Root">Resource Root</h2><hr>
<p>設定前端資源的主目錄，也就是 Laravel 的 <code>public</code> 目錄。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir018.png" alt=""></p>
<p>選擇 <code>public</code> 目錄，按上方的 <code>Resource Root</code>，會在右側出現 <code>Resource roots public</code>。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir019.png" alt=""></p>
<p>設定了 <code>Resource roots</code> 之後，在 project windows 的 <code>public</code> 會顯示紫色。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir020.png" alt=""></p>
<p>在 <code>resources/views/welcome.blade.php</code> 加上 Vue.js 後，在 <code>js/app.js</code> 出現反白。<span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52Directories_demo/commit/b5e0b68d2677e96e77117eb1d9f17ea316af7d1f" target="_blank" rel="external">修改 welcome.blade.php</a></span></span></span></p>
<p>PhpStorm 抱怨找不到 <code>js/app.js</code>，的確我們在 <code>public</code> 目錄下還沒有建立 <code>js/app.js</code>。</p>
<p><img src="/images/phpstorm/phpstorm-directories/dir021.png" alt=""></p>
<p>在 <code>public</code> 目錄下新增 <code>js/app.js</code> 之後，PhpStorm 就不在警告了。<span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52Directories_demo/commit/4418c29aa7d0913388911dee8ad5411414adbb25" target="_blank" rel="external">新增 js/app.js</a></span></span></span></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  <strong>Resource roots</strong> 不是設定在 Laravel 的 <strong>resources</strong> 目錄，而是設定在 <strong>public</strong> 目錄。藉由此設定，PhpStorm 可以幫你檢查 Blade 或 HTML 的 JavaScript 與 CSS 路徑是否合法。</div>
<h2 id="Excluded">Excluded</h2><hr>
<p>不由 PhpStorm 管理，或不想由 PhpStorm 建立 index 的目錄。</p>
<p>實務上若你在專案目錄下，會自己建立一個目錄放 Spec 或相關文件，如 pdf, docx, xlsx 格式，這個目錄交給 PhpStorm 管理並沒有任何意義，只會增加建立 index 時間而已，就可以將該目錄設定為 <code>Excluded</code>。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>這些都是很重要的設定，可惜 PhpStorm 文件並沒有仔細介紹，以上都是實際使用 PhpStorm 一段時間之後摸索出來的心得，將這些目錄設定之後，才能發揮 PhpStorm 強悍功能。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52Directories_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[正確設定 Directories 才能發揮 PhpStorm 的威力]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 PhpStorm 打造 Vue.js 開發環境?]]></title>
    <link href="http://oomusou.io/vuejs/vuejs-on-phpstorm/"/>
    <id>http://oomusou.io/vuejs/vuejs-on-phpstorm/</id>
    <published>2016-06-08T15:33:02.000Z</published>
    <updated>2016-06-12T10:58:09.000Z</updated>
    <content type="html"><![CDATA[<p>我是一個很依賴語法提示才能寫程式的人，一來我記憶力很差，我記不了很多API，二來我很容易 typo，所以只能依賴語法提示用選的，所以寫 Vue.js 的第一件事情，就是在 PhpStorm 先把開發環境弄好。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Vue.js 1.0.24<br>PhpStorm 2016.1.2<br>Plugin : vue-for-idea 1.0.6<br>Plugin : Vue.js 1.1.0</p>
<h2 id="Vue-js_on_PhpStorm">Vue.js on PhpStorm</h2><hr>
<p>PhpStorm 要支援 Vue.js，主要有 3 個重點 :</p>
<ol>
<li><strong>Directive</strong> : 支援由 <code>v-</code> 開頭的 directive，如 <code>v-model</code>，以及其 shorthand，如 <code>@click</code>，<code>:href</code>。</li>
<li><strong>API</strong> : 支援 Vue.js 的 API，如 <code>Vue.component()</code>。</li>
<li><strong>vue 元件</strong> : 支援 Vue.js 自創的 component 格式，在 PhpStorm 正常顯示，沒有警告。</li>
</ol>
<h2 id="安裝_Vue-js_外掛">安裝 Vue.js 外掛</h2><hr>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps000.png" alt=""></p>
<p><strong><em> PhpStorm -&gt; Preferences -&gt; Plugin </em></strong></p>
<ul>
<li>輸入 <code>vue</code>，按 <code>Search in repositories</code>。</li>
</ul>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps001.png" alt=""></p>
<p>會搜尋到 2 個 Vue.js 外掛 : <code>vue-for-idea</code> 與 <code>Vue.js</code>。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>這兩個外掛並非 JetBrains 官方所出，而是由 open source 社群所維護，目前這兩個外掛仍在開發中，各自實現了一些功能，如 <code>Vue.js</code> 外掛支援 directive，卻不支援 shorthand，而 <code>vue-for-idea</code> 外掛支援 shorthand，卻不支援 directive，所以必須兩個外掛都裝，功能才會比較齊全。</span></span></span></p>
<p>將這兩個外掛全部安裝。  </p>
<p>先安裝 <code>vue-for-idea</code> 外掛。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps002.png" alt=""></p>
<p>安裝完 <code>vue-for-idea</code> 外掛之後，需重新啟動 PhpStorm。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps003.png" alt=""></p>
<p>安裝 <code>Vue.js</code> 外掛。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps004.png" alt=""></p>
<p>安裝完 <code>Vue.js</code> 外掛之後，需重新啟動 PhpStorm。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps005.png" alt=""></p>
<p><strong><em> PhpStorm -&gt; Preferences -&gt; Plugin </em></strong></p>
<ul>
<li>重新啟動後，確認 <code>vue-for-idea</code> 與 <code>Vue.js</code> 兩個外掛都已經安裝成功。</li>
</ul>
<h2 id="第一次執行_Vue-js">第一次執行 Vue.js</h2><hr>
<p>Vue.js 提供很多方式安裝</p>
<ol>
<li>直接下載</li>
<li>CDN</li>
<li>NPM</li>
<li>Vue-CLI</li>
</ol>
<p>本文先以最簡單的 CDN 方式安裝 Vue.js。</p>
<p><strong>welcome.blade.php</strong><span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52Vue10_demo/commit/888b8d71bd9792e2447a7c750e1c1ce89b7b99f3" target="_blank" rel="external">在 blade 載入 Vue.js</a></span></span></span><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">title</span>&gt;</span>Laravel<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">link</span> <span class="attribute">href</span>=<span class="value">"https://fonts.googleapis.com/css?family=Lato:100"</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">type</span>=<span class="value">"text/css"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">style</span>&gt;</span><span class="css"></span><br><span class="line">            <span class="tag">html</span>, <span class="tag">body</span> <span class="rules">&#123;</span><br><span class="line">                <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">100%</span></span></span>;</span><br><span class="line">            &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">body</span> <span class="rules">&#123;</span><br><span class="line">                <span class="rule"><span class="attribute">margin</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">                <span class="rule"><span class="attribute">padding</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">                <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">100%</span></span></span>;</span><br><span class="line">                <span class="rule"><span class="attribute">display</span>:<span class="value"> table</span></span>;</span><br><span class="line">                <span class="rule"><span class="attribute">font-weight</span>:<span class="value"> <span class="number">100</span></span></span>;</span><br><span class="line">                <span class="rule"><span class="attribute">font-family</span>:<span class="value"> <span class="string">'Lato'</span></span></span>;</span><br><span class="line">            &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="class">.container</span> <span class="rules">&#123;</span><br><span class="line">                <span class="rule"><span class="attribute">text-align</span>:<span class="value"> center</span></span>;</span><br><span class="line">                <span class="rule"><span class="attribute">display</span>:<span class="value"> table-cell</span></span>;</span><br><span class="line">                <span class="rule"><span class="attribute">vertical-align</span>:<span class="value"> middle</span></span>;</span><br><span class="line">            &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="class">.content</span> <span class="rules">&#123;</span><br><span class="line">                <span class="rule"><span class="attribute">text-align</span>:<span class="value"> center</span></span>;</span><br><span class="line">                <span class="rule"><span class="attribute">display</span>:<span class="value"> inline-block</span></span>;</span><br><span class="line">            &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="class">.title</span> <span class="rules">&#123;</span><br><span class="line">                <span class="rule"><span class="attribute">font-size</span>:<span class="value"> <span class="number">96px</span></span></span>;</span><br><span class="line">            &#125;</span></span><br><span class="line">        </span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"app"</span> <span class="attribute">class</span>=<span class="value">"container"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"content"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"title"</span>&gt;</span>Laravel 5<span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">div</span>&gt;</span>@&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.24/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"js/app.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>45 行<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.24/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>直接以 CDN 載入 Vue.js。</p>
<p>46 行<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"js/app.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>將 Vue.js 的程式碼寫在 <code>js/app.js</code>。</p>
<p>42 行<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span>&gt;</span>@&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>使用 Vue.js 顯示 <code>message</code> 變數。</p>
<p>加上 <code>@</code> 是為了告訴 Laravel 的 Blade 不要處理，交給 Vue.js 處理。</p>
<p><strong>app.js</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52Vue10_demo/commit/62fd031bf31125e1b7c9570c57017ab861b3c0fb" target="_blank" rel="external">新增 app.js</a></span></span></span><br><figure class="highlight javascript"><figcaption><span>public/js/app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vue = &#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        message: <span class="string">'Vue.js 1'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(vue);</span><br></pre></td></tr></table></figure></p>
<p>建立 <code>Vue</code> 物件，<code>vue</code> 為其 constructor，設定了 <code>el</code> 與 <code>data</code> 屬性。</p>
<p>要將變數 <code>message</code> 為 <code>Vue.js 1</code> 的值，透過 data binding 顯示在 <code>welcome.blade.php</code>。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps010.png" alt=""></p>
<p>若能看到 <code>Vue.js 1</code>，表示 Vue.js 已經正常啟動。</p>
<h2 id="安裝_Vue-js_Library">安裝 Vue.js Library</h2><hr>
<p>目前為止雖然可以正常執行 Vue.js，不過那僅代表瀏覽器執行正常，並不代表 PhpStorm 認識 Vue.js，PhpStorm 目前也還無法對 Vue.js 做語法提示。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps006.png" alt=""></p>
<p>對於 Vue.js 的 CDN，PhpStorm 提出了警告，表示沒有本機版本，因此無法提供語法提示。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps007.png" alt=""></p>
<p>將滑鼠放在反白的 CDN 上，按熱鍵 &#8997; + &#8617;，選擇 <code>Download library</code>。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps008.png" alt=""></p>
<p>下載成功後，CDN 上的反白警告會消失。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps009.png" alt=""></p>
<p><strong><em>PhpStorm -&gt; Preferences -&gt; Languages &amp; Frameworks -&gt; JavaScript -&gt; Libraries</em></strong></p>
<ul>
<li>會出現 <code>vue</code>，表示 Vue.js 的 external library 已經安裝成功，從此 PhpStorm 可以為 Vue.js 的 API 做語法提示。</li>
</ul>
<h2 id="Directive">Directive</h2><hr>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps011.png" alt=""></p>
<p>只要輸入 <code>v</code>，就會顯示 Vue.js 專屬的 directive 了。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps015.png" alt=""></p>
<p>也支援 <code>@</code> 開頭的 shorthand。</p>
<h2 id="API">API</h2><hr>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps012.png" alt=""></p>
<p>PhpStorm 的語法提示可以自動顯示 Vue.js 的 API 了。</p>
<p>若為 Vue.js 的 API，會加上 <code>(vue)</code>。</p>
<h2 id="Vue_元件">Vue 元件</h2><hr>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps013.png" alt=""></p>
<p>按熱鍵 &#8963; + N 時，會出現 <code>Vue File</code>，可以讓我們直接新增 Vue 元件。</p>
<p><img src="/images/vuejs/vuejs-on-phpstorm/vueps014.png" alt=""></p>
<p>自動產生預設的 Vue 元件框架。</p>
<p>PhpStorm 可以認出 Vue 元件，且程式碼也不再出現任何錯誤警告。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>PhpStorm 包含 WebStorm，所以也可以拿來開發 JavaScript，並對 JavaScript 加以測試、重構與偵錯，在 PhpStorm 打造好 Vue.js 的開發環境後，就可以開心的學習 Vue.js 了。</li>
<li>目前 <code>vue-for-idea</code> 與 <code>Vue.js</code> 這兩個外掛仍在持續開發中，功能還不夠完整，希望 JetBrains 能趕快針對 Vue.js 開發出專屬套件，讓 PhpStorm 開發 Vue.js 更有效率。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52Vue10_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[在 PhpStorm 對 Vue.js 語法提示與語法變色]]>
    
    </summary>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
      <category term="Vue.js" scheme="http://oomusou.io/tags/Vue-js/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用變數讀取 property?]]></title>
    <link href="http://oomusou.io/javascript/javascript-variable-property/"/>
    <id>http://oomusou.io/javascript/javascript-variable-property/</id>
    <published>2016-06-07T12:23:43.000Z</published>
    <updated>2016-06-07T03:27:04.000Z</updated>
    <content type="html"><![CDATA[<p>傳統我們會使用 <code>if else</code> 判斷，讀取不同的 property，但由於 JavaScript 與 PHP 動態語言的特性，我們可以將要讀取的 property 名稱以<strong>變數</strong>表示，直接以該變數讀取 property。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>ECMAScript 5<br>PHP 7.0</p>
<h2 id="JavaScript">JavaScript</h2><hr>
<h3 id="if_else">if else</h3><p>傳統若要根據不同的條件，讀取不同 property，我們會使用 <code>if else</code>方式 :<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/VariableProperty/commit/b84e31b15722571402a379bd040090bfaf7c41f1" target="_blank" rel="external">JavaScript : 傳統使用 if else 切換讀取 property</a></span></span></span></p>
<figure class="highlight javascript"><figcaption><span>JavaScript</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">User</span>(<span class="params">firstName, lastName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">    <span class="keyword">this</span>.lastName = lastName;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> type = <span class="string">'first'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> User(<span class="string">'Sam'</span>, <span class="string">'Xiao'</span>);</span><br><span class="line"><span class="keyword">if</span> (type === <span class="string">'first'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(user.firstName);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(user.lastName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 9 行<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (type === <span class="string">'first'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(user.firstName);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(user.lastName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>if else</code> 去判斷變數值，讀取不同 property。</p>
<h3 id="Variable">Variable</h3><p>若將 property 名稱使用變數表示，則不需使用 <code>if else</code> 判斷 :<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/VariableProperty/commit/9e4288fc847a12f9aeef2d1af9240f0dee01a098" target="_blank" rel="external">JavaScript : 動態使用變數切換讀取 property</a></span></span></span></p>
<figure class="highlight javascript"><figcaption><span>JavaScript</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">User</span>(<span class="params">firstName, lastName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">    <span class="keyword">this</span>.lastName = lastName;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> type = <span class="string">'first'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> User(<span class="string">'Sam'</span>, <span class="string">'Xiao'</span>);</span><br><span class="line">propName = (type === <span class="string">'first'</span>) ? <span class="string">'firstName'</span> : <span class="string">'lastName'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(user[propName]);</span><br></pre></td></tr></table></figure>
<p>第 9 行<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">propName = (type === <span class="string">'first'</span>) ? <span class="string">'firstName'</span> : <span class="string">'lastName'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(user[propName]);</span><br></pre></td></tr></table></figure></p>
<p>判斷 <code>type</code>，並將要讀取的 property 名稱存入 <code>propName</code> 變數。</p>
<p>在 JavaScript，若要執行物件的 method，有以下3種方式 :</p>
<ol>
<li>object.property </li>
<li>object[‘property’] : 其中 ‘property’ 是<strong>字串</strong>。</li>
<li>object[property] : 其中 property 是<strong>變數</strong>。</li>
</ol>
<p>因為第 3 種方式，我們可以將 property 名稱以變數方式傳入 <code>[]</code>。</p>
<h2 id="PHP">PHP</h2><hr>
<p>PHP 也可以達到類似 JavaScript 的功能。</p>
<h3 id="if_else-1">if else</h3><p>傳統若要根據不同的條件，讀取不同 property，我們會使用 <code>if else</code>方式 :<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/VariableProperty/commit/df7bb5fd3c633902f0fe2b86a53700ab7e5e5f2d" target="_blank" rel="external">PHP : 傳統使用 if else 切換讀取 property</a></span></span></span></p>
<figure class="highlight php"><figcaption><span>PHP</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$firstName</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lastName</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * User constructor.</span><br><span class="line">     * <span class="doctag">@param</span> string $firstName</span><br><span class="line">     * <span class="doctag">@param</span> string $lastName</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string <span class="variable">$firstName</span>, string <span class="variable">$lastName</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;firstName = <span class="variable">$firstName</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;lastName = <span class="variable">$lastName</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$type</span> = <span class="string">'first'</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> User(<span class="string">'Sam'</span>, <span class="string">'Xiao'</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$type</span> === <span class="string">'first'</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$user</span>-&gt;firstName);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$user</span>-&gt;lastName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$type</span> === <span class="string">'first'</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$user</span>-&gt;firstName);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$user</span>-&gt;lastName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>if else</code> 去判斷變數值，讀取不同 property。</p>
<h3 id="Variable-1">Variable</h3><p>若將 property 名稱使用變數表示，則不需使用 <code>if else</code>判斷 :<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/VariableProperty/commit/4d69a38b81ce41e654b3041c66c9005bddea3492" target="_blank" rel="external">PHP : 動態使用變數切換讀取 property</a></span></span></span></p>
<figure class="highlight php"><figcaption><span>PHP</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$firstName</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lastName</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * User constructor.</span><br><span class="line">     * <span class="doctag">@param</span> string $firstName</span><br><span class="line">     * <span class="doctag">@param</span> string $lastName</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string <span class="variable">$firstName</span>, string <span class="variable">$lastName</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;firstName = <span class="variable">$firstName</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;lastName = <span class="variable">$lastName</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$type</span> = <span class="string">'first'</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> User(<span class="string">'Sam'</span>, <span class="string">'Xiao'</span>);</span><br><span class="line"><span class="variable">$propName</span> = (<span class="variable">$type</span> === <span class="string">'first'</span>) ? <span class="string">'firstName'</span> : <span class="string">'lastName'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$user</span>-&gt;<span class="variable">$propName</span>);</span><br></pre></td></tr></table></figure>
<p>第 23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$propName</span> = (<span class="variable">$type</span> === <span class="string">'first'</span>) ? <span class="string">'firstName'</span> : <span class="string">'lastName'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$user</span>-&gt;<span class="variable">$propName</span>);</span><br></pre></td></tr></table></figure></p>
<p>判斷 <code>$type</code>，並將要讀取的 property 名稱存入 <code>$propName</code> 變數。</p>
<p>在 PHP，允許我們在 <code>-&gt;</code> 之後直接加上<strong>變數</strong>，代表要執行的 property。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>JavaScript 與 PHP 都允許我們將欲讀取的 propety 名稱以變數表示。</li>
<li>因為 property 名稱是<strong>字串</strong>，所以我們可以將 property 名稱存在<strong>設定檔</strong>內，如 <code>config/app.php</code>，將來若因為需求改變，須改變讀取的 property 時，只需修改設定檔即可，並透過 <code>config::get()</code> 讀取 property 名稱，原來程式碼完全不用修改，達到<strong>開放封閉原則</strong>的要求。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/VariableProperty" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[使用變數讀取 property 取代 if else]]>
    
    </summary>
    
      <category term="JavaScript" scheme="http://oomusou.io/tags/JavaScript/"/>
    
      <category term="PHP" scheme="http://oomusou.io/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 Repository 模式處理一對多資料庫?]]></title>
    <link href="http://oomusou.io/laravel/laravel-repository-fk/"/>
    <id>http://oomusou.io/laravel/laravel-repository-fk/</id>
    <published>2016-05-28T12:23:43.000Z</published>
    <updated>2016-06-06T05:06:39.000Z</updated>
    <content type="html"><![CDATA[<p>Repository 模式對於處理中大型專案非常有效，可避免 model 與 controller 過於肥大而難以維護，且讓我們可以單獨對 repository 做單元測試，而不必對 Eloquent 做複雜的 mock。但在一對多的資料庫中，由於存在 foreign key，使得新增資料存檔時，因為 foreign key 還沒出現，而面臨了巨大的挑戰。</p>
<p>本文提出簡單方法，讓 Repository 也能處理一對多資料庫。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Laravel 5.2.32</p>
<h2 id="面臨的挑戰">面臨的挑戰</h2><hr>
<p>為了讓 controller 與 model 徹底解耦合，我們會使用 repository 模式，將資料庫邏輯封裝在 repository 內。為了方便，我們會將最常用的 CRUD 寫在 <code>AbstractRepository</code> 內。</p>
<p><strong>AbstractRepository.php</strong><br><figure class="highlight php"><figcaption><span>app/Repositories/AbstractRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** 注入的model */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 根據pk找資料</span><br><span class="line">     * <span class="doctag">@param</span> $id</span><br><span class="line">     * <span class="doctag">@param</span> array $columns</span><br><span class="line">     * <span class="doctag">@return</span> mixed</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">(<span class="variable">$id</span>, <span class="variable">$columns</span> = [<span class="string">'*'</span>])</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;find(<span class="variable">$id</span>, <span class="variable">$columns</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 根據一般欄位找資料</span><br><span class="line">     * <span class="doctag">@param</span> $attribute</span><br><span class="line">     * <span class="doctag">@param</span> $value</span><br><span class="line">     * <span class="doctag">@param</span> array $columns</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findBy</span><span class="params">(<span class="variable">$attribute</span>, <span class="variable">$value</span>, <span class="variable">$columns</span> = [<span class="string">'*'</span>])</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model</span><br><span class="line">            -&gt;where(<span class="variable">$attribute</span>, <span class="string">'='</span>, <span class="variable">$value</span>)</span><br><span class="line">            -&gt;first(<span class="variable">$columns</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳全部資料</span><br><span class="line">     * <span class="doctag">@param</span> array $columns</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">all</span><span class="params">(<span class="variable">$columns</span> = [<span class="string">'*'</span>])</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;all(<span class="variable">$columns</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳分頁資料</span><br><span class="line">     * <span class="doctag">@param</span> int $perPage</span><br><span class="line">     * <span class="doctag">@param</span> array $columns</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">paginate</span><span class="params">(<span class="variable">$perPage</span> = <span class="number">15</span>, <span class="variable">$columns</span> = [<span class="string">'*'</span>])</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;paginate(<span class="variable">$perPage</span>, <span class="variable">$columns</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 新增資料，回傳 model，直接存檔</span><br><span class="line">     * <span class="doctag">@param</span> array $data</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(array <span class="variable">$data</span>)</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;create(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 修改資料，回傳 model，直接存檔</span><br><span class="line">     * <span class="doctag">@param</span> array $data</span><br><span class="line">     * <span class="doctag">@param</span> $id</span><br><span class="line">     * <span class="doctag">@param</span> string $attribute</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(array <span class="variable">$data</span>, <span class="variable">$id</span>, <span class="variable">$attribute</span> = <span class="string">"id"</span>)</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model</span><br><span class="line">            -&gt;where(<span class="variable">$attribute</span>, <span class="string">'='</span>, <span class="variable">$id</span>)</span><br><span class="line">            -&gt;update(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除資料，回傳 model，直接刪除</span><br><span class="line">     * <span class="doctag">@param</span> $id</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">(<span class="variable">$id</span>)</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;destroy(<span class="variable">$id</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>這樣對於單一 table 來說，新的 repository 只要繼承 <code>AbstractRepository</code>，基本的 CRUD 都有了。</p>
<p>但若是一對多 table，因為存在 FK，因此無法在 <code>create()</code> 時同時處理 FK。</p>
<h2 id="支援一對多存檔">支援一對多存檔</h2><hr>
<p>對 <code>AbstractRepository</code> 稍加擴充，讓 repository 可以利用 Eloquent 的 relation 處理 FK。</p>
<p><strong>AbstractRepository.php</strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/04e7bb23e55352de275cfcba417c5ca2fb91d3d8" target="_blank" rel="external">新增 AbstractRepository</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/AbstractRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** 注入的model */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string $modelName model名稱 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$modelName</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AbstractRepository constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;modelName = get_class(<span class="variable">$this</span>-&gt;model);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 若存在則傳回 model，若不存在則新增</span><br><span class="line">     * <span class="doctag">@param</span> array $data</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">firstOrCreate</span><span class="params">(array <span class="variable">$data</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;firstOrCreate(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 新增資料，傳回 model，不存檔</span><br><span class="line">     * <span class="doctag">@param</span> array $data</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span><span class="params">(array <span class="variable">$data</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$this</span>-&gt;modelName(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>22 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 新增資料，傳回 model，不存檔</span><br><span class="line"> * <span class="doctag">@param</span> array $data</span><br><span class="line"> * <span class="doctag">@return</span> Model</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span><span class="params">(array <span class="variable">$data</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$this</span>-&gt;modelName(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新增資料除了原有的 <code>create()</code>外，還多了 <code>new()</code>，專門負責處理一對多的新增，此時並不像 <code>create()</code> 將資料直接存進資料庫，而是傳回 model 物件。</p>
<p><code>modelName</code> 為 field，主要儲存目前 repository 的 model 的 class 名稱，為一字串，主要提供 <code>new</code> 所需要的變數。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>這裡用到了一個 PHP 技巧，<code>new</code> 了一個變數成物件，詳細請參考<a href="/php/php-variable-object/">如何使用變數建立物件?</a></span></span></span></p>
<p>14  行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * AbstractRepository constructor.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;modelName = get_class(<span class="variable">$this</span>-&gt;model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>modelName</code> 在 constructor 內，由 PHP 原生的 <code>get_class()</code> 從 model 物件獲得該物件的 class 名稱。</p>
<p>47 行<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 若存在則傳回 model，若不存在則新增</span><br><span class="line"> * @param <span class="keyword">array</span> <span class="variable">$data</span></span><br><span class="line"> * @<span class="keyword">return</span> Model</span><br><span class="line"> */</span><br><span class="line">public <span class="keyword">function</span> firstOrCreate(<span class="keyword">array</span> <span class="variable">$data</span>)</span><br><span class="line">&#123;</span><br><span class="line">    return <span class="variable">$this-</span>&gt;model-&gt;firstOrCreate(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>這也是新增的 method，主要用在一對多存檔時，如典型的 1 篇 post 對多篇 comment。</p>
<p>新增 comment 時，post 可能存在，也可能不存在，只要將 post 資料傳給 <code>firstOrCreate()</code> 即可，若 post 存在則傳回 <code>Post</code> model，若不存在則新增 post 並傳回 <code>Post</code> model，也就是無論如何都會傳回 <code>model</code>，讓 <code>Post</code> 可以透過 relation 來處理 <code>comment</code> 的 FK。</p>
<h2 id="實際_Repository">實際 Repository</h2><hr>
<p>將以典型的 1 篇 post 對多篇 comment 的一對多架構，實際使用 repository 模式來處理 comment 的 FK。</p>
<p><strong>PostRepository.php</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/d0b2ec387637a0f858d765b8457102881a7e585d" target="_blank" rel="external">新增 PostRepository</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/PostRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepository</span> <span class="keyword">extends</span> <span class="title">AbstractRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Post $model Model物件 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostRepository constructor.</span><br><span class="line">     * <span class="doctag">@param</span> $model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Post <span class="variable">$model</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;model = <span class="variable">$model</span>;</span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>PostRepository</code> 直接繼承 <code>AbstractRepository</code>，在 constructor 將 <code>Post</code> model 注入，並執行 <code>parent::__construct()</code>，也就是 <code>AbstractRepository</code> 的 constructor。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  一般我們習慣將 <b>parent::__construct()</b> 寫在 constructor 的第一行，不過在此我們必須很技巧的將 <b>parent::__construct()</b> 寫在 constructor 的最後一行，因為在 AbstractRepository 的 constructor 中，$modelName 是由 $model 透過 <b>get_class()</b> 而來，所以 $model 必須先準備好才能 <b>get_class()</b>，因此 <b>parent::__construct()</b> 必須寫在最後一行。</div>
<p><strong>CommentRepository.php</strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/82cd347c7c5f33a1573556c96471293f6d504c2a" target="_blank" rel="external">新增 CommentRepository</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/CommentRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Comment</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentRepository</span> <span class="keyword">extends</span> <span class="title">AbstractRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Comment $model Model物件  */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostRepository constructor.</span><br><span class="line">     * <span class="doctag">@param</span> $model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Comment <span class="variable">$model</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;model = <span class="variable">$model</span>;</span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同理，<code>CommentRepository</code> 也只需繼承 <code>AbstractRepository</code> 即可，其餘與 <code>PostRepository</code> 相同。</p>
<h2 id="單元測試">單元測試</h2><hr>
<h3 id="先新增_Post，再新增一筆_Comment">先新增 Post，再新增一筆 Comment</h3><p>最簡單的應用，就是先新增一筆 post，再新增一筆 comment。</p>
<p><strong>PostRepositoryTest.php</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/82b2f934b96717b43e68d6a934c0f2a882a8d044" target="_blank" rel="external">單元測試 : 先新增 Post 再新增一筆 Comment</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/Repositories/PostRepositoryTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">CommentRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepositoryTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 先新增<span class="title">Post</span>再新增一筆<span class="title">Comment</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="comment">//&lt;editor-fold desc="Expected"&gt;</span></span><br><span class="line">        <span class="variable">$expectedPost</span> = [</span><br><span class="line">            <span class="string">'title'</span>       =&gt; <span class="string">'Post1 title'</span>,</span><br><span class="line">            <span class="string">'description'</span> =&gt; <span class="string">'Post1 description'</span>,</span><br><span class="line">            <span class="string">'content'</span>     =&gt; <span class="string">'Post1 content'</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedComment</span> = [</span><br><span class="line">            <span class="string">'name'</span>    =&gt; <span class="string">'Sam'</span>,</span><br><span class="line">            <span class="string">'email'</span>   =&gt; <span class="string">'oomusou@gmail.com'</span>,</span><br><span class="line">            <span class="string">'comment'</span> =&gt; <span class="string">"Sam's comment"</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">//&lt;/editor-fold&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$target</span> = app(PostRepository::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$target</span>-&gt;create(<span class="variable">$expectedPost</span>)</span><br><span class="line">            -&gt;comments()</span><br><span class="line">            -&gt;create(<span class="variable">$expectedComment</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'posts'</span>, <span class="variable">$expectedPost</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>29 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="variable">$target</span>-&gt;create(<span class="variable">$expectedPost</span>)</span><br><span class="line">    -&gt;comments()</span><br><span class="line">    -&gt;create(<span class="variable">$expectedComment</span>);</span><br></pre></td></tr></table></figure></p>
<p><code>$target</code> 即為 <code>PostRepository</code>。</p>
<p>post 資料由 <code>create()</code> 傳入，新增後回傳 <code>Post</code> model，繼續由 <code>comments()</code> relation 去新增 comment。</p>
<p>由於 comment 資料是由 <code>PostRepository</code> 負責，而非 <code>CommentRepository</code> 負責，因此 comment 的 FK 會由 <code>PostRepository</code> 處理。</p>
<p>這種方式與直接使用 Eloquent 處理一對多類似，也符合 ActiveRecord 習慣，因此非常直覺。</p>
<h3 id="先新增_Post，再新增多筆_Comment">先新增 Post，再新增多筆 Comment</h3><p>此外，先新增一筆 post，再新增多筆 comment，也是常見的應用。</p>
<p><strong>PostRepositoryTest.php</strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/6e0f9604413f8fa152fab40069c83c794de74f9d" target="_blank" rel="external">單元測試 : 先新增 Post 再新增多筆 Comment</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/Repositories/PostRepositoryTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">CommentRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepositoryTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 先新增<span class="title">Post</span>再新增多筆<span class="title">Comment</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="comment">//&lt;editor-fold desc="Expected"&gt;</span></span><br><span class="line">        <span class="variable">$expectedPost</span> = [</span><br><span class="line">            <span class="string">'title'</span>       =&gt; <span class="string">'Post1 title'</span>,</span><br><span class="line">            <span class="string">'description'</span> =&gt; <span class="string">'Post1 description'</span>,</span><br><span class="line">            <span class="string">'content'</span>     =&gt; <span class="string">'Post1 content'</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedComment</span> = [</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Sam'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'oomusou@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Sam's comment"</span></span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Sunny'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'sunny@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Sunny's comment"</span></span><br><span class="line">            ],</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">//&lt;/editor-fold&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$target</span> = app(PostRepository::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$post</span> = <span class="variable">$target</span>-&gt;create(<span class="variable">$expectedPost</span>);</span><br><span class="line"></span><br><span class="line">        collect(<span class="variable">$expectedComment</span>)</span><br><span class="line">            -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> <span class="title">use</span> <span class="params">(<span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">                <span class="variable">$post</span>-&gt;comments()-&gt;create(<span class="variable">$value</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'posts'</span>, <span class="variable">$expectedPost</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>37 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post</span> = <span class="variable">$target</span>-&gt;create(<span class="variable">$expectedPost</span>);</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>PostRepository</code> 先新增一筆 post。</p>
<p>39 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">collect(<span class="variable">$expectedComment</span>)</span><br><span class="line">    -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> <span class="title">use</span> <span class="params">(<span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">        <span class="variable">$post</span>-&gt;comments()-&gt;create(<span class="variable">$value</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<p>因為有多筆 comments 要新增，所以動用了 <code>collection-&gt;each()</code>。</p>
<p>使用 <code>Post</code> model 的 <code>comments()</code> relation 來新增每個 <code>comment</code>。</p>
<h3 id="先新增_Comment，再新增_Post">先新增 Comment，再新增 Post</h3><p>前面兩個範例，都是先新增 post，再新增 comment，但實務上可能遇到 comment 先新增，然後才新增 post，此時就會遇到 comment 新增，但 FK 還沒出現的問題。</p>
<p><strong>PostRepositoryTest.php</strong><span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/153444d6e312eefd43350612c779912c1aaa1225" target="_blank" rel="external">單元測試 : 先新增Comment再新增Post</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/Repositories/PostRepositoryTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">CommentRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepositoryTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 先新增<span class="title">Comment</span>再新增<span class="title">Post</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="comment">//&lt;editor-fold desc="Expected"&gt;</span></span><br><span class="line">        <span class="variable">$expectedPost</span> = [</span><br><span class="line">            <span class="string">'title'</span>       =&gt; <span class="string">'Post1 title'</span>,</span><br><span class="line">            <span class="string">'description'</span> =&gt; <span class="string">'Post1 description'</span>,</span><br><span class="line">            <span class="string">'content'</span>     =&gt; <span class="string">'Post1 content'</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedComment</span> = [</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Sam'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'oomusou@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Sam's comment"</span>,</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Sunny'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'sunny@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Sunny's comment"</span>,</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Jack'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'jack@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Jack's comment"</span>,</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">//&lt;/editor-fold&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$postRepository</span> = app(PostRepository::class);</span><br><span class="line">        <span class="variable">$commentRepository</span> = app(CommentRepository::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$comment</span> = <span class="variable">$commentRepository</span>-&gt;new(<span class="variable">$expectedComment</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="variable">$post</span> = <span class="variable">$postRepository</span>-&gt;firstOrCreate(<span class="variable">$expectedPost</span>);</span><br><span class="line">        <span class="variable">$post</span>-&gt;comments()-&gt;save(<span class="variable">$comment</span>);</span><br><span class="line"></span><br><span class="line">        collect(<span class="variable">$expectedComment</span>)</span><br><span class="line">            -&gt;forget(<span class="number">0</span>)</span><br><span class="line">            -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> <span class="title">use</span> <span class="params">(<span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">                <span class="variable">$post</span>-&gt;comments()-&gt;create(<span class="variable">$value</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'posts'</span>, <span class="variable">$expectedPost</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>43 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$comment</span> = <span class="variable">$commentRepository</span>-&gt;new(<span class="variable">$expectedComment</span>[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure></p>
<p>根據需求，comment 必須先新增，此時因為 comment 的 FK 還不知道，因此不能使用 <code>create()</code>，只能使用 <code>new()</code> 先將 comment 資料存進 <code>Comment</code> model 並回傳。</p>
<p>44 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post</span> = <span class="variable">$postRepository</span>-&gt;firstOrCreate(<span class="variable">$expectedPost</span>);</span><br></pre></td></tr></table></figure></p>
<p>將 post 資料由 <code>firstOrCreate()</code> 傳入，無論 post 資料是否存在，最後都會傳回 <code>Post</code> model。</p>
<p>45 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post</span>-&gt;comments()-&gt;save(<span class="variable">$comment</span>);</span><br></pre></td></tr></table></figure></p>
<p>最後由 <code>Post</code> model 的 <code>comments()</code> relation 負責儲存 <code>Comment</code> model，其 FK 也會由 <code>PostRepository</code> 來儲存。</p>
<p>47 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">collect(<span class="variable">$expectedComment</span>)</span><br><span class="line">    -&gt;forget(<span class="number">0</span>)</span><br><span class="line">    -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> <span class="title">use</span> <span class="params">(<span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">        <span class="variable">$post</span>-&gt;comments()-&gt;create(<span class="variable">$value</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<p>最後由 <code>collection-&gt;each()</code> 來儲存剩下的 comments 資料。</p>
<p>唯一較特殊的是 : 因為第一筆 comment 已經儲存過，所以必須先使用 <code>forget(0)</code> 加以踢除，避免重複存檔。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Eloquent 因為使用 ActiveRecord 模式，本身就有點 repository 味道，因此很多人在使用 repository + Eloquent，會覺得有點格格不入的感覺，尤其在處理一對多存檔時，因為 FK 的問題而傷透腦筋。本文在不改變 Eloquent 習慣的前提下，多了一個 <code>new()</code> 與 <code>firstOrCreate()</code>，讓 repository 也能順利處理一對多存檔。</li>
<li>Repository 模式並沒有要取代 Eloquent，事實上 Eloquent 非常的好用，只是在大型專案下，若大量將資料庫邏輯寫在 model，會造成 model 肥大而難以維護，若透過 repository 模式，若單一 repository 過於肥大，甚至可以單一 model 配合多個 repository，讓 repository 更加的<strong>高內聚</strong>，也讓 controller 與 model 更加的<strong>低耦合</strong>，如此將更好維護，repository 也更容易測試。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[讓 controller 與 model 徹底解耦合]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何對工廠模式開放封閉?]]></title>
    <link href="http://oomusou.io/tdd/tdd-factory-ocp/"/>
    <id>http://oomusou.io/tdd/tdd-factory-ocp/</id>
    <published>2016-05-08T12:23:43.000Z</published>
    <updated>2016-06-15T01:15:46.000Z</updated>
    <content type="html"><![CDATA[<p>將建構物件的邏輯封裝在工廠模式，已經達到 90% 的開放封閉，最少其他 class 都已經開放封閉，將來所有的邏輯修改只剩下工廠模式，若能將工廠模式也開放封閉，那就太好了。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>Laravel 5.2.31</p>
<h2 id="前言">前言</h2><hr>
<p>在<a href="/phpstorm/phpstorm-tdd-refactor/">如何使用 PhpStorm 實現 TDD、重構與偵錯?</a>與<a href="/tdd/tdd-di/">深入探討依賴注入</a>中，為了達到工廠模式的開放封閉，我用了一個技巧 : 故意將<strong>參數名稱</strong>與<strong>class名稱</strong>取相同，達到工廠模式的開放封閉，但實務上，可能參數來自於下拉式選單的 index，如 0, 1, 2 ….，或者參數與實際 class 名稱並不相同，需要一個 <code>if else</code> 或 <code>switch</code> 轉換，這樣就必須在工廠模式的 <code>create()</code> 或 <code>bind()</code> 寫邏輯，因此無法達成開放封閉原則的要求。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>本範例為<a href="/tdd/tdd-di/">深入探討依賴注入</a>的延伸，若覺得本文的範例看不懂，請先閱讀<a href="/tdd/tdd-di/">深入探討依賴注入</a></span></span></span></p>
<h2 id="實際案例">實際案例</h2><hr>
<p>假設目前有 3 家貨運公司，每家公司的計費方式不同，使用者可以動態選擇不同的貨運公司，將一步步的重構將工廠模式開放封閉。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>本範例靈感來自於91哥的<a href="https://dotblogs.com.tw/hatelove/archive/2013/01/02/learning-tdd-in-30-days-day17-refactoring-with-strategy-pattern.aspx" target="_blank" rel="external">30天快速上手TDD Day 17:Refactoring - Stagegy Pattern</a></span></span></span></p>
<h2 id="單元測試">單元測試</h2><hr>
<p><strong>ShippingServiceTest.php</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/90363a0c813718490c4fd6ec25310544d8bffeeb" target="_blank" rel="external">新增黑貓單元測試</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓單元測試<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$companyNo</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$target</span> = App::make(ShippingService::class);</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;calculateFee(<span class="variable">$companyNo</span>, <span class="variable">$weight</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先建立 <code>ShippingService</code> 的單元測試。</p>
<h2 id="ShippingService">ShippingService</h2><hr>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/8dd2d0ed4957c4a6fcd5430285384c0b9a1e9554" target="_blank" rel="external">新增 ShippingService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $companyNo</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(int <span class="variable">$companyNo</span>, int <span class="variable">$weight</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$logistics</span> = LogisticsFactory::create(<span class="variable">$companyNo</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因為已經制定了 <code>LogisticsInterface</code>，3 家貨運公司的計費方式，已經分別被封裝在 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>PostOffice</code> 3 個 class 內，所以必須使用工廠模式根據 <code>$companyNo</code>，回傳適當的貨運公司物件。</p>
<h2 id="工廠模式">工廠模式</h2><hr>
<p><strong>LogisticsFactory.php</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/79b6ecd9ce06658bbc359a3cda3070759a34d141" target="_blank" rel="external">新增 LogisticsFactory</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/LogisticsFactory.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogisticsFactory</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(int <span class="variable">$companyNo</span> = <span class="number">0</span>)</span> : <span class="title">LogisticsInterface</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$companyNo</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BlackCat();</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="variable">$companyNo</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Hsinchu();</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="variable">$companyNo</span> == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PostOffice();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BlackCat();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>if else</code> 判斷 <code>$companyNo</code>，根據不同的 <code>$companyNo</code>，回傳不同的貨運公司物件。</p>
<p>目前為止完全符合需求，會得到第 1 個 <span class="label label-success">綠燈</span>。</p>
<h2 id="將_if_else_重構成_switch">將 if else 重構成 switch</h2><hr>
<p><strong>LogisticsFactory.php</strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/04646722e327a0b844168cd615be9f36755938ab" target="_blank" rel="external">將 if else 重構成 switch</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/LogisticsFactory.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogisticsFactory</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(int <span class="variable">$companyNo</span> = <span class="number">0</span>)</span> : <span class="title">LogisticsInterface</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$companyNo</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> BlackCat();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Hsinchu();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PostOffice();</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> BlackCat();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將 <code>if else</code> 重構成 <code>switch</code>，可稍微改善程式碼的可讀性。<span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>將 <code>if else</code> 重構成 <code>switch</code>，請參考<a href="/phpstorm/phpstorm-if-switch/">如何在PhpStorm將if else重構成switch case?</a></span></span></span></p>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 2 個 <span class="label label-success">綠燈</span>。</p>
<h2 id="將_swtich_重構成_LUT">將 swtich 重構成 LUT</h2><hr>
<p><strong>LogisticsFactory.php</strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/63876d0ddec8c859562588755a5c43fd73a1adc5" target="_blank" rel="external">將 switch 重構成 LUT</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/LogisticsFactory.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogisticsFactory</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(int <span class="variable">$companyNo</span> = <span class="number">0</span>)</span> : <span class="title">LogisticsInterface</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$lut</span> = [</span><br><span class="line">            <span class="number">0</span> =&gt; BlackCat::class,</span><br><span class="line">            <span class="number">1</span> =&gt; Hsinchu::class,</span><br><span class="line">            <span class="number">2</span> =&gt; PostOffice::class</span><br><span class="line">        ];</span><br><span class="line">        <span class="variable">$className</span> = Collection::make(<span class="variable">$lut</span>)-&gt;get(<span class="variable">$companyNo</span>, BlackCat::class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$className</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將 <code>switch</code> 的條件式，改用 LUT (Look Up Table) 的方式表示，其中 <code>case</code> 重構成陣列的 key，要 <code>new</code> 的 class 重構成陣列的 value。</p>
<p>使用 <code>Collection::make()</code> 將陣列轉成 Laravel 的 collection。<span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>使用 <code>collect()</code> helper 亦可。</span></span></span></p>
<p>使用 collection 的 <code>get()</code>，針對 <code>$lut</code> 做搜尋。</p>
<ul>
<li>第 1 個參數傳入的是 key 的比對值，相當於 <code>switch</code> 的 <code>case</code>。</li>
<li>第 2 個參數傳入的示若 key 搜尋不到，所傳回的預設值，相當於 <code>switch</code> 的 <code>default</code>。</li>
</ul>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 3 個 <span class="label label-success">綠燈</span>。</p>
<h2 id="將_LUT_重構到_app-php">將 LUT 重構到 app.php</h2><hr>
<p><strong>app.php</strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/1f81b011192c27ab06a552b32f808aaaddbf2a03" target="_blank" rel="external">將 LUT 重構到 config/app.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>config/app.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'logistics'</span> =&gt; [</span><br><span class="line">    <span class="number">0</span> =&gt; App\Services\BlackCat::class,</span><br><span class="line">    <span class="number">1</span> =&gt; App\Services\Hsinchu::class,</span><br><span class="line">    <span class="number">2</span> =&gt; App\Services\PostOffice::class</span><br><span class="line">],</span><br></pre></td></tr></table></figure></p>
<p>將陣列搬到 <code>config/app.php</code> 下，將來若對應邏輯有所修改，只需改 <code>app.php</code> 即可。</p>
<p><strong>LogisticsFactory.php</strong><span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/1f81b011192c27ab06a552b32f808aaaddbf2a03" target="_blank" rel="external">將 LUT 重構到 config/app.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/LogisticsFactory.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogisticsFactory</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(int <span class="variable">$companyNo</span> = <span class="number">0</span>)</span> : <span class="title">LogisticsInterface</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$lut</span> = config(<span class="string">'app.logistics'</span>);</span><br><span class="line">        <span class="variable">$className</span> = Collection::make(<span class="variable">$lut</span>)-&gt;get(<span class="variable">$companyNo</span>, BlackCat::class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$className</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>$lut</code> 改由 <code>config()</code> 讀取 <code>config/app.php</code> 的設定，目前工廠不包含建立物件的邏輯，LUT 已經搬到 <code>app.php</code>，因此完成工廠模式的開放封閉。</p>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 4 個 <span class="label label-success">綠燈</span>。</p>
<h2 id="重構成依賴注入">重構成依賴注入</h2><hr>
<p>為了達到可測試性的要求，你可能會想將貨運公司物件改用依賴注入的方式，因此我們繼續重構。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/68f1de804a36258178d0fc5375ab2dea84d8f59d" target="_blank" rel="external">ShippingService 改用依賴注入</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> LogisticsInterface</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$logistics</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * ShippingService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> LogisticsInterface $logistics</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(LogisticsInterface <span class="variable">$logistics</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;logistics = <span class="variable">$logistics</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(int <span class="variable">$weight</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;logistics-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>改用 constructor injection 的方式，將貨運物件注入。</p>
<h2 id="重構單元測試">重構單元測試</h2><hr>
<p>由於 <code>ShippingService</code> 重構成依賴注入方式，因此單元測試也要跟著重構。</p>
<p><strong>ShippingServiceTest.php</strong><span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/6454e2d748935b6f1aea3131af0cc1fa176475c0" target="_blank" rel="external">重構黑貓單元測試</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">LogisticsFactory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓單元測試<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$companyNo</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        LogisticsFactory::bind(<span class="variable">$companyNo</span>);</span><br><span class="line">        <span class="variable">$target</span> = App::make(ShippingService::class);</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因為改成依賴注入，工廠模式的功能不再是建立物件，而是在決定 <code>App::bind()</code> 該與什麼 class 做連結，因此也將工廠模式的 <code>create()</code> 改成 <code>bind()</code>。</p>
<h2 id="重構工廠模式">重構工廠模式</h2><hr>
<p><strong>LogisticsFactory.php</strong><span class="margin-note-marker"><sup>14</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">14</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52FactoryOCP-/commit/95a2295156f4a35e702f9415ee9ac3993f5210de" target="_blank" rel="external">重構 LogisticsFactory</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/LogisticsFactory.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogisticsFactory</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">(int <span class="variable">$companyNo</span> = <span class="number">0</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$lut</span> = config(<span class="string">'app.logistics'</span>);</span><br><span class="line">        <span class="variable">$className</span> = Collection::make(<span class="variable">$lut</span>)-&gt;get(<span class="variable">$companyNo</span>, BlackCat::class);</span><br><span class="line"></span><br><span class="line">        App::bind(LogisticsInterface::class, <span class="variable">$className</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>$lut</code> 也是改由 <code>config()</code> 讀取 <code>config/app.php</code> 的設定，目前工廠不包含 <code>App::bind()</code> 的邏輯，LUT 已經搬到 <code>app.php</code>，因此完成工廠模式的開放封閉。</p>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 5 個 <span class="label label-success">綠燈</span>。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>將 <code>if else</code> 或 <code>switch</code> 邏輯改用 LUT 表示，可將陣列改放到 <code>config/app.php</code> 下，將來若有任何邏輯修改，都是修改在設定檔，而達成工廠模式的開放封閉。</li>
<li>透過 collection 的 <code>get()</code>，可以很方便的搭配 LUT，還可傳入預設參數，配合 <code>switch</code> 的 <code>default</code>。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52FactoryOCP-" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[將邏輯改用 LUT 表示，可將 LUT 改放到 app.php 設定檔]]>
    
    </summary>
    
      <category term="Design Pattern" scheme="http://oomusou.io/tags/Design-Pattern/"/>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="TDD" scheme="http://oomusou.io/tags/TDD/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[實務上如何活用 Closure?]]></title>
    <link href="http://oomusou.io/php/php-closure-practice/"/>
    <id>http://oomusou.io/php/php-closure-practice/</id>
    <published>2016-04-30T12:23:43.000Z</published>
    <updated>2016-05-02T14:08:09.000Z</updated>
    <content type="html"><![CDATA[<p>PHP 5.3 正式將 closure 帶入 PHP，到了 Laravel 5，我們看到了 Laravel 大量使用 closure，除了在配合 Laravel 的地方使用 closure 外，我們該如何將 closure 加以內化，進而活用在自己的程式碼中呢? 我們將實際探索 Laravel 原始碼，學習 Taylor Otwell 如何使用 closure。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>Laravel 5.2.31</p>
<h2 id="Closure_vs-_Callback">Closure vs. Callback</h2><hr>
<p>一般人想到 closure，就會想到 callback，這是由我們寫 jQuery 與 Node.js 的所得到的經驗，將 closure 用在 event 或非同步的狀況下。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>關於 PHP 的 closure 基本語法，詳細請參考 <a href="/php/php-closure/">如何使用 Closure?</a></span></span></span></p>
<p>由於 PHP 是同步的，所以很多人不知道該怎麼在 PHP 使用 closure，實際探索 Laravel 原始碼後我們會發現，儘管在同步的 PHP，Laravel 內部仍有 3 個地方會使用 closure 實現 : </p>
<ol>
<li><strong> 由使用者執行一段邏輯 </strong></li>
<li><strong> 由使用者決定一個布林 </strong></li>
<li><strong> 由使用者改變一個物件 </strong></li>
</ol>
<p>我們將一一的詳細討論，學習 Laravel 怎麼活用 closure，再以實際範例重構成 closure。</p>
<h2 id="由使用者執行一段邏輯">由使用者執行一段邏輯</h2><hr>
<h3 id="Schema::create()">Schema::create()</h3><p>學習 Laravel，大家第一個會碰到的 closure，大概會在 migration 的 <code>Schema::create()</code> :</p>
<figure class="highlight php"><figcaption><span>database/migrations/create_users_table.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">Blueprint</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Migrations</span>\<span class="title">Migration</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateUsersTable</span> <span class="keyword">extends</span> <span class="title">Migration</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Run the migrations.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        Schema::create(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint <span class="variable">$table</span>)</span> </span>&#123;</span><br><span class="line">            <span class="variable">$table</span>-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;string(<span class="string">'name'</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;string(<span class="string">'email'</span>)-&gt;unique();</span><br><span class="line">            <span class="variable">$table</span>-&gt;string(<span class="string">'password'</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;rememberToken();</span><br><span class="line">            <span class="variable">$table</span>-&gt;timestamps();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Reverse the migrations.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">down</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        Schema::drop(<span class="string">'users'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Schema::create(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint <span class="variable">$table</span>)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$table</span>-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">    <span class="variable">$table</span>-&gt;string(<span class="string">'name'</span>);</span><br><span class="line">    <span class="variable">$table</span>-&gt;string(<span class="string">'email'</span>)-&gt;unique();</span><br><span class="line">    <span class="variable">$table</span>-&gt;string(<span class="string">'password'</span>);</span><br><span class="line">    <span class="variable">$table</span>-&gt;rememberToken();</span><br><span class="line">    <span class="variable">$table</span>-&gt;timestamps();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>我們發現 <code>Schema::create()</code> 的第 2 個參數要求我們傳入一個 closure，且 closure 還傳入了 <code>Blueprint $table</code>，為什麼會有這樣怪異的寫法呢?</p>
<p>若去 trace Laravel 原始碼，會發現 <code>Schema::create()</code> 是長這樣 :</p>
<figure class="highlight php"><figcaption><span>database/migrations/create_users_table.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Connection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Builder</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Create a new table on the schema.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span>  string    $table</span><br><span class="line">     * <span class="doctag">@param</span>  \Closure  $callback</span><br><span class="line">     * <span class="doctag">@return</span> \Illuminate\Database\Schema\Blueprint</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(<span class="variable">$table</span>, Closure <span class="variable">$callback</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$blueprint</span> = <span class="variable">$this</span>-&gt;createBlueprint(<span class="variable">$table</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$blueprint</span>-&gt;create();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$callback</span>(<span class="variable">$blueprint</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$this</span>-&gt;build(<span class="variable">$blueprint</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>create()</code> 共執行 4 個函式，其中 3 個函式為 Laravel 自己要執行的邏輯，只有 21 行的 <code>$callback($blueprint)</code> 是要執行使用者的邏輯。</p>
<p>其中 <code>Blueprint $table</code> 就是在此由 <code>$blueprint</code> 所代入的。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當函式內，中間有一段邏輯，必須由使用者決定，而非函式本身所決定，可要求使用者傳入 closure 並執行之。</div>
<p>我們來舉一個實務上的例子比較容易理解。</p>
<h3 id="實際範例">實際範例</h3><p><strong> 測試案例 </strong></p>
<ul>
<li>顯示出 <code>Post</code> model 的所有文章。</li>
</ul>
<p><strong> 單元測試 </strong><br><strong> PostServiceTest.php </strong><span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/93611680214f43c8f177b86e6159b3342204f75e" target="_blank" rel="external">單元測試 : 顯示所有 Post()</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/PostServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">PostService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 顯示所有<span class="title">Post</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">10</span>;</span><br><span class="line">        <span class="variable">$target</span> = App::make(PostService::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;displayAllPosts();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>驗證傳回文章筆數是否為 <code>10</code> 筆。</p>
<p><strong> PostService.php </strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/e27a224d1a15054f53965d73b8e3b690d0958caf" target="_blank" rel="external">新增 displayAllPost()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPosts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">            <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第 8 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@var</span> PostRepository</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * PostService constructor.</span><br><span class="line"> * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將 <code>PostRepository</code> 依賴注入。</p>
<p>21 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPosts</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">        <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由 <code>PostRepository-&gt;getAllPosts()</code> 取得 <code>$posts</code> collection。</p>
<p><code>foreach</code> 整個 collection，透過 <code>echo()</code> 顯示訊息。</p>
<p>最後回傳所有文章的筆數。</p>
<p><strong> PostRepository.php </strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/59c54a2d2580bfa56562b50c0b827f4681fbcf49" target="_blank" rel="external">新增 getAllPosts()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> Collection|Post[]</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllPosts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Post::all();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>傳回所有文章。</p>
<p>目前為止完全符合需求，會得到第 1 個 <span class="label label-success">綠燈</span>。</p>
<h3 id="使用_Closure_重構">使用 Closure 重構</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPosts</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">        <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據需求，我們發現只有第 9 行與第 10 行會根據使用者需求而異動，其他行數都不會異動，因此我們想將其他行數提煉出來。</p>
<p><strong> PostService.php </strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/fc815ed863aa1b605ed5363d668143c687a40715" target="_blank" rel="external">重構 : 使用 Closure 重構成 getAllPosts()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPosts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;getAllPosts(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">            <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllPosts</span><span class="params">(Closure <span class="variable">$closure</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">            <span class="variable">$closure</span>(<span class="variable">$post</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>34 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllPosts</span><span class="params">(Closure <span class="variable">$closure</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">        <span class="variable">$closure</span>(<span class="variable">$post</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提煉出 <code>getAllPosts()</code> 後，我們發現 <code>foreach()</code> 內關於顯示邏輯部分，會根據使用者需求而異動，根據之前的經驗 :</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當函式內，中間有一段邏輯，必須由使用者決定，而非函式本身所決定，可要求使用者傳入 closure 並執行之。</div>
<p>第 6 行我們以 <code>$closure</code> 取代，因為顯示需要 <code>Post</code> model 資料， 因此傳入 <code>$post</code>。</p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPosts</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;getAllPosts(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">        <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將原本由 <code>echo()</code> 顯示資料部分，改由 closure 傳進 <code>getAllPosts()</code>。</p>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 2 個 <span class="label label-success">綠燈</span>。</p>
<h3 id="使用_Collection_重構">使用 Collection 重構</h3><div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  為什麼要自己寫 <strong>getAllPosts()</strong> 呢? Laravel 的 collection 不是有自帶 <strong>each()</strong> 嗎?</div>
<p>沒錯，因為實務上太多在 collection 內執行其他 closure 的需求，Laravel 的 collection 已經幫我們準備了 <code>each()</code> 函式。</p>
<p><strong> PostService.php </strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/1612ff6dafa0751fb178da3231c73b954292ddcf" target="_blank" rel="external">重構 : 使用 Collection-&gt;each()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPosts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts()</span><br><span class="line">            -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">                <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">            &#125;)-&gt;count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由於 Eloquent 傳回的就是 collection，因此可以將 closure 傳入 <code>each()</code>，這樣我們連 <code>foreach()</code> 也不用寫。</p>
<p>由於 collection 的函式都支援 fluent API 風格，也是回傳 collection，因此可以繼續下 <code>count()</code> 加以回傳。</p>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 3 個 <span class="label label-success">綠燈</span>。</p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  為什麼 <strong>each()</strong> 可以取代自己寫的 <strong>foreach()</strong> 呢?</div>
<p><strong> Collection.php </strong><br><figure class="highlight php"><figcaption><span>Illuminate/Support/Collection.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span> <span class="keyword">implements</span> <span class="title">ArrayAccess</span>, <span class="title">Arrayable</span>, <span class="title">Countable</span>, <span class="title">IteratorAggregate</span>, <span class="title">Jsonable</span>, <span class="title">JsonSerializable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Execute a callback over each item.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span>  callable  $callback</span><br><span class="line">     * <span class="doctag">@return</span> $this</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">each</span><span class="params">(callable <span class="variable">$callback</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$this</span>-&gt;items <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$item</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$callback</span>(<span class="variable">$item</span>, <span class="variable">$key</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>若進去 trace Laravel 原始碼，會發現 <code>each()</code> 內幫我們實現了 <code>foreach()</code>，而我們傳進去的 closure 正好在 <code>foreach()</code> 內執行，若 closure 傳回 false，還可以中斷 <code>foreach()</code>。</p>
<p>其中 <code>$callback()</code> 剛好是藏在函式中，由使用者決定的邏輯，而 <code>$callback</code> 之外，都是函式自己的邏輯，也再次應證之前的結論 :</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當函式內，中間有一段邏輯，必須由使用者決定，而非函式本身所決定，可要求使用者傳入 closure 並執行之。</div>
<h2 id="由使用者決定一個布林">由使用者決定一個布林</h2><hr>
<h3 id="Collection-&gt;first()">Collection-&gt;first()</h3><p>有些 Laravel 函式，會希望我們傳進一個 closure，回傳 true 或 false，如 collection 的 <code>first()</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])-&gt;first(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$key</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span> &gt; <span class="number">2</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<p><code>first()</code> 會傳回符合條件的第一個元素，但條件必須我們自己用 closure 傳進去，為什麼會有這樣怪異的寫法呢?</p>
<p>若去 trace Laravel 原始碼，會發現 <code>first()</code> 長這樣 :<br><figure class="highlight php"><figcaption><span>Illuminate/Support/Arr.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Arr</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * Return the first element in an array passing a given truth test.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span>  array  $array</span><br><span class="line">     * <span class="doctag">@param</span>  callable|null  $callback</span><br><span class="line">     * <span class="doctag">@param</span>  mixed  $default</span><br><span class="line">     * <span class="doctag">@return</span> mixed</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">(<span class="variable">$array</span>, callable <span class="variable">$callback</span> = null, <span class="variable">$default</span> = null)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="variable">$callback</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="variable">$array</span>) ? value(<span class="variable">$default</span>) : reset(<span class="variable">$array</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$array</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (call_user_func(<span class="variable">$callback</span>, <span class="variable">$key</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value(<span class="variable">$default</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>17 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$array</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (call_user_func(<span class="variable">$callback</span>, <span class="variable">$key</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Laravel 會 <code>foreach()</code> 整個陣列，由 <code>call_user_func()</code> 去執行 closure，遇到第一個 closure 傳回 true 的條件，就 return 離開迴圈。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當函式內，中間有一個布林，必須由使用者決定，而非函式本身所決定，可要求使用者傳入 closure 並執行之。</div>
<p>我們來舉一個實務上的例子比較容易理解。</p>
<h3 id="實際範例-1">實際範例</h3><p><strong> 測試案例 </strong></p>
<ul>
<li>顯示出 <code>Post</code> model 的所有奇數 ID 文章。</li>
</ul>
<p><strong> 單元測試 </strong><br><strong> PostServiceTest.php </strong><span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/77bdf04cec0150deb389ca81fc59842076481d60" target="_blank" rel="external">單元測試 : 顯示所有奇數 ID 文章</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/PostServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">PostService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 顯示奇數<span class="title">ID</span>的<span class="title">Post</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">5</span>;</span><br><span class="line">        <span class="variable">$target</span> = App::make(PostService::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;displayAllOddPosts();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>驗證傳回文章筆數是否為 <code>5</code> 筆。</p>
<p><strong> PostService.php </strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/b652e244a652032d3904c709df83ccecfe46ef63" target="_blank" rel="external">新增 displayAllOddPost()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllOddPosts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line">        <span class="variable">$cnt</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$post</span>-&gt;id % <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="variable">$cnt</span>++;</span><br><span class="line">                <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$cnt</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>21 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllOddPosts</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line">    <span class="variable">$cnt</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$post</span>-&gt;id % <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="variable">$cnt</span>++;</span><br><span class="line">            <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cnt</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由 <code>PostRepository-&gt;getAllPosts()</code> 取得 <code>$posts</code> collection。</p>
<p><code>foreach</code> 整個 collection，由 <code>if ($post-&gt;id % 2)</code> 做判斷，若 ID 為奇數，則 <code>$cnt++</code> 並顯示訊息。</p>
<p>最後回傳所有文章的筆數。</p>
<p>目前為止完全符合需求，會得到第 1 個 <span class="label label-success">綠燈</span>。</p>
<h3 id="使用_Closure_重構-1">使用 Closure 重構</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllOddPosts</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line">    <span class="variable">$cnt</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$post</span>-&gt;id % <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="variable">$cnt</span>++;</span><br><span class="line">            <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cnt</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據需求，我們發現只有第 10 行的 <code>if ($post-&gt;id % 2)</code> 會根據使用者需求而異動，其他行數都不會異動，因此我們想將其他行數提煉出來。</p>
<p><strong> PostService.php </strong><span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/b73d48cf89b54e721fbb1e025d04dcc6b10abd53" target="_blank" rel="external">重構 : 使用 Closure 重構成 filterAllOddPosts()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllOddPosts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;filterAllOddPosts(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="variable">$post</span>-&gt;id % <span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> Closure $closure</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterAllOddPosts</span><span class="params">(Closure <span class="variable">$closure</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line">        <span class="variable">$cnt</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$closure</span>(<span class="variable">$post</span>)) &#123;</span><br><span class="line">                <span class="variable">$cnt</span>++;</span><br><span class="line">                <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$cnt</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>37 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@param</span> Closure $closure</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterAllOddPosts</span><span class="params">(Closure <span class="variable">$closure</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line">    <span class="variable">$cnt</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$closure</span>(<span class="variable">$post</span>)) &#123;</span><br><span class="line">            <span class="variable">$cnt</span>++;</span><br><span class="line">            <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cnt</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提煉出 <code>filterAllOddPosts()</code> 後，我們發現 <code>foreach()</code> 內關於是否為奇數部分，會根據使用者需求而異動，根據之前的經驗 :</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當函式內，中間有一個布林，必須由使用者決定，而非函式本身所決定，可要求使用者傳入 closure 並執行之。</div>
<p>第 11 行我們以 <code>$closure</code> 取代，因為判斷需要 <code>Post</code> model 資料， 因此傳入 <code>$post</code>。</p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllOddPosts</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;filterAllOddPosts(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="variable">$post</span>-&gt;id % <span class="number">2</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將原本由 <code>if ($post-&gt;id % 2)</code> 判斷奇數部分，改由 closure 傳進 <code>filterAllOddPosts()</code>。</p>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 2 個 <span class="label label-success">綠燈</span>。</p>
<h3 id="使用_Collection_重構-1">使用 Collection 重構</h3><div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  為什麼要自己寫 <strong>filterAllOddPosts()</strong> 呢? Laravel 的 collection 不是有自帶 <strong>filter()</strong> 嗎?</div>
<p>沒錯，因為實務上太多在 collection 內執行 filter 的需求，Laravel 的 collection 已經幫我們準備了 <code>filter()</code> 函式。</p>
<p><strong> PostService.php </strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/16717e9edc23f409d11356403db6a10ee96eb845" target="_blank" rel="external">重構 : 使用 Collection-&gt;filter()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllOddPosts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts()</span><br><span class="line">            -&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (<span class="variable">$value</span>-&gt;id % <span class="number">2</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">            -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">                <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">            &#125;)-&gt;count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由於 Eloquent 傳回的就是 collection，因此可以將 closure 傳入 <code>filter()</code>，這樣我們連 <code>foreach()</code> 也不用寫。</p>
<p>由於 collection 的函式都支援 fluent API 風格，也是回傳 collection，因此可以繼續下 <code>each()</code> 顯示資訊。</p>
<p>最後再用 <code>count()</code> 回傳筆數。</p>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 3 個 <span class="label label-success">綠燈</span>。</p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  為什麼 <strong>filter()</strong> 可以取代自己寫的 <strong>foreach()</strong> 呢?</div>
<p><strong> Collection.php </strong><br><figure class="highlight php"><figcaption><span>Illuminate/Support/Collection.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span> <span class="keyword">implements</span> <span class="title">ArrayAccess</span>, <span class="title">Arrayable</span>, <span class="title">Countable</span>, <span class="title">IteratorAggregate</span>, <span class="title">Jsonable</span>, <span class="title">JsonSerializable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Run a filter over each of the items.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span>  callable|null  $callback</span><br><span class="line">     * <span class="doctag">@return</span> static</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">(callable <span class="variable">$callback</span> = null)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$callback</span>) &#123;</span><br><span class="line">            <span class="variable">$return</span> = [];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$this</span>-&gt;items <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$callback</span>(<span class="variable">$value</span>, <span class="variable">$key</span>)) &#123;</span><br><span class="line">                    <span class="variable">$return</span>[<span class="variable">$key</span>] = <span class="variable">$value</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">static</span>(<span class="variable">$return</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">static</span>(array_filter(<span class="variable">$this</span>-&gt;items));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>若進去 trace Laravel 原始碼，會發現 <code>filter()</code> 內幫我們實現了 <code>foreach()</code>，而我們傳進去的 closure 正好在 <code>foreach()</code> 內執行 <code>if ($callback($value, $key))</code>。</p>
<p>其中 <code>$callback()</code> 剛好是藏在函式的 <code>if</code> 內，由使用者決定的邏輯，而 <code>$callback</code> 之外，都是函式自己的邏輯，也再次應證之前的結論 :</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當函式內，中間有一個布林，必須由使用者決定，而非函式本身所決定，可要求使用者傳入 closure 並執行之。</div>
<h2 id="由使用者改變一個物件">由使用者改變一個物件</h2><hr>
<h3 id="Where_Nested_Query">Where Nested Query</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">SELECT * </span><br><span class="line"><span class="keyword">FROM</span> posts</span><br><span class="line"><span class="keyword">WHERE</span> (<span class="keyword">status</span> = <span class="number">0</span> <span class="keyword">or</span> <span class="keyword">status</span> = <span class="number">1</span>)</span></span><br></pre></td></tr></table></figure>
<p>若要寫出以上的巢狀 query，在 Eloquent 我們必須這樣寫。<span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>關於巢狀 query 寫法，詳細請參考 <a href="/laravel/eloquent/eloquent-where-and-or/">如何在 Eloquent 建立一個含 or 的 where 條件式?</a></span></span></span></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Post::where(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$query</span>)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;where(<span class="string">'status'</span>, <span class="number">0</span>)</span><br><span class="line">        -&gt;orWhere(<span class="string">'status'</span>, <span class="number">1</span>);</span><br><span class="line">&#125;)-&gt;get();</span><br></pre></td></tr></table></figure>
<p>Eloquent 要求我們在 <code>where()</code> 傳入一個 closure，在 closure 的 <code>$query</code> 加入巢狀 query，，為什麼會有這樣怪異的寫法呢?</p>
<p>若去 trace Laravel 原始碼，會發現 <code>where()</code> 長這樣 :<br><figure class="highlight php"><figcaption><span>Illuminate/Database/Eloquent/Builder.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Builder</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Add a basic where clause to the query.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span>  string  $column</span><br><span class="line">     * <span class="doctag">@param</span>  string  $operator</span><br><span class="line">     * <span class="doctag">@param</span>  mixed   $value</span><br><span class="line">     * <span class="doctag">@param</span>  string  $boolean</span><br><span class="line">     * <span class="doctag">@return</span> $this</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">(<span class="variable">$column</span>, <span class="variable">$operator</span> = null, <span class="variable">$value</span> = null, <span class="variable">$boolean</span> = <span class="string">'and'</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$column</span> <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">            <span class="variable">$query</span> = <span class="variable">$this</span>-&gt;model-&gt;newQueryWithoutScopes();</span><br><span class="line"></span><br><span class="line">            call_user_func(<span class="variable">$column</span>, <span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$this</span>-&gt;query-&gt;addNestedWhereQuery(<span class="variable">$query</span>-&gt;getQuery(), <span class="variable">$boolean</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            call_user_func_array([<span class="variable">$this</span>-&gt;query, <span class="string">'where'</span>], func_get_args());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>15 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$query</span> = <span class="variable">$this</span>-&gt;model-&gt;newQueryWithoutScopes();</span><br></pre></td></tr></table></figure></p>
<p>建立一個新的 query builder 物件。</p>
<p>17 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(<span class="variable">$column</span>, <span class="variable">$query</span>);</span><br></pre></td></tr></table></figure></p>
<p>將 <code>$query</code> 物件傳進 closure，由使用者將巢狀 query 加到 <code>$query</code> 物件內。</p>
<p>19 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$this</span>-&gt;query-&gt;addNestedWhereQuery(<span class="variable">$query</span>-&gt;getQuery(), <span class="variable">$boolean</span>);</span><br></pre></td></tr></table></figure></p>
<p>再將使用者修改過的 <code>$query</code> 物件加到 <code>addNestedWhereQuery()</code> 函式內。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當函式內，中間有一個物件，必須由使用者修改，而非函式本身所能修改，可要求使用者傳入 closure 並執行之。</div>
<p>我們來舉一個實務上的例子比較容易理解。</p>
<h3 id="實際範例-2">實際範例</h3><p><strong> 測試案例 </strong></p>
<ul>
<li>將 <code>Post</code> model 的 <code>title</code> 全部改成 <code>Laravel</code>，並顯示之。</li>
</ul>
<p><strong> 單元測試 </strong><br><strong> PostServiceTest.php </strong><span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/2d6adf442b3a40228bf6953f6a62b746bac67514" target="_blank" rel="external">單元測試 : title 全部改成 Laravel 並顯示</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/PostServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">PostService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">title</span>全部改成<span class="title">Laravel</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">10</span>;</span><br><span class="line">        <span class="variable">$target</span> = App::make(PostService::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;displayAllPostsWithLaravel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>驗證傳回文章筆數是否為 <code>10</code> 筆。</p>
<p><strong> PostService.php </strong><span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/133cb20860ac2029cfc4a978d397c20c59efd60f" target="_blank" rel="external">新增 displayAllPostWithLaravel()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPostsWithLaravel</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">            <span class="variable">$post</span>-&gt;title = <span class="string">'Laravel'</span>;</span><br><span class="line">            <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>21 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPostsWithLaravel</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">        <span class="variable">$post</span>-&gt;title = <span class="string">'Laravel'</span>;</span><br><span class="line">        <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由 <code>PostRepository-&gt;getAllPosts()</code> 取得 <code>$posts</code> collection。</p>
<p><code>foreach</code> 整個 collection，由 <code>$post-&gt;title = &#39;Laravel&#39;</code> 對 <code>$post</code> 變數做修改，並顯示訊息。</p>
<p>最後回傳所有文章的筆數。</p>
<p>目前為止完全符合需求，會得到第 1 個 <span class="label label-success">綠燈</span>。</p>
<h3 id="使用_Closure_重構-2">使用 Closure 重構</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPostsWithLaravel</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">        <span class="variable">$post</span>-&gt;title = <span class="string">'Laravel'</span>;</span><br><span class="line">        <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據需求，我們發現只有第 9 行的 <code>$post-&gt;title = &#39;Laravel&#39;</code>會根據使用者需求而異動，其他行數都不會異動，因此我們想將其他行數提煉出來。</p>
<p><strong> PostService.php </strong><span class="margin-note-marker"><sup>14</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">14</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/f951d5906c269292dd87f915ed3caa090752400e" target="_blank" rel="external">重構 : 使用 Closure 重構成 replaceAllOddPostsWithLaravel()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPostsWithLaravel</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;replaceAllPostsWithLaravel(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">            <span class="variable">$post</span>-&gt;title = <span class="string">'Laravel'</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> Closure $closure</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">replaceAllPostsWithLaravel</span><span class="params">(Closure <span class="variable">$closure</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">            <span class="variable">$closure</span>(<span class="variable">$post</span>);</span><br><span class="line">            <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>33 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@param</span> Closure $closure</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">replaceAllPostsWithLaravel</span><span class="params">(Closure <span class="variable">$closure</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$posts</span> <span class="keyword">as</span> <span class="variable">$post</span>) &#123;</span><br><span class="line">        <span class="variable">$closure</span>(<span class="variable">$post</span>);</span><br><span class="line">        <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$posts</span>-&gt;count();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提煉出 <code>replaceAllPostsWithLaravel()</code> 後，我們發現 <code>foreach()</code> 內修改 <code>$post</code> 物件部分，會根據使用者需求而異動，根據之前的經驗 :</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當函式內，中間有一個物件，必須由使用者修改，而非函式本身所能修改，可要求使用者傳入 closure 並執行之。</div>
<p>第 10 行我們以 <code>$closure</code> 取代，因為需要修改 <code>Post</code> model 資料， 因此傳入 <code>$post</code> 物件。</p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPostsWithLaravel</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;replaceAllPostsWithLaravel(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">        <span class="variable">$post</span>-&gt;title = <span class="string">'Laravel'</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將原本由 <code>$post-&gt;title = &#39;Laravel&#39;</code> 修改物件部分，改由 closure 傳進 <code>replaceAllOddPostsWithLaravel()</code>。</p>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 2 個 <span class="label label-success">綠燈</span>。</p>
<h3 id="使用_Collection_重構-2">使用 Collection 重構</h3><div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  為什麼要自己寫 <strong>replaceAllOddPostsWithLaravel()</strong> 呢? Laravel 的 collection 不是有自帶 <strong>each()</strong> 嗎?</div>
<p>沒錯，因為實務上太多在 collection 內修改物件的需求，Laravel 的 collection 已經幫我們準備了 <code>each()</code> 函式。</p>
<p><strong> PostService.php </strong><span class="margin-note-marker"><sup>15</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">15</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo/commit/1917242e68b5ebcb0ac64ecf485fd0acda964aec" target="_blank" rel="external">重構 : 使用 Collection-&gt;each()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostRepository $postRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepository <span class="variable">$postRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postRepository = <span class="variable">$postRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayAllPostsWithLaravel</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;postRepository-&gt;getAllPosts()</span><br><span class="line">            -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">                <span class="variable">$post</span>-&gt;title = <span class="string">'Laravel'</span>;</span><br><span class="line">            &#125;)</span><br><span class="line">            -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(Post <span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">                <span class="variable">$txt</span> = <span class="string">"&#123;$post-&gt;id&#125; : &#123;$post-&gt;title&#125;"</span> . PHP_EOL;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="variable">$txt</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">            -&gt;count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由於 Eloquent 傳回的就是 collection，因此可以將 closure 傳入 <code>each()</code>，並將 <code>$post</code>物件傳入 closure，這樣我們連 <code>foreach()</code> 也不用寫。</p>
<p>由於 collection 的函式都支援 fluent API 風格，也是回傳 collection，因此可以繼續下 <code>each()</code> 顯示資訊。</p>
<p>最後再用 <code>count()</code> 回傳筆數。</p>
<p>重構後趕快執行測試，看看有沒有重構壞掉。</p>
<p>目前為止完全符合需求，會得到第 3 個 <span class="label label-success">綠燈</span>。</p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  為什麼 <strong>each()</strong> 可以修改 <strong>$post</strong> 物件呢?</div>
<p>雖然 PHP 是以 pass by value 傳遞變數，但別忘了對於物件，PHP 是 pass by reference，因此在 closure 內可以直接修改 <code>$post</code> 物件。</p>
<p>Collection 的 <code>each()</code> 原始碼，之前已經分析過，就不再贅述，不過不管是使用 <code>each()</code>，或是自己建立的 <code>replaceAllOddPostsWithLaravel()</code>，其心法都是相同的 :</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當函式內，中間有一個物件，必須由使用者修改，而非函式本身所能修改，可要求使用者傳入 closure 並執行之。</div>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>若重複的是一段邏輯，可將該邏輯提煉為函式；若重複的是一段邏輯以外的邏輯，可將以外的邏輯提煉為函式，而將該段邏輯成為 closure 傳入。</li>
<li>若可以使用 collection 提供的函式，優先使用之，其次再自己提煉函式，傳入 closure。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52LearnClosureByLaravel_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[將 Closure 內化到自己的程式碼中]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="PHP" scheme="http://oomusou.io/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[PHP 與 TypeScript 的 Template Literals]]></title>
    <link href="http://oomusou.io/php/php-template-literals/"/>
    <id>http://oomusou.io/php/php-template-literals/</id>
    <published>2016-04-29T12:23:43.000Z</published>
    <updated>2016-04-29T07:45:21.000Z</updated>
    <content type="html"><![CDATA[<p>TypeScript 提供了 Template Literals，可以讓字串處理的可讀性更高，不再只是湊字串而已，事實上，PHP 也有這種機制。  </p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>TypeScript 1.8.9</p>
<h2 id="TypeScript">TypeScript</h2><hr>
<figure class="highlight typescript"><figcaption><span>TypeScript</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name:<span class="built_in">string</span> = <span class="string">'Sam'</span>;</span><br><span class="line"><span class="keyword">var</span> sentence:<span class="built_in">string</span> = `Hello $&#123;name&#125;`;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(sentence);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hello Sam</span></span><br></pre></td></tr></table></figure>
<p>在 TypeScript，只要字串改用<code>反引號</code> ，再配合 <code>${}</code> 即可。</p>
<h2 id="PHP">PHP</h2><hr>
<figure class="highlight php"><figcaption><span>PHP</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$name</span> = <span class="string">'Sam'</span>;</span><br><span class="line"><span class="variable">$sentence</span> = <span class="string">"Hello &#123;$name&#125;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$sentence</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hello Sam</span></span><br></pre></td></tr></table></figure>
<p>在 PHP，只要字串改用<code>雙引號</code>，再配合<code>{$}</code>即可。</p>
<p>剛好與 TypeScript 相反。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Template literals 方式湊字串，遠比傳統用 <code>+</code> 或 <code>.</code> 的方式可讀性高，最少可以先看到字串整體的全貌。</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[PHP 也有支援如 TypeScript 的 Template Literal]]>
    
    </summary>
    
      <category term="PHP" scheme="http://oomusou.io/tags/PHP/"/>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 PhpStorm 開發 Angular 2?]]></title>
    <link href="http://oomusou.io/angular2/angular2-phpstorm-setup/"/>
    <id>http://oomusou.io/angular2/angular2-phpstorm-setup/</id>
    <published>2016-04-28T12:23:43.000Z</published>
    <updated>2016-04-28T08:57:04.000Z</updated>
    <content type="html"><![CDATA[<p>PhpStorm 不僅能開發 PHP 與 Laravel 而已，還內建 TypeScript 編譯，掛上 JetBrains 的官方 Angular 外掛後，PhpStorm 就能完美支援 TypeScript 與 Angular 2。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PhpStorm 2016.1<br>Angular 2.0.0-beta.15</p>
<h2 id="5_Min_Quickstart">5 Min Quickstart</h2><hr>
<p>本文將以 Angular 2 官網的 <a href="https://angular.io/docs/ts/latest/quickstart.html#" target="_blank" rel="external">5 Min Quickstart</a> 使用 PhpStorm 開發，而不使用官網的 <code>npm start</code> 方式。 <span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>若你想使用 Laravel Elixir 方式開發 Angular 2，詳細請參考 <a href="/angular2/angular2-laravel-setup/">如何在 Laravel 執行 Angular 2</a></span></span></span></p>
<h2 id="建立專案">建立專案</h2><hr>
<p>我們將使用 PhpStorm 從頭開始建立 Angular 2 專案。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup000.png" alt=""></p>
<p>啟動 PhpStorm，按 <code>Create New Project</code> 建立新專案。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup001.png" alt=""></p>
<p>選擇左側 <code>Empty Project</code>，在 Location 輸入專案路徑。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup002.png" alt=""></p>
<p>PhpStorm 一如往常出現 <code>Detact PSR-0 namesapce roots</code> 提示，直接關閉不用理它，因為我們現在要寫的是 TypeScript，不是 PHP。</p>
<h2 id="安裝外掛">安裝外掛</h2><hr>
<p>Angular 2 簡單的說就是 TypeScript + Angular 2 framework，所以必須先在 PhpStorm 安裝 TypeScript 與 Angular 2 外掛，令人振奮的是：這些外掛都是官方提供，是 JetBrains 為 WebStorm 與 PhpStorm 量身定做的。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>外掛只要裝一次即可，將來若有新版，PhpStorm 會自動提醒你更新。</span></span></span></p>
<h3 id="JavaScript_外掛">JavaScript 外掛</h3><hr>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup003.png" alt=""></p>
<p><strong><em> PhpStorm -&gt; Preferences -&gt; Plugins </em></strong></p>
<p>PhpStorm 在安裝時已經內建 <code>JavaScript Support</code> 外掛，支援 JavaScript 與 TypeScript。</p>
<p>輸入 <code>JavaScript</code>，確認 <code>JavaScript Support</code> 打勾。</p>
<h3 id="Node-js_外掛">Node.js 外掛</h3><hr>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup004.png" alt=""></p>
<p><strong><em> PhpStorm -&gt; Preferences -&gt; Plugins </em></strong></p>
<p>PhpStorm 在安裝時並沒有內建 <code>NodeJS</code> 外掛，必須手動安裝。</p>
<p>輸入 <code>node.js</code>，會找到 <code>NodeJS</code> 外掛，按 <code>Install</code> 安裝，注意這是 <strong> JetBrains </strong> 官方寫的外掛。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup005.png" alt=""></p>
<p>安裝完後，須按 <code>Restart PhpStorm</code> 重新啟動 PhpStorm，外掛才會生效。</p>
<h3 id="Angular_外掛">Angular 外掛</h3><hr>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup006.png" alt=""></p>
<p><strong><em> PhpStorm -&gt; Preferences -&gt; Plugins </em></strong></p>
<p>PhpStorm 在安裝時並沒有內建 <code>AngularJS</code> 外掛，必須手動安裝。</p>
<p>輸入 <code>AngularJS</code>，會找到 <code>AngularJS</code> 外掛，按 <code>Install</code> 安裝，注意這是 <strong> JetBrains </strong> 官方寫的外掛。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup007.png" alt=""></p>
<p>安裝完後，須按 <code>Restart PhpStorm</code> 重新啟動 PhpStorm，外掛才會生效。</p>
<h2 id="設定_TypeScript">設定 TypeScript</h2><hr>
<p>PhpStorm 預設並沒有啟動 TypeScript，必須自行設定。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>每個專案都要重新設定一次 TypeScript。</span></span></span></p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup008.png" alt=""></p>
<p><strong><em> PhpStorm -&gt; Preferences -&gt; Languages &amp; Frameworks -&gt; TypeScript </em></strong></p>
<p>將 <code>Enable TypeScript Compiler</code> 打勾。</p>
<p><strong> Node interpreter </strong> : 預設會自動抓到 NVM 所安裝的 Node.js 版本，可自行切換。<br><strong> Compiler version </strong> : PhpStorm 預設就有安裝 TypeScript 版本，可自行切換。<br><strong> Use tsconfig.json </strong> :  使用 <code>tsconfig.json</code> 做為 TypeScript 的設定檔。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup009.png" alt=""></p>
<p>TypeScript 設定完成後，下方會多出 <code>TypeScript Compiler</code>，將來任何編譯錯誤訊息都會顯示在此。</p>
<h2 id="新增_TypeScript_設定檔">新增 TypeScript 設定檔</h2><hr>
<p>剛剛已經設定 TypeScript 使用 <code>tsconfig.json</code>，現在就來建立 <code>tsconfig.json</code>。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup012.png" alt=""></p>
<p>按熱鍵 &#8984; + N，出現 <code>New</code> 選單，選擇 <code>tsconfig.json File</code>。</p>
<p><strong> tsconfig.json </strong> <span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Angular2Quickstart_demo/commit/dec4aac1fd8f4428d054aa4f39a157fde1d93c46" target="_blank" rel="external">新增 TypeScript 設定檔</a></span></span></span><br><figure class="highlight javascript"><figcaption><span>tsconfig.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="string">"target"</span>: <span class="string">"es5"</span>,</span><br><span class="line">    <span class="string">"module"</span>: <span class="string">"system"</span>,</span><br><span class="line">    <span class="string">"moduleResolution"</span>: <span class="string">"node"</span>,</span><br><span class="line">    <span class="string">"sourceMap"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"emitDecoratorMetadata"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"experimentalDecorators"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"removeComments"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"noImplicitAny"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"exclude"</span>: [</span><br><span class="line">    <span class="string">"node_modules"</span>,</span><br><span class="line">    <span class="string">"typings/main"</span>,</span><br><span class="line">    <span class="string">"typings/main.d.ts"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup013.png" alt=""></p>
<p>在專案根目錄新增 <code>tsconfig.json</code>。</p>
<h2 id="新增_typings-json">新增 typings.json</h2><hr>
<p>TypeScript 是強型別語言，若使用了傳統 JavaScript 函式庫，就必須再加上 <code>d.ts</code> 檔案描述其型別，供 TypeScript 編譯時使用。</p>
<p><code>typings.json</code> 就是統一描述 Angular 2 所需參考 <code>d.ts</code> 的地方。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup016.png" alt=""></p>
<p>按熱鍵 &#8984; + N，出現 <code>New</code> 選單，選擇 <code>File</code>。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup017.png" alt=""></p>
<p>檔名輸入 <code>typings.json</code>。</p>
<p><strong> typings.json </strong> <span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Angular2Quickstart_demo/commit/18351d0afcf330a9ea0d67401efff090a441ae1d" target="_blank" rel="external">新增 typings.json</a></span></span></span><br><figure class="highlight javascript"><figcaption><span>typings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"ambientDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"es6-shim"</span>: <span class="string">"github:DefinitelyTyped/DefinitelyTyped/es6-shim/es6-shim.d.ts#7de6c3dd94feaeb21f20054b9f30d5dabc5efabd"</span>,</span><br><span class="line">    <span class="string">"jasmine"</span>: <span class="string">"github:DefinitelyTyped/DefinitelyTyped/jasmine/jasmine.d.ts#5c182b9af717f73146399c2485f70f1e2ac0ff2b"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup018.png" alt=""></p>
<p>在專案根目錄新增 <code>typings.json</code>。</p>
<h2 id="安裝_Angular_2_與其相依套件">安裝 Angular 2 與其相依套件</h2><hr>
<p>除了 Angular 2 本身外，它還有很多相依的套件，須由 NPM 管理安裝。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup010.png" alt=""></p>
<p>按熱鍵 &#8984; + N，出現 <code>New</code> 選單，選擇 <code>package.json File</code>。</p>
<p><strong> package.json </strong> <span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Angular2Quickstart_demo/commit/18351d0afcf330a9ea0d67401efff090a441ae1d" target="_blank" rel="external">安裝 Angular 2 所相依的套件</a></span></span></span><br><figure class="highlight javascript"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"angular2-quickstart"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"start"</span>: <span class="string">"tsc &amp;&amp; concurrently \"npm run tsc:w\" \"npm run lite\" "</span>,</span><br><span class="line">    <span class="string">"lite"</span>: <span class="string">"lite-server"</span>,</span><br><span class="line">    <span class="string">"postinstall"</span>: <span class="string">"typings install"</span>,</span><br><span class="line">    <span class="string">"tsc"</span>: <span class="string">"tsc"</span>,</span><br><span class="line">    <span class="string">"tsc:w"</span>: <span class="string">"tsc -w"</span>,</span><br><span class="line">    <span class="string">"typings"</span>: <span class="string">"typings"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"angular2"</span>: <span class="string">"2.0.0-beta.16"</span>,</span><br><span class="line">    <span class="string">"systemjs"</span>: <span class="string">"0.19.26"</span>,</span><br><span class="line">    <span class="string">"es6-shim"</span>: <span class="string">"^0.35.0"</span>,</span><br><span class="line">    <span class="string">"reflect-metadata"</span>: <span class="string">"0.1.2"</span>,</span><br><span class="line">    <span class="string">"rxjs"</span>: <span class="string">"5.0.0-beta.2"</span>,</span><br><span class="line">    <span class="string">"zone.js"</span>: <span class="string">"0.6.12"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"concurrently"</span>: <span class="string">"^2.0.0"</span>,</span><br><span class="line">    <span class="string">"lite-server"</span>: <span class="string">"^2.2.0"</span>,</span><br><span class="line">    <span class="string">"typescript"</span>: <span class="string">"^1.8.10"</span>,</span><br><span class="line">    <span class="string">"typings"</span>:<span class="string">"^0.8.1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup014.png" alt=""></p>
<p>在專案根目錄新增 <code>package.json</code>。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup015.png" alt=""></p>
<p>選擇 <code>package.json</code>，按滑鼠右鍵，選擇 <code>Run &#39;npm install&#39;</code>。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup019.png" alt=""></p>
<p>PhpStorm 啟動 NPM 安裝相依套件。<span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>安裝 node 套件時，最低需求是不能看到 <code>ERR</code> 出現，有警告沒關係，嘗試更新 node.js 版本試試看。</span></span></span></p>
<h2 id="建立第一個_Component">建立第一個 Component</h2><hr>
<p>Angular 2 強調整個網頁都由 component 所構成，首先我們要先建立一個 component。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup020.png" alt=""></p>
<p>按熱鍵 &#8984; + N，出現 <code>New</code> 選單，選擇 <code>Directory</code>。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup021.png" alt=""></p>
<p>建立 <code>app</code> 目錄，統一將 TypeScript 程式碼放在 <code>app</code> 目錄下。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup022.png" alt=""></p>
<p>在 <code>app</code> 目錄下按熱鍵 &#8984; + N，出現 <code>New</code> 選單，選擇 <code>TypeScript file</code>。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup023.png" alt=""></p>
<p>檔名輸入 <code>app.component</code>。</p>
<p><strong> app.component.ts </strong> <span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/Angular2Quickstart_demo/commit/ca12ceba99825e3af73b71fb280c3b8279e5192e" target="_blank" rel="external">建立第一個 Component</a></span></span></span><br><figure class="highlight typescript"><figcaption><span>app/app.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component&#125; from <span class="string">'angular2/core'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">    selector: <span class="string">'my-app'</span>,</span><br><span class="line">    template: <span class="string">'&lt;h1&gt;My First Angular 2 App&lt;/h1&gt;'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123; &#125;</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup024.png" alt=""></p>
<p>在 <code>app</code> 目錄下建立 <code>app.component.ts</code>。</p>
<p>此為 TypeScript 語法，主要表示其 HTML tag 為 <code>my-app</code>，其所代表的 HTML 為 <code>&lt;h1&gt;My First Angular 2 App&lt;/h1&gt;</code>。</p>
<p>因為目前還沒有任何顯示邏輯，所以 <code>AppComponent</code> class 為空的。</p>
<p>特別注意左側 project 視窗，PhpStorm 已經在 <code>app.component.ts</code> 左側顯示 <code>TS</code> 圖示，表示 PhpStorm 已經認出副檔名為 <code>ts</code> 的 TypeScript。</p>
<p>此外，當存檔後，TypeScript 編譯器會自動編譯，並將相對應的 JavaScript 與 source map 產生在相同目錄下，不用擔心這樣會檔案很多很難管理，PhpStorm 很聰明的預設只會顯示 TypeScript 檔案，並不會顯示 JavaScript 與 source map 檔案，除非你去展開 TypeScript，才會出現 JavaScript 與 source map。</p>
<p>因為實務上其實只會去修改 TypeScript，並不會去修改 JavaScript 與 source map，所以 PhpStorm 很貼心的在 project 視窗只顯示 TypeScript 檔案。</p>
<p>下方 TypeScript 視窗會即時顯示出編譯結果。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup025.png" alt=""></p>
<p>若故意將 <code>AppComponent</code> 的右 <code>}</code> 刪除，存檔後馬上出現編譯錯誤，訊息會顯示在下方 TypeScript 視窗。</p>
<h2 id="建立_Angular_2_啟動檔">建立 Angular 2 啟動檔</h2><hr>
<p>Angular 2 需要一個程式的起動點，就類似 C 語言的 <code>main()</code> 一樣，<code>main.ts</code> 就是扮演起動 Angular 2 的角色。</p>
<p><strong> main.ts </strong> <span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>GitHub Commit : <a href="https://github.com/oomusou/Angular2Quickstart_demo/commit/df884e5ff97f0d95ce257156f95b7b449dac3ba2" target="_blank" rel="external">建立 Angular 2 的啟動檔</a></span></span></span><br><figure class="highlight typescript"><figcaption><span>app/main.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;bootstrap&#125;    from <span class="string">'angular2/platform/browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;AppComponent&#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"></span><br><span class="line">bootstrap(AppComponent);</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup026.png" alt=""></p>
<p>在 <code>app</code> 目錄下建立 <code>main.ts</code>。</p>
<p>第 1 行<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;bootstrap&#125; from <span class="string">'angular2/platform/browser'</span></span><br></pre></td></tr></table></figure></p>
<p>載入 <code>angular2/platform/browser</code>，表示 Angular 2 跑在瀏覽器平台，此外，Angular 2 還可以跑在 <code>Apache Cordova</code> 與 <code>Native</code> 平台，    只要 import 不同 <code>bootstrap</code> 即可。</p>
<p>第 2 行<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;AppComponent&#125; from <span class="string">'./app.component'</span></span><br></pre></td></tr></table></figure></p>
<p>載入我們剛剛建立的 <code>app.component.ts</code>。</p>
<p>第 4 行<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootstrap(AppComponent);</span><br></pre></td></tr></table></figure></p>
<p>啟動我們剛剛建立的 <code>app.component.ts</code>。</p>
<h2 id="建立_HTML">建立 HTML</h2><hr>
<p>接著我們要建立 <code>index.html</code>，並將我們建立 <code>&lt;my-app&gt;&lt;/my-app&gt;</code> component 放進 HTML中。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup027.png" alt=""></p>
<p>按熱鍵 &#8984; + N，出現 <code>New</code> 選單，選擇 <code>HTML file</code>。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup028.png" alt=""></p>
<p>檔名輸入 <code>index</code>。</p>
<p><strong> index.html </strong> <span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Angular2Quickstart_demo/commit/6b92f0feaa80087fb8a1e35dcd6e4536352bc0c2" target="_blank" rel="external">建立 HTML</a></span></span></span><br><figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">title</span>&gt;</span>Angular 2 QuickStart<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">name</span>=<span class="value">"viewport"</span> <span class="attribute">content</span>=<span class="value">"width=device-width, initial-scale=1"</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">href</span>=<span class="value">"styles.css"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 1. Load libraries --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- IE required polyfills, in this exact order --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/es6-shim/es6-shim.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/systemjs/dist/system-polyfills.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/angular2/es6/dev/src/testing/shims_for_IE.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>   </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/angular2/bundles/angular2-polyfills.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/systemjs/dist/system.src.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/rxjs/bundles/Rx.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/angular2/bundles/angular2.dev.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2. Configure SystemJS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript"></span><br><span class="line">      System.config(&#123;</span><br><span class="line">        packages: &#123;        </span><br><span class="line">          app: &#123;</span><br><span class="line">            format: <span class="string">'register'</span>,</span><br><span class="line">            defaultExtension: <span class="string">'js'</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      System.import(<span class="string">'app/main'</span>)</span><br><span class="line">            .then(<span class="literal">null</span>, <span class="built_in">console</span>.error.bind(<span class="built_in">console</span>));</span><br><span class="line">    </span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 3. Display the application --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">my-app</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="title">my-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup029.png" alt=""></p>
<p>在專案根目錄新增 <code>index.html</code>。</p>
<p>第 7 行<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1. Load libraries --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- IE required polyfills, in this exact order --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/es6-shim/es6-shim.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/systemjs/dist/system-polyfills.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/angular2/es6/dev/src/testing/shims_for_IE.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>   </span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/angular2/bundles/angular2-polyfills.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/systemjs/dist/system.src.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/rxjs/bundles/Rx.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"node_modules/angular2/bundles/angular2.dev.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>載入 Angular 2 所需要的 JavaScript。</p>
<p>18 行<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="number">2.</span> Configure SystemJS --&gt;</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript"></span><br><span class="line">    System.config(&#123;</span><br><span class="line">        packages: &#123;</span><br><span class="line">            app: &#123;</span><br><span class="line">                format: <span class="string">'register'</span>,</span><br><span class="line">                defaultExtension: <span class="string">'js'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.import(<span class="string">'app/main'</span>)</span><br><span class="line">            .then(<span class="literal">null</span>, <span class="built_in">console</span>.error.bind(<span class="built_in">console</span>));</span><br><span class="line"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>設定 SystemJS。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup032.png" alt=""></p>
<p>在 <code>index.html</code> 輸入 <code>&lt;my-</code>，已經可以顯示 <code>my-app</code>，顯示 PhpStorm 已經可以抓到 Angular 2 的 component。</p>
<h2 id="在瀏覽器顯示">在瀏覽器顯示</h2><hr>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup030.png" alt=""></p>
<p>在 <code>index.html</code> 點擊右上角的瀏覽器圖示，選擇要顯示的瀏覽器。</p>
<p><img src="/images/angular2/angular2-phpstorm-setup/setup031.png" alt=""></p>
<p>若能顯示 <code>My First Angular 2 App</code>，表示 Angular 2 已經正常啟動，若出現 <code>loading</code>，則表示 Angular 2 啟動失敗。</p>
<p>PhpStorm 有內建 Http Server，因此不用另外啟動其他 Http Server就可以正確執行 Angular 2。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>PhpStorm 對於 TypeScript 與 Angular 2 支援完整，除了支援 TypeScript 與 Angular 2 的語法提示外，也可以抓到 Angular 2 的 component。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Angular2Quickstart_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[PhpStorm 也支援 TypeScript 與 Angular 2]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何判斷 Collection 的元素是否重複?]]></title>
    <link href="http://oomusou.io/laravel/collection/collection-duplicated/"/>
    <id>http://oomusou.io/laravel/collection/collection-duplicated/</id>
    <published>2016-04-26T12:23:43.000Z</published>
    <updated>2016-04-26T07:40:16.000Z</updated>
    <content type="html"><![CDATA[<p>實務上遇到的問題，不過 Collection 似乎沒有內建方法可用，需動用一點小技巧。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>Laravel 5.2.30</p>
<h2 id="Collection_包含重複元素">Collection 包含重複元素</h2><hr>
<p><strong> CollectionTest.php </strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52CollectionIsDuplicatedElement/commit/36e5ace382f465362dbb45a6859c53d2b4a9468c" target="_blank" rel="external">單元測試 : Collection 含有重複 Element</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/CollectionTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">CollectionDemo</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Collection</span>含有重複<span class="title">Element</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$fake</span> = collect([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">        <span class="variable">$target</span> = App::make(CollectionDemo::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;hasDuplicated(<span class="variable">$fake</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertTrue(<span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第 9 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$fake</span> = collect([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br></pre></td></tr></table></figure></p>
<p>特別設計含有重複元素的 collection，<code>1</code> 為重複元素。</p>
<p><strong> CollectionDemo.php </strong><span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52CollectionIsDuplicatedElement/commit/0d6422204c18ffa3714ba1c03765d157a20fd8fb" target="_blank" rel="external">判斷 Collection 是否含有重複 Element</a></span></span></span><br><figure class="highlight php"><figcaption><span>Services/CollectionDemo.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionDemo</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> Collection $cols</span><br><span class="line">     * <span class="doctag">@return</span> bool</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasDuplicated</span><span class="params">(Collection <span class="variable">$cols</span>)</span> : <span class="title">bool</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="variable">$cols</span>-&gt;count() != <span class="variable">$cols</span>-&gt;unique()-&gt;count());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 collection 內建的 <code>unique()</code>，它會傳回一個沒有重複的新 collection。</p>
<p>若兩個 collection 的 <code>count()</code> 不一樣，表示此 collection 必含重複元素。</p>
<h2 id="元素重複於_Collection_內">元素重複於 Collection 內</h2><hr>
<p><strong> CollectionTest.php </strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52CollectionIsDuplicatedElement/commit/90d3c8384718519baa0843c902370bbddf3c18c0" target="_blank" rel="external">單元測試 : Element 在 Collection 內重複</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/CollectionTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">CollectionDemo</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Element</span>在<span class="title">Collection</span>內重複<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$fake</span> = collect([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">        <span class="variable">$target</span> = App::make(CollectionDemo::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;isDuplicated(<span class="variable">$fake</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertTrue(<span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>12 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;isDuplicated(<span class="variable">$fake</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>
<p>第一個參數傳入 collection，第二個參數傳入元素，判斷此元素是否在 collection 內重複。</p>
<p><strong> CollectionDemo.php </strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52CollectionIsDuplicatedElement/commit/5f7a52d98252f01ceb24c89c74c98f255daf57d3" target="_blank" rel="external">判斷 Element 是否重複於 Collection</a></span></span></span><br><figure class="highlight php"><figcaption><span>Services/CollectionDemo.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionDemo</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> Collection $cols</span><br><span class="line">     * <span class="doctag">@param</span> int $element</span><br><span class="line">     * <span class="doctag">@return</span> bool</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isDuplicated</span><span class="params">(Collection <span class="variable">$cols</span>, int <span class="variable">$element</span>)</span> : <span class="title">bool</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$cnt</span> = <span class="variable">$cols</span>-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(int <span class="variable">$value</span>)</span> <span class="title">use</span> <span class="params">(<span class="variable">$element</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="variable">$value</span> === <span class="variable">$element</span>);</span><br><span class="line">        &#125;)-&gt;count();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="variable">$cnt</span> &gt; <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 使用 collection 內建的 <code>filter()</code>，傳入一個 closure，filter 出符合傳入元素值的新 collection。</p>
<p> 若新 collection 的 <code>count()</code> 大於 <code>1</code>，表示重複了。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Laravel 的 collection 相當好用，若能用的巧，可以幾乎完全不用寫 <code>for</code> 或 <code>foreach</code>，程式相當精簡。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52CollectionIsDuplicatedElement" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[判斷 Collection 元素是否重複的小技巧]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 Laravel Elixir + Browsersync 自動刷新瀏覽器?]]></title>
    <link href="http://oomusou.io/laravel/elixir/elixir-browsersync/"/>
    <id>http://oomusou.io/laravel/elixir/elixir-browsersync/</id>
    <published>2016-04-25T15:23:43.000Z</published>
    <updated>2016-04-28T01:25:37.000Z</updated>
    <content type="html"><![CDATA[<p>由於 HTML/CSS 技術越來越複雜，如 Dreamweaver 那種所見即所得的工具已經很難全面支援 HTML/CSS，所以前端開發取而代之的是文字編輯器配合 Emmet，然後直接在瀏覽器預覽，此時如 Browsersync 就非常方便。Laravel Elixir 3.3 之後直接支援 Browsersync，讓我們只要直接存檔就可以立即在瀏覽器看結果。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Laravel 5.2.30<br>Laravel Elixir 5.0.0</p>
<h2 id="Prerequisite">Prerequisite</h2><hr>
<ul>
<li>在 OS X 已經成功安裝 Node.js、NPM 與 Gulp。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>詳細請參考<a href="/laravel/elixir/elixir-nodejs/">如何在 OS X 安裝 Laravel 前端開發環境?</a></span></span></span></li>
</ul>
<h2 id="安裝_Laravel_Elixir">安裝 Laravel Elixir</h2><hr>
<p>Gulp 可以幫我們做一些前端的自動化工作，如自動編譯 Less 與 Saas，Babel 自動編譯 JavaScript ES6，自動執行 PHPUnit…等。</p>
<p>Laravel Elixir 是 Laravel 對 Gulp 的再次封裝，讓我們可以更簡單地在 Laravel 使用 Gulp。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>詳細請參考<a href="http://laravel.com/docs/master/elixir" target="_blank" rel="external">Laravel Elixir</a></span></span></span></p>
<p>在使用 Composer 建立 Laravel 專案時，會自動安裝後端的 <code>composer.json</code> 內的 PHP package，但卻沒有自動安裝前端的 <code>package.json</code> 內的 Node package，需自行手動安裝。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ npm install</span><br></pre></td></tr></table></figure>
<p><img src="/images/laravel/elixir/elixir-browsersync/browsersync000.png" alt=""></p>
<p>使用 NPM 安裝 Laravel elixir。</p>
<h2 id="測試_Laravel_Elixir">測試 Laravel Elixir</h2><hr>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ gulp</span><br></pre></td></tr></table></figure>
<p><img src="/images/laravel/elixir/elixir-browsersync/browsersync001.png" alt=""></p>
<p>若能看到以上畫面，表示 Laravel Elixer 已經正常執行，可順利編譯 Saas。</p>
<h2 id="修改_gulpfile-js">修改 gulpfile.js</h2><hr>
<p><strong> gulpfile.js </strong> <span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52ElixirBrowserSync_demo/commit/87de4f3afcda27fd54b8b3fe3f3d38210c79ff92" target="_blank" rel="external">修改 gulpfile.js，啟動 Browsersync</a></span></span></span><br><figure class="highlight javascript"><figcaption><span>gulpfile.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> elixir = <span class="built_in">require</span>(<span class="string">'laravel-elixir'</span>);</span><br><span class="line"></span><br><span class="line">elixir(<span class="function"><span class="keyword">function</span> (<span class="params">mix</span>) </span>&#123;</span><br><span class="line">    mix.sass(<span class="string">'app.scss'</span>);</span><br><span class="line"></span><br><span class="line">    mix.browserSync(&#123;</span><br><span class="line">        files: [<span class="string">'app/**/*'</span>, <span class="string">'public/**/*'</span>, <span class="string">'resources/views/**/*'</span>],</span><br><span class="line">        port: <span class="number">5000</span>,</span><br><span class="line">        proxy: <span class="string">'localhost:8000'</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/laravel/elixir/elixir-browsersync/browsersync002.png" alt=""></p>
<p>啟動 Browsersync，若將來對 PHP、blade 或 JavaScript 有任何修改，只要存檔就會在瀏覽器自動更新。</p>
<ul>
<li><strong> files </strong> : 設定監視哪些檔案一變更，就要啟動 Browsersync。</li>
<li><strong> port </strong> : 設定 Browsersync 所使用的 port。</li>
<li><strong> proxy </strong> : 指定到 8000，因為 PHP 內建 Http server 為 8000。</li>
</ul>
<h2 id="啟動_Http_Server">啟動 Http Server</h2><hr>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan serve --host 0.0.0.0</span><br></pre></td></tr></table></figure>
<p><img src="/images/laravel/elixir/elixir-browsersync/browsersync003.png" alt=""></p>
<p>使用 PHP 內建的 Http server。</p>
<h2 id="啟動_Gulp_Watch">啟動 Gulp Watch</h2><hr>
<p>Gulp 會在背景執行，持續監視檔案，只要一變更，就會重新執行 Gulp。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ gulp watch</span><br></pre></td></tr></table></figure>
<p><img src="/images/laravel/elixir/elixir-browsersync/browsersync004.png" alt=""></p>
<p>Gulp watch 必須在新的 process 執行，也就是必須有一個 process 執行 <code>php artisan serve</code>，一個 process 執行 <code>gulp watch</code>。</p>
<h2 id="自動啟動瀏覽器">自動啟動瀏覽器</h2><hr>
<p><img src="/images/laravel/elixir/elixir-browsersync/browsersync005.png" alt=""></p>
<p>Laravel 將執行在 <code>localhost:5000</code>。</p>
<p>將來修改 PHP、blade 或 JavaScript，只要存檔後，瀏覽器就會自動更新，不用再手動 refersh。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>有了 Laravel Elixir + Browsersync ，以後我們有任何修改，就不用再一直手動 refresh 看結果了，若搭配雙螢幕更為方便。</li>
<li>這種方式在 Windows 也可以使用，不侷限在 OS X，只要在 Windows 也裝好 Node.js、NPM 與 Gulp 即可。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52ElixirBrowserSync_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[Laravel Elixir 3.3 開始支援 Browsersync]]>
    
    </summary>
    
      <category term="Browsersync" scheme="http://oomusou.io/tags/Browsersync/"/>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="Laravel Elixir" scheme="http://oomusou.io/tags/Laravel-Elixir/"/>
    
  </entry>
  
</feed>
