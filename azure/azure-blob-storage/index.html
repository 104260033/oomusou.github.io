<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>如何在 Azure 使用 Laravel + Blob Storage? | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="利用 Azure SDK for PHP 使用 Azure 服務">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="利用 Azure SDK for PHP 使用 Azure 服務">
<meta property="og:type" content="article">
<meta property="og:title" content="如何在 Azure 使用 Laravel + Blob Storage?">
<meta property="og:url" content="http://oomusou.io/azure/azure-blob-storage/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="利用 Azure SDK for PHP 使用 Azure 服務">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2016-08-15T02:32:10.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何在 Azure 使用 Laravel + Blob Storage?">
<meta name="twitter:description" content="利用 Azure SDK for PHP 使用 Azure 服務">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 如何在 Azure 使用 Laravel + Blob Storage?</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 利用 Azure SDK for PHP 使用 Azure 服務			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Blob_Storage_簡介"><span class="toc-article-text">Blob Storage 簡介</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Blob_Storage_應用"><span class="toc-article-text">Blob Storage 應用</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Blob_Storage_概念"><span class="toc-article-text">Blob Storage 概念</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#建立_Azure_Storage_Account"><span class="toc-article-text">建立 Azure Storage Account</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#安裝_Azure_SDK_for_PHP"><span class="toc-article-text">安裝 Azure SDK for PHP</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#建立_Azure_Storage_連接字串"><span class="toc-article-text">建立 Azure Storage 連接字串</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#建立_Container"><span class="toc-article-text">建立 Container</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#建立_Blob"><span class="toc-article-text">建立 Blob</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#顯示所有_Blob"><span class="toc-article-text">顯示所有 Blob</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#下載_Blob"><span class="toc-article-text">下載 Blob</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#刪除_Blob"><span class="toc-article-text">刪除 Blob</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#刪除_Container"><span class="toc-article-text">刪除 Container</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Reference"><span class="toc-article-text">Reference</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>除了關聯式資料庫外，實務上我們常需要將<strong>文字檔</strong>或<strong>二進位檔</strong> (圖片檔或影音檔) 上傳到雲端，並提供下載，此時我們可以使用 Azure 的 Blob Storage 儲存這類型的檔案。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.8<br>Laravel 5.2.43<br>PhpStorm 2016.2</p>
<h2 id="Blob_Storage_簡介">Blob Storage 簡介</h2><hr>
<ul>
<li>在雲端中儲存檔案的服務，可儲存任何類型的檔案，包含文字檔與二進位檔。</li>
<li>全球任何地方都可透過 HTTP 或 HTTPS 來存取這些資料。您可以使用 Blob Storage 向全球公開資料，或私下儲存應用程式資料。</li>
</ul>
<h2 id="Blob_Storage_應用">Blob Storage 應用</h2><hr>
<ul>
<li>瀏覽器所需的圖片或文件。</li>
<li>檔案的分散式存取。</li>
<li>視訊和音訊的串流傳輸。</li>
<li>檔案備份、歸檔。</li>
</ul>
<h2 id="Blob_Storage_概念">Blob Storage 概念</h2><hr>
<p><img src="/images/azure/azure-blob-storage/blob018.jpg" alt=""></p>
<ul>
<li>Account<ul>
<li>需透過 Account 存取 Container 與 Blob。</li>
</ul>
</li>
<li>Container<ul>
<li>放置 Blob 的地方，類似檔案的<strong>資料夾</strong>。</li>
<li>必須以<strong>小寫</strong>命名。</li>
</ul>
</li>
<li>Blob<ul>
<li>任何類型的檔案。</li>
</ul>
</li>
</ul>
<h2 id="建立_Azure_Storage_Account">建立 Azure Storage Account</h2><hr>
<p>要使用 Azure Blob Storage，首先必須登入 <a href="https://portal.azure.com" target="_blank" rel="external">Azure portal</a>，建立 storage account 。</p>
<p><img src="/images/azure/azure-blob-storage/blob001.png" alt=""></p>
<p><strong><em>New -&gt; Data + Storage -&gt; Storage account</em></strong></p>
<p><img src="/images/azure/azure-blob-storage/blob002.png" alt=""></p>
<ul>
<li><strong>Name</strong> : 輸入 storage account 名稱。</li>
<li><strong>Resource Manager</strong> : 選擇 <code>Resource manager</code>。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>關於 <code>Resource manager</code> 與 <code>classic</code> 的差異，詳細請參考 Tom FitzMacken, <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-manager-deployment-model/" target="_blank" rel="external">Azure Resource Manager vs. classic deployment: Understand deployment models and the state of your resources</a></span></span></span></li>
<li><strong>Account Kind</strong> : 選擇 <code>Blob storage</code>。</li>
<li><strong>Replication</strong> : 選擇最基本的 <code>Locally-redundant storage (LRS)</code> 即可。</li>
<li><strong>Access Tier</strong> : 選擇 <code>Hot</code>。</li>
</ul>
<div class="alert alert-info"><i class="fa fa-info"></i>  Replication 快速整理</div>
<ul>
<li>Azure 會自動為 storage account 的資料都會進行 replication，確保資料的持久性與高可用性。</li>
<li><p>提供了 4 種 replication 機制 :<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>關於 replication，詳細請參考 Tamra Myers, <a href="https://azure.microsoft.com/en-us/documentation/articles/storage-redundancy/#locally-redundant-storage" target="_blank" rel="external">Azure Storage replication</a></span></span></span></p>
<ol>
<li><strong>Locally redundant storage (LRS)</strong> : 提供本機備援。</li>
<li><strong>Zone-redundant storage (ZRS)</strong> : 提供區域備援。</li>
<li><strong>Geo-redundant storage (GRS)</strong> : 提供異地備援。</li>
<li><strong>Read-access geo-redundant storage (RA-GRS)</strong> : 提供讀取權限的異地備援。</li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Replication</th>
<th style="text-align:center">LRS</th>
<th style="text-align:center">ZRS</th>
<th style="text-align:center">GRS</th>
<th style="text-align:center">RA-GRS</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">可跨多個設備複寫</td>
<td style="text-align:center">No</td>
<td style="text-align:center">Yes</td>
<td style="text-align:center">Yes</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left">可從次要位置及主要位置讀取資料</td>
<td style="text-align:center">No</td>
<td style="text-align:center">No</td>
<td style="text-align:center">No</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left">可在不同的節點上維護的資料副本數量</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
<td style="text-align:center">6</td>
<td style="text-align:center">6</td>
</tr>
</tbody>
</table>
<div class="alert alert-info"><i class="fa fa-info"></i>  Access Tier 快速整理</div>
<p>預設為 <code>Hot</code>。</p>
<p><strong>用途</strong></p>
<ul>
<li><strong>Hot</strong> : 適合經常讀、寫的檔案，例如 : 圖檔、文件等。</li>
<li><strong>Cool</strong> : 適合備份檔案，或不常使用之檔案。</li>
</ul>
<p><strong>價格</strong></p>
<ul>
<li><strong>Hot</strong> : 儲存空間費用較高、存取與交易成本較低。</li>
<li><strong>Cool</strong> : 儲存空間費用較低、存取與交易成本較高。</li>
</ul>
<p><img src="/images/azure/azure-blob-storage/blob003.png" alt=""></p>
<ul>
<li><strong>Resource Group</strong> : 可以新建 group，也可以使用目前既有 group，使用 group 的優點是方便管理，若要刪除可以整個 group 一起刪除。</li>
<li><strong>Location</strong> : 選擇離我們最近的 <code>East Asia</code>。</li>
</ul>
<p>按 <code>Create</code> 開始建立 storage account。</p>
<p><img src="/images/azure/azure-blob-storage/blob004.png" alt=""></p>
<p>成功建立 storage account 後，可以在儀表板看到。</p>
<h2 id="安裝_Azure_SDK_for_PHP">安裝 Azure SDK for PHP</h2><hr>
<p>Azure 提供了 <a href="https://github.com/Azure/azure-sdk-for-php" target="_blank" rel="external">Azure SDK for PHP</a>，讓我們可以在 PHP 輕鬆地使用 Azure 服務，由於使用了 Composer 管理套件，所以不單 Laravel 可使用，其他 PHP framework 也可以使用。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/efde1a2fbfa266f483e46b668beb93de2099390a" target="_blank" rel="external">安裝 Azure SDK for PHP</a></span></span></span></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ composer require microsoft/windowsazure</span><br></pre></td></tr></table></figure>
<p><img src="/images/azure/azure-blob-storage/blob000.png" alt=""></p>
<h2 id="建立_Azure_Storage_連接字串">建立 Azure Storage 連接字串</h2><hr>
<p>剛剛雖然在 <a href="https://portal.azure.com" target="_blank" rel="external">Azure portal</a> 建立了 storage account，但 Laravel 還是不知道該如何連上 Azure Storage，我們還必須在 Laravel 建立連接字串，才能存取 Container 與 Blob。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DefaultEndpointsProtocol=[http|https];AccountName=[yourAccount];AccountKey=[yourKey]</span><br></pre></td></tr></table></figure>
<p>Azure Storage 連接字串的格式需包含幾個部分 :</p>
<ul>
<li><strong>DefaultEndpointsProtocol</strong> : 選擇 <code>http</code> 或 <code>https</code>。</li>
<li><strong>AccountName</strong> : Azure Storage account 名稱。</li>
<li><strong>AccountKey</strong> : Azure Storage account 的 key。</li>
</ul>
<div class="alert alert-info"><i class="fa fa-info"></i>  AccountName 與 AccountKey 該填什麼呢?</div>
<p><img src="/images/azure/azure-blob-storage/blob005.png" alt=""></p>
<p><strong><em>Settings -&gt; General -&gt; Access Keys</em></strong></p>
<p><img src="/images/azure/azure-blob-storage/blob006.png" alt=""></p>
<ul>
<li><code>Storage account name</code> 即為連接字串的 <code>AccountName</code>。</li>
<li><code>key1</code> 即為連接字串的 <code>AccountKey</code>。</li>
</ul>
<p><img src="/images/azure/azure-blob-storage/blob007.png" alt=""></p>
<p>在 Laravel 的 <code>.env</code> 建立以 <code>AZURE_STORAGE</code> 為 key 的連接字串。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/9f84f40aef236c30d16beb8f37311b646a1b02c1" target="_blank" rel="external">建立 Azure Storage 連接字串</a></span></span></span></p>
<h2 id="建立_Container">建立 Container</h2><hr>
<p>以 TDD 方式使用 <a href="https://github.com/Azure/azure-sdk-for-php" target="_blank" rel="external">Azure SDK for PHP</a>。</p>
<p><strong>AzureBlobServiceUnitTest.php</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/325d35d15c8f6b0c31d0a6eb46f7ba24bacdc0dd" target="_blank" rel="external">單元測試 : 建立 Container</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/AzureBlobServiceUnitTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">AzureBlobService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobServiceUnitTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AzureBlobService */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = App::make(AzureBlobService::class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 建立<span class="title">Container</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;createContainer(<span class="variable">$containerName</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第 5 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> AzureBlobService */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">parent</span>::setUp();</span><br><span class="line">    <span class="variable">$this</span>-&gt;target = App::make(AzureBlobService::class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由 <code>AzureBlobService</code> 建立待測試的 <code>$target</code> 物件。</p>
<p>14 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 建立<span class="title">Container</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">    <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;createContainer(<span class="variable">$containerName</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">    <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>Arrange</strong> : 由於不需要 mock 與假資料，所以 <code>arrange</code> 部分暫時從缺。</li>
<li><strong>Act</strong> : 建立待測 method <code>createContainer()</code>，傳入 Container 名稱。</li>
<li><strong>Assert</strong> : 期望建立 Container 成功傳回 <code>true</code>。</li>
</ul>
<p><strong>AzureBlobService.php</strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/10905247074a251dc711573af1287b11310a72f0" target="_blank" rel="external">建立 Container</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AzureBlobService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Blob</span>\<span class="title">Internal</span>\<span class="title">IBlob</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Common</span>\<span class="title">ServiceException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">WindowsAzure</span>\<span class="title">Common</span>\<span class="title">ServicesBuilder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$storageConnectionString</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> IBlob */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blobProxy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AzureBlobService constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;storageConnectionString = env(<span class="string">'AZURE_STORAGE'</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy = ServicesBuilder::getInstance()-&gt;createBlobService(<span class="variable">$this</span>-&gt;storageConnectionString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 建立 Container</span><br><span class="line">     * <span class="doctag">@param</span> string $containerName</span><br><span class="line">     * <span class="doctag">@return</span> bool</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainer</span><span class="params">(string <span class="variable">$containerName</span>)</span> : <span class="title">bool</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;blobProxy-&gt;createContainer(<span class="variable">$containerName</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第 9 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$storageConnectionString</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@var</span> IBlob */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$blobProxy</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * AzureBlobService constructor.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;storageConnectionString = env(<span class="string">'AZURE_STORAGE'</span>);</span><br><span class="line">    <span class="variable">$this</span>-&gt;blobProxy = ServicesBuilder::getInstance()-&gt;createBlobService(<span class="variable">$this</span>-&gt;storageConnectionString);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由 <code>env()</code> 讀取剛剛在 <code>.env</code> 建立的 <code>AZURE_STORAGE</code> 連接字串。</p>
<p>由 <a href="https://github.com/Azure/azure-sdk-for-php" target="_blank" rel="external">Azure SDK for PHP</a> 所提供的 <code>ServiceBuilder::getInstance()</code> 的 <code>createBlobService()</code> 在本機建立 <code>$blobProxy</code> 物件，傳入 Azure Storage 連接字串。</p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 建立 Container</span><br><span class="line"> * <span class="doctag">@param</span> string $containerName</span><br><span class="line"> * <span class="doctag">@return</span> bool</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainer</span><span class="params">(string <span class="variable">$containerName</span>)</span> : <span class="title">bool</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy-&gt;createContainer(<span class="variable">$containerName</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>透過 <code>$blobProxy</code> 物件的 <code>createContainer()</code> 建立 Container。</p>
<p>若 Container 建立失敗 (如重複建立 Container )，將丟出 <code>ServiceException</code>。</p>
<p><img src="/images/azure/azure-blob-storage/blob008.png" alt=""></p>
<p>測試 <span class="label label-success">綠燈</span>，建立 Container 成功。</p>
<p><img src="/images/azure/azure-blob-storage/blob009.png" alt=""></p>
<p>在 <a href="https://portal.azure.com" target="_blank" rel="external">Azure portal</a> 也能看到剛剛所建立的 Container。</p>
<h2 id="建立_Blob">建立 Blob</h2><hr>
<p><strong>AzureBlobServiceUnitTest.php</strong><span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/0b913cd4c94a98a84c4d7a362fcabdcfb62389fd" target="_blank" rel="external">單元測試 : 建立 Blob</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/AzureBlobServiceUnitTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">AzureBlobService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobServiceUnitTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AzureBlobService */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = App::make(AzureBlobService::class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 建立<span class="title">Blob</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">        <span class="variable">$blobName</span> = <span class="string">'myblob'</span>;</span><br><span class="line">        <span class="variable">$content</span> = fopen(<span class="keyword">__DIR__</span> . <span class="string">'/blob.txt'</span>, <span class="string">'r'</span>);</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;createBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>, <span class="variable">$content</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>14 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 建立<span class="title">Blob</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">    <span class="variable">$blobName</span> = <span class="string">'myblob'</span>;</span><br><span class="line">    <span class="variable">$content</span> = fopen(<span class="keyword">__DIR__</span> . <span class="string">'/blob.txt'</span>, <span class="string">'r'</span>);</span><br><span class="line">    <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;createBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>, <span class="variable">$content</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">    <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>Arrange</strong> : 由於不需要 mock 與假資料，所以 <code>arrange</code> 部分暫時從缺。</li>
<li><strong>Act</strong> : 建立待測 method <code>createBlob()</code>，傳入 Container 名稱、Blob 名稱與上傳物件。</li>
<li><strong>Assert</strong> : 期望建立 Blob 成功傳回 <code>true</code>。</li>
</ul>
<p><strong>AzureBlobService.php</strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/c9345c5b913c082588e55fe080b2bf8f0c545d17" target="_blank" rel="external">建立 Blob</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AzureBlobService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Blob</span>\<span class="title">Internal</span>\<span class="title">IBlob</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Common</span>\<span class="title">ServiceException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">WindowsAzure</span>\<span class="title">Common</span>\<span class="title">ServicesBuilder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$storageConnectionString</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> IBlob */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blobProxy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AzureBlobService constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;storageConnectionString = env(<span class="string">'AZURE_STORAGE'</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy = ServicesBuilder::getInstance()-&gt;createBlobService(<span class="variable">$this</span>-&gt;storageConnectionString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 建立 Blob</span><br><span class="line">     * <span class="doctag">@param</span> string $containerName</span><br><span class="line">     * <span class="doctag">@param</span> string $blobName</span><br><span class="line">     * <span class="doctag">@param</span> $content</span><br><span class="line">     * <span class="doctag">@return</span> bool</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createBlob</span><span class="params">(string <span class="variable">$containerName</span>, string <span class="variable">$blobName</span>, <span class="variable">$content</span>)</span> : <span class="title">bool</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;blobProxy-&gt;createBlockBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>, <span class="variable">$content</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 建立 Blob</span><br><span class="line"> * <span class="doctag">@param</span> string $containerName</span><br><span class="line"> * <span class="doctag">@param</span> string $blobName</span><br><span class="line"> * <span class="doctag">@param</span> $content</span><br><span class="line"> * <span class="doctag">@return</span> bool</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createBlob</span><span class="params">(string <span class="variable">$containerName</span>, string <span class="variable">$blobName</span>, <span class="variable">$content</span>)</span> : <span class="title">bool</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy-&gt;createBlockBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>, <span class="variable">$content</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>透過 <code>$blobProxy</code> 物件的 <code>createBlockBlob()</code> 建立 Blob。</p>
<p>若 Blob 建立失敗，將丟出 <code>ServiceException</code>。</p>
<p><img src="/images/azure/azure-blob-storage/blob010.png" alt=""></p>
<p>測試 <span class="label label-success">綠燈</span>，建立 Container 成功。</p>
<p><img src="/images/azure/azure-blob-storage/blob011.png" alt=""></p>
<p>在 <a href="https://portal.azure.com" target="_blank" rel="external">Azure portal</a> 也能看到剛剛所建立的 Blob。</p>
<h2 id="顯示所有_Blob">顯示所有 Blob</h2><hr>
<p><strong>AzureBlobServiceUnitTest.php</strong><span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/43cf30577d4f981439b24c1c57be268fba270067" target="_blank" rel="external">單元測試 : 顯示所有 Blob</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/AzureBlobServiceUnitTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">AzureBlobService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobServiceUnitTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AzureBlobService */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = App::make(AzureBlobService::class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 顯示所有<span class="title">Blob</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;listAllBlobs(<span class="variable">$containerName</span>)-&gt;all();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = [</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'myblob'</span>, <span class="string">'url'</span>  =&gt; <span class="string">'https://laravel52blobstorage.blob.core.windows.net/mycontainer/myblob'</span>]</span><br><span class="line">        ];</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>14 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 顯示所有<span class="title">Blob</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">    <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;listAllBlobs(<span class="variable">$containerName</span>)-&gt;all();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    <span class="variable">$expected</span> = [</span><br><span class="line">        [<span class="string">'name'</span> =&gt; <span class="string">'myblob'</span>, <span class="string">'url'</span>  =&gt; <span class="string">'https://laravel52blobstorage.blob.core.windows.net/mycontainer/myblob'</span>]</span><br><span class="line">    ];</span><br><span class="line">    <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>Arrange</strong> : 由於不需要 mock 與假資料，所以 <code>arrange</code> 部分暫時從缺。</li>
<li><strong>Act</strong> : 建立待測 method <code>listAllBlobs()</code>，傳入 Container 名稱。</li>
<li><strong>Assert</strong> : 建立期望回傳的的陣列做 assertion。</li>
</ul>
<p><strong>AzureBlobService.php</strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/ec3b356bc8f55d5b1a8bf0b2d25f667aa126b257" target="_blank" rel="external">顯示所有 Blob</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AzureBlobService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Blob</span>\<span class="title">Internal</span>\<span class="title">IBlob</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Common</span>\<span class="title">ServiceException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">WindowsAzure</span>\<span class="title">Common</span>\<span class="title">ServicesBuilder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$storageConnectionString</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> IBlob */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blobProxy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AzureBlobService constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;storageConnectionString = env(<span class="string">'AZURE_STORAGE'</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy = ServicesBuilder::getInstance()-&gt;createBlobService(<span class="variable">$this</span>-&gt;storageConnectionString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 列出 Container 的所有 Blob</span><br><span class="line">     * <span class="doctag">@param</span> string $containerName</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listAllBlobs</span><span class="params">(string <span class="variable">$containerName</span>)</span> : <span class="title">Collection</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/** <span class="doctag">@var</span> ListBlobsResult $blobLists */</span></span><br><span class="line">            <span class="variable">$blobLists</span> = <span class="variable">$this</span>-&gt;blobProxy-&gt;listBlobs(<span class="variable">$containerName</span>);</span><br><span class="line">            <span class="variable">$blobs</span> = <span class="variable">$blobLists</span>-&gt;getBlobs();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> collect(<span class="variable">$blobs</span>)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(Blob <span class="variable">$blob</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> [</span><br><span class="line">                    <span class="string">'name'</span> =&gt; <span class="variable">$blob</span>-&gt;getName(),</span><br><span class="line">                    <span class="string">'url'</span>  =&gt; <span class="variable">$blob</span>-&gt;getUrl(),</span><br><span class="line">                ];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">            <span class="keyword">return</span> collect([]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 列出 Container 的所有 Blob</span><br><span class="line"> * <span class="doctag">@param</span> string $containerName</span><br><span class="line"> * <span class="doctag">@return</span> Collection</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listAllBlobs</span><span class="params">(string <span class="variable">$containerName</span>)</span> : <span class="title">Collection</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> ListBlobsResult $blobLists */</span></span><br><span class="line">        <span class="variable">$blobLists</span> = <span class="variable">$this</span>-&gt;blobProxy-&gt;listBlobs(<span class="variable">$containerName</span>);</span><br><span class="line">        <span class="variable">$blobs</span> = <span class="variable">$blobLists</span>-&gt;getBlobs();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> collect(<span class="variable">$blobs</span>)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(Blob <span class="variable">$blob</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">'name'</span> =&gt; <span class="variable">$blob</span>-&gt;getName(),</span><br><span class="line">                <span class="string">'url'</span>  =&gt; <span class="variable">$blob</span>-&gt;getUrl(),</span><br><span class="line">            ];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">        <span class="keyword">return</span> collect([]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>透過 <code>$blobProxy</code> 物件的 <code>listBlobs()</code> 取得 <code>$blobLists</code> 物件，在由其 <code>getBlobs()</code> 取得所有 Blob 陣列。</p>
<p>若 Blob 取得失敗，將丟出 <code>ServiceException</code>。</p>
<p><img src="/images/azure/azure-blob-storage/blob012.png" alt=""></p>
<p>測試 <span class="label label-success">綠燈</span>，顯示所有 Blob 成功。</p>
<h2 id="下載_Blob">下載 Blob</h2><hr>
<p><strong>AzureBlobServiceUnitTest.php</strong><span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/fe083b525cebe45853cf536f98a0520d1b7f9259" target="_blank" rel="external">單元測試 : 下載 Blob</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/AzureBlobServiceUnitTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">AzureBlobService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobServiceUnitTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AzureBlobService */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = App::make(AzureBlobService::class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 下載<span class="title">Blob</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">        <span class="variable">$blobName</span> = <span class="string">'myblob'</span>;</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;downloadBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>14 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 下載<span class="title">Blob</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">    <span class="variable">$blobName</span> = <span class="string">'myblob'</span>;</span><br><span class="line">    <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;downloadBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">    <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>Arrange</strong> : 由於不需要 mock 與假資料，所以 <code>arrange</code> 部分暫時從缺。</li>
<li><strong>Act</strong> : 建立待測 method <code>downloadBlob()</code>，傳入 Container 名稱與 Blob 名稱。</li>
<li><strong>Assert</strong> : 期望下載 Blob 成功傳回 <code>true</code>。</li>
</ul>
<p><strong>AzureBlobService.php</strong><span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/ee55a135ee2ec1b0e319707674c8f2cf79893790" target="_blank" rel="external">下載 Blob</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AzureBlobService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Blob</span>\<span class="title">Internal</span>\<span class="title">IBlob</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Common</span>\<span class="title">ServiceException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">WindowsAzure</span>\<span class="title">Common</span>\<span class="title">ServicesBuilder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$storageConnectionString</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> IBlob */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blobProxy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AzureBlobService constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;storageConnectionString = env(<span class="string">'AZURE_STORAGE'</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy = ServicesBuilder::getInstance()-&gt;createBlobService(<span class="variable">$this</span>-&gt;storageConnectionString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 下載 Blob</span><br><span class="line">     * <span class="doctag">@param</span> string $containerName</span><br><span class="line">     * <span class="doctag">@param</span> string $blobName</span><br><span class="line">     * <span class="doctag">@return</span> bool</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">downloadBlob</span><span class="params">(string <span class="variable">$containerName</span>, string <span class="variable">$blobName</span>)</span> : <span class="title">bool</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/** <span class="doctag">@var</span> GetBlobResult $blob */</span></span><br><span class="line">            <span class="variable">$blob</span> = <span class="variable">$this</span>-&gt;blobProxy-&gt;getBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>);</span><br><span class="line">            fpassthru(<span class="variable">$blob</span>-&gt;getContentStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 下載 Blob</span><br><span class="line"> * <span class="doctag">@param</span> string $containerName</span><br><span class="line"> * <span class="doctag">@param</span> string $blobName</span><br><span class="line"> * <span class="doctag">@return</span> bool</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">downloadBlob</span><span class="params">(string <span class="variable">$containerName</span>, string <span class="variable">$blobName</span>)</span> : <span class="title">bool</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> GetBlobResult $blob */</span></span><br><span class="line">        <span class="variable">$blob</span> = <span class="variable">$this</span>-&gt;blobProxy-&gt;getBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>);</span><br><span class="line">        fpassthru(<span class="variable">$blob</span>-&gt;getContentStream());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>透過 <code>$blobProxy</code> 物件的 <code>getBlob()</code> 取得 <code>$blob</code> 物件，在由其 <code>getContentStream()</code> 以串流資源形式取得 Blob。</p>
<p>若 Blob 取得失敗，將丟出 <code>ServiceException</code>。</p>
<p><img src="/images/azure/azure-blob-storage/blob013.png" alt=""></p>
<p>測試 <span class="label label-success">綠燈</span>，並顯示文字檔內容為 <code>Hello Azure Blob</code>。</p>
<h2 id="刪除_Blob">刪除 Blob</h2><hr>
<p><strong>AzureBlobServiceUnitTest.php</strong><span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/90c6bdd5fcddae4c9c31eb06bc2c704f7f22d555" target="_blank" rel="external">單元測試 : 刪除 Blob</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/AzureBlobServiceUnitTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">AzureBlobService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobServiceUnitTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AzureBlobService */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = App::make(AzureBlobService::class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 刪除<span class="title">Blob</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">        <span class="variable">$blobName</span> = <span class="string">'myblob'</span>;</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;deleteBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>14 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 刪除<span class="title">Blob</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">    <span class="variable">$blobName</span> = <span class="string">'myblob'</span>;</span><br><span class="line">    <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;deleteBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">    <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>Arrange</strong> : 由於不需要 mock 與假資料，所以 <code>arrange</code> 部分暫時從缺。</li>
<li><strong>Act</strong> : 建立待測 method <code>deleteBlob()</code>，傳入 Container 名稱與 Blob 名稱。</li>
<li><strong>Assert</strong> : 期望刪除 Blob 成功傳回 <code>true</code>。</li>
</ul>
<p><strong>AzureBlobService.php</strong><span class="margin-note-marker"><sup>14</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">14</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/1ca521fece2d59b672f2edfd536a48954d02befc" target="_blank" rel="external">刪除 Blob</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AzureBlobService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Blob</span>\<span class="title">Internal</span>\<span class="title">IBlob</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Common</span>\<span class="title">ServiceException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">WindowsAzure</span>\<span class="title">Common</span>\<span class="title">ServicesBuilder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$storageConnectionString</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> IBlob */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blobProxy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AzureBlobService constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;storageConnectionString = env(<span class="string">'AZURE_STORAGE'</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy = ServicesBuilder::getInstance()-&gt;createBlobService(<span class="variable">$this</span>-&gt;storageConnectionString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除 Blob</span><br><span class="line">     * <span class="doctag">@param</span> string $containerName</span><br><span class="line">     * <span class="doctag">@param</span> string $blobName</span><br><span class="line">     * <span class="doctag">@return</span> bool</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteBlob</span><span class="params">(string <span class="variable">$containerName</span>, string <span class="variable">$blobName</span>)</span> : <span class="title">bool</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;blobProxy-&gt;deleteBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 刪除 Blob</span><br><span class="line"> * <span class="doctag">@param</span> string $containerName</span><br><span class="line"> * <span class="doctag">@param</span> string $blobName</span><br><span class="line"> * <span class="doctag">@return</span> bool</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteBlob</span><span class="params">(string <span class="variable">$containerName</span>, string <span class="variable">$blobName</span>)</span> : <span class="title">bool</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy-&gt;deleteBlob(<span class="variable">$containerName</span>, <span class="variable">$blobName</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>透過 <code>$blobProxy</code> 物件的 <code>deleteBlob()</code> 刪除 Blob。</p>
<p>若 Blob 取得失敗，將丟出 <code>ServiceException</code>。</p>
<p><img src="/images/azure/azure-blob-storage/blob014.png" alt=""></p>
<p>測試 <span class="label label-success">綠燈</span>，刪除 Blob 成功。</p>
<p><img src="/images/azure/azure-blob-storage/blob015.png" alt=""></p>
<p>在 <a href="https://portal.azure.com" target="_blank" rel="external">Azure portal</a> 已經看不到任何 Blob。</p>
<h2 id="刪除_Container">刪除 Container</h2><hr>
<p><strong>AzureBlobServiceUnitTest.php</strong><span class="margin-note-marker"><sup>15</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">15</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/ffd04ac8890c76c1313c537e22391b0474422d89" target="_blank" rel="external">單元測試 : 刪除 Container</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/AzureBlobServiceUnitTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">AzureBlobService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobServiceUnitTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AzureBlobService */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = App::make(AzureBlobService::class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 刪除<span class="title">Container</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;deleteContainer(<span class="variable">$containerName</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>14 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 刪除<span class="title">Container</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="variable">$containerName</span> = <span class="string">'mycontainer'</span>;</span><br><span class="line">    <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;deleteContainer(<span class="variable">$containerName</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    <span class="variable">$expected</span> = <span class="keyword">true</span>;</span><br><span class="line">    <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>Arrange</strong> : 由於不需要 mock 與假資料，所以 <code>arrange</code> 部分暫時從缺。</li>
<li><strong>Act</strong> : 建立待測 method <code>deleteContainer()</code>，傳入 Container 名稱。</li>
<li><strong>Assert</strong> : 期望刪除 Container 成功傳回 <code>true</code>。</li>
</ul>
<p><strong>AzureBlobService.php</strong><span class="margin-note-marker"><sup>16</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">16</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo/commit/9e49ce014487beb0b8df96e7e92019103c38eeb6" target="_blank" rel="external">刪除 Container</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AzureBlobService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Blob</span>\<span class="title">Internal</span>\<span class="title">IBlob</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MicrosoftAzure</span>\<span class="title">Storage</span>\<span class="title">Common</span>\<span class="title">ServiceException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">WindowsAzure</span>\<span class="title">Common</span>\<span class="title">ServicesBuilder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AzureBlobService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$storageConnectionString</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> IBlob */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blobProxy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AzureBlobService constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;storageConnectionString = env(<span class="string">'AZURE_STORAGE'</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy = ServicesBuilder::getInstance()-&gt;createBlobService(<span class="variable">$this</span>-&gt;storageConnectionString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除 Container</span><br><span class="line">     * <span class="doctag">@param</span> string $containerName</span><br><span class="line">     * <span class="doctag">@return</span> bool</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteContainer</span><span class="params">(string <span class="variable">$containerName</span>)</span> : <span class="title">bool</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;blobProxy-&gt;deleteContainer(<span class="variable">$containerName</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>23 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 刪除 Container</span><br><span class="line"> * <span class="doctag">@param</span> string $containerName</span><br><span class="line"> * <span class="doctag">@return</span> bool</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteContainer</span><span class="params">(string <span class="variable">$containerName</span>)</span> : <span class="title">bool</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;blobProxy-&gt;deleteContainer(<span class="variable">$containerName</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException <span class="variable">$exception</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$exception</span>-&gt;getCode() . <span class="string">':'</span> . <span class="variable">$exception</span>-&gt;getMessage();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>透過 <code>$blobProxy</code> 物件的 <code>deleteContainer()</code> 刪除 Container。</p>
<p>若 Blob 取得失敗，將丟出 <code>ServiceException</code>。</p>
<p><img src="/images/azure/azure-blob-storage/blob016.png" alt=""></p>
<p>測試 <span class="label label-success">綠燈</span>，刪除 Container 成功。</p>
<p><img src="/images/azure/azure-blob-storage/blob017.png" alt=""></p>
<p>在 <a href="https://portal.azure.com" target="_blank" rel="external">Azure portal</a> 已經看不到任何 Container。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Azure 提供了 Blob Storage，讓我們可以方便地儲存文字檔或二進位檔。</li>
<li>Azure 還提供了 <a href="https://github.com/Azure/azure-sdk-for-php" target="_blank" rel="external">Azure SDK for PHP</a>，使用了 Composer 的套件管理方式，只要簡單的 <code>composer require</code> 後即可立即使用，且不限於 Laravel，其他 PHP framework 也可以使用。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52PhpStormAzureBlobStorage_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<ul>
<li>Microsoft Azure, <a href="https://github.com/Azure/azure-sdk-for-php" target="_blank" rel="external">Azure SDK for PHP</a></li>
<li>Microsoft Azure, <a href="https://azure.microsoft.com/en-us/develop/php/" target="_blank" rel="external">PHP Develop Center</a></li>
<li>Robert McMurray, <a href="https://azure.microsoft.com/en-us/documentation/articles/storage-php-how-to-use-blobs/" target="_blank" rel="external">How to use blob storage from PHP</a></li>
<li>Robin Shahan, <a href="https://azure.microsoft.com/en-us/documentation/articles/storage-create-storage-account/#create-a-storage-account" target="_blank" rel="external">About Azure storage accounts</a></li>
<li>Tamra Myers, <a href="https://azure.microsoft.com/en-us/documentation/articles/storage-manage-access-to-resources/" target="_blank" rel="external">Manage anonymous read access to containers and blobs</a></li>
<li>Tom FitzMacken, <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-manager-deployment-model/" target="_blank" rel="external">Azure Resource Manager vs. classic deployment: Understand deployment models and the state of your resources</a></li>
<li>Tamra Myers, <a href="https://azure.microsoft.com/en-us/documentation/articles/storage-redundancy/#locally-redundant-storage" target="_blank" rel="external">Azure Storage replication</a></li>
</ul>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/azure/azure-ide-helper/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2016-08-13 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Azure/">Azure<span>4</span></a></li> <li><a href="/tags/Laravel/">Laravel<span>44</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
