<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>如何使用 PhpStorm 對 Collection 除錯? | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="使用 Watches 替 Collection 除錯">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="使用 Watches 替 Collection 除錯">
<meta property="og:type" content="article">
<meta property="og:title" content="如何使用 PhpStorm 對 Collection 除錯?">
<meta property="og:url" content="http://oomusou.io/phpstorm/phpstorm-collection-debug/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="使用 Watches 替 Collection 除錯">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2016-07-11T01:34:20.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何使用 PhpStorm 對 Collection 除錯?">
<meta name="twitter:description" content="使用 Watches 替 Collection 除錯">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 如何使用 PhpStorm 對 Collection 除錯?</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 使用 Watches 替 Collection 除錯			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Motivation"><span class="toc-article-text">Motivation</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#實際案例"><span class="toc-article-text">實際案例</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#單元測試"><span class="toc-article-text">單元測試</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#OrderService"><span class="toc-article-text">OrderService</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#使用_Collection_重構"><span class="toc-article-text">使用 Collection 重構</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#將_Closure_加以重構"><span class="toc-article-text">將 Closure 加以重構</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#使用_Watches_除錯"><span class="toc-article-text">使用 Watches 除錯</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Reference"><span class="toc-article-text">Reference</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>Laravel 的 <code>Collection</code> 在實務上非常好用，除了 Eloquent 直接回傳 <code>Collection</code> 外，還擴充了很多 method，讓我們可以使用 higher order function 與 fluent 風格開發，讓程式可讀性更高。不過 <code>Collection</code> 的除錯就比較麻煩，本文使用 PhpStorm 內建的 <strong>Watches</strong>，讓我們可以在不用修改程式碼的前提下，快速對 <code>Collection</code> 除錯。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>Laravel 5.2.39<br>PhpStorm 2016.1.2</p>
<h2 id="Motivation">Motivation</h2><hr>
<p>在看了 Adam Wathan 的 <a href="http://adamwathan.me/refactoring-to-collections/" target="_blank" rel="external">Refactoring to Collections</a> 之後，發現這種 declarative 式的程式風格，不僅程式碼更精簡，可讀性更高，也符合 SOLID 原則的單一職責，因此開始大量使用 <code>Collection</code> 內建的 method 來寫程式。</p>
<p>但由於是 fluent 風格的程式，因此在 debug 時面臨困難，必須修改程式碼，加上很多暫存變數，設定中斷點後，透過 <strong>Variables</strong> 去觀察暫存變數，等除錯完後，再透過重構的 <code>Inline Variable</code> 去合併變數。</p>
<p>在 Freek Van der Herten 的 <a href="https://murze.be/2016/06/debugging-collections/" target="_blank" rel="external">Debugging collections</a> 一文中，提出了使用了 Collection Macro 配合 <code>dd()</code> 的方式，這種方式就不需要增加暫存變數，只要在要 debug 的 method 之後加上 <code>-&gt;dd()</code> 即可，非常方便。</p>
<p>不過唯一小小的可惜是，這種方式仍然需要去修改程式碼去加上 <code>-&gt;dd()</code>，是否可能在完全不需修改程式碼的前提下，快速對 <code>Collection</code> 除錯呢?</p>
<h2 id="實際案例">實際案例</h2><hr>
<p>我們將以 <code>Order</code> model 為例，顯示<code>今天全部訂單金額</code>，並寫單元測試判斷結果是否如預期。</p>
<h2 id="單元測試">單元測試</h2><hr>
<p>以 TDD 方式開發，因此必須先寫單元測試。</p>
<p><strong>OrderServiceTest.php</strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo/commit/a74e7cc1327e79f0a47e967d225cbaf5c88197f5" target="_blank" rel="external">單元測試 : 今天全部訂單金額</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/OrderServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Order</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">OrderService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 今天全部訂單金額<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** Arrange */</span></span><br><span class="line">        Carbon::setTestNow(Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>));</span><br><span class="line"></span><br><span class="line">        Order::create([</span><br><span class="line">            <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">17</span>),</span><br><span class="line">            <span class="string">'quantity'</span>   =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'price'</span>      =&gt; <span class="number">100</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        Order::create([</span><br><span class="line">            <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>),</span><br><span class="line">            <span class="string">'quantity'</span>   =&gt; <span class="number">2</span>,</span><br><span class="line">            <span class="string">'price'</span>      =&gt; <span class="number">200</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        Order::create([</span><br><span class="line">            <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>),</span><br><span class="line">            <span class="string">'quantity'</span>   =&gt; <span class="number">3</span>,</span><br><span class="line">            <span class="string">'price'</span>      =&gt; <span class="number">300</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">1300</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Act */</span></span><br><span class="line">        <span class="variable">$actual</span> = app(OrderService::class)-&gt;calculateTodayTotalAmount();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>16 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Carbon::setTestNow(Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>));</span><br></pre></td></tr></table></figure></p>
<p>由於需求是<code>今天全部訂單金額</code>，勢必使用 <code>Carbon::now()</code> 回傳今天日期，但 <code>Carbon::now()</code> 回傳的每天的真實日期，並不是個固定值，這將造成測試困難，因此 Carbon 提供了 <code>setTestNow()</code> 讓我們自行設定測試用的日期，讓  <code>Carbon::now()</code> 回傳我們預期的日期，這是寫單元測試常用的手法。</p>
<p>18 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Order::create([</span><br><span class="line">    <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">17</span>),</span><br><span class="line">    <span class="string">'quantity'</span>   =&gt; <span class="number">1</span>,</span><br><span class="line">    <span class="string">'price'</span>      =&gt; <span class="number">100</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">Order::create([</span><br><span class="line">    <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>),</span><br><span class="line">    <span class="string">'quantity'</span>   =&gt; <span class="number">2</span>,</span><br><span class="line">    <span class="string">'price'</span>      =&gt; <span class="number">200</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">Order::create([</span><br><span class="line">    <span class="string">'order_date'</span> =&gt; Carbon::create(<span class="number">2016</span>, <span class="number">6</span>, <span class="number">18</span>),</span><br><span class="line">    <span class="string">'quantity'</span>   =&gt; <span class="number">3</span>,</span><br><span class="line">    <span class="string">'price'</span>      =&gt; <span class="number">300</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>由於我們是使用 SQLite in Memory 做測試，每個測試案例執行完就會釋放記憶體，所以除了需要重新 migration 外，還要重新塞假資料進資料庫。</p>
<p>由於我們要測試的日期為 <code>2016, 6, 18</code>，除了塞兩筆 <code>2016, 6, 18</code> 資料外，還多塞了一筆 <code>2016, 6, 17</code>，目的要測試日期時間有沒有抓錯。</p>
<p>36 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$expected</span> = <span class="number">1300</span>;</span><br></pre></td></tr></table></figure></p>
<p>根據我們所塞的假資料，人工計算其期望值為 <code>1300</code>，將以此值與測試所得的實際值做 assertion。</p>
<p>38 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Act */</span></span><br><span class="line"><span class="variable">$actual</span> = app(OrderService::class)-&gt;calculateTodayTotalAmount();</span><br></pre></td></tr></table></figure></p>
<p>實際建立 <code>OrderService</code> 物件，並測試 <code>calculateTodayTotalAmount()</code>。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>此時 <code>OrderService</code> 與 <code>calculateTodayTotalAmount()</code> 都還沒建立，TDD 會等待測試亮 <span class="label label-danger">紅燈</span> 時，才去新增 <code>OrderService</code> 與 <code>calculateTodayTotalAmount()</code>。</span></span></span></p>
<p>除了使用 <code>app()</code> helper function 外，也可以使用 Facade 版本的 <code>App::make()</code>，但不建議使用 <code>new</code>，因為實務上待測物件可能會搭配依賴注入，若使用 <code>new</code> 必須自己在 constructor 輸入參數，非常麻煩，使用 <code>app()</code> 或 <code>App::make()</code> 後， Laravel 會自行依照 constructor 的 type hint 依賴注入，非常方便。</p>
<p>41 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Assert */</span></span><br><span class="line"><span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br></pre></td></tr></table></figure></p>
<p>最後使用 <code>assertEquals()</code> 判斷期望值與實際值是否相等。</p>
<h2 id="OrderService">OrderService</h2><hr>
<p>實際跑測試，會得到第 1 個 <span class="label label-danger">紅燈</span>，PHPUnit 抱怨 <code>OrderService</code> 與 <code>calculateTodayTotalAmount()</code> 尚未建立，須趕快補上。</p>
<p><strong>OrderService.php</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo/commit/e5112c689f60ceded162e52ac4dd91a783c42a6c" target="_blank" rel="external">建立 foreach 版本 OrderService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/OrderService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Order</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Order */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * OrderService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Order $order</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Order <span class="variable">$order</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算今天全部訂單金額</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$totalAmount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$orders</span> = <span class="variable">$this</span>-&gt;order-&gt;all();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$orders</span> <span class="keyword">as</span> <span class="variable">$order</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$order</span>-&gt;order_date == Carbon::now()) &#123;</span><br><span class="line">                <span class="variable">$totalAmount</span> = <span class="variable">$totalAmount</span> + <span class="variable">$order</span>-&gt;quantity * <span class="variable">$order</span>-&gt;price;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$totalAmount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第 8 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> Order */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * OrderService constructor.</span><br><span class="line"> * <span class="doctag">@param</span> Order $order</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Order <span class="variable">$order</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 constructor injection 注入 <code>Order</code> model。</p>
<p>20 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 計算今天全部訂單金額</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$totalAmount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$orders</span> = <span class="variable">$this</span>-&gt;order-&gt;all();</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$orders</span> <span class="keyword">as</span> <span class="variable">$order</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$order</span>-&gt;order_date == Carbon::now()) &#123;</span><br><span class="line">            <span class="variable">$totalAmount</span> = <span class="variable">$totalAmount</span> + <span class="variable">$order</span>-&gt;quantity * <span class="variable">$order</span>-&gt;price;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$totalAmount</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由於需求是<code>今天全部訂單金額</code>，我們先建立一個 <code>$totalAmout</code> 初始變數，再由 <code>$this-&gt;orders-&gt;all()</code> 傳回資料庫目前所有訂單。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>實務上不會直接使用 <code>$this-&gt;order-&gt;all()</code> 的方式回傳 <code>Order</code> model 的所有資料，這裡只是為了範例便宜行事，應該從 <code>OrderRepository</code> 傳回必要的資料即可，這樣才不會造成 MySQL 與 PHP 的負擔。</span></span></span></p>
<p>接著使用 <code>foreach</code> 對全部 <code>orders</code> 判斷，只有 <code>order_date</code> 為 <code>今天</code>，也就是等於 <code>Carbon::now()</code> 才加以計算。</p>
<p>訂單金額並沒有直接一個欄位，需要使用 <code>$order-&gt;quantity</code> * <code>$order-&gt;price</code> 加以計算，才能與 <code>$totalAmount</code> 相加。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug000.png" alt=""></p>
<p>得到第 1 個 <span class="label label-success">綠燈</span>，完成 <code>OrderService</code>。</p>
<h2 id="使用_Collection_重構">使用 Collection 重構</h2><hr>
<p>以上為典型的 <strong>Imperative Programming</strong> 寫法，透過暫存變數 <code>$totalAmount</code>，迴圈 <code>foreach()</code> 與判斷式 <code>if</code> 的方式寫程式，這也是過去我們習慣的 PHP 風格。</p>
<p>這種方式的缺點是程式可讀性較差，當你在 trace <code>calculateTodayTotalAmount()</code> 時，需馬上與一堆變數、迴圈與判斷式纏鬥，而不能一眼就看出程式所有表達的意思。</p>
<p><strong>OrderService.php</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo/commit/517181e2b84f0483bc0574dd796a3cac3ae44781" target="_blank" rel="external">建立 Collection 版本的 OrderService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/OrderService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Order</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Order */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * OrderService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Order $order</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Order <span class="variable">$order</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算今天全部訂單金額</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;order-&gt;all()</span><br><span class="line">            -&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$value</span>-&gt;order_date == Carbon::now();</span><br><span class="line">            &#125;)</span><br><span class="line">            -&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">            &#125;)</span><br><span class="line">            -&gt;reduce(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$carry</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$carry</span> + <span class="variable">$value</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>20 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 計算今天全部訂單金額</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;order-&gt;all()</span><br><span class="line">        -&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$value</span>-&gt;order_date == Carbon::now();</span><br><span class="line">        &#125;)</span><br><span class="line">        -&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">        &#125;)</span><br><span class="line">        -&gt;reduce(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$carry</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$carry</span> + <span class="variable">$value</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>需求為 <code>今天全部訂單金額</code>，因此有以下幾個重點 :</p>
<ul>
<li><strong>今天</strong> : 必須先過濾出<code>今天</code>的資料。</li>
<li><strong>金額</strong> : 必須先由 <code>$order-&gt;quantity</code> * <code>$order-&gt;price</code> 計算<code>金額</code>。</li>
<li><strong>全部訂單</strong> : 必須由 <code>$totalAmout</code> 計算<code>全部訂單</code>金額。</li>
</ul>
<p><code>$this-&gt;order-&gt;all()</code> 回傳的為 <code>Collection</code>，事實上 Laravel 的 <code>Collection</code> 內建非常多的 method，可直接使用。<span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>詳細請參考 Laravel 的官方文件 : <a href="https://laravel.com/docs/master/collections#available-methods" target="_blank" rel="external">Collections</a></span></span></span></p>
<p>若使用 <code>Collection</code> 的 method，可改寫成 :</p>
<ul>
<li><strong>filter()</strong> : 由 <code>filter()</code> 過濾出<code>今天</code>的資料。</li>
<li><strong>map()</strong> : 由 <code>map()</code> 計算出 <code>$order-&gt;quantity</code> * <code>$order-&gt;price</code>。</li>
<li><strong>reduce()</strong> : 由 <code>reduce()</code> 計算出 <code>$totalAmount</code>。</li>
</ul>
<p>27 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="variable">$value</span>-&gt;order_date == Carbon::now();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p><code>filter()</code> 要求傳入一個 closure，第 1 個參數為 <code>$value</code>，第 2 個參數為 <code>$key</code>，只要在 closure 內 return <code>filter()</code> 所需要的布林條件式即可。<span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>詳細請參考 Laravel 官方文件 : <a href="https://laravel.com/docs/master/collections#method-filter" target="_blank" rel="external">filter()</a></span></span></span></p>
<p>以本例來說，<code>$value</code> 就是 <code>foreach</code> 中 <code>$orders</code> 的 <code>$order</code>，所以其 <code>filter()</code> 條件為 <code>$value-&gt;order_date == Carbon::now()</code>。</p>
<p>30 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p><code>map()</code> 要求傳傳入一個 closure，第 1 個參數為 <code>$value</code>，第 2 個參數為 <code>$key</code>，只要在 closure 內 return <code>map()</code> 要成為的新值即可。<span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>詳細請參考 Laravel 官方文件 : <a href="https://laravel.com/docs/master/collections#method-map" target="_blank" rel="external">map()</a></span></span></span></p>
<p>以本例來說，<code>$value</code> 就是 <code>foreach</code> 中 <code>$orders</code> 的 <code>$order</code>，<code>map()</code> 之後的新值為 <code>$order-&gt;quantity</code> * <code>$order-&gt;price</code>。</p>
<p>33 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;reduce(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$carry</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$carry</span> + <span class="variable">$value</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><code>reduce()</code> 要求傳傳入一個 closure，第 1 個參數為 <code>$carry</code>，第 2 個參數為 <code>$value</code>，其中 <code>$carry</code> 為下一次執行 <code>reduce()</code> 時的累加值，只要在 closure 內 return 下一次執行 <code>reduce()</code> 時 <code>$carry</code> 的新值即可。<span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>詳細請參考 Laravel 官方文件 : <a href="https://laravel.com/docs/master/collections#method-reduce" target="_blank" rel="external">reduce()</a></span></span></span></p>
<p>以本例來說，<code>$value</code> 就是 <code>foreach</code> 中 <code>$orders</code> 的 <code>$order</code>，而 <code>$carry</code> 就是 <code>$totalAmount</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug001.png" alt=""></p>
<p>得到第 2 個 <span class="label label-success">綠燈</span>，使用 <code>Collection</code> 重構 <code>OrderService</code>。</p>
<h2 id="將_Closure_加以重構">將 Closure 加以重構</h2><hr>
<p>使用 <code>filter()</code>、<code>map()</code> 與 <code>reduce()</code> 搭配 closure 的寫法，已經比 Imperative Programming 寫法精簡，但 closure 部分可讀性還不是很高，需要進一步重構。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug002.png" alt=""></p>
<p>選擇 <code>filter()</code> 內部的 closure，按熱鍵 &#8963; + T，出現 <code>Refactor This</code> 選單，選擇 <code>7.Method</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug003.png" alt=""></p>
<p>Visibility 選擇 <code>Private</code>，在函式名稱輸入 <code>filterToToday</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug004.png" alt=""></p>
<p>PhpStorm 會替我們將 closure 重構出新的 <code>filterToToday()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug005.png" alt=""></p>
<p>重構後趕快跑單元測試，確認 PhpStorm 有沒有改壞。</p>
<p>將 <code>map()</code> 與 <code>reduce()</code> 的 closure 也依照以上方式加以重構成 private method。</p>
<p><strong>OrderService.php</strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo/commit/38bc52878707f137f5ce87a41ad9c3fd4b90057d" target="_blank" rel="external">將 Closure 加以重構</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/OrderService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Order</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Order */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * OrderService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Order $order</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Order <span class="variable">$order</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算今天全部訂單金額</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;order-&gt;all()</span><br><span class="line">            -&gt;filter(<span class="variable">$this</span>-&gt;filterToToday())</span><br><span class="line">            -&gt;map(<span class="variable">$this</span>-&gt;mapToAmount())</span><br><span class="line">            -&gt;reduce(<span class="variable">$this</span>-&gt;reduceToTotalAmount());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 只有今天的訂單</span><br><span class="line">     * <span class="doctag">@return</span> Closure</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterToToday</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$value</span>-&gt;order_date == Carbon::now();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 換算成金額</span><br><span class="line">     * <span class="doctag">@return</span> Closure</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">mapToAmount</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 換算成總金額</span><br><span class="line">     * <span class="doctag">@return</span> Closure</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">reduceToTotalAmount</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$carry</span>, <span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$carry</span> + <span class="variable">$value</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>22 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 計算今天全部訂單金額</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateTodayTotalAmount</span><span class="params">()</span> : <span class="title">int</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;order-&gt;all()</span><br><span class="line">        -&gt;filter(<span class="variable">$this</span>-&gt;filterToToday())</span><br><span class="line">        -&gt;map(<span class="variable">$this</span>-&gt;mapToAmount())</span><br><span class="line">        -&gt;reduce(<span class="variable">$this</span>-&gt;reduceToTotalAmount());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最後程式碼會重構成這樣，可讀性很高，就跟口語敘述一樣直覺。</p>
<ol>
<li>先由 <code>Order</code> model 傳回所有資料。</li>
<li>再透過 <code>filter()</code> 過濾<code>今天</code>的資料。</li>
<li>再透過 <code>map()</code> 計算出<code>金額</code>。</li>
<li>最後由 <code>reduce()</code> 計算出<code>總金額</code>。</li>
</ol>
<p>至於怎麼<code>過濾</code>、<code>計算</code>，那是 closure 的事情，若有必要再繼續 trace 下去，不需一開始就面臨一堆變數、迴圈與判斷，這就是所謂的 Declarative Programming 只重視 <code>我們要做什麼，而不是要如何做</code>。</p>
<p>44 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 換算成金額</span><br><span class="line"> * <span class="doctag">@return</span> Closure</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">mapToAmount</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>-&gt;quantity * <span class="variable">$value</span>-&gt;price;</span><br><span class="line">   &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由 closure 所重構出來的 method，也都符合 SOLID 的單一職責原則，將來若有需要，可以再進一步的重構成 interface 與 trait。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug006.png" alt=""></p>
<p>重構後趕快跑單元測試，確認 PhpStorm 有沒有改壞。</p>
<h2 id="使用_Watches_除錯">使用 Watches 除錯</h2><hr>
<p>使用 Declarative Programming 方式，程式可讀性雖然高，但除錯則面臨很大的挑戰，由於其 fluent 風格，基本上程式只有一行，因此無從下中斷點觀察變數，只能在除錯時加上很多暫存變數觀察。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug007.png" alt=""></p>
<p>加了 <code>$aa</code>、<code>$bb</code> … <code>$dd</code> 等暫存變數，雖然可以在 Debug Window 的 Variables 加以觀察，但必須修改程式碼，雖然之後可以靠重構的 <code>Inline Variable</code> 加以還原，但還是很麻煩。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug008.png" alt=""></p>
<p>比較理想的方式是使用 Debug Windw 的 Watches，比如說我們只想除錯 <code>$this-&gt;order-&gt;all()</code>，用滑鼠選擇 <code>$this-&gt;order-&gt;all()</code>，按滑鼠右鍵選擇 <code>Add to Watches</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug009.png" alt=""></p>
<p><code>$this-&gt;order-&gt;all()</code> 將會新增到右側下方的 Watches，可直接展開觀察結果。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug010.png" alt=""></p>
<p>同理若要除錯 <code>$this-&gt;orders-&gt;all()-&gt;filter($this-&gt;filterToToday())</code>，可將 <code>$this-&gt;orders-&gt;all()-&gt;filter($this-&gt;filterToToday())</code> 選起來，按滑鼠右鍵選擇 <code>Add to Watches</code>。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug012.png" alt=""></p>
<p><code>$this-&gt;orders-&gt;all()-&gt;filter($this-&gt;filterToToday())</code> 將會新增到右側下方的 Watches，可直接展開觀察結果。</p>
<p><img src="/images/phpstorm/phpstorm-collection-debug/debug011.png" alt=""></p>
<p>你也可以將 <code>Collection</code> 的每個過程全部加到 Watches，且只要你不刪除，Watches 就永遠存在，將來除錯還可以繼續用，這樣就可以達到不用修改程式碼，又可以對 <code>Collection</code> 除錯的目的。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Declarative 比 Imperative 方式更精簡，程式可讀性更高，也更符合單一職責原則。</li>
<li>Laravel 的 <code>Collection</code> 非常好用，但除錯一直是大家的夢靨，透過 PhpStorm 的 Watches，不僅不用修改程式碼，也可以繼續使用中斷點的除錯方式。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52PhpStormCollectionDebug_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<ul>
<li>Adam Watham, <a href="http://adamwathan.me/refactoring-to-collections/" target="_blank" rel="external">Refactoring to Collections</a></li>
<li>Freek Van der Herten, <a href="https://murze.be/2016/06/debugging-collections/" target="_blank" rel="external">Debugging collections</a></li>
<li>Taylor Otwell, <a href="https://laravel.com/docs/master/collections#available-methods" target="_blank" rel="external">Laravel Collections</a></li>
<li>PhpStorm 2016.1 Help, <a href="https://www.jetbrains.com/help/phpstorm/2016.1/debug-tool-window-watches.html" target="_blank" rel="external">Debug Tool Window.Watches</a></li>
</ul>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/azure/azure_phpstorm_deploy/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/phpstorm/phpstorm-refactor-namespace/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2016-06-19 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Laravel/">Laravel<span>41</span></a></li> <li><a href="/tags/Laravel-Collection/">Laravel Collection<span>4</span></a></li> <li><a href="/tags/PhpStorm/">PhpStorm<span>28</span></a></li> <li><a href="/tags/Refactoring/">Refactoring<span>7</span></a></li> <li><a href="/tags/TDD/">TDD<span>16</span></a></li> <li><a href="/tags/Xdebug/">Xdebug<span>3</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
