<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>如何使用PhpStorm實現TDD、重構與偵錯? | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="使用正確的工具將會事半功倍">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="使用正確的工具將會事半功倍">
<meta property="og:type" content="article">
<meta property="og:title" content="如何使用PhpStorm實現TDD、重構與偵錯?">
<meta property="og:url" content="http://oomusou.io/phpstorm/phpstorm-tdd-refactor/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="使用正確的工具將會事半功倍">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2016-03-22T14:31:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何使用PhpStorm實現TDD、重構與偵錯?">
<meta name="twitter:description" content="使用正確的工具將會事半功倍">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 如何使用PhpStorm實現TDD、重構與偵錯?</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 使用正確的工具將會事半功倍			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#物件導向"><span class="toc-article-text">物件導向</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#SOLID"><span class="toc-article-text">SOLID</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#設計模式"><span class="toc-article-text">設計模式</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#重構"><span class="toc-article-text">重構</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#TDD"><span class="toc-article-text">TDD</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#設定環境"><span class="toc-article-text">設定環境</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#建立Laravel專案"><span class="toc-article-text">建立Laravel專案</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#安裝Laravel_Elixir"><span class="toc-article-text">安裝Laravel Elixir</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#使用PhpStorm開啟"><span class="toc-article-text">使用PhpStorm開啟</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#設定Namespace_Roots"><span class="toc-article-text">設定Namespace Roots</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#設定PHP_Interpreter"><span class="toc-article-text">設定PHP Interpreter</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#設定PHPUnit"><span class="toc-article-text">設定PHPUnit</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#測試Gulp_TDD"><span class="toc-article-text">測試Gulp TDD</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#TDD-1"><span class="toc-article-text">TDD</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Spec"><span class="toc-article-text">Spec</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#測試案例"><span class="toc-article-text">測試案例</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#設定Domain目錄"><span class="toc-article-text">設定Domain目錄</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#第一個測試"><span class="toc-article-text">第一個測試</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#第二個測試"><span class="toc-article-text">第二個測試</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#第三個測試"><span class="toc-article-text">第三個測試</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#重構-1"><span class="toc-article-text">重構</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#if_else改成switch"><span class="toc-article-text">if else改成switch</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Extract_Method"><span class="toc-article-text">Extract Method</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Inline"><span class="toc-article-text">Inline</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Move_Method"><span class="toc-article-text">Move Method</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Replace_Type_Code_with_State/Stratgey"><span class="toc-article-text">Replace Type Code with State/Stratgey</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Self_Encapsulate_Field"><span class="toc-article-text">Self Encapsulate Field</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#將變化封裝在class"><span class="toc-article-text">將變化封裝在class</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Replace_Constructor_with_Factory_Method"><span class="toc-article-text">Replace Constructor with Factory Method</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Replace_Conditional_with_Polymorphism"><span class="toc-article-text">Replace Conditional with Polymorphism</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#開放封閉原則"><span class="toc-article-text">開放封閉原則</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#偵錯"><span class="toc-article-text">偵錯</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#使用測試案例偵錯"><span class="toc-article-text">使用測試案例偵錯</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#使用PhpStorm偵錯"><span class="toc-article-text">使用PhpStorm偵錯</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#學習資源"><span class="toc-article-text">學習資源</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#學習方式"><span class="toc-article-text">學習方式</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>TDD要求我們先寫測試，雖然會在專案一開始多花一點時間，但只要我們選對工具，就可將花在<strong>測試</strong>、<strong>重構</strong>與<strong>偵錯</strong>的時間再省回來，讓我們雖然輸在起跑點，卻可贏在決勝點。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>OS X 10.11.2<br>PHP 7.0.0<br>Laravel 5.1.28<br>PhpStorm 10.0.3</p>
<h2 id="物件導向">物件導向</h2><hr>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/xwin000.jpg" alt=""></p>
<p>假如今天PM開的需求，就是希望我們做出一台<strong>X戰機</strong>，我們當然可以完全手刻出符合Spec的X戰機，但只要需求一變，需要我們<strong>改</strong>功能，<strong>加</strong>功能時，我們就很頭大了。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/xwin001.jpg" alt=""></p>
<p>因此我們需要將X戰機<strong>樂高化</strong>，<strong>改</strong>功能只要<strong>換</strong>樂高積木，<strong>加</strong>功能只要<strong>加</strong>樂高積木即可。</p>
<p><strong>物件導向</strong>簡單的說就是<strong>樂高導向</strong>，每個<strong>樂高積木</strong>就是<code>class</code>，樂高積木的<strong>規格</strong>就是<code>interface</code>或<code>abstract class</code>，只要符合規格的積木，我們都可以<strong>換掉</strong>或<strong>加上去</strong>。</p>
<h3 id="SOLID">SOLID</h3><p>程式語言提供了各種物件導向程式的<strong>語法</strong>，倒底要怎樣寫才是符合物件導向精神的程式呢?</p>
<p><strong>SOLID原則</strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>詳細請參考大澤木小鐵的<a href="http://slides.com/jaceju/design-patterns-by-examples#/" target="_blank" rel="external">從實例學習設計模式 威力加強版 使用PHP</a></span></span></span></p>
<ol>
<li><strong>S</strong> : <strong>Single Responsibility Principle</strong> (單一職責原則)</li>
<li><strong>O</strong> : <strong>Open Closed Principle</strong> (開放封閉原則)</li>
<li><strong>L</strong> : <strong>Liskov Substitution Principle</strong> (里氏替換原則)，<strong>Least Knowledge Principle</strong> (最小知識原則)</li>
<li><strong>I</strong> : <strong>Interface Segregation Principle</strong> (介面隔離原則)</li>
<li><strong>D</strong> : <strong> Dependency Inversion Principle</strong> (依賴反轉原則)</li>
</ol>
<p>Laravel的作者Taylor Otwell曾有一段話 : <span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>詳細請參考<a href="http://blog.turn.tw/?p=957" target="_blank" rel="external">Laravel之父 : 學習出色的Design Pattern</a></span></span></span></p>
<blockquote><p>如果有人想成為更棒的PHP工程師，你會怎麼建議？</p>
<p>學習出色的Design Pattern。這不只適用在PHP。你可以在任何程式語言使用這些pattern。尤其是SOLID。把這五個徹底學好，它會把你帶到新的境界，我每次寫code幾乎都在想這五個。</p>
<footer><strong>Taylor Otwell</strong></footer></blockquote>
<p>除了Design Pattern，重點在於更根本的<strong>SOLID</strong>，這5點才是物件導向的心法。</p>
<h3 id="設計模式">設計模式</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/dp.jpg" alt=""></p>
<p><strong>設計模式</strong>其實就是大神們留下來<strong>好的</strong>物件導向<strong>設計範本</strong>。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span><a href="http://www.tenlong.com.tw/items/9572054112?item_id=997944" target="_blank" rel="external">物件導向設計模式-可再利用物件導向軟體之要素</a></span></span></span></p>
<p>優點 : </p>
<ol>
<li><strong>具體方案</strong> : 至少是個具體的物件導向設計方式，不再流於抽象概念。</li>
<li><strong>用得巧就很棒</strong> : 只要在<strong>適當的場合</strong>，使用<strong>適當的模式</strong>，就會非常漂亮。</li>
</ol>
<p>缺點 :</p>
<ol>
<li><strong>學習門檻高</strong> : 理解設計模式已經<strong>不容易</strong>，要套用在實務上<strong>更難</strong>，很依賴<strong>天份</strong>。</li>
<li><strong>容易over design</strong> : 初學者容易一開始就套大量<strong>設計模式</strong>，導致系統提前<strong>過於複雜</strong>。</li>
</ol>
<h3 id="重構">重構</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor.jpg" alt=""></p>
<p>將既有的程式<strong>整形</strong>成符合物件導向精神的程式。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span><a href="http://www.tenlong.com.tw/items/9861547533?item_id=45657" target="_blank" rel="external">重構 : 改善既有程式的設計 (二版)</a></span></span></span></p>
<p>優點 :</p>
<ol>
<li><strong>學習門檻較低</strong> : 重構招式較平易近人，容易學習。</li>
<li><strong>可套用在legacy code</strong> : 不再只有新的專案才能物件導向。</li>
</ol>
<p>缺點 :</p>
<ol>
<li><strong>需要依賴測試做保障</strong> : 重構需要頻繁的測試，也需要測試保證重構沒有出錯。</li>
</ol>
<h3 id="TDD">TDD</h3><p>既然<strong>重構</strong>需要<strong>測試</strong>，到底要<strong>先</strong>寫測試，還是<strong>後</strong>寫測試呢?</p>
<p><strong>TDD</strong>的全名為<strong>Test Driven Development</strong> (測試驅動開發) 顛覆大家以往的習慣，強調<code>先寫測試，再寫程式</code>，整個流程是 :</p>
<img src="/images/phpstorm/phpstorm-tdd-refactor/solid000.svg" width="750">
<p>優點 :</p>
<ol>
<li><strong>提供重構堅固的屏障</strong> : 有寫測試，我們才敢放膽重構。</li>
<li><strong>避免over design</strong> : 只為<span class="label label-danger">紅燈</span>變成<span class="label label-success">綠燈</span>寫程式，不會寫出額外的程式。</li>
<li><strong>Top Down思維</strong> : 因為測試先寫，會以<strong>測試好寫</strong>的角度去寫程式， 會比較接近使用者，也符合物件導向的精神。<span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>詳細請參考<a href="/tdd/tdd-solid/">使用TDD實踐SOLID</a></span></span></span></li>
<li><strong>偵錯快速</strong> : 將來要debug時，只要一跑測試，就可以快速找到錯誤所在。</li>
</ol>
<p>缺點 :</p>
<ol>
<li><strong>先寫測試，一開始會多花一點時間</strong> : 所以我們要找更強的工具幫我們將時間省回來。</li>
<li><strong>需要學習如何寫測試</strong> : 寫測試有不少技巧，如<strong>3A原則</strong>、<strong>Mock物件</strong>、<strong>依賴注入</strong>、<strong>Assertion</strong>…。</li>
</ol>
<h2 id="設定環境">設定環境</h2><hr>
<h3 id="建立Laravel專案">建立Laravel專案</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~$ composer create-project laravel/laravel Laravel51Refactor_demo 5.1 --prefer-dist</span><br></pre></td></tr></table></figure>
<p>在命令列下<code>composer create-project</code>指令建立Laravel專案。<span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/f8cf3f177f855569ba9f80dfa4941975ec58a116" target="_blank" rel="external">composer create-project</a></span></span></span></p>
<h3 id="安裝Laravel_Elixir">安裝Laravel Elixir</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ npm install</span><br></pre></td></tr></table></figure>
<p>由於我們會使用Laravel Elixir在背後自動執行測試，因此要使用<code>npm install</code>。<span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/817a91c43ee3ee113dd5474fbed1995d25003de8" target="_blank" rel="external">npm install</a></span></span></span></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ gulp</span><br></pre></td></tr></table></figure>
<p>執行<code>gulp</code>之後，若能出現如下圖的<code>Sass Compiled</code>，表示Laravel Elixir已經安裝成功。<span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>Laravel Elixir是否能安裝成功，取決幾個因素：Node.js、Gulp與Laravel Elixir之間的版本相依，詳細請參考<a href="/laravel/elixir/elixir-nodejs/">如何在OS X安裝Laravel前端開發環境?</a></span></span></span><br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor011.png" alt=""></p>
<h3 id="使用PhpStorm開啟">使用PhpStorm開啟</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor000.png" alt=""></p>
<p>啟動PhpStorm。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor001.png" alt=""></p>
<p>選擇剛建立的專案目錄。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor002.png" alt=""></p>
<p>一開始<code>indexing</code>雖稍微久一點，但只要做一次即可。<span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>PhpStorm會對整個專案的檔案做index，以加速將來檔案的搜尋。</span></span></span></p>
<h3 id="設定Namespace_Roots">設定Namespace Roots</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor003.png" alt=""></p>
<p>第一次開啟專案，PhpStorm會跳出<code>Detect PSR-0 namespaces roots</code>要求你設定。選擇<code>Settings | Directories</code>。<span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>理論上選擇<code>automatically</code>也可以，不過由於之前下了<code>npm install</code>之後，將大量node packages安裝在<code>node_modules</code>目錄下，若由PhpStorm自動去偵測目錄，將花較長時間，因此在此採用手動設定，詳細請參考<a href="/phpstorm/phpstorm-new-laravel-project/">如何使用PhpStorm建立Laravel專案?</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor004.png" alt=""></p>
<p>設定<code>Sources</code>目錄。</p>
<p>由於Laravel預設的namespace目錄是從<code>app</code>目錄開始，因此選擇<code>app</code>目錄，按下<code>Sources</code>，右側會出現藍色<code>Sources Folders : app</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor005.png" alt=""></p>
<p>設定<strong>namespace名稱</strong>。</p>
<p>按下<code>P</code>，設定prefix。</p>
<p>根據PSR-4，我們可以有很多namespace root，因此可以對目錄設定prefix，將<code>app</code>目錄的prefix設定為<code>App</code>。<span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>這個步驟非常重要，設定好namespace root後，將來只要建立class，PhpStorm都會幫你管理namespace，不用再對namespace操心。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor006.png" alt=""></p>
<p>設定<code>Resource Root</code>目錄。</p>
<p>Laravel預設將前端的asset放在<code>resources</code>目錄，選擇<code>resources</code>，按下<code>Resource Root</code>，右側會出現紫色<code>Resource roots : resources</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor007.png" alt=""></p>
<p>設定<code>Tests</code>目錄。</p>
<p>Laravel預設將<strong>測試</strong>程式放在<code>tests</code>目錄，選擇<code>tests</code>，按下<code>Tests</code>，右側會出現綠色<code>Test Source Folders : tests</code>。</p>
<h3 id="設定PHP_Interpreter">設定PHP Interpreter</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor009.png" alt=""></p>
<p>PhpStorm允許我們直接在IDE內執行<strong>測試</strong>與<strong>偵錯</strong>，因此我們必須告訴PhpStorm，我們使用PHP的版本，以及PHP interpreter位置。<span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>詳細請參考<a href="/phpstorm/phpstorm-debug-testing/">如何使用PhpStorm測試與除錯?</a></span></span></span></p>
<h3 id="設定PHPUnit">設定PHPUnit</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor010.png" alt=""></p>
<p>PhpStorm允許我們直接在IDE內跑<strong>單元測試</strong>，因此我們必須告訴PhpStorm，PHPUnit的autoloader與<code>phpunit.xml</code>設定檔位置。<span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>詳細請參考<a href="/phpstorm/phpstorm-debug-testing/">如何使用PhpStorm測試與除錯?</a></span></span></span></p>
<h3 id="測試Gulp_TDD">測試Gulp TDD</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor012.png" alt=""></p>
<p>一開始已經使用<code>npm install</code>安裝了Laravel Elixir，為了要使Elixir能自動在背景執行PHPUnit，只要我們一存檔就執行測試，需修改<code>gulpfile.js</code>，加上<code>.phpUnit();</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor013.png" alt=""></p>
<p>在命令列執行<code>gulp tdd</code>，啟動Laravel Elixir在背景執行PHPUnit。<span class="margin-note-marker"><sup>14</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">14</span>在PhpStorm可按熱鍵：&#8997; + F12，可在下方顯示terminal直接輸入指令。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor014.png" alt=""></p>
<p>開啟<code>tests/ExampleTest.php</code>，這是Laravel所提供預設的測試，用來測試Laravel預設的首頁是否有<code>Laravel 5</code>字串。</p>
<p>將<code>5</code>改成<code>4</code>，存檔後就會在右上角顯示<span class="label label-danger">紅燈</span>，顯示測試錯誤。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor015.png" alt=""></p>
<p>若從<code>4</code>改成<code>5</code>，存檔後就會在右上角顯示<span class="label label-success">綠燈</span>，顯示測試成功。</p>
<p>若<span class="label label-danger">紅燈</span>與<span class="label label-success">綠燈</span>都能出現，表示<strong>Gulp TDD</strong>正常。</p>
<h2 id="TDD-1">TDD</h2><hr>
<h3 id="Spec">Spec</h3><p>計算一位顧客所有訂單的金額。<span class="margin-note-marker"><sup>15</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">15</span>本範例改編自<a href="http://www.books.com.tw/products/0010411649" target="_blank" rel="external">重構：改善既有程式的設計</a>的第一章範例，原書使用Java，經簡化後改成PHP版本。</span></span></span></p>
<table>
<thead>
<tr>
<th style="text-align:left">影片種類</th>
<th style="text-align:left">租期</th>
<th style="text-align:left">租金</th>
<th style="text-align:left">逾期費</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">普通片</td>
<td style="text-align:left">7天</td>
<td style="text-align:left">100</td>
<td style="text-align:left">10</td>
</tr>
<tr>
<td style="text-align:left">新片</td>
<td style="text-align:left">3天</td>
<td style="text-align:left">150</td>
<td style="text-align:left">30</td>
</tr>
<tr>
<td style="text-align:left">兒童片</td>
<td style="text-align:left">7天</td>
<td style="text-align:left">40</td>
<td style="text-align:left">10</td>
</tr>
</tbody>
</table>
<h3 id="測試案例">測試案例</h3><ol>
<li><p>普通片1支，10天<span class="margin-note-marker"><sup>16</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">16</span>寫測試的第一步，就是要將spec寫成<strong>測試案例</strong>，也就是實際的input與output結果，如此才能根據input與output判斷測試結果是否正確。</span></span></span></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  100 + (10-7) * 10 = 130</div>
</li>
<li><p>新片1支，5天</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  150 + (5-3) * 30 = 210</div>
</li>
<li><p>兒童片1支，8天</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  40 + (8-7) * 10 = 50</div>
</li>
</ol>
<h3 id="設定Domain目錄">設定Domain目錄</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor016.png" alt=""></p>
<p>我們會將所有的class放在自己的<strong>Domain目錄</strong>下，或稱為<strong>Business Layer</strong>。<span class="margin-note-marker"><sup>17</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">17</span>詳細請參考<a href="/laravel/laravel-architecture/">Laravel的中大型專案架構</a></span></span></span></p>
<p>首先，在<code>app</code>目錄下建立<code>VideoRental</code>子目錄。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor017.png" alt=""></p>
<p>輸入<code>VideoRental</code>。<span class="margin-note-marker"><sup>18</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">18</span>在左側選擇<code>app</code>目錄，按下&#8963; + Ｎ，出現下拉選單，選擇<code>Directory</code>建立新目錄。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor018.png" alt=""></p>
<p>由於新目錄會有自己的namespace名稱，因此要修改<code>composer.json</code>的<code>psr-4</code>設定，加上<code>VideoRental</code>與其目錄。</p>
<p>執行<code>composer dumpautoload</code>建立新的autoload檔案。<span class="margin-note-marker"><sup>19</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">19</span>這一步一定要做，否則PHP會找不到我們自己建立的class，詳細請參考<a href="/laravel/laravel-architecture/">Laravel的中大型專案架構</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor019.png" alt=""></p>
<p>在PhpStorm設定<code>VideoRental</code> namespace。<span class="margin-note-marker"><sup>20</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">20</span>這一步一定要做，如此PhpStorm才會知道新的<code>VideoRental</code> namespace，將來建立新class時，才可以選的到此namespace。<br><strong><em>PhpStorm -&gt; Preferences… -&gt; Project:xxx -&gt; Directories</em></strong></span></span></span></p>
<p>選擇<code>app/VideoRental</code>目錄，按下<code>Sources</code>，右側會出現藍色<code>Sources Folders : app/VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor020.png" alt=""></p>
<p>按下<code>P</code>，設定namespace名稱。</p>
<p>將<code>app/VideoRental</code>目錄的prefix設定為<code>VideoRental</code>。<span class="margin-note-marker"><sup>21</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">21</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/d3b9a9a1b9733045a42685cd28682b955367f731" target="_blank" rel="external">新增domain目錄</a></span></span></span></p>
<h3 id="第一個測試">第一個測試</h3><p>接下來會介紹3種測試方式。</p>
<p>第一種測試方式 : <strong>使用Gulp TDD</strong></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor021.png" alt=""></p>
<p>在命令列使用<code>php artisan make:test</code>建立測試class，預設會繼承<code>tests</code>目錄下的<code>TestCase</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor040.png" alt=""></p>
<p>在命令列執行<code>gulp tdd</code>，讓Laravel Elixir在背後執行PHPUnit，將來只要我們一存檔就會自動執行測試。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor022.png" alt=""></p>
<p>建立<strong>PHPUnit Test Method</strong>。<span class="margin-note-marker"><sup>22</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">22</span>在寫測試的class內，按熱鍵 : &#8963; + N，會出現<code>Generate</code>選單，選擇<code>PHPUnit Test Method</code>，可幫我們自動建立test method。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor023.png" alt=""></p>
<p>PhpStorm自動幫我們建立以<code>test</code>為開頭的test method。<span class="margin-note-marker"><sup>23</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">23</span>PHPUnit預設會將2種method視為test method，一種是以<code>test</code>為開頭的method，一種是在PHPDoc註解加上<code>@test</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor024.png" alt=""></p>
<p>更改test method名稱，以最能描述<strong>測試案例</strong>的<code>口語命名</code>，不用遵循PSR-2。<span class="margin-note-marker"><sup>24</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">24</span>詳細請參考<a href="/php/php-psr2/">PSR-2 PHP Coding Style</a></span></span></span></p>
<p>在test method內加上<strong>arrange</strong>，<strong>act</strong>, <strong>assert</strong>，以<strong>3A</strong>原則寫測試。<span class="margin-note-marker"><sup>25</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">25</span>因為每個test method都需要3A原則當架構，建議可以自行加入PhpStorm的<strong>Live Template</strong></span></span></span></p>
<p><strong>3A原則</strong><br><strong>Arrange</strong></p>
<ul>
<li>建立物件 (待測物件，相依物件，Mock物件）。</li>
<li>建立假資料。</li>
<li>設定<strong>期望值</strong>。</li>
</ul>
<p><strong>Act</strong></p>
<ul>
<li>實際執行待測物件的method，獲得<strong>實際值</strong>。</li>
</ul>
<p><strong>Assert</strong></p>
<ul>
<li>使用PHPUnit提供的assertion，測試<strong>期望值</strong>與<strong>實際值</strong>是否相等。</li>
</ul>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor025.png" alt=""></p>
<p>依<strong>3A原則</strong>為骨架，依次將測試補上。<span class="margin-note-marker"><sup>26</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">26</span>實務上第一個會將<code>act</code>先補上，也就是先決定要測試哪一個method。</span></span></span></p>
<p>先寫測試讓我們會以<strong>測試好寫</strong>為前提設計，會幫助我們以<strong>使用者需求</strong>的<strong>抽象化角度</strong>去思考架構。</p>
<p><strong>Arrange</strong><br>因為我們的需求是：<code>計算一位顧客所有訂單的金額</code>，且<strong>金額</strong>會隨著<strong>電影</strong>種類而不同，因此最基本，我們會有<code>Movie</code>、<code>Order</code>與<code>Customer</code>三個class，且一位顧客會有多筆訂單，因此會有<code>addOrder()</code>提供新增訂單。<span class="margin-note-marker"><sup>27</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">27</span>此時<code>Movie</code>、<code>Order</code>、<code>Customer</code>、<code>addOrder</code>與<code>calculateTotalPrice()</code>都還沒建立，因此在PhpStorm會<strong>反白</strong>，這不用擔心，因為我們現在是<strong>先寫測試</strong>，以<strong>Top Down</strong>的方式去思考，不用擔心這些class與method還沒建立，只要先思考<code>這樣子我們測試最好寫</code>就好了，這是<strong>TDD</strong>很重要的心法。</span></span></span></p>
<p>將<strong>測試案例</strong>的<strong>期望值</strong>寫入<code>$expected</code>。</p>
<p><strong>Act</strong><br>實際測試<code>Customer</code>的<code>calculateTotalPrice()</code>，獲得<strong>實際值</strong><code>$actual</code>。</p>
<p><strong>Assert</strong><br>使用PHPUnit的<code>assertEquals()</code>驗證<strong>期望值</strong>與<strong>實際值</strong>是否相同。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  該自己用if else寫測試嗎？</div>
<p>這裡當然可以自己用PHP寫 <code>if ($expected == $actual)</code>判斷，不過因為牽涉到人為的邏輯判斷，當測試錯誤時，很難確定到底是測試有問題，還是我們自己寫的PHP邏輯有問題，所以在測試中<strong>不應該</strong>寫邏輯，而<strong>應該</strong>使用PHPUnit的<code>assertion</code><span class="margin-note-marker"><sup>28</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">28</span>PHPUnit提供很多assertion method，詳細請參考<a href="https://phpunit.de/manual/current/en/appendixes.assertions.html" target="_blank" rel="external">PHPUnit Assertions</a></span></span></span>，因為PHPUnit已經被<code>測試過</code>了，當測試結果有錯時，不用再懷疑是不是測試寫錯，一定是我們的程式寫錯了。</p>
<p>存檔後，會出現第一個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Class Movie not found</code>。<span class="margin-note-marker"><sup>29</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">29</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/1909e6038030b1d00050c3cadfd4224429d0521c" target="_blank" rel="external">第一個測試 : 第一個紅燈</a></span></span></span></p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  The Three Rules of TDD No.1</div>
<blockquote><p>You are not allowed to write any production code unless it is to make a failing unit test pass.</p>
<footer><strong>Uncle Bob</strong><cite>&nbsp;-The Three Rules of TDD</cite></footer></blockquote>
<p>白話就是：你必須先寫測試亮<span class="label label-danger">紅燈</span>之後，才可以寫程式。<span class="margin-note-marker"><sup>30</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">30</span><a href="http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd" target="_blank" rel="external">The Three Rules of TDD</a></span></span></span></p>
<p>目的：</p>
<ol>
<li>先亮<span class="label label-danger">紅燈</span>，表示你已經<strong>先寫了測試</strong>，只是因為沒寫程式所以紅燈。</li>
<li>先亮<span class="label label-danger">紅燈</span>，表示你之前寫的程式沒有<strong>over design</strong>。</li>
</ol>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor026.png" alt=""></p>
<p>測試錯誤訊息告訴我們 : <code>Class Movie not found</code>。因為我們還沒建立<code>Movie</code>。</p>
<p>直接在PhpStorm內建立<code>Movie</code>。<span class="margin-note-marker"><sup>31</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">31</span>將滑鼠游標放在<code>Movie</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Create class</code>，按下可自動建立<code>Movie</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor027.png" alt=""></p>
<p>出現<strong>Create New PHP Class</strong>對話框，選擇目錄在<code>app/VideoRental</code>下，並選擇namespace : <code>VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor028.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>Movie</code>。</p>
<p>存檔後出現第二個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Class Order not found</code>。<span class="margin-note-marker"><sup>32</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">32</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/0588af6e93320f6b4d5ee79664378d8afb1196b9" target="_blank" rel="external">第一個測試 : 第二個紅燈</a></span></span></span></p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  The Three Rules of TDD No.2</div>
<blockquote><p>You are not allowed to write any more of a unit test than is sufficient to fail; and compilation failures are failures.</p>
<footer><strong>Uncle Bob</strong><cite>&nbsp;-The Three Rules of TDD</cite></footer></blockquote>
<p>白話就是：測試出現<span class="label label-danger">紅燈</span>之後，你就必須先改程式將<span class="label label-danger">紅燈</span>變成<span class="label label-success">綠燈</span>，而不是寫其他的測試製造更多的<strong>紅燈</strong>。<span class="margin-note-marker"><sup>33</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">33</span><a href="http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd" target="_blank" rel="external">The Three Rules of TDD</a></span></span></span></p>
<p>目的 : </p>
<ol>
<li>將程式<strong>聚焦</strong>在目前的需求，方便程式解決目前的<span class="label label-danger">紅燈</span>。</li>
<li>不會一開始就將架構想的太複雜，造成over design，而枉費我們分拆測試範例。<span class="margin-note-marker"><sup>34</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">34</span>詳細請參考<a href="https://www.facebook.com/91agile" target="_blank" rel="external">91哥</a>的<a href="https://www.dotblogs.com.tw/hatelove/2015/12/14/explanation-the-three-laws-of-tdd" target="_blank" rel="external">The Three Laws of TDD - 從紅燈變綠燈的過程</a></span></span></span></li>
</ol>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor033.png" alt=""></p>
<p>測試錯誤訊息告訴我們 : <code>Order not found</code>。因為我們還沒建立<code>Order</code>。</p>
<p>直接在PhpStorm內建立<code>Order</code>。<span class="margin-note-marker"><sup>35</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">35</span>將滑鼠游標放在<code>Order</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Create class</code>，按下可自動建立<code>Order</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor029.png" alt=""></p>
<p>出現<strong>Create New PHP Class</strong>對話框，選擇目錄在<code>app/VideoRental</code>下，並選擇namespace : <code>VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor030.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>Order</code>。</p>
<p>存檔後出現第三個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Class Customer not found</code>。<span class="margin-note-marker"><sup>36</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">36</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/a7d01365221e77eaa6c1e667635313534eb18712" target="_blank" rel="external">第一個測試 : 第三個紅燈</a></span></span></span></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  不要因為在測試時看到<strong>紅燈</strong>而沮喪</div>
<p>事實上TDD的開發流程本來就是先有<span class="label label-danger">紅燈</span>才去寫程式，這也是TDD能解決<strong>over design</strong>的關鍵，因為測試案例的<strong>紅燈</strong>來自於<strong>需求</strong>，由<span class="label label-danger">紅燈</span>變成<span class="label label-success">綠燈</span>就是<strong>解決需求</strong>，若沒有<span class="label label-danger">紅燈</span>而直接<span class="label label-success">綠燈</span>，就表示程式有<strong>over design</strong>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor034.png" alt=""></p>
<p>測試錯誤訊息告訴我們 : <code>Class Customer not found</code>。因為我們還沒建立<code>Customer</code>。</p>
<p>直接在PhpStorm內建立<code>Customer</code>。<span class="margin-note-marker"><sup>37</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">37</span>將滑鼠游標放在<code>Customer</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Create class</code>，按下可自動建立<code>Customer</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor031.png" alt=""></p>
<p>出現<strong>Create New PHP Class</strong>對話框，選擇目錄在<code>app/VideoRental</code>下，並選擇namespace : <code>VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor032.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>Customer</code>。</p>
<p>存檔後出現第四個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Call to undefined method VideoRental\Customer::addOrder()</code>。<span class="margin-note-marker"><sup>38</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">38</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/e67cd66246e4feae03a3c81d6134bfb9b00ec0e1" target="_blank" rel="external">第一個測試 : 第四個紅燈</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor035.png" alt=""></p>
<p>測試錯誤訊息告訴我們 : <code>Call to undefined method VideoRental\Customer::addOrder()</code>。因為我們還沒建立<code>addOrder()</code>。</p>
<p>直接在PhpStorm內建立<code>addOrder()</code>。<span class="margin-note-marker"><sup>39</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">39</span>將滑鼠游標放在<code>addOrder()</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Add method</code>，按下可自動建立<code>addOrder()</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor036.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>addOrder()</code>。</p>
<p>存檔後出現第五個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Call to undefined method VideoRental\Customer::calculateTotalPrice()</code>。<span class="margin-note-marker"><sup>40</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">40</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/22b2252f197b760834a8d0271339ec9212e85a78" target="_blank" rel="external">第一個測試 : 第五個紅燈</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor037.png" alt=""></p>
<p>測試錯誤訊息告訴我們 : <code>Call to undefined method VideoRental\Customer::calculateTotalPrice()</code>。因為我們還沒建立<code>calculateTotalPrice()</code>。</p>
<p>直接在PhpStorm內建立<code>calculateTotalPrice()</code>。<span class="margin-note-marker"><sup>41</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">41</span>將滑鼠游標放在<code>calculateTotalPrice()</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Add method</code>，按下可自動建立<code>calculateTotalPrice()</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor038.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>calculateTotalPrice()</code>。</p>
<p>存檔後出現第六個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Failed asserting that null matches expected 130</code>。<span class="margin-note-marker"><sup>42</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">42</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/6dcf3d7d431828ddc9f19a5c02d8c38ceedbac94" target="_blank" rel="external">第一個測試 : 第六個紅燈</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor039.png" alt=""></p>
<p>既然測試要求<code>130</code>，我們就直接很<strong>無恥</strong>的回傳<code>130</code>。</p>
<p>這樣我們就獲得了第一個測試的第一個綠燈。<span class="margin-note-marker"><sup>43</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">43</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/ba302b5ba8d122276bf532cd72acb303e25b1e59" target="_blank" rel="external">第一個測試 : 第一個綠燈</a></span></span></span></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  直接使用return也太無恥了吧!!</div>
<p>第一個測試為了剛好符合第一個測試案例的需求，我們可以先<strong>無恥</strong>的使用return方式，反正接下來的測試案例我們自然會重構。</p>
<h3 id="第二個測試">第二個測試</h3><p>第二種測試方式 : <strong>在命令列執行<code>vendor/bin/phpunit</code></strong><br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor041.png" alt=""></p>
<p>將第一個測試<code>test_order_1_regular_movie_with_10_days()</code>複製貼上，改成第二個測試<code>test_order_1_new_release_movie_with_5_days()</code>。<span class="margin-note-marker"><sup>44</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">44</span>不用擔心在test code使用<strong>複製貼上</strong>，test code不用擔心duplicated code問題，只有production code才必須考慮。</span></span></span></p>
<p>先在命令列使用&#8963; + C結束<code>gulp tdd</code>，然後執行<code>vendor/bin/phpunit</code>執行測試。</p>
<p>實務上可以在PHPDoc加上<code>@group</code>標籤為test method分類，如誰寫的測試，哪一個class的測試，方便<code>vendor/bin/phpunit</code>執行時只跑該group。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor042.png" alt=""></p>
<p>執行測試後，出現第二個測試案例的第一個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Failed asserting that 130 matches expected 210</code>。<span class="margin-note-marker"><sup>45</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">45</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/7a58b7e2bfbee5b34e3e02d4f585596b132ba190" target="_blank" rel="external">第二個測試 : 第一個紅燈</a></span></span></span></p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  別忘了Uncle Bob的叮嚀，每個測試案例都要先出現第一個<span class="label label-danger">紅燈</span>，若一開始就出現<span class="label label-success">綠燈</span>，表示你之前程式有over design了。</div>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor043.png" alt=""></p>
<p>之前我們只新增了<code>addOrder()</code>，並還沒有填入程式。</p>
<p>宣告一個<code>$orders</code>陣列，並將<code>$order</code>push進<code>$orders</code>。<span class="margin-note-marker"><sup>46</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">46</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/980f01a9538f7dc35ee86bcc1a159ab2831c68de" target="_blank" rel="external">第二個測試 : 補齊Customer-&gt;addOrder()</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor044.png" alt=""></p>
<p>由於將來<code>calculateTotalPrice()</code>也要使用<code>$orders</code>陣列，因此我們想將<code>$orders</code>從method內的變數變成class的field。<span class="margin-note-marker"><sup>47</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">47</span>將滑鼠游標放在<code>$orders</code>之後，按&#8963; + T，會出現PhpStorm所有的<strong>重構</strong>選單，選擇<strong><em>Extract Field…</em></strong>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor045.png" alt=""></p>
<p>出現兩種重構方式，選擇第一種 : <code>$orders</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor047.png" alt=""></p>
<p>出現<strong>Introduce field</strong>對話框，預設field已經幫我們填入<code>orders</code>。</p>
<p>可以自行選擇<code>Initialize in</code>與<code>Visibility</code>的方式。</p>
<p>這裡我們選擇<code>Field declaration</code>，也就是會直接在field宣告時初始化陣列。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor048.png" alt=""></p>
<p>如我們所願，宣告成<code>protected $orders = []</code>。</p>
<p>並且push部分也自動改成field。<span class="margin-note-marker"><sup>48</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">48</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/c8c9e8d1d360e2fa3ae8db127479eed8f8164de3" target="_blank" rel="external">第二個測試：Customer-&gt;addOrder()將$orders重構成field</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor049.png" alt=""></p>
<p>由於需求是<code>計算一位顧客所有訂單的金額</code>，所以勢必有<code>$totalPrice</code>變數負責累加，然後需要一個<code>foreach</code>將整個<code>$orders</code>loop一次，計算每種影片種類的金額。</p>
<p>以Top Down的方式思考，由於我們現在是在<code>Order</code> class，所以必須透過<code>getMovie()</code>傳回<code>Movie</code>物件，並透過其<code>getType()</code> method傳回<strong>影片種類</strong>，然後將計費方式的演算法寫在裡面。<span class="margin-note-marker"><sup>49</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">49</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/ade44e32f10da6f2b77d3a0ffb391396fb376d5f" target="_blank" rel="external">第二個測試 : 補齊Customer-&gt;calculateTotalPrice()的Regular計算方式</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor050.png" alt=""></p>
<p>執行測試後，出現第二個測試案例的第二個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Call to undefined method VideoRental\Order::getMovie()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor051.png" alt=""></p>
<p>錯誤訊息告訴我們 : <code>Call to undefined method VideoRental\Order::getMovie()</code>，因為我們還沒建立<code>getMovie()</code>。</p>
<p>直接在PhpStorm內建立<code>getMovie()</code>。<span class="margin-note-marker"><sup>50</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">50</span>將滑鼠游標放在<code>getMovie()</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Add method</code>，按下可自動建立<code>getMovie()</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor052.png" alt=""></p>
<p>出現<code>Can not find target class for modification</code>的錯誤訊息，因為PhpStorm無法得知<code>$order</code>變數的型別，因此不知道要將<code>getMovie()</code>建立在哪一個class。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor053.png" alt=""></p>
<p>加上註解描述<code>$order</code>的型別為<code>Order</code>。<span class="margin-note-marker"><sup>51</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">51</span>這種寫法雖然可行，但不是最漂亮的寫法，最漂亮的寫法應該是直接在field註解型別，也就使在<code>protected $order = []</code>之前直接<code>@var Order[]</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor054.png" alt=""></p>
<p>之後PhpStorm就會自動在<code>Order</code>建立<code>getMovie()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor055.png" alt=""></p>
<p>由於<code>getMovie()</code>的<code>$movie</code>來自於field，因此在constructor先將參數補全。</p>
<p>由於我們對constructor加了參數，因此出現了<code>Argument PHPDoc missing</code>的警告。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor056.png" alt=""></p>
<p>使用PhpStorm幫我們補齊PHPDoc。<span class="margin-note-marker"><sup>52</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">52</span>將滑鼠游標放在<code>int $days</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Update PHPDoc Comment</code>，按下可自動將參數新增至PHPDoc。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor057.png" alt=""></p>
<p>PhpStorm幫我們將新的參數註解加入了PHPDoc，將原來的參數註解改成<code>@internal</code>，這顯然是多餘的。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor058.png" alt=""></p>
<p>刪除多餘的<code>@internal</code>註解。<br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor059.png" alt=""></p>
<p>使用PhpStorm幫我們建立field。<span class="margin-note-marker"><sup>53</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">53</span>將滑鼠游標放在<code>int $days</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Initialize fields</code>，按下可自動將constructor參數新增成field。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor060.png" alt=""></p>
<p>選擇所要建立field的參數。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor061.png" alt=""></p>
<p>PhpStorm自動幫我們宣告field，並在contructor自動加上初始化的程式。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor062.png" alt=""></p>
<p>回到<code>getMovie()</code>，除了加上<code>return $this-&gt;movie</code>之外，還補上了回傳型別<code>Movie</code>。</p>
<p>使用PhpStorm自動幫我們加上<code>getMovie()</code>註解。<span class="margin-note-marker"><sup>54</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">54</span>將滑鼠游標放在<code>Movie</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Generate PHPDoc for function</code>，按下可自動替<code>getMovie()</code>產生註解。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor063.png" alt=""></p>
<p>在註解第一行加上人看得懂的註解。<span class="margin-note-marker"><sup>55</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">55</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/afe5ea8ecea60a562875e2a61a6ba4b93fbd8603" target="_blank" rel="external">第二個測試 : 補齊Order-&gt;getMovie()</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor064.png" alt=""></p>
<p> 執行測試後，出現第二個測試案例的第三個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Call to undefined method ViderRental\Movie::getType()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor066.png" alt=""></p>
<p>錯誤訊息告訴我們 : <code>Call to undefined method ViderRental\Movie::getType()</code>，因為我們還沒建立<code>getType()</code>。</p>
<p>直接在PhpStorm內建立<code>getType()</code>。<span class="margin-note-marker"><sup>56</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">56</span>將滑鼠游標放在<code>getType()</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Add method</code>，按下可自動建立<code>getType()</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor065.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>getType()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor067.png" alt=""></p>
<p>由於<code>getType()</code>的<code>$type</code>來自於field，因此在constructor先將參數補全。</p>
<p>由於我們對constructor加了參數，因此出現<code>Argument PHPDoc missing</code>的警告。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor068.png" alt=""></p>
<p>使用PhpStorm幫我們補齊PHPDoc。<span class="margin-note-marker"><sup>57</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">57</span>將滑鼠游標放在<code>$type</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Update PHPDoc Comment</code>，按下可自動將參數新增至PHPDoc。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor069.png" alt=""></p>
<p>PhpStorm幫我們將新的參數註解加入了PHPDoc，將原來的參數改成<code>@internal</code>，這顯然是多餘的。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor070.png" alt=""></p>
<p>刪除多餘的<code>@internal</code>註解。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor071.png" alt=""></p>
<p>使用PhpStorm幫我們建立field。<span class="margin-note-marker"><sup>58</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">58</span>將滑鼠游標放在<code>string $type</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Initialize fields</code>，按下可自動將constructor參數新增成field。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor072.png" alt=""></p>
<p>選擇所要建立field的參數。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor073.png" alt=""></p>
<p>PhpStorm自動幫我們宣告field，並在contructor自動加上初始化的程式。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor074.png" alt=""></p>
<p>回到<code>getType()</code>，補上了回傳型別<code>string</code>。</p>
<p>使用PhpStorm自動幫我們加上<code>getType()</code>註解。<span class="margin-note-marker"><sup>59</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">59</span>將滑鼠游標放在<code>string</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Generate PHPDoc for function</code>，按下可自動替<code>getType()</code>產生註解。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor075.png" alt=""></p>
<p>加上<code>return $this-&gt;type</code>。</p>
<p>在註解第一行加上人看得懂的註解。<span class="margin-note-marker"><sup>60</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">60</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/86e838dc3e42ae07cdc645b37b71c76367a1cdff" target="_blank" rel="external">第二個測試：補齊Order-&gt;getType()</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor076.png" alt=""></p>
<p>執行測試後，出現第二個測試案例的第四個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Call to undefined method VideoRental\Order::getDays()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor077.png" alt=""></p>
<p>錯誤訊息告訴我們 : <code>Call to undefined method VideoRental\Order::getDays()</code>，因為我們還沒建立<code>getDays()</code>。</p>
<p>直接在PhpStorm內建立<code>getDays()</code>。<span class="margin-note-marker"><sup>61</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">61</span>將滑鼠游標放在<code>getDays()</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Add method</code>，按下可自動建立<code>getDays()</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor078.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>getDays()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor079.png" alt=""></p>
<p>之前已經建立好<code>$days</code> field，所以可以直接<code>return $this-&gt;days</code>，並加上註解。<span class="margin-note-marker"><sup>62</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">62</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/cbf036f75148c94bf87618687451b3ba820ad3db" target="_blank" rel="external">第二個測試：補齊Order-&gt;getDays()</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor080.png" alt=""></p>
<p>執行測試後，出現第二個測試案例的第五個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Failed asserting that 0 matches expected 210</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor081.png" alt=""></p>
<p>錯誤訊息告訴我們 : <code>Failed asserting that 0 matches expected 210</code>，因為我們還沒寫<code>NewRelease</code>的計費方式的演算法。</p>
<p>補上<code>NewRelease</code>的計費方式演算法。</p>
<p>這樣我們就獲得了第二個測試的第一個綠燈。<span class="margin-note-marker"><sup>63</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">63</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/c41afb2986be6d4b67090426a7755da646472ec8" target="_blank" rel="external">第二個測試 : 第一個綠燈</a></span></span></span></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  其實Children的計費方式也蠻接近的，我就順便elseif將Children補上好了!!</div>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  The Three Rules of TDD No.3</div>
<blockquote><p>You are not allowed to write any more production code than is sufficient to pass the one failing unit test.</p>
<footer><strong>Uncle Bob</strong><cite>&nbsp;-The Three Rules of TDD</cite></footer></blockquote>
<p>白話就是：若沒有<strong>測試案例</strong>，就不要自作聰明去寫程式。<span class="margin-note-marker"><sup>64</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">64</span><a href="http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd" target="_blank" rel="external">The Three Rules of TDD</a></span></span></span></p>
<p>目的 : </p>
<ol>
<li>避免<strong>over design</strong>，導致系統提早無謂的複雜。</li>
<li>將來若有新的測試案例，到時候再<strong>重構</strong>就好，不用現在去擔心。</li>
</ol>
<h3 id="第三個測試">第三個測試</h3><p>第三種測試方式 : <strong>直接在PhpStorm測試</strong><br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor082.png" alt=""></p>
<p>將第一個測試<code>test_order_1_regular_movie_with_10_days()</code>複製貼上，改成第三個測試<code>test_order_1_children_movie_with_8_days()</code>。<span class="margin-note-marker"><sup>65</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">65</span>不用擔心在test code使用<strong>複製貼上</strong>，test code不用擔心duplicated code問題，只有production code才必須考慮。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor083.png" alt=""></p>
<p>直接在PhpStorm執行測試。<span class="margin-note-marker"><sup>66</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">66</span>在左側選擇<code>CustomerTest.php</code>，按熱鍵&#8963; + &#8679; + R。</span></span></span></p>
<p>我們發現前兩個測試案例都是<span class="label label-success">綠燈</span>，只有第三個測試案例是<span class="label label-danger">紅燈</span>。</p>
<p>這是第三個測試案例的第一個<span class="label label-danger">紅燈</span>，錯誤訊息為<code>Failed asserting that 130 matches expected 210</code>。<span class="margin-note-marker"><sup>67</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">67</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/a041e0d318e7f7e7d16689662ac22bc0d1221977" target="_blank" rel="external">第三個測試 : 第一個紅燈</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor084.png" alt=""></p>
<p>錯誤訊息告訴我們 : <code>Failed asserting that 130 matches expected 210</code>，因為我們還沒寫<code>Childer</code>的計費方式演算法。</p>
<p>補上<code>Children</code>的計費方式演算法。</p>
<p>這樣我們就獲得了第三個測試案例的第一個<span class="label label-success">綠燈</span>。<span class="margin-note-marker"><sup>68</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">68</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/0b76208d1e94bbe1347fbf92166735c0b6692941" target="_blank" rel="external">第三個測試 : 第一個綠燈</a></span></span></span></p>
<h2 id="重構-1">重構</h2><hr>
<p>3個測試案例都通過，代表程式基本上已經符合Spec要求，可以即時交付程式。</p>
<p>但是符合Spec的程式並不代表這是<strong>好的程式</strong>，一個好的程式至少要符合5個要求：</p>
<ol>
<li>容易維護。</li>
<li>容易新增功能。</li>
<li>容易重複使用。</li>
<li>容易寫測試。</li>
<li>容易上Git，不易與其他人發生衝突。</li>
</ol>
<p>若更簡單的說，就是要符合<strong>SOLID</strong>原則的程式，才算是好程式。</p>
<p>接下來我們將使用<strong>重構</strong>，將目前的程式調整成符合<strong>SOLID</strong>原則的好程式。</p>
<h3 id="if_else改成switch">if else改成switch</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor168.png" alt=""></p>
<p>在<code>Customer</code>的<code>calculateTotalPrice()</code>，有個<code>if...elseif</code>，因為都是判斷<code>$order-&gt;getMovie()-&gt;getType()</code>，將<code>if...elseif</code>改成<code>switch</code>，會讓程式碼比較容易閱讀。<span class="margin-note-marker"><sup>69</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">69</span>這並不是<strong>重構</strong>這本書所談的重構手法，不過<code>switch</code>的確比<code>if...elseif</code>容易閱讀，所以實務上也常常會將<code>if...elseif</code>重構成<code>switch</code>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor085.png" alt=""></p>
<p>重構成<code>switch</code>之後，馬上跑測試，確認<strong>重構</strong>沒將程式改壞掉。<span class="margin-note-marker"><sup>70</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">70</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/17a116a80867482da508d9c8a2c015b269bd3eaf" target="_blank" rel="external">重構 : if else改switch</a></span></span></span></p>
<h3 id="Extract_Method">Extract Method</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor086.png" alt=""></p>
<p>改成<code>switch</code>之後，雖然程式碼已經比較容易閱讀了，但是在<code>calculateTotalPrice()</code>內還是顯得很臃腫，因此想使用<strong>重構</strong>的<strong>Extract Method</strong>將此<code>switch</code>重構成一個<code>method</code>。<span class="margin-note-marker"><sup>71</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">71</span>使用滑鼠選擇想要重構的程式碼，按熱鍵&#8963; + T，會出現PhpStorm所有的<strong>重構</strong>選單，選擇<strong><em>Extract Method…</em></strong>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor087.png" alt=""></p>
<p>出現<strong>Extract Method</strong>對話框，輸入重構後method名稱與選擇Visibility。</p>
<p>還可以選擇回傳值的處理方式，可以是<code>return</code>，也可以是<code>pass by reference</code>。</p>
<p>最後對於<code>switch</code>的處理方式，可以選擇在<code>case</code>內直接<code>return</code>，還是最後一起<code>return</code>，這裡選擇每個<code>case</code>內直接<code>return</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor088.png" alt=""></p>
<p>重構之後，PhpStorm會自動幫你建立<code>calculatePrice()</code>，且原來程式也幫你自動呼叫<code>calculatePrice()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor089.png" alt=""></p>
<p>馬上跑測試，確認PhpStorm的<strong>Extract Method</strong>沒將程式改壞掉。<span class="margin-note-marker"><sup>72</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">72</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/c7ec6a41092a59c4c9b283c3859a08c8fb7900c0" target="_blank" rel="external">重構 : Extract Method (switch -&gt; Customer-&gt;calculatePrice())</a></span></span></span></p>
<h3 id="Inline">Inline</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor090.png" alt=""></p>
<p>經過<strong>Extract Method</strong>重構之後，我們發現<code>$price</code>這個暫存變數沒有存在的價值了。可使用<strong>重構</strong>的<strong>Inlilne</strong>將此暫存變數移除。<span class="margin-note-marker"><sup>73</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">73</span>將滑鼠游標放在<code>$price</code>之後，按熱鍵&#8963; + T，會出現PhpStorm所有的<strong>重構</strong>選單，選擇<strong><em>Inline…</em></strong>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor091.png" alt=""></p>
<p>PhpStorm會詢問你是否將所有的<code>$price</code>變數都inline。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor092.png" alt=""></p>
<p>Inline之後，程式就變成我們所預期的只有一行。</p>
<p>馬上跑測試，確認PhpStorm的<strong>Inline</strong>沒將程式改壞掉。<span class="margin-note-marker"><sup>74</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">74</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/7847894ea3ee56999834ff20c27d67cd05efac5c" target="_blank" rel="external">重構 : Inline</a></span></span></span></p>
<h3 id="Move_Method">Move Method</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor169.png" alt=""></p>
<p>經過重構產生的<code>calculatePrice()</code>，但程式內卻一直使用<code>$order</code>物件的method，看起來<code>calculatePrice()</code>不應該放在<code>Customer</code>內，而應該放在<code>Order</code>內。<br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor093.png" alt=""></p>
<p>使用<strong>重構</strong>的<strong>Move Method</strong>將<code>calculatePrice()</code>從<code>Customer</code>搬到<code>Order</code>內。<span class="margin-note-marker"><sup>75</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">75</span>將滑鼠游標放在<code>calculatePrice</code>之後，按熱鍵&#8963; + T，會出現PhpStorm所有的<strong>重構</strong>選單，選擇<strong><em>Move…</em></strong>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor094.png" alt=""></p>
<p>出現<code>Move non-static method is not supported</code>錯誤訊息，也就是PhpStorm目前只能支援將對<code>static method</code>進行<strong>重構</strong>的<strong>Move Method</strong>，而一般<code>method</code>不支援。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor095.png" alt=""></p>
<p>因為PhpStorm目前僅支援<code>static method</code>的<strong>Move Method</strong>，因此先暫時將<code>calculatePrice()</code>改成<code>static method</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor096.png" alt=""></p>
<p>重新對<code>calculatePrice()</code>執行<strong>重構</strong>的<strong>Move Method</strong>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor097.png" alt=""></p>
<p>出現<strong>Move Static Member</strong>對話框，因為我們要將<code>calculatePrice()</code>搬到<code>Order</code>，要連namespace一起輸入。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor098.png" alt=""></p>
<p>重構之後，因為<code>calculatePrice()</code>已經變成<code>static method</code>，原來的<code>calculateTotalPrice()</code>內是使用<code>$this-&gt;calculatePrice($order)</code>，已經被PhpStorm重構成<code>Order::calculatePrice($order)</code>。</p>
<p>但這顯然不是我們要的。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor099.png" alt=""></p>
<p>將<code>Order::</code>改成<code>$order-&gt;</code>。<span class="margin-note-marker"><sup>76</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">76</span>加上註解描述<code>$order</code>的型別為<code>Order</code>這種寫法雖然可行，但不是最漂亮的寫法，最漂亮的寫法應該是直接在field註解型別，也就使在<code>protected $order = []</code>之前直接<code>@var Order[]</code>，之後所有的<code>foreach</code>內都不用再加上註釋。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor100.png" alt=""></p>
<p>PhpStorm雖然已經幫我們把<code>calculatePrice()</code>搬到<code>Order</code>，但顯然<code>static</code>是多餘的，且因為已經在<code>Order</code>，所以不需再傳入<code>$order</code>了。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor101.png" alt=""></p>
<p>將<code>static</code>刪除。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor102.png" alt=""></p>
<p>因為已經搬到<code>Order</code>，所以如<code>getMovie()</code>與<code>getDays()</code>都不在需要<code>$order</code>，而是需要改成<code>$this</code>。</p>
<p>使用<strong>重構</strong>的<strong>Rename</strong>，將<code>$order</code>改成<code>$this</code>。<span class="margin-note-marker"><sup>77</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">77</span>將滑鼠游標放在<code>$order</code>之後，按熱鍵&#8963; + T，會出現PhpStorm所有的<strong>重構</strong>選單，選擇<strong><em>Rename…</em></strong>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor103.png" alt=""></p>
<p>將全部的<code>$order</code>都改成<code>$this</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor104.png" alt=""></p>
<p>剛才我們只是借用<strong>重構</strong>的<strong>Rename</strong>將<code>$order</code>改成<code>$this</code>，事實上<code>calculatePrice()</code>根本不需要任何參數，將<code>Order $this</code>刪除。</p>
<p>馬上跑測試，確認PhpStorm的<strong>Rename</strong>沒將程式改壞掉。<span class="margin-note-marker"><sup>78</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">78</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/05adad763fc534f81400880f8bbf98168e90bf66" target="_blank" rel="external">重構 : Move Method : Order-&gt;calculatePrice()</a></span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor105.png" alt=""></p>
<p>在剛剛重構產生的<code>Order</code>的<code>calculatePrice()</code>內，我們發現<code>switch</code>竟然是去判斷<code>Movie</code>的<code>getType()</code>，這是不合理的，似乎暗示著應該將這個<code>switch</code>判斷搬到<code>Movie</code>內。<span class="margin-note-marker"><sup>79</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">79</span>使用滑鼠選擇想要重構的程式碼，按熱鍵&#8963; + T，會出現PhpStorm所有的<strong>重構</strong>選單，選擇<strong><em>Extract Method…</em></strong>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor106.png" alt=""></p>
<p>出現<strong>Extract Method</strong>對話框，原本我們是想將此<code>switch</code>重構成<code>Movie</code>的<code>calculatePrice()</code>，但PhpStorm的<strong>Extract Method</strong>無法跨class，我們只好先<strong>Extract Method</strong>在<code>Order</code>內，然後再使用<strong>Move Method</strong>搬到<code>Movie</code>。</p>
<p>因為同一個class不能存在兩個<code>calculatePrice()</code>，因此先取名為<code>MovieCalculatePrice()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor107.png" alt=""></p>
<p>使用<strong>Move Method</strong>將<code>MovieCalculatePrice()</code>搬到<code>Movie</code>。</p>
<p>因為目前PhpStorm只支援<code>static method</code>的<strong>Movie Method</strong>，因此先改成<code>static</code>。<span class="margin-note-marker"><sup>80</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">80</span>將滑鼠游標放在<code>MovieCalculatePrice</code>之後，按熱鍵&#8963; + T，會出現PhpStorm所有的<strong>重構</strong>選單，選擇<strong><em>Move…</em></strong>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor108.png" alt=""></p>
<p>出現<strong>Move Static Member</strong>對話框，因為我們要將<code>MovieCalculatePrice()</code>搬到<code>Movie</code>，要連namespace一起輸入。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor109.png" alt=""></p>
<p>重構之後，因為<code>MovieCalculatePrice()</code>已經變成<code>static method</code>，原來的<code>calculatePrice()</code>內是使用<code>$this-&gt;MovieCalculatePrice()</code>，已經被PhpStorm重構成<code>Movie::MovieCalculatePrice()</code>。</p>
<p>但這顯然不是我們要的。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor110.png" alt=""></p>
<p>將<code>Movie::MovieCalculatePrice()</code>改成<code>$this-&gt;getMovie()-&gt;calculatePrice()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor111.png" alt=""></p>
<p>PhpStorm雖然已經幫我們把<code>MovieCalculatePrice()</code>搬到<code>Movie</code>，但顯然<code>static</code>是多餘的。</p>
<p>且<code>$this-&gt;getMovie()</code>也不需要了，因為已經在<code>Movie</code>內，改用<code>$this</code>就好。</p>
<p><code>$this-&gt;getDays()</code>則比較麻煩，因為這原本是<code>Order-&gt;getDays()</code>，現在搬到Movie之後，勢必要靠參數從<code>Order</code>傳進來。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor112.png" alt=""></p>
<p>將<code>static</code>刪除。</p>
<p>將<code>$this-&gt;getMovie()</code>改成<code>$this</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor113.png" alt=""></p>
<p>我們是希望將<code>$this-&gt;getDays()</code>能<strong>Extract Parameter</strong>，不過目前在PhpStorm無法將一個method直接<strong>Extract Parameter</strong>，需要透過一些技巧。</p>
<p>先使用PhpStorm將<code>$this-&gt;getDays()</code>透過<strong>Extract Variable</strong>成變數。<span class="margin-note-marker"><sup>81</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">81</span>選擇<code>$this-&gt;getDays()</code>，按熱鍵&#8963; + T，會出現PhpStorm所有的<strong>重構</strong>選單，選擇<strong><em>Extract Variable…</em></strong>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor114.png" alt=""></p>
<p>出現<strong>Introduce variable</strong>對話框，我們希望重構成<code>$days</code>變數。</p>
<p>將<code>Replace all occurrences</code>打勾，我們打算將全部的<code>$this-&gt;getDays()</code>都取代。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor115.png" alt=""></p>
<p>我們看到<code>$this-&gt;getDays()</code>已經全部被<code>$days</code>所取代。</p>
<p>但<code>$days = $this-&gt;getDays()</code>顯然是多餘的。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor116.png" alt=""></p>
<p>將<code>$days = $this-&gt;getDays()</code>刪除。</p>
<p>加上<code>int $days</code>參數，並加上註解。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor117.png" alt=""></p>
<p>由於多了<code>int $days</code>參數，因此在<code>Order-&gt;calculatePrice()</code>要多傳<code>$this-&gt;getDays()</code>進來。</p>
<p>馬上跑測試，確認PhpStorm沒將程式改壞掉。<span class="margin-note-marker"><sup>82</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">82</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/24c5b86e246690a8d6717974ab3dd3a9a4bef43d" target="_blank" rel="external">重構 : Move Method : Movie-&gt;calculatePrice()</a></span></span></span></p>
<h3 id="Replace_Type_Code_with_State/Stratgey">Replace Type Code with State/Stratgey</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor170.png" alt=""></p>
<p>在<strong>重構</strong>的技巧中，有一招叫做<strong>Replace Type Code with State/Strategy</strong>，簡單的說，當你的程式會使用<code>switch</code>對同一個變數去做判斷時，可以改用物件導向的<strong>多型</strong>來處理，或者更白話的說，改用<strong>設計模式</strong>的<strong>State模式</strong>或<strong>Strategy模式</strong>去處理。</p>
<p>這樣的好處是會使你的程式符合<strong>SOLID</strong>的<strong>開放封閉原則</strong>，將來若新的需求要新增，將不用去改原來程式的<code>switch</code>，只要去新增class即可。<span class="margin-note-marker"><sup>83</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">83</span><strong>開放封閉原則</strong> : 軟體中的類別、函式對於擴展是開放的，對於修改是封閉的。</span></span></span></p>
<h3 id="Self_Encapsulate_Field">Self Encapsulate Field</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor118.png" alt=""></p>
<p>我們即將重構成<strong>State模式</strong>，因為<strong>State模式</strong>會將變化抽象化成一個<strong>物件</strong>，也就是需要將原本的字串，如<code>Regular</code>、<code>NewRelease</code>、<code>Children</code>最後抽象化成<strong>物件</strong>，因此<strong>重構</strong>教我們要使用<strong>Replace Type Code with State/Strategy</strong>前，先執行另一招重構 : <strong>Self Encapsulate Field</strong>。</p>
<p><strong>Self Encapsulate Field</strong>簡單的說，就是將field全部改用<code>setter</code>的方式寫入，這樣我們就可以在<code>setter</code>內將<strong>字串</strong>抽象化成<strong>物件</strong>。<span class="margin-note-marker"><sup>84</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">84</span>將滑鼠游標放在<code>$type</code>之後，按熱鍵&#8984; + N，會出現<code>Generate</code>選單，選擇<code>Setters</code>，可幫我們自動建立<code>$type</code>的setter。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor119.png" alt=""></p>
<p>選擇所要建立setter的field。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor120.png" alt=""></p>
<p>PhpStorm自動幫我們加上<code>$type</code>的setter : <code>setType()</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor121.png" alt=""></p>
<p>將setType()的參數加上type hint。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor122.png" alt=""></p>
<p>建立setter只是<strong>Self Encapsulate Field</strong>的第一步，接下來就將程式所有地方改用setter去寫入<code>$type</code> field。<span class="margin-note-marker"><sup>85</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">85</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/3f0729de0f88c44dc4679e780809421eb5369072" target="_blank" rel="external">重構 : Self Encapsulate Field</a></span></span></span></p>
<h3 id="將變化封裝在class">將變化封裝在class</h3><p><strong>State模式</strong>會將變化封裝在class內，也就是以物件導向的<strong>多型</strong>取代<code>switch</code>，無論將來怎麼變化，對使用者看起來都是相同的<code>abstract class</code>。</p>
<p><strong>建立Abstract Class</strong><br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor123.png" alt=""></p>
<p>在<code>VideoRental</code>目錄下建立<code>AbstractMovieType</code>。<span class="margin-note-marker"><sup>86</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">86</span>在左側選擇<code>VideoRental</code>目錄，按熱鍵&#8963; + N，會出現<code>New</code>選單，選擇<code>PHP Class</code>，可幫我們自動建立新的class。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor124.png" alt=""></p>
<p>出現<strong>Create New PHP class</strong>對話框，class名稱輸入<code>AbstractMovieType</code>，namespace選擇<code>VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor125.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>AbstractMovieType</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor126.png" alt=""></p>
<p>因為我們要建立的是abstract class，所以在class前面加上<code>abstract</code>。</p>
<p>另外定義一個abstract method : <code>calculatePrice()</code>。<span class="margin-note-marker"><sup>87</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">87</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/6c746df7b7486505520b9b8f9e7cfe9d07577b46" target="_blank" rel="external">重構 : 建立AbstractMovieType</a></span></span></span></p>
<p><strong>建立RegularMovieType Class</strong></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor127.png" alt=""></p>
<p>接著我們要將各種影片類型的計費方式，封裝在class內。</p>
<p>新增<code>RegularMovieType</code>，負責<strong>普通片</strong>的計費方式。<span class="margin-note-marker"><sup>88</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">88</span>在左側選擇<code>VideoRental</code>目錄，按熱鍵&#8963; + N，會出現<code>New</code>選單，選擇<code>PHP Class</code>，可幫我們自動建立新的class。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor128.png" alt=""></p>
<p>出現<strong>Create New PHP class</strong>對話框，class名稱輸入<code>RegularMovieType</code>，namespace選擇<code>VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor129.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>RegularMovieType</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor130.png" alt=""></p>
<p>繼承<code>AbstractMovieType</code>，使用PhpStorm幫我們建立abstract class所定義的method。<span class="margin-note-marker"><sup>89</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">89</span>將滑鼠游標放在<code>AbstractMovieType</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Add method stubs</code>，按下可自動根據所繼承的<code>abstract class</code>建立method。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor131.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>calculatePrice()</code>，連註解也會一併建立。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor132.png" alt=""></p>
<p>將原本在<code>Movie-&gt;calculatePrice()</code>內的<strong>普通片</strong>計費方式<strong>剪下</strong>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor133.png" alt=""></p>
<p>貼到<code>RegularMovieType</code>的<code>calculatePrice()</code>內。</p>
<p>直接將<code>$price</code>的初始值指定為<code>100</code>即可。<span class="margin-note-marker"><sup>90</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">90</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/19bdc0e9380da49ca6d90f54e3f2c4d0490cbe2e" target="_blank" rel="external">重構 : 建立RegularMovieType</a></span></span></span></p>
<p><strong>建立NewReleaseMovieType Class</strong><br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor134.png" alt=""></p>
<p>新增<code>NewReleaseMovieType</code>，負責<strong>新片</strong>的計費方式。<span class="margin-note-marker"><sup>91</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">91</span>在左側選擇<code>VideoRental</code>目錄，按熱鍵&#8963; + N，會出現<code>New</code>選單，選擇<code>PHP Class</code>，可幫我們自動建立新的class。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor135.png" alt=""></p>
<p>出現<strong>Create New PHP class</strong>對話框，class名稱輸入<code>NewReleaseMovieType</code>，namespace選擇<code>VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor136.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>NewReleaseMovieType</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor137.png" alt=""></p>
<p>繼承<code>AbstractMovieType</code>，使用PhpStorm幫我們建立abstract class所定義的method。<span class="margin-note-marker"><sup>92</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">92</span>將滑鼠游標放在<code>AbstractMovieType</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Add method stubs</code>，按下可自動根據所繼承的<code>abstract class</code>建立method。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor138.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>calculatePrice()</code>，連註解也會一併建立。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor139.png" alt=""></p>
<p>將原本在<code>Movie-&gt;calculatePrice()</code>內的<strong>新片</strong>計費方式<strong>剪下</strong>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor140.png" alt=""></p>
<p>貼到<code>NewReleaseMovieType</code>的<code>calculatePrice()</code>內。</p>
<p>直接將<code>$price</code>的初始值指定為<code>150</code>即可。<span class="margin-note-marker"><sup>93</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">93</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/ebf4d2057d46625018058426d9cf2b03c21151fc" target="_blank" rel="external">重構 : 建立NewReleaseMovieType</a></span></span></span></p>
<p><strong>建立ChildrenMovieType Class</strong></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor141.png" alt=""></p>
<p>新增<code>ChildrenMovieType</code>，負責<strong>兒童片</strong>的計費方式。<span class="margin-note-marker"><sup>94</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">94</span>在左側選擇<code>VideoRental</code>目錄，按熱鍵&#8963; + N，會出現<code>New</code>選單，選擇<code>PHP Class</code>，可幫我們自動建立新的class。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor142.png" alt=""></p>
<p>出現<strong>Create New PHP class</strong>對話框，class名稱輸入<code>ChildrenMovieType</code>，namespace選擇<code>VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor143.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>ChildrenMovieType</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor144.png" alt=""></p>
<p>繼承<code>AbstractMovieType</code>，使用PhpStorm幫我們建立abstract class所定義的method。<span class="margin-note-marker"><sup>95</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">95</span>將滑鼠游標放在<code>AbstractMovieType</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Add method stubs</code>，按下可自動根據所繼承的<code>abstract class</code>建立method。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor145.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>calculatePrice()</code>，連註解也會一併建立。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor146.png" alt=""></p>
<p>將原本在<code>Movie-&gt;calculatePrice()</code>內的<strong>兒童片</strong>計費方式<strong>剪下</strong>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor147.png" alt=""></p>
<p>貼到<code>ChildrenMovieType</code>的<code>calculatePrice()</code>內。</p>
<p>直接將<code>$price</code>的初始值指定為<code>40</code>即可。<span class="margin-note-marker"><sup>96</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">96</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/12b737c2e5c9cd4c98557aa01fdff20b84663bc5" target="_blank" rel="external">重構 : 建立ChildrenMovieType</a></span></span></span></p>
<p><strong>重構setType()</strong><br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor148.png" alt=""></p>
<p>之前的<code>setType()</code>只是單純的<code>$type</code> field的setter，不過使用<strong>State模式</strong>之後，<code>setType()</code>的角色就有了改變，不再只是單存的setter，而是要建立適當的<code>AbstractMovieType</code>物件。</p>
<p>將<code>calculatePrice()</code>剩下的<code>switch</code><strong>剪下</strong>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor149.png" alt=""></p>
<p>貼到<code>setType()</code>內。</p>
<p>將<code>$this-&gt;getType()</code>改成<code>$type</code>。</p>
<p>將<code>$this-&gt;type</code>改<code>new</code>我們剛剛建立，用來封裝<strong>計費方式</strong>的物件。</p>
<p><code>private $type</code>的PHPDoc註解型別，也從原來的<code>string</code>改成<code>AbstractMovieType</code>。</p>
<p><strong>重構getType()</strong><br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor150.png" alt=""></p>
<p>因為<code>$type</code> field的型別已經從原本的<code>string</code>改成<code>AbstractMovieType</code>，因此<code>getType()</code>的回傳型別與PHPDoc註解也要更新。</p>
<p><strong>重構calculatePrice()</strong><br><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor151.png" alt=""></p>
<p>由於<code>setType()</code>已經幫我們切換<strong>計費方式</strong>物件，據<strong>SOLID</strong>的<strong>里氏替換原則</strong>，且這些物件都是繼承於<code>AbstractMovieType</code>，根我們可以直接呼叫子類別的<code>calculatePrice()</code>。</p>
<p>馬上跑測試，確認<strong>重構</strong>沒將程式改壞掉。<span class="margin-note-marker"><sup>97</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">97</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/2febe67cb64bf893de17ac2e0c2ea99ca2c99de2" target="_blank" rel="external">重構 : Movie-&gt;setType(), getType()與calculatePrice()</a></span></span></span></p>
<h3 id="Replace_Constructor_with_Factory_Method">Replace Constructor with Factory Method</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor152.png" alt=""></p>
<p>在<strong>重構</strong>的技巧中，有一招叫做<strong>Replace Constructor with Factory Method</strong>，簡單的說，當你使用<code>new</code>去建立物件時，就直接相依了該物件，我們可將<code>new</code>物件的邏輯封裝在<strong>Simple Factory模式</strong>內，如此我們就只相依<strong>工廠物件</strong>，而不會直將相依於<strong>計費方式</strong>物件。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor153.png" alt=""></p>
<p>新增<code>MovieTypeFactory</code>，負責建立<strong>計費方式</strong>物件。<span class="margin-note-marker"><sup>98</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">98</span>在左側選擇<code>VideoRental</code>目錄，按熱鍵&#8963; + N，會出現<code>New</code>選單，選擇<code>PHP Class</code>，可幫我們自動建立新的class。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor154.png" alt=""></p>
<p>出現<strong>Create New PHP class</strong>對話框，class名稱輸入<code>MovieTypeFactory</code>，namespace選擇<code>VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor155.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>MovieTypeFactory</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor156.png" alt=""></p>
<p>建立<code>create()</code>，並宣告成static。</p>
<p>將原本在<code>Movie-&gt;setType()</code>的程式全部貼到<code>create()</code>內。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor157.png" alt=""></p>
<p><code>create()</code>加上<code>string $type</code>參數，並加上回傳型別<code>AbstractMovieType</code>。</p>
<p>因為<code>create()</code>功能就是在建立物件，所以全部改成<code>return</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor158.png" alt=""></p>
<p>原本<code>Movie-&gt;setType()</code>，改由<code>MovieFactory::create()</code>來建立<strong>計費方式</strong>物件。</p>
<p>如此<code>Movie</code>將不再直接相依於每個<strong>計費物件</strong>，只相依於<code>MovieTypeFactory</code>。</p>
<p>馬上跑測試，確認<strong>重構</strong>沒將程式改壞掉。<span class="margin-note-marker"><sup>99</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">99</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/265b345f75793f67e0e044b2b004fbe04a97934a" target="_blank" rel="external">重構 : Simple Factory</a></span></span></span></p>
<h3 id="Replace_Conditional_with_Polymorphism">Replace Conditional with Polymorphism</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor159.png" alt=""></p>
<p>在<strong>重構</strong>技巧中，有一招叫做<strong>Replace Conditional with Polymorphism</strong>，簡單的說，就是要使用物件導向的<strong>多型</strong>來取代<code>switch</code>，達到<strong>SOLID</strong>的<strong>開放封閉原則</strong>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor160.png" alt=""></p>
<p>使用Laravel的service container，利用<code>App::bind()</code>將<code>AbstractMovieType</code>與實際的<strong>計費方式</strong>連結。</p>
<p>使用<code>App::make()</code>建立<code>AbstractMovieType</code>型別的物件。</p>
<p>也就是說，只要<strong>計費方式</strong>物件改變，<code>App::bind()</code>會重新與<code>AbstractMovieType</code>連結，但對於<code>App::make()</code>來說，都是建立<code>AbstractMovieType</code>型別的物件，這就是物件導向的<strong>多型</strong>。<span class="margin-note-marker"><sup>100</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">100</span>詳細請參考<a href="/laravel/laravel-service-provider/">深入探討Service Provider</a></span></span></span></p>
<p>馬上跑測試，確認<strong>重構</strong>沒將程式改壞掉。<span class="margin-note-marker"><sup>101</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">101</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/182e7025e5fff605dc99419de774f2c72cd719be" target="_blank" rel="external">重構 : 多型App::bind()</a></span></span></span></p>
<h3 id="開放封閉原則">開放封閉原則</h3><table>
<thead>
<tr>
<th style="text-align:left">影片種類</th>
<th style="text-align:left">租期</th>
<th style="text-align:left">租金</th>
<th style="text-align:left">逾期費</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">普通片</td>
<td style="text-align:left">7天</td>
<td style="text-align:left">100</td>
<td style="text-align:left">10</td>
</tr>
<tr>
<td style="text-align:left">新片</td>
<td style="text-align:left">3天</td>
<td style="text-align:left">150</td>
<td style="text-align:left">30</td>
</tr>
<tr>
<td style="text-align:left">兒童片</td>
<td style="text-align:left">7天</td>
<td style="text-align:left">40</td>
<td style="text-align:left">10</td>
</tr>
<tr>
<td style="text-align:left">國片</td>
<td style="text-align:left">10天</td>
<td style="text-align:left">80</td>
<td style="text-align:left">10</td>
</tr>
</tbody>
</table>
<div class="alert alert-info"><i class="fa fa-info"></i>  現在需求改變，為了鼓勵<strong>國片</strong>，決定<strong>調降租金</strong>，並且<strong>延長租期</strong>。</div>
<p><strong> 測試案例 </strong></p>
<ol>
<li><p>普通片1支，10天</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  100 + (10-7) * 10 = 130</div>
</li>
<li><p>新片1支，5天</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  150 + (5-3) * 30 = 210</div>
</li>
<li><p>兒童片1支，8天</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  40 + (8-7) * 10 = 50</div>
</li>
<li><p>國片1支，12天</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  80 + (12-10) * 10 = 100</div>
</li>
</ol>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor161.png" alt=""></p>
<p>新增<strong>國片</strong>測試案例，得到第一個<span class="label label-danger">紅燈</span>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor162.png" alt=""></p>
<p>新增<code>TaiwanMovieType</code>，負責<strong>國片</strong>的計費方式。<span class="margin-note-marker"><sup>102</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">102</span>在左側選擇<code>VideoRental</code>目錄，按熱鍵&#8963; + N，會出現<code>New</code>選單，選擇<code>PHP Class</code>，可幫我們自動建立新的class。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor163.png" alt=""></p>
<p>出現<strong>Create New PHP class</strong>對話框，class名稱輸入<code>TaiwanMovieType</code>，namespace選擇<code>VideoRental</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor164.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>TaiwanMovieType</code>。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor165.png" alt=""></p>
<p>繼承<code>AbstractMovieType</code>，使用PhpStorm幫我們建立abstract class所定義的method。<span class="margin-note-marker"><sup>103</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">103</span>將滑鼠游標放在<code>AbstractMovieType</code>之後，按熱鍵&#8997; + &#8617;，會出現<code>Add method stubs</code>，按下可自動根據所繼承的<code>abstract class</code>建立method。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor166.png" alt=""></p>
<p>PhpStorm會幫我們建立<code>calculatePrice()</code>，連註解也會一併建立。</p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor167.png" alt=""></p>
<p>補上<strong>國片</strong>的<strong>計費方式</strong>。</p>
<p>馬上跑測試，確認新增的<strong>國片</strong>測試案例是否正常。<span class="margin-note-marker"><sup>104</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">104</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel51Refactor_demo/commit/fd60eb1e598c37d2c4fac0f1eb48fc7fa42fa528" target="_blank" rel="external">重構 : 開放封閉原則</a></span></span></span></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  若使用原本<strong>switch</strong>的方式，無論<strong>switch</strong>寫在哪裡，只要新增功能，就一定要去改<strong>switch</strong>，這就違反了<strong>SOLID</strong>的<strong>開放封閉原則</strong>，若使用物件導向的<strong>多型</strong>之後，若新增功能，只要新增class，繼承abstract class即可，原來的程式完全不用修改，完全達到<strong>開放封閉原則</strong>的要求。</div>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  我們做了哪些重構?</div>
<ol>
<li><strong>Extract Method</strong> : 將原本很長的函式利用<strong>Extract Method</strong>拆解成數個小小的method。</li>
<li><strong>Move Method</strong> : 利用<strong>Move Method</strong>將method搬到它適合的class內。</li>
<li><strong>使用多型取代switch</strong> : 若程式內有<code>switch</code>，考慮使用物件導向<strong>多型</strong>的<strong>State模式</strong>或<strong>Strategy模式</strong>取代，達成<strong>SOLID</strong>的<strong>開放封閉原則</strong>。</li>
</ol>
<h2 id="偵錯">偵錯</h2><hr>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor171.png" alt=""></p>
<p>假設在<strong>國片</strong>的<strong>計費方式</strong>，故意將<strong>逾期費用</strong><code>10</code>元改成<code>5</code>元，我們該如何找到這個bug呢?</p>
<h3 id="使用測試案例偵錯">使用測試案例偵錯</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor172.png" alt=""></p>
<p>執行測試，發現錯在<code>test_order_1_taiwan_movie_with_12_days()</code>這個測試案例，且期望值是100，而實際值是90。</p>
<p>且由於每個測試案例是針對單一class的method，我們可以很快的鎖定問題是出在<code>Customer-&gt;calculatePrice()</code>的錯誤。</p>
<h3 id="使用PhpStorm偵錯">使用PhpStorm偵錯</h3><p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor173.png" alt=""></p>
<p>PhpStorm允許我們直接在PHP內下中斷點，假如你知道問題在哪裡，可以直接在該class的method內下中斷點，若完全沒有頭緒，可以在<code>act</code>之處下中斷點，最少在執行target的method前會停下來。<span class="margin-note-marker"><sup>105</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">105</span>在欲中斷的程式之處按熱鍵 : &#8984; + F8，可<strong>設定</strong>或<strong>取消</strong>中斷點。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor174.png" alt=""></p>
<p>啟動<strong>偵錯</strong>模式。<span class="margin-note-marker"><sup>106</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">106</span>在欲啟動<strong>偵錯</strong>的測試案例內，按熱鍵 : &#8963; + &#8679; + D啟動偵錯模式，程式會停在剛剛建立的<strong>中斷點</strong>。</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor175.png" alt=""></p>
<p>Step Into進<code>Customer-&gt;calculateTotalPrice()</code>。<span class="margin-note-marker"><sup>107</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">107</span>Step Into : 熱鍵 : F7<br>Step Over : 熱鍵 : F8<br>Step Out : 熱鍵 : &#8679; + F8</span></span></span></p>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor176.png" alt=""></p>
<p>找到root cause在<code>TaiwanMovieType</code>的<code>calculatePrice()</code>的18行有問題。</p>
<h2 id="學習資源">學習資源</h2><hr>
<ul>
<li>測試 : <a href="https://laracasts.com/series/phpunit-testing-in-laravel" target="_blank" rel="external">PHPUnit Testing with Laravel</a></li>
</ul>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor177.png" alt=""></p>
<ul>
<li>重構 : <a href="http://www.tenlong.com.tw/items/9861547533?item_id=45657" target="_blank" rel="external">重構 : 改善既有程式的設計 (二版)</a></li>
</ul>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/refactor.jpg" alt=""></p>
<ul>
<li>設計模式 : <a href="http://www.tenlong.com.tw/items/9866761797?item_id=45056" target="_blank" rel="external">大話設計模式</a></li>
</ul>
<p><img src="/images/phpstorm/phpstorm-tdd-refactor/dp_easy.jpg" alt=""></p>
<h2 id="學習方式">學習方式</h2><hr>
<img src="/images/phpstorm/phpstorm-tdd-refactor/roadmap.svg" width="750">
<ul>
<li>直接由<strong>設計模式</strong>學習物件導向的學習曲線較為陡峭，很吃天份，失敗機率較高。</li>
<li>學習<strong>測試</strong>與<strong>重構</strong>達成<strong>設計模式</strong>的學習曲線較為平緩，適合常人，成功機率較高。</li>
</ul>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>好程式不是<strong>設計</strong>出來的，而是<strong>重構</strong>出來的。</li>
<li>重構一定要搭配測試。TDD讓我們以<strong>Top Down</strong>方式，以需求出發，幫助我們抽象化思考，不用太早就去思考細節，可以更容易設計出符合SOLID的物件導向程式。</li>
<li>測試重構會多花一點時間，因此我們要選擇更強悍的工具將時間省回來。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的<a href="https://github.com/oomusou/Laravel51Refactor_demo" target="_blank" rel="external">GitHub</a>上找到。</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/javascript/javascript-variable-method/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/laravel/eloquent/eloquent-relation-one-to-one/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2016-01-14 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/LaraDiner/">LaraDiner<span>17</span></a></li> <li><a href="/tags/PhpStorm/">PhpStorm<span>22</span></a></li> <li><a href="/tags/Refactoring/">Refactoring<span>3</span></a></li> <li><a href="/tags/TDD/">TDD<span>13</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
