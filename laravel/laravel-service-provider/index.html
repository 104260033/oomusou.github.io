<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>深入探討Service Provider | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="Service Provider是Laravel管理Package的核心技術">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="Service Provider是Laravel管理Package的核心技術">
<meta property="og:type" content="article">
<meta property="og:title" content="深入探討Service Provider">
<meta property="og:url" content="http://oomusou.io/laravel/laravel-service-provider/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="Service Provider是Laravel管理Package的核心技術">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2016-03-22T14:03:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入探討Service Provider">
<meta name="twitter:description" content="Service Provider是Laravel管理Package的核心技術">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 深入探討Service Provider</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> Service Provider是Laravel管理Package的核心技術			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#定義"><span class="toc-article-text">定義</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#As_Bootstrapper"><span class="toc-article-text">As Bootstrapper</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#As_Organizer"><span class="toc-article-text">As Organizer</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#邂逅_:_安裝Package"><span class="toc-article-text">邂逅 : 安裝Package</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#建立Service_Provider"><span class="toc-article-text">建立Service Provider</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#自己載入Package"><span class="toc-article-text">自己載入Package</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#使用–dev安裝package"><span class="toc-article-text">使用–dev安裝package</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#產生Service_Provider"><span class="toc-article-text">產生Service Provider</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#在register()註冊"><span class="toc-article-text">在register()註冊</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#註冊自己的Service_Provider"><span class="toc-article-text">註冊自己的Service Provider</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#管理自己的Service_Container"><span class="toc-article-text">管理自己的Service Container</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#建立Interface"><span class="toc-article-text">建立Interface</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#實現Interface"><span class="toc-article-text">實現Interface</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#注入Container"><span class="toc-article-text">注入Container</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#切換class"><span class="toc-article-text">切換class</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Register()與Boot()"><span class="toc-article-text">Register()與Boot()</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Deferred_Providers"><span class="toc-article-text">Deferred Providers</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#加入$defer"><span class="toc-article-text">加入$defer</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#加入provides()"><span class="toc-article-text">加入provides()</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#刪除service-json"><span class="toc-article-text">刪除service.json</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#重新啟動Laravel"><span class="toc-article-text">重新啟動Laravel</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>Laravel提供了<code>service container</code>讓我們方便實現<strong>Dependency Injection</strong>，而<code>service provider</code>則是我們註冊及管理service container的地方。</p>
<p>事實上Laravel內部所有的核心組件都是使用service provider統一管理，除了可以用來管理package外，也可以用來管理自己寫的物件。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Laravel 5.1</p>
<h2 id="定義">定義</h2><hr>
<h3 id="As_Bootstrapper">As Bootstrapper</h3><p>我們知道Laravel提供了service container，方便我們實現<strong>SOLID</strong>的<strong>依賴倒轉原則</strong>，當type hint搭配interface時，需要自己下<code>App::bind()</code>，Laravel才知道要載入什麼物件，但<code>App::bind()</code>要寫在哪裡呢？Laravel提供了<code>service provider</code>，專門負責<code>App::bind()</code>。</p>
<p>我們可以在<code>config/app.php</code>的<code>providers</code>看到所有的package，事實上Laravel核心與其他package都是靠service provider載入。</p>
<h3 id="As_Organizer">As Organizer</h3><p>Taylor在書中一直強調 : <code>不要認為只有package才會使用service provider，它可以用來管理自己的service container</code>，也就是說，若因為<code>需求</code>而需要墊<code>interface</code>時，可以把service provider當成<code>Simple Factory</code> pattern使用，將變化封裝在service provider內，將來需求若有變化，只要改service provider即可，其他使用該interface的程式皆不必修改。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span><a href="https://leanpub.com/laravel" target="_blank" rel="external">Laravel: From Apprentice To Artisan</a></span></span></span></p>
<h2 id="邂逅_:_安裝Package">邂逅 : 安裝Package</h2><hr>
<p>初學者第一次接觸service provider，應該是在安裝package時，以安裝<code>Laravel Debugbar</code>為例，一開始我們會使用composer安裝 : <span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>詳細請參考<a href="/laravel/laravel-debugbar/">如何使用Laravel Debugbar?</a></span></span></span></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ composer require barryvdh/laravel-debugbar</span><br></pre></td></tr></table></figure>
<p>接著我們會在<code>config/app.php</code>的<code>providers</code>加入<code>Barryvdh\Debugbar\ServiceProvider::class</code>。</p>
<figure class="highlight php"><figcaption><span>config/app.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'providers'</span> =&gt; [</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Laravel Framework Service Providers...</span><br><span class="line">     */</span></span><br><span class="line">    (略)</span><br><span class="line">    Illuminate\View\ViewServiceProvider::class,</span><br><span class="line">    Barryvdh\Debugbar\ServiceProvider::class,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Application Service Providers...</span><br><span class="line">     */</span></span><br><span class="line">    App\Providers\AppServiceProvider::class,</span><br><span class="line">    App\Providers\AuthServiceProvider::class,</span><br><span class="line">    App\Providers\EventServiceProvider::class,</span><br><span class="line">    App\Providers\RouteServiceProvider::class,</span><br><span class="line"></span><br><span class="line">],</span><br></pre></td></tr></table></figure> 
<p>上半部為<code>Laravel Framework Service Provider</code>，載入Laravel預設的package。</p>
<p>下半部為<code>Application Service Provider</code>，載入自己所使用的<code>service container</code>。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  為什麼使用composer安裝完package之後，還要設定service provider呢？</div>
<p>以Laravel Debugbar為例，使用composer安裝完package之後，只是將package安裝在<code>/vendor/barryvdh/laravel-debugbar</code>目錄下，此時Laravel還不知道有這個package，必須在<code>config/app.php</code>中<code>註冊</code>該package所提供的service provider，Laravel才知道Laravel Debugbar的存在，並在Laravel啟動時載入時透過Laravel Debugbar的service provider去載入Laravel Debugbar。</p>
<h2 id="建立Service_Provider">建立Service Provider</h2><hr>
<p>一般來說，有3個地方我們會自己建立service provider : </p>
<ol>
<li>想自己載入package。(As Bootstrapper)</li>
<li>想管理自己的service container。(As Organizer)</li>
<li>自己寫package。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>請參考<br><a href="/laravel/laravel-package-hello-world/">如何開發自己的Package?</a></span></span></span></li>
</ol>
<h3 id="自己載入Package">自己載入Package</h3><h4 id="使用–dev安裝package">使用–dev安裝package</h4><p>以Laravel Debugbar為例，雖然可以使用package所提供的service provider，並在<code>config/app.php</code>中註冊，不過由於Laravel Debugbar屬於<code>開發</code>用的package，因此我不希望<code>正式上線</code>主機也安裝，若使用之前的安裝方式，則連正式上線主機也會有Laravel Debugbar。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ composer require barryvdh/laravel-debugbar --dev</span><br></pre></td></tr></table></figure>
<p>composer加上<code>--dev</code>參數後，package只會安裝在<code>require-dev</code>區段，將來在正式上線主機只要下<code>composer install --no-dev</code>，就不會安裝Laravel Debugbar。</p>
<p><code>composer require</code>執行完，<code>composer.json</code>內容會如下圖所示 :<br><figure class="highlight javascript"><figcaption><span>config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"require"</span>: &#123;</span><br><span class="line">    <span class="string">"php"</span>: <span class="string">"&gt;=5.5.9"</span>,</span><br><span class="line">    <span class="string">"laravel/framework"</span>: <span class="string">"5.1.*"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"require-dev"</span>: &#123;</span><br><span class="line">    <span class="string">"fzaninotto/faker"</span>: <span class="string">"~1.4"</span>,</span><br><span class="line">    <span class="string">"mockery/mockery"</span>: <span class="string">"0.9.*"</span>,</span><br><span class="line">    <span class="string">"phpunit/phpunit"</span>: <span class="string">"~4.0"</span>,</span><br><span class="line">    <span class="string">"phpspec/phpspec"</span>: <span class="string">"~2.1"</span>,</span><br><span class="line">    <span class="string">"laravel/homestead"</span>: <span class="string">"^2.1"</span>,</span><br><span class="line">    <span class="string">"barryvdh/laravel-debugbar"</span>: <span class="string">"^2.0"</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h4 id="產生Service_Provider">產生Service Provider</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan make:provider MyLaravelDebugbarServiceProvider</span><br></pre></td></tr></table></figure>
<p>在<code>app\Providers\</code>目錄下會建立自己的<code>MyLaravelServiceProvider.php</code>，預設會有<code>boot()</code>與<code>register()</code>。<br><figure class="highlight php"><figcaption><span>app/Providers/MyLaravelServiceProvider.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLaravelDebugbarServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Bootstrap the application services.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Register the application services.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">    	<span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>所有的service provider都是繼承<code>Illuminate\Support\ServiceProvider</code>，因為<code>ServiceProvider</code>是一個<code>abstract class</code>，且定義了<code>register()</code>這個<code>abstract function</code>，所以繼承的<code>MyLaravelDebugbarServiceProvider</code>必須實作<code>register()</code>。</p>
<figure class="highlight php"><figcaption><span>Illuminate/Support/ServiceProvider.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Support</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">BadMethodCallException</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceProvider</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    (以上略)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    (以下略)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>register()</code>有兩個功能 : </p>
<ol>
<li>讓你手動<code>register</code>一個service provider。</li>
<li>讓你手動將一個interface <code>bind</code>到指定class。</li>
</ol>
<p>第一個功能用在<code>自己載入package</code>，第二個功能用在<code>管理自己的service container</code>，在下個範例會看到。</p>
<h4 id="在register()註冊">在register()註冊</h4><figure class="highlight php"><figcaption><span>Illuminate/Support/ServiceProvider.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Register the application services.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;app-&gt;environment() == <span class="string">'local'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;app-&gt;register(<span class="string">'Barryvdh\Debugbar\ServiceProvider'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>   
<p>由於Laravel Debugbar不適合在<code>正式上線</code>主機使用，因此我們特別判斷<code>application enviromnent</code>是否為<code>local</code>，若為local，才使用<code>$this-&gt;app-&gt;register()</code>註冊<code>Barryvdh\Debugbar\ServiceProvider</code>，這相當於在<code>config/app.php</code>的<code>providers</code>加入<code>Barryvdh\Debugbar\ServiceProvider::class</code>。</p>
<h4 id="註冊自己的Service_Provider">註冊自己的Service Provider</h4><figure class="highlight php"><figcaption><span>config/app.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'providers'</span> =&gt; [</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Laravel Framework Service Providers...</span><br><span class="line">     */</span></span><br><span class="line">    Illuminate\Foundation\Providers\ArtisanServiceProvider::class,</span><br><span class="line">    (略)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Application Service Providers...</span><br><span class="line">     */</span></span><br><span class="line">    App\Providers\AppServiceProvider::class,</span><br><span class="line">    App\Providers\AuthServiceProvider::class,</span><br><span class="line">    App\Providers\EventServiceProvider::class,</span><br><span class="line">    App\Providers\RouteServiceProvider::class,</span><br><span class="line">    App\Providers\MyLaravelDebugbarServiceProvider::class,</span><br><span class="line"></span><br><span class="line"> ],</span><br></pre></td></tr></table></figure> 
<p>在<code>config/app.php</code>的最下方加入<code>App\Providers\MyLaravelDebugbarServiceProvider::class</code>，載入剛剛我們自己建立的<code>MyLaravelDebugbarServiceProvider</code>。</p>
<p>也就是說，原本<code>config/app.php</code>是直接載入Laravel Debugbar提供的service provider，現在改成載入<code>自己寫</code>的service provider，加入了判斷application environment，再自行載入Laravel Debugbar提供的service provider，以避免在正式上線主機載入Laravel Debugbar。</p>
<p><img src="/images/laravel/laravel-service-provider/provider000.png" alt=""></p>
<h3 id="管理自己的Service_Container">管理自己的Service Container</h3><p>在<a href="/2015/10/14/tdd-repository-testing/">如何對Repository做測試?</a>中，我們曾經使用了<code>Repository Pattern</code>搭配controller，不過當初並沒有墊interface，現在我們加上了<code>PostControllerInterface</code>，並使用service provider管理。</p>
<h4 id="建立Interface">建立Interface</h4><figure class="highlight php"><figcaption><span>app/Contracts/PostRepositoryInterface.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Contracts</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Interface PostRepositoryInterface</span><br><span class="line"> * <span class="doctag">@package</span> App\Contracts</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">PostRepositoryInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 傳回最新3筆文章</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLatest3Posts</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義<code>PostRepositoryInterface</code>，只有一個<code>getLatest3Post()</code>。</p>
<h4 id="實現Interface">實現Interface</h4><figure class="highlight php"><figcaption><span>app/Repositories/PostRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Contracts</span>\<span class="title">PostRepositoryInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Class PostRepository</span><br><span class="line"> * <span class="doctag">@package</span> App\Repositories</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepository</span> <span class="keyword">implements</span> <span class="title">PostRepositoryInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> Post</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Post</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostRepository constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Post $Post</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Post <span class="variable">$Post</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;Post = <span class="variable">$Post</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 傳回最新3筆文章</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLatest3Posts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;Post</span><br><span class="line">            -&gt;query()</span><br><span class="line">            -&gt;orderBy(<span class="string">'id'</span>, <span class="string">'desc'</span>)</span><br><span class="line">            -&gt;limit(<span class="number">3</span>)</span><br><span class="line">            -&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第7行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Class PostRepository</span><br><span class="line"> * <span class="doctag">@package</span> App\Repositories</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepository</span> <span class="keyword">implements</span> <span class="title">PostRepositoryInterface</span></span></span><br></pre></td></tr></table></figure></p>
<p><code>PostRepository</code> class實踐了<code>PostRepositoryInterface</code>。</p>
<figure class="highlight php"><figcaption><span>app/Repositories/MyRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Contracts</span>\<span class="title">PostRepositoryInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Class MyRepository</span><br><span class="line"> * <span class="doctag">@package</span> App\Repositories</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRepository</span> <span class="keyword">implements</span> <span class="title">PostRepositoryInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 傳回最新3筆文章</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLatest3Posts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$posts</span> = <span class="keyword">new</span> Collection();</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt;= <span class="number">3</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$post</span> = [</span><br><span class="line">                <span class="string">'id'</span>        =&gt; <span class="variable">$i</span>,</span><br><span class="line">                <span class="string">'title'</span>     =&gt; <span class="string">'My title'</span> . <span class="variable">$i</span>,</span><br><span class="line">                <span class="string">'sub_title'</span> =&gt; <span class="string">'My sub_title'</span> . <span class="variable">$i</span>,</span><br><span class="line">                <span class="string">'content'</span>   =&gt; <span class="string">'My content'</span> . <span class="variable">$i</span>,</span><br><span class="line">            ];</span><br><span class="line"></span><br><span class="line">            <span class="variable">$posts</span>-&gt;push((object)<span class="variable">$post</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$posts</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第6行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Class MyRepository</span><br><span class="line"> * <span class="doctag">@package</span> App\Repositories</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRepository</span> <span class="keyword">implements</span> <span class="title">PostRepositoryInterface</span></span></span><br></pre></td></tr></table></figure></p>
<p><code>MyRepository</code> class一樣實踐了<code>PostRepositoryInterface</code>。</p>
<p>13行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 傳回最新3筆文章</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> Collection</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLatest3Posts</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$posts</span> = <span class="keyword">new</span> Collection();</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt;= <span class="number">3</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$post</span> = [</span><br><span class="line">            <span class="string">'id'</span>        =&gt; <span class="variable">$i</span>,</span><br><span class="line">            <span class="string">'title'</span>     =&gt; <span class="string">'My title'</span> . <span class="variable">$i</span>,</span><br><span class="line">            <span class="string">'sub_title'</span> =&gt; <span class="string">'My sub_title'</span> . <span class="variable">$i</span>,</span><br><span class="line">            <span class="string">'content'</span>   =&gt; <span class="string">'My content'</span> . <span class="variable">$i</span>,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$posts</span>-&gt;push((object)<span class="variable">$post</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$posts</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>沒到透過<code>Post</code> model向資料庫讀取資料，而是自己用<code>Collection</code>湊3筆資料。<br>比較特別的是<code>$post</code>為陣列，所以要<code>push</code>進collection時，需要轉型成<code>object</code>，否則blade在顯示時會出錯。</p>
<h4 id="注入Container">注入Container</h4><figure class="highlight php"><figcaption><span>app/Http/Controllers/PostsController.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Contracts</span>\<span class="title">PostRepositoryInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> PostRepositoryInterface</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$posts</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostsController constructor.</span><br><span class="line">     * <span class="doctag">@param</span> $posts</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepositoryInterface <span class="variable">$posts</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;posts = <span class="variable">$posts</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Display a listing of the resource.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> \Illuminate\Http\Response</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$posts</span> = <span class="variable">$this</span>-&gt;posts-&gt;getLatest3Posts();</span><br><span class="line">        <span class="variable">$data</span> = compact(<span class="string">'posts'</span>);</span><br><span class="line">        <span class="keyword">return</span> View(<span class="string">'posts.index'</span>, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第8行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@var</span> PostRepositoryInterface</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$posts</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * PostsController constructor.</span><br><span class="line"> * <span class="doctag">@param</span> $posts</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostRepositoryInterface <span class="variable">$posts</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;posts = <span class="variable">$posts</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將repository由constructor注入到controller，注意現在<code>$post</code>的型別為<code>PostRepositoryInterface</code>，而不是<code>PostRepository</code>。</p>
<h4 id="切換class">切換class</h4><p>Service container神奇的地方就在於任何有<code>type hint</code>的地方，Laravel都會自動幫你載入物件，但若<code>type hint</code>為<code>interface</code>，由於實踐該interface可能有很多物件，你必須使用<code>App::bind()</code>告訴Laravel該interface必須載入什麼物件，否則無法載入。</p>
<p>至於<code>App::bind()</code>該寫在哪裡呢？Taylor建議你寫在<code>service provider</code>的<code>register()</code>。</p>
<figure class="highlight php"><figcaption><span>app/Providers/RepositoryServiceProvider.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Contracts</span>\<span class="title">PostRepositoryInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">MyRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Class RepositoryServiceProvider</span><br><span class="line"> * <span class="doctag">@package</span> App\Providers</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RepositoryServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Bootstrap the application services.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Register the application services.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;app-&gt;bind(</span><br><span class="line">            PostRepositoryInterface::class,</span><br><span class="line">            PostRepository::class</span><br><span class="line"><span class="comment">//            MyRepository::class</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>24行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Register the application services.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;app-&gt;bind(</span><br><span class="line">            PostRepositoryInterface::class,</span><br><span class="line">            PostRepository::class</span><br><span class="line"><span class="comment">//            MyRepository::class</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>當你要注入的是<code>PostRepository</code>時，就bind<code>PostRepository::class</code>，若要注入的是<code>MyRepository</code>時，就bind<code>MyRepository::class</code>，controller完全不用修改。</p>
<h2 id="Register()與Boot()">Register()與Boot()</h2><hr>
<p>當我們使用<code>php artisan make:provider</code>建立service provider時，預設會建立<code>register()</code>與<code>boot()</code>，之前已經討論過<code>register()</code>是來自於<code>ServiceProvider</code>的abstract method，所以我們必須實踐，但<code>boot()</code>呢？<code>boot()</code>並不是<code>ServiceProvider</code>的abstract method，所以我們<code>可以不</code>實踐，但為什麼<code>php artisan make:provider</code>也幫我們建立了<code>boot()</code>呢？</p>
<p>當所有service provider的<code>register()</code>執行完後，接著會執行各serive provider的<code>boot()</code>，在<br>Laravel source的<code>Application</code>的<code>bootProvider()</code>會去呼叫<code>boot()</code>。<br><figure class="highlight php"><figcaption><span>Illuminate/Foundation/Application.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Boot the given service provider.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Support\ServiceProvider  $provider</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bootProvider</span><span class="params">(ServiceProvider <span class="variable">$provider</span>)</span></span><br><span class="line"> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (method_exists(<span class="variable">$provider</span>, <span class="string">'boot'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;call([<span class="variable">$provider</span>, <span class="string">'boot'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure> </p>
<p>所以Laravel並沒有強迫要實踐<code>boot()</code>，Laravel再執行完所有service provider的<code>register()</code>之後，若你有實作<code>boot()</code>的話，就會來執行該service provider的<code>boot()</code>。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  到底什麼程式該寫在register()?什麼程式該寫在 boot()呢?</div>
<p><code>register()</code>應該只拿來寫<code>App::bind()</code>或<code>App:register()</code>，若要使用初始化物件，或使用其他相依物件，則應該寫在<code>boot()</code>，有兩個原因 : </p>
<ol>
<li>根據<strong>SOLID</strong>的<strong>單一職責原則</strong>，<code>register()</code>只負責service container的register與binding，<code>boot()</code>負責初始化物件。</li>
<li>若在<code>register()</code>使用其他相依物件，可能該物件還沒<code>bind</code>，而導致執行錯誤；<code>boot()</code>在所有<code>register()</code>之後才執行，因此可以確保所有物件都已經<code>bind</code>。</li>
</ol>
<h2 id="Deferred_Providers">Deferred Providers</h2><hr>
<p>在<code>config/app.php</code>的<code>providers</code>中service provider，都會在Laravel一啟動時做register與binding，若一些service container較少被使用，你想在該service container實際被使用才做register與binding，以加快Laravel啟動，可以使用<code>deferred provider</code>。</p>
<h3 id="加入$defer">加入$defer</h3><figure class="highlight php"><figcaption><span>app/Providers/RepositoryServiceProvider.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RepositoryServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Indicates if loading of the provider is deferred.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@var</span> bool</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$defer</span> = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    (以下略)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在自己的service provider內加入<code>$defer</code> property為true。</p>
<h3 id="加入provides()">加入provides()</h3><figure class="highlight php"><figcaption><span>app/Providers/RepositoryServiceProvider.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RepositoryServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Get the services provided by the provider</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> array</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">provides</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [PostRepositoryInterface::class];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>provides()</code>回傳該service provider所要處理的完整interface名稱。</p>
<h3 id="刪除service-json">刪除service.json</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan clear-compiled</span><br></pre></td></tr></table></figure>
<p>所有要啟動的service provider都會被compile在<code>bootstrap/cache/service.json</code>，因為我們剛剛將<code>PostRepositoryServiceProvider</code>改成<code>deferred provider</code>，所以必須刪除<code>service.json</code>重新建立。</p>
<h3 id="重新啟動Laravel">重新啟動Laravel</h3><figure class="highlight php"><figcaption><span>bootstrap/cache/service.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"providers"</span>: [</span><br><span class="line">        (略)</span><br><span class="line">        <span class="string">"App\\Providers\\RepositoryServiceProvider"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"eager"</span>: [</span><br><span class="line">        (略)</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"deferred"</span>: &#123;</span><br><span class="line">        (略)</span><br><span class="line">        <span class="string">"App\\Contracts\\PostRepositoryInterface"</span>: <span class="string">"App\\Providers\\RepositoryServiceProvider"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"when"</span>: &#123;</span><br><span class="line">       （略)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Laravel重新啟動後，會重新建立<code>service.json</code>，在<code>providers</code>屬性，會列出所有service provider，因為我們剛剛將<code>PostRepositoryServiceProvider</code>加上<code>$deffered = true</code>，所以現在<code>defferred</code>屬性會有該service provider，而<code>provides()</code>所傳回的interface，正是物件的property。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Service provider提供了統一了大家寫<code>App::bind()</code>之處。</li>
<li><code>register()</code>內只應該寫register與binding，而<code>boot()</code>內只應該寫初始化物件或使用其他相依物件。</li>
<li>Service provider不單只是package會使用，也可以拿來管理service container，將變化封裝在service provider內，當將來需求變化時，只要修改service provider即可。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的<a href="https://github.com/oomusou/" target="_blank" rel="external">GitHub</a>上找到。</p>
<ol>
<li><a href="https://github.com/oomusou/MyLaravelDebugbar_demo" target="_blank" rel="external">My Laravel Debugbar</a></li>
<li><a href="https://github.com/oomusou/Laravel51RepositoryInterface_demo" target="_blank" rel="external">Repository with Interface</a></li>
<li><a href="https://github.com/oomusou/Laravel51RepositoryInterfaceDeffered_demo" target="_blank" rel="external">Repository with Deferred</a></li>
</ol>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/laravel/laravel-package-hello-world/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/tdd/tdd-91/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2015-11-09 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/LaraDiner/">LaraDiner<span>17</span></a></li> <li><a href="/tags/Laravel/">Laravel<span>39</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
