<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>如何使用 Repository 模式處理一對多資料庫? | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="讓 controller 與 model 徹底解耦合">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="讓 controller 與 model 徹底解耦合">
<meta property="og:type" content="article">
<meta property="og:title" content="如何使用 Repository 模式處理一對多資料庫?">
<meta property="og:url" content="http://oomusou.io/laravel/laravel-repository-fk/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="讓 controller 與 model 徹底解耦合">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2016-06-06T05:06:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何使用 Repository 模式處理一對多資料庫?">
<meta name="twitter:description" content="讓 controller 與 model 徹底解耦合">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 如何使用 Repository 模式處理一對多資料庫?</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 讓 controller 與 model 徹底解耦合			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#面臨的挑戰"><span class="toc-article-text">面臨的挑戰</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#支援一對多存檔"><span class="toc-article-text">支援一對多存檔</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#實際_Repository"><span class="toc-article-text">實際 Repository</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#單元測試"><span class="toc-article-text">單元測試</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#先新增_Post，再新增一筆_Comment"><span class="toc-article-text">先新增 Post，再新增一筆 Comment</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#先新增_Post，再新增多筆_Comment"><span class="toc-article-text">先新增 Post，再新增多筆 Comment</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#先新增_Comment，再新增_Post"><span class="toc-article-text">先新增 Comment，再新增 Post</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>Repository 模式對於處理中大型專案非常有效，可避免 model 與 controller 過於肥大而難以維護，且讓我們可以單獨對 repository 做單元測試，而不必對 Eloquent 做複雜的 mock。但在一對多的資料庫中，由於存在 foreign key，使得新增資料存檔時，因為 foreign key 還沒出現，而面臨了巨大的挑戰。</p>
<p>本文提出簡單方法，讓 Repository 也能處理一對多資料庫。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Laravel 5.2.32</p>
<h2 id="面臨的挑戰">面臨的挑戰</h2><hr>
<p>為了讓 controller 與 model 徹底解耦合，我們會使用 repository 模式，將資料庫邏輯封裝在 repository 內。為了方便，我們會將最常用的 CRUD 寫在 <code>AbstractRepository</code> 內。</p>
<p><strong>AbstractRepository.php</strong><br><figure class="highlight php"><figcaption><span>app/Repositories/AbstractRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** 注入的model */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 根據pk找資料</span><br><span class="line">     * <span class="doctag">@param</span> $id</span><br><span class="line">     * <span class="doctag">@param</span> array $columns</span><br><span class="line">     * <span class="doctag">@return</span> mixed</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">(<span class="variable">$id</span>, <span class="variable">$columns</span> = [<span class="string">'*'</span>])</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;find(<span class="variable">$id</span>, <span class="variable">$columns</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 根據一般欄位找資料</span><br><span class="line">     * <span class="doctag">@param</span> $attribute</span><br><span class="line">     * <span class="doctag">@param</span> $value</span><br><span class="line">     * <span class="doctag">@param</span> array $columns</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findBy</span><span class="params">(<span class="variable">$attribute</span>, <span class="variable">$value</span>, <span class="variable">$columns</span> = [<span class="string">'*'</span>])</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model</span><br><span class="line">            -&gt;where(<span class="variable">$attribute</span>, <span class="string">'='</span>, <span class="variable">$value</span>)</span><br><span class="line">            -&gt;first(<span class="variable">$columns</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳全部資料</span><br><span class="line">     * <span class="doctag">@param</span> array $columns</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">all</span><span class="params">(<span class="variable">$columns</span> = [<span class="string">'*'</span>])</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;all(<span class="variable">$columns</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 回傳分頁資料</span><br><span class="line">     * <span class="doctag">@param</span> int $perPage</span><br><span class="line">     * <span class="doctag">@param</span> array $columns</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">paginate</span><span class="params">(<span class="variable">$perPage</span> = <span class="number">15</span>, <span class="variable">$columns</span> = [<span class="string">'*'</span>])</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;paginate(<span class="variable">$perPage</span>, <span class="variable">$columns</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 新增資料，回傳 model，直接存檔</span><br><span class="line">     * <span class="doctag">@param</span> array $data</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(array <span class="variable">$data</span>)</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;create(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 修改資料，回傳 model，直接存檔</span><br><span class="line">     * <span class="doctag">@param</span> array $data</span><br><span class="line">     * <span class="doctag">@param</span> $id</span><br><span class="line">     * <span class="doctag">@param</span> string $attribute</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(array <span class="variable">$data</span>, <span class="variable">$id</span>, <span class="variable">$attribute</span> = <span class="string">"id"</span>)</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model</span><br><span class="line">            -&gt;where(<span class="variable">$attribute</span>, <span class="string">'='</span>, <span class="variable">$id</span>)</span><br><span class="line">            -&gt;update(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刪除資料，回傳 model，直接刪除</span><br><span class="line">     * <span class="doctag">@param</span> $id</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">(<span class="variable">$id</span>)</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;destroy(<span class="variable">$id</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>這樣對於單一 table 來說，新的 repository 只要繼承 <code>AbstractRepository</code>，基本的 CRUD 都有了。</p>
<p>但若是一對多 table，因為存在 FK，因此無法在 <code>create()</code> 時同時處理 FK。</p>
<h2 id="支援一對多存檔">支援一對多存檔</h2><hr>
<p>對 <code>AbstractRepository</code> 稍加擴充，讓 repository 可以利用 Eloquent 的 relation 處理 FK。</p>
<p><strong>AbstractRepository.php</strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/04e7bb23e55352de275cfcba417c5ca2fb91d3d8" target="_blank" rel="external">新增 AbstractRepository</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/AbstractRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** 注入的model */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string $modelName model名稱 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$modelName</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * AbstractRepository constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;modelName = get_class(<span class="variable">$this</span>-&gt;model);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 若存在則傳回 model，若不存在則新增</span><br><span class="line">     * <span class="doctag">@param</span> array $data</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">firstOrCreate</span><span class="params">(array <span class="variable">$data</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;model-&gt;firstOrCreate(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 新增資料，傳回 model，不存檔</span><br><span class="line">     * <span class="doctag">@param</span> array $data</span><br><span class="line">     * <span class="doctag">@return</span> Model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span><span class="params">(array <span class="variable">$data</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$this</span>-&gt;modelName(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>22 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 新增資料，傳回 model，不存檔</span><br><span class="line"> * <span class="doctag">@param</span> array $data</span><br><span class="line"> * <span class="doctag">@return</span> Model</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span><span class="params">(array <span class="variable">$data</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$this</span>-&gt;modelName(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新增資料除了原有的 <code>create()</code>外，還多了 <code>new()</code>，專門負責處理一對多的新增，此時並不像 <code>create()</code> 將資料直接存進資料庫，而是傳回 model 物件。</p>
<p><code>modelName</code> 為 field，主要儲存目前 repository 的 model 的 class 名稱，為一字串，主要提供 <code>new</code> 所需要的變數。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>這裡用到了一個 PHP 技巧，<code>new</code> 了一個變數成物件，詳細請參考<a href="/php/php-variable-object/">如何使用變數建立物件?</a></span></span></span></p>
<p>14  行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * AbstractRepository constructor.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;modelName = get_class(<span class="variable">$this</span>-&gt;model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>modelName</code> 在 constructor 內，由 PHP 原生的 <code>get_class()</code> 從 model 物件獲得該物件的 class 名稱。</p>
<p>47 行<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 若存在則傳回 model，若不存在則新增</span><br><span class="line"> * @param <span class="keyword">array</span> <span class="variable">$data</span></span><br><span class="line"> * @<span class="keyword">return</span> Model</span><br><span class="line"> */</span><br><span class="line">public <span class="keyword">function</span> firstOrCreate(<span class="keyword">array</span> <span class="variable">$data</span>)</span><br><span class="line">&#123;</span><br><span class="line">    return <span class="variable">$this-</span>&gt;model-&gt;firstOrCreate(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>這也是新增的 method，主要用在一對多存檔時，如典型的 1 篇 post 對多篇 comment。</p>
<p>新增 comment 時，post 可能存在，也可能不存在，只要將 post 資料傳給 <code>firstOrCreate()</code> 即可，若 post 存在則傳回 <code>Post</code> model，若不存在則新增 post 並傳回 <code>Post</code> model，也就是無論如何都會傳回 <code>model</code>，讓 <code>Post</code> 可以透過 relation 來處理 <code>comment</code> 的 FK。</p>
<h2 id="實際_Repository">實際 Repository</h2><hr>
<p>將以典型的 1 篇 post 對多篇 comment 的一對多架構，實際使用 repository 模式來處理 comment 的 FK。</p>
<p><strong>PostRepository.php</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/d0b2ec387637a0f858d765b8457102881a7e585d" target="_blank" rel="external">新增 PostRepository</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/PostRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepository</span> <span class="keyword">extends</span> <span class="title">AbstractRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Post $model Model物件 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostRepository constructor.</span><br><span class="line">     * <span class="doctag">@param</span> $model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Post <span class="variable">$model</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;model = <span class="variable">$model</span>;</span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>PostRepository</code> 直接繼承 <code>AbstractRepository</code>，在 constructor 將 <code>Post</code> model 注入，並執行 <code>parent::__construct()</code>，也就是 <code>AbstractRepository</code> 的 constructor。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  一般我們習慣將 <b>parent::__construct()</b> 寫在 constructor 的第一行，不過在此我們必須很技巧的將 <b>parent::__construct()</b> 寫在 constructor 的最後一行，因為在 AbstractRepository 的 constructor 中，$modelName 是由 $model 透過 <b>get_class()</b> 而來，所以 $model 必須先準備好才能 <b>get_class()</b>，因此 <b>parent::__construct()</b> 必須寫在最後一行。</div>
<p><strong>CommentRepository.php</strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/82cd347c7c5f33a1573556c96471293f6d504c2a" target="_blank" rel="external">新增 CommentRepository</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/CommentRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Comment</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentRepository</span> <span class="keyword">extends</span> <span class="title">AbstractRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Comment $model Model物件  */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostRepository constructor.</span><br><span class="line">     * <span class="doctag">@param</span> $model</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Comment <span class="variable">$model</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;model = <span class="variable">$model</span>;</span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同理，<code>CommentRepository</code> 也只需繼承 <code>AbstractRepository</code> 即可，其餘與 <code>PostRepository</code> 相同。</p>
<h2 id="單元測試">單元測試</h2><hr>
<h3 id="先新增_Post，再新增一筆_Comment">先新增 Post，再新增一筆 Comment</h3><p>最簡單的應用，就是先新增一筆 post，再新增一筆 comment。</p>
<p><strong>PostRepositoryTest.php</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/82b2f934b96717b43e68d6a934c0f2a882a8d044" target="_blank" rel="external">單元測試 : 先新增 Post 再新增一筆 Comment</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/Repositories/PostRepositoryTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">CommentRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepositoryTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 先新增<span class="title">Post</span>再新增一筆<span class="title">Comment</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="comment">//&lt;editor-fold desc="Expected"&gt;</span></span><br><span class="line">        <span class="variable">$expectedPost</span> = [</span><br><span class="line">            <span class="string">'title'</span>       =&gt; <span class="string">'Post1 title'</span>,</span><br><span class="line">            <span class="string">'description'</span> =&gt; <span class="string">'Post1 description'</span>,</span><br><span class="line">            <span class="string">'content'</span>     =&gt; <span class="string">'Post1 content'</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedComment</span> = [</span><br><span class="line">            <span class="string">'name'</span>    =&gt; <span class="string">'Sam'</span>,</span><br><span class="line">            <span class="string">'email'</span>   =&gt; <span class="string">'oomusou@gmail.com'</span>,</span><br><span class="line">            <span class="string">'comment'</span> =&gt; <span class="string">"Sam's comment"</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">//&lt;/editor-fold&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$target</span> = app(PostRepository::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$target</span>-&gt;create(<span class="variable">$expectedPost</span>)</span><br><span class="line">            -&gt;comments()</span><br><span class="line">            -&gt;create(<span class="variable">$expectedComment</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'posts'</span>, <span class="variable">$expectedPost</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>29 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="variable">$target</span>-&gt;create(<span class="variable">$expectedPost</span>)</span><br><span class="line">    -&gt;comments()</span><br><span class="line">    -&gt;create(<span class="variable">$expectedComment</span>);</span><br></pre></td></tr></table></figure></p>
<p><code>$target</code> 即為 <code>PostRepository</code>。</p>
<p>post 資料由 <code>create()</code> 傳入，新增後回傳 <code>Post</code> model，繼續由 <code>comments()</code> relation 去新增 comment。</p>
<p>由於 comment 資料是由 <code>PostRepository</code> 負責，而非 <code>CommentRepository</code> 負責，因此 comment 的 FK 會由 <code>PostRepository</code> 處理。</p>
<p>這種方式與直接使用 Eloquent 處理一對多類似，也符合 ActiveRecord 習慣，因此非常直覺。</p>
<h3 id="先新增_Post，再新增多筆_Comment">先新增 Post，再新增多筆 Comment</h3><p>此外，先新增一筆 post，再新增多筆 comment，也是常見的應用。</p>
<p><strong>PostRepositoryTest.php</strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/6e0f9604413f8fa152fab40069c83c794de74f9d" target="_blank" rel="external">單元測試 : 先新增 Post 再新增多筆 Comment</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/Repositories/PostRepositoryTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">CommentRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepositoryTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 先新增<span class="title">Post</span>再新增多筆<span class="title">Comment</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="comment">//&lt;editor-fold desc="Expected"&gt;</span></span><br><span class="line">        <span class="variable">$expectedPost</span> = [</span><br><span class="line">            <span class="string">'title'</span>       =&gt; <span class="string">'Post1 title'</span>,</span><br><span class="line">            <span class="string">'description'</span> =&gt; <span class="string">'Post1 description'</span>,</span><br><span class="line">            <span class="string">'content'</span>     =&gt; <span class="string">'Post1 content'</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedComment</span> = [</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Sam'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'oomusou@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Sam's comment"</span></span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Sunny'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'sunny@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Sunny's comment"</span></span><br><span class="line">            ],</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">//&lt;/editor-fold&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$target</span> = app(PostRepository::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$post</span> = <span class="variable">$target</span>-&gt;create(<span class="variable">$expectedPost</span>);</span><br><span class="line"></span><br><span class="line">        collect(<span class="variable">$expectedComment</span>)</span><br><span class="line">            -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> <span class="title">use</span> <span class="params">(<span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">                <span class="variable">$post</span>-&gt;comments()-&gt;create(<span class="variable">$value</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'posts'</span>, <span class="variable">$expectedPost</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>37 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post</span> = <span class="variable">$target</span>-&gt;create(<span class="variable">$expectedPost</span>);</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>PostRepository</code> 先新增一筆 post。</p>
<p>39 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">collect(<span class="variable">$expectedComment</span>)</span><br><span class="line">    -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> <span class="title">use</span> <span class="params">(<span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">        <span class="variable">$post</span>-&gt;comments()-&gt;create(<span class="variable">$value</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<p>因為有多筆 comments 要新增，所以動用了 <code>collection-&gt;each()</code>。</p>
<p>使用 <code>Post</code> model 的 <code>comments()</code> relation 來新增每個 <code>comment</code>。</p>
<h3 id="先新增_Comment，再新增_Post">先新增 Comment，再新增 Post</h3><p>前面兩個範例，都是先新增 post，再新增 comment，但實務上可能遇到 comment 先新增，然後才新增 post，此時就會遇到 comment 新增，但 FK 還沒出現的問題。</p>
<p><strong>PostRepositoryTest.php</strong><span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo/commit/153444d6e312eefd43350612c779912c1aaa1225" target="_blank" rel="external">單元測試 : 先新增Comment再新增Post</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/Repositories/PostRepositoryTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">CommentRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepositoryTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 先新增<span class="title">Comment</span>再新增<span class="title">Post</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="comment">//&lt;editor-fold desc="Expected"&gt;</span></span><br><span class="line">        <span class="variable">$expectedPost</span> = [</span><br><span class="line">            <span class="string">'title'</span>       =&gt; <span class="string">'Post1 title'</span>,</span><br><span class="line">            <span class="string">'description'</span> =&gt; <span class="string">'Post1 description'</span>,</span><br><span class="line">            <span class="string">'content'</span>     =&gt; <span class="string">'Post1 content'</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedComment</span> = [</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Sam'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'oomusou@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Sam's comment"</span>,</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Sunny'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'sunny@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Sunny's comment"</span>,</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'name'</span>    =&gt; <span class="string">'Jack'</span>,</span><br><span class="line">                <span class="string">'email'</span>   =&gt; <span class="string">'jack@gmail.com'</span>,</span><br><span class="line">                <span class="string">'comment'</span> =&gt; <span class="string">"Jack's comment"</span>,</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">//&lt;/editor-fold&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$postRepository</span> = app(PostRepository::class);</span><br><span class="line">        <span class="variable">$commentRepository</span> = app(CommentRepository::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$comment</span> = <span class="variable">$commentRepository</span>-&gt;new(<span class="variable">$expectedComment</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="variable">$post</span> = <span class="variable">$postRepository</span>-&gt;firstOrCreate(<span class="variable">$expectedPost</span>);</span><br><span class="line">        <span class="variable">$post</span>-&gt;comments()-&gt;save(<span class="variable">$comment</span>);</span><br><span class="line"></span><br><span class="line">        collect(<span class="variable">$expectedComment</span>)</span><br><span class="line">            -&gt;forget(<span class="number">0</span>)</span><br><span class="line">            -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> <span class="title">use</span> <span class="params">(<span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">                <span class="variable">$post</span>-&gt;comments()-&gt;create(<span class="variable">$value</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'posts'</span>, <span class="variable">$expectedPost</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$this</span>-&gt;seeInDatabase(<span class="string">'comments'</span>, <span class="variable">$expectedComment</span>[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>43 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$comment</span> = <span class="variable">$commentRepository</span>-&gt;new(<span class="variable">$expectedComment</span>[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure></p>
<p>根據需求，comment 必須先新增，此時因為 comment 的 FK 還不知道，因此不能使用 <code>create()</code>，只能使用 <code>new()</code> 先將 comment 資料存進 <code>Comment</code> model 並回傳。</p>
<p>44 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post</span> = <span class="variable">$postRepository</span>-&gt;firstOrCreate(<span class="variable">$expectedPost</span>);</span><br></pre></td></tr></table></figure></p>
<p>將 post 資料由 <code>firstOrCreate()</code> 傳入，無論 post 資料是否存在，最後都會傳回 <code>Post</code> model。</p>
<p>45 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post</span>-&gt;comments()-&gt;save(<span class="variable">$comment</span>);</span><br></pre></td></tr></table></figure></p>
<p>最後由 <code>Post</code> model 的 <code>comments()</code> relation 負責儲存 <code>Comment</code> model，其 FK 也會由 <code>PostRepository</code> 來儲存。</p>
<p>47 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">collect(<span class="variable">$expectedComment</span>)</span><br><span class="line">    -&gt;forget(<span class="number">0</span>)</span><br><span class="line">    -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> <span class="title">use</span> <span class="params">(<span class="variable">$post</span>)</span> </span>&#123;</span><br><span class="line">        <span class="variable">$post</span>-&gt;comments()-&gt;create(<span class="variable">$value</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<p>最後由 <code>collection-&gt;each()</code> 來儲存剩下的 comments 資料。</p>
<p>唯一較特殊的是 : 因為第一筆 comment 已經儲存過，所以必須先使用 <code>forget(0)</code> 加以踢除，避免重複存檔。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Eloquent 因為使用 ActiveRecord 模式，本身就有點 repository 味道，因此很多人在使用 repository + Eloquent，會覺得有點格格不入的感覺，尤其在處理一對多存檔時，因為 FK 的問題而傷透腦筋。本文在不改變 Eloquent 習慣的前提下，多了一個 <code>new()</code> 與 <code>firstOrCreate()</code>，讓 repository 也能順利處理一對多存檔。</li>
<li>Repository 模式並沒有要取代 Eloquent，事實上 Eloquent 非常的好用，只是在大型專案下，若大量將資料庫邏輯寫在 model，會造成 model 肥大而難以維護，若透過 repository 模式，若單一 repository 過於肥大，甚至可以單一 model 配合多個 repository，讓 repository 更加的<strong>高內聚</strong>，也讓 controller 與 model 更加的<strong>低耦合</strong>，如此將更好維護，repository 也更容易測試。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52RepositoryFK_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/javascript/javascript-variable-property/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/tdd/tdd-factory-ocp/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2016-05-28 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Laravel/">Laravel<span>35</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
