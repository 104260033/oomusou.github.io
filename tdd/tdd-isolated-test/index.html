<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>如何測試內含相依物件的函式? | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="幾個解決內含相依物件而無法隔離測試的方法">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="幾個解決內含相依物件而無法隔離測試的方法">
<meta property="og:type" content="article">
<meta property="og:title" content="如何測試內含相依物件的函式?">
<meta property="og:url" content="http://oomusou.io/tdd/tdd-isolated-test/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="幾個解決內含相依物件而無法隔離測試的方法">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2016-04-07T16:48:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何測試內含相依物件的函式?">
<meta name="twitter:description" content="幾個解決內含相依物件而無法隔離測試的方法">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">點燈坊</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 如何測試內含相依物件的函式?</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 幾個解決內含相依物件而無法隔離測試的方法			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#傳統寫法"><span class="toc-article-text">傳統寫法</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#為什麼要隔離？"><span class="toc-article-text">為什麼要隔離？</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解決方法"><span class="toc-article-text">解決方法</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#依賴注入方法"><span class="toc-article-text">依賴注入方法</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#OOP反璞歸真方法"><span class="toc-article-text">OOP反璞歸真方法</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PHP邪惡方法"><span class="toc-article-text">PHP邪惡方法</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>談到unit test，就不能不談到isolated test，但實務上常常因為函式內有相依物件而無法做到isolated ，若是依照TDD的方式寫unit test，因為測試先寫，會一開始就考慮到<code>可測試性</code>，自然會將相依物件改用DI與service container的方式，但若是<code>事後補測試</code>，就常常會有因為相依物件而造成測試加不上去的問題。<br>本文歸納出幾個方法，有<code>依賴注入方法</code>，有<code>OOP反璞歸真方法</code>，最後還有<code>PHP邪惡方法</code>。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 5.6.15<br>Laravel 5.1.24<br>Homestead 0.3.0</p>
<h2 id="傳統寫法">傳統寫法</h2><hr>
<p>在Taylor Otwell的<a href="https://leanpub.com/laravel" target="_blank" rel="external">Laravel: From Apprentice To Artisan</a>的第2頁談到一段code :<br><figure class="highlight php"><figcaption><span>app/Http/Controllers/UserController.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$users</span> = User::all();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'users.index'</span>, compact(<span class="string">'users'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>大部分人學MVC架構，都是這樣寫controller，別小看這兩行code，若我們想對controller做unit test時，<code>User::all()</code>這一行我們就面臨很大的問題 : </p>
<ol>
<li><p><code>User</code>是個model，也就是<code>相依物件</code>，它直接到資料庫去抓資料，若我們要對<code>UserController@index</code>寫測試時，勢必得直接去資料庫抓資料，由於資料庫比較慢，這就違反了unit test的<strong>FIRST</strong>原則的<strong>Fast</strong>。</p>
</li>
<li><p>為了isolated test，我們會想將<code>User</code>給mock掉，但因為<code>User</code>直接相依在<code>index()</code>內，導致我們無從注入mock，因此無法寫測試。</p>
</li>
</ol>
<h2 id="為什麼要隔離？">為什麼要隔離？</h2><hr>
<p>實際程式彼此之間一定都有關聯，所以一定會有相依物件，為了做unit test，我們需要將這些相依物件做隔離 : <span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>以下5點歸納來自於<a href="http://jaceju.net" target="_blank" rel="external">大澤木小鐵</a>的<a href="/tdd/tdd-jaceju/">在PHP上學會自動化測試與實戰TDD</a>與<a href="https://www.facebook.com/91agile/?fref=ts" target="_blank" rel="external">陳仕傑</a>在<a href="https://skilltree.my" target="_blank" rel="external">SkillTree</a>開的<a href="https://skilltree.my/events/mbh" target="_blank" rel="external">自動測試與TDD開發實務(使用C#)第四梯</a>的講義內容。</span></span></span></p>
<ol>
<li><p><strong>執行速度快</strong><br>unit test的執行速度就是要快，才能方便我們不斷的測試與重構，若程式中使用了<code>外部API</code>、<code>檔案存取</code>、<code>資料庫存取</code>這些，一定要想辦法隔離掉，才能加速測試速度，若測試包含了<code>外部API</code>、<code>檔案存取</code>、<code>資料庫存取</code>，就不算是unit test了，而是integration test。</p>
</li>
<li><p><strong>關注點分離</strong><br>現在unit test要測試的是controller，而非model，因此我們希望能將model給mock掉，將關注點鎖定在controller。</p>
</li>
<li><p><strong>單一職責</strong><br>物件導向 <strong><em>SOLID</em></strong> 的第一條要求 <strong><em>單一職責</em></strong>，若以測試的角度來看，單一職責讓我們<code>容易寫測試</code>，試想controller內同時包含<code>商業邏輯</code>與<code>資料庫邏輯</code>時，由於功能太多，我們測試會多難寫呢？</p>
</li>
<li><p><strong>獨立測試</strong><br>若被測試的程式包含<code>外部API</code>、<code>檔案存取</code>、<code>資料庫存取</code>等相依物件，我們在做測試時就必須要有很多前提，如</p>
<ul>
<li>網路必須暢通才能存取外部API。</li>
<li>檔案必須存在才能存取。</li>
<li>資料庫必須要有某些資料才能測試。</li>
</ul>
<p>若我們能將這些相依物件加以隔離，也就是說不用再依賴<code>某些前提下</code>才能做測試，我們就能單獨對每一個method做測試，也因為如此，我們會非常容易debug，若某個method的unit test出錯，就一定是該method的邏輯有問題，而不是<code>外部API</code>、<code>檔案</code>或<code>資料庫</code>有問題。</p>
</li>
<li><p><strong>測試程式的健壯性</strong><br>一個好的unit test，應該只在<code>需求異動</code>才需要修改，若沒有隔離掉相依物件，則可能相依物件修改，則unit test也要跟著修改。</p>
</li>
</ol>
<h2 id="解決方法">解決方法</h2><hr>
<h3 id="依賴注入方法">依賴注入方法</h3><p>最主流的方法就是使用DI搭配Laravel的service container，讓所有的相依都透過costructor注入，這樣在測試時，我們就可以使用mock的方式產生<code>假物件</code>，徹底隔離相依物件。</p>
<p>若是用在controller，就會搭配repository pattern，將所有的<code>資料庫邏輯</code>寫在repository內，透過constructor注入到controller，而在controller則專心寫<code>商業邏輯</code>，在對controller做unit test時，就可以將repository加以mock，徹底隔離資料庫。</p>
<figure class="highlight php"><figcaption><span>app/Http/Controller/UserController.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">UserRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> UserRepository</span><br><span class="line">     *</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$userRepository</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * UserController constructor.</span><br><span class="line">     * <span class="doctag">@param</span> UserRepository $userRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserRepository <span class="variable">$userRepository</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;userRepository = <span class="variable">$userRepository</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Display a listing of the resource.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> \Illuminate\Http\Response</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$users</span> = <span class="variable">$this</span>-&gt;userRepository-&gt;getAll();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'users.index'</span>, compact(<span class="string">'users'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 
<p>Controller改用repository pattern，<code>UserRepository</code>透過DI由constructor注入到controller，如此做法就符合 <strong><em>SOLID</em></strong> 的最後一條 <strong><em>DIP</em></strong>，高層不再相依於底層物件，而是改用注入的方式。</p>
<p>之後controller所有對資料庫的操作，都是透過<code>UserRepository</code>，而不直接透過<code>User</code> model。<br><figure class="highlight php"><figcaption><span>app/Repositories/UserRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> User</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$user</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * UserRepository constructor.</span><br><span class="line">     * <span class="doctag">@param</span> $user</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(User <span class="variable">$user</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;user = <span class="variable">$user</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;user-&gt;all();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>在<code>app</code>目錄下新增<code>Repositories</code>目錄，專門負責放repository，建立<code>UserRepository</code>，專門放與<code>User</code> model相關的<code>資料庫邏輯</code>。</p>
<p>當然在repository一樣可以使用model facade去存取資料庫，不過我個人偏好使用DI的方式，也就是將相依的<code>User</code> model也透過DI由constructor注入到repository。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>Facade是Laravel 4.2的產物，在Laravel 5也可以使用，雖然使用方便，但由於facade是透過PHP的<code>__call()</code>動態產生，所以PhpStorm的auto complete無法使用，必須額外安裝<code>__ide_helper.php</code>，透過描述<code>PhpDoc Blocks</code>的<code>@method</code>去描述，才能使用auto complete，另外facade的使用會讓人沒有namespace的概念，與Laravel 5重視namespace的理念格格不入，因此我個人比較不喜歡使用facade。</span></span></span></p>
<p>若production code能改成這樣，unit test就非常好寫啦。<br><figure class="highlight php"><figcaption><span>tests/TestCase.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestCase</span> <span class="keyword">extends</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The base URL to use while testing the application.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@var</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$baseUrl</span> = <span class="string">'http://localhost'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates the application.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> \Illuminate\Foundation\Application</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createApplication</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$app</span> = <span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$app</span>-&gt;make(Illuminate\Contracts\Console\Kernel::class)-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$app</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 初始化mock物件</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> string $class</span><br><span class="line">     * <span class="doctag">@return</span> Mockery</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initMock</span><span class="params">(<span class="variable">$class</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$mock</span> = Mockery::mock(<span class="variable">$class</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;app-&gt;instance(<span class="variable">$class</span>, <span class="variable">$mock</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$mock</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p><code>TestCase</code>是Laravel預設所提供給測試用的class，所有自己的測試class都會繼承於<code>TestCase</code>。</p>
<p>24行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 初始化mock物件</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> string $class</span><br><span class="line"> * <span class="doctag">@return</span> Mockery</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initMock</span><span class="params">(<span class="variable">$class</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$mock</span> = Mockery::mock(<span class="variable">$class</span>);</span><br><span class="line">    <span class="variable">$this</span>-&gt;app-&gt;instance(<span class="variable">$class</span>, <span class="variable">$mock</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$mock</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由於每個測試class都會使用到mock，因此將mock初始化的功能<code>initMock()</code> pull member up到上層的<code>TestCase</code>。</p>
<p>首先傳入要mock的class或interface，是字串。</p>
<p>使用<code>Mockery::mock()</code>去mock該class或interface，<code>Mockery</code>是PHP負責做mock的package，Laravel預設已經整合在內。</p>
<p><code>$this-&gt;app-&gt;instance()</code>則是告訴Laravel的service container，當type hint為該class時，使用指定的物件。與<code>$this-&gt;app-&gt;bind()</code>的差異是 : </p>
<ul>
<li><code>bind()</code>用來將指定的interface與class做連結。(不需指定class與class連結，Laravel會自動處理)</li>
<li><code>instance()</code>則是用來將指定的interface或class與物件做連結。</li>
</ul>
<p>因為mock出來的是<code>物件</code>，所以要使用<code>instance()</code>。</p>
<figure class="highlight php"><figcaption><span>tests/UserControllTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">UserController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">UserRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">View</span>\<span class="title">View</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mockery</span>\<span class="title">Mock</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> UserController</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> Mock</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$mock</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Setup the test environment.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">        <span class="variable">$this</span>-&gt;mock = <span class="variable">$this</span>-&gt;initMock(UserRepository::class);</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = <span class="variable">$this</span>-&gt;app-&gt;make(UserController::class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Clean up the testing environment before the next test.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tearDown</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = <span class="keyword">null</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;mock = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">parent</span>::tearDown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Test UserController<span class="doctag">@index</span></span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@group</span> UserController</span><br><span class="line">     * <span class="doctag">@group</span> UserController0</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testIndex</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// arrange</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="keyword">new</span> Collection([</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'oomusou'</span>, <span class="string">'email'</span> =&gt; <span class="string">'oomusou@gmail.com'</span>],</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'sam'</span>,     <span class="string">'email'</span> =&gt; <span class="string">'sam@gmail.com'</span>],</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'sunny'</span>,   <span class="string">'email'</span> =&gt; <span class="string">'sunny@gmail.com'</span>],</span><br><span class="line">        ]);</span><br><span class="line">        <span class="variable">$this</span>-&gt;mock-&gt;shouldReceive(<span class="string">'getAll'</span>)</span><br><span class="line">            -&gt;once()</span><br><span class="line">            -&gt;withAnyArgs()</span><br><span class="line">            -&gt;andReturn(<span class="variable">$expected</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// act</span></span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> View $view */</span></span><br><span class="line">        <span class="variable">$view</span> = <span class="variable">$this</span>-&gt;target-&gt;index();</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$view</span>-&gt;users;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// assert</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 
<p>第9行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@var</span> UserController</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$target</span>;</span><br></pre></td></tr></table></figure></p>
<p>建立<code>$target</code> property， 負責放<code>待測物件</code>，建議加上PHPDoc blocks描述<code>$target</code>物件的型別，這樣的優點是將來PHPStorm的auto complete就可以自動顯示出待測物件的property與method。</p>
<p>14行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@var</span> Mock</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$mock</span>;</span><br></pre></td></tr></table></figure></p>
<p>建立<code>$mock</code> property，負責放<code>mock物件</code>，建議加上PHPDoc blocks描述<code>$mock</code>物件的型別，這樣的優點是PHPStorm的auto complete可以自動顯示mockery的property與method，且inspection也不會再將<code>shouldReceive()</code>反白。</p>
<p>19行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Setup the test environment.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">parent</span>::setUp();</span><br><span class="line">    <span class="variable">$this</span>-&gt;mock = <span class="variable">$this</span>-&gt;initMock(UserRepository::class);</span><br><span class="line">    <span class="variable">$this</span>-&gt;target = <span class="variable">$this</span>-&gt;app-&gt;make(UserController::class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用PhpStorm的<strong><em>&#8963; + o</em></strong>建立override method，選擇<code>TestCase</code>的<code>setUp()</code>與<code>tearDown()</code>來override。</p>
<p>每個TestCase執行時，都會自動執行<code>setUp()</code>，因此可以在此建立mock物件與待測物件。</p>
<p>PhpStorm會自動產生<code>parent::setUp()</code>，表示會先執行<code>TestCase</code>的<code>setUp()</code>。<br>將我們要mock的class字串傳入稍早建立的<code>TestCase</code>的<code>initMock()</code>，並將建立完的mock物件回傳給<code>$mock</code> property。</p>
<p>使用service container的<code>$this-&gt;app-&gt;make()</code>替我們建立<code>UserController</code>物件，也就是我們要測試的controller。<br><div class="alert alert-danger"><i class="fa fa-bug"></i>  一定要先建立mock物件，才能建立待測物件，因為UserController需要依賴UserRepository注入，所以需要先使用<b>$this->app->instance()</b>先建立好mock物件，再執行<b>$this->app->make()</b>，否則PHPUnit會報錯。</div></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  可以使用DI方式，自己<b>new UserController()</b>嗎？</div>由於<code>UserController</code>的constructor已經使用<code>UserRepository</code>注入，因此PHPUnit會抱怨constructor沒有傳入參數，所以必須改寫成<code>new UserController($this-&gt;mock);</code>，改傳入我們自己mock的<code>UserRepository</code>。<br><br><div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  建議既然已經使用了service container，DI就完全交給Laravel處理，不用再自己new了。</div>
<p>31行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Clean up the testing environment before the next test.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tearDown</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;target = <span class="keyword">null</span>;</span><br><span class="line">    <span class="variable">$this</span>-&gt;mock = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">parent</span>::tearDown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每個TestCase執行完，都會自動執行<code>tearDown()</code>，因此可以在此將<code>$target</code>與<code>$mock</code>設定為null，避免下次unit test受到干擾。<br><div class="alert alert-danger"><i class="fa fa-bug"></i>  在Laravel 5.1，<b>Mockery::close()</b>會在<b>Illuminate\Foundation\Testing\TestCase</b>的<b>tearDown()</b>被執行，因此我們不必再自己加<b>Mockery::close()</b>，不過在Laravel 4.2，我們必須自己在<b>tearDown()</b>加<b>Mockery::close()</b>，否則mock不會正常執行。</div></p>
<p>43行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Test UserController<span class="doctag">@index</span></span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@group</span> UserController</span><br><span class="line"> * <span class="doctag">@group</span> UserController0</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testIndex</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure></p>
<p>建立<code>UserController@index</code>的測試方法，依照PHPUnit習慣，若method以<code>test</code>為prefix命名，則自動會視為測試方法，否則必須自己在PHPDoc block加上<code>@test</code>。</p>
<p>建議在PHPDoc block加上<code>@group</code>為測試分類，方便PHPUnit可選擇某個group<code>獨立測試</code>。</p>
<p>51行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arrange</span></span><br><span class="line"><span class="variable">$expected</span> = <span class="keyword">new</span> Collection([</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'oomusou'</span>, <span class="string">'email'</span> =&gt; <span class="string">'oomusou@gmail.com'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'sam'</span>,     <span class="string">'email'</span> =&gt; <span class="string">'sam@gmail.com'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'sunny'</span>,   <span class="string">'email'</span> =&gt; <span class="string">'sunny@gmail.com'</span>],</span><br><span class="line">]);</span><br><span class="line"><span class="variable">$this</span>-&gt;mock-&gt;shouldReceive(<span class="string">'getAll'</span>)</span><br><span class="line">    -&gt;once()</span><br><span class="line">    -&gt;withAnyArgs()</span><br><span class="line">    -&gt;andReturn(<span class="variable">$expected</span>);</span><br></pre></td></tr></table></figure></p>
<p>寫controlller的unit test依然會依照3A原則 : <code>arrange</code>、<code>act</code>與<code>assert</code>。</p>
<ul>
<li><code>arrange</code> : 準備<code>測試資料</code> <code>$fake</code>、<code>mock物件</code> <code>$mock</code>、<code>待測物件</code> <code>$target</code>，與建立<code>測試期望值</code> <code>$expected</code>。</li>
<li><code>act</code> : 執行待測物件的<code>method</code>，建立<code>實際結果值</code> <code>$actual</code>。</li>
<li><code>assert</code> : 使用PHPUnit的<code>assertXXX()</code>測試<code>$expected</code>與<code>$actual</code>是否如預期。</li>
</ul>
<p>先談<code>arrange</code>部分 :<br>由於<code>mock物件</code>與<code>待測物件</code>已經在<code>setUp()</code>建立，目前將焦點放在<code>測試期望值</code>與<code>mock物件該mock什麼method</code>。</p>
<p><code>UserRepository</code>的<code>getAll()</code>是實際到資料庫去撈3筆資料，為了要符合isolated test要求，這三筆資料我們必須自己mock。</p>
<p><code>$expected</code>自己使用<code>new Collection()</code>建立了3筆假資料。</p>
<p>之前只建立了mock物件，但卻還沒描述此mock物件到底該mock哪個method，我們使用Mockery的<code>shouldReceive()</code>來mock <code>UserRepository</code>的<code>getAll()</code>。</p>
<p><code>once()</code>表示此method只會被執行一次，若你mock的method被執行<code>超過一次</code>，PHPUnit就會報錯，因此很適合驗證<code>物件的互動</code>，當然還提供<code>twice()</code>與<code>times()</code>，可依實際需求而使用。</p>
<p><code>withAnyArgs()</code>則用來mock <code>argument</code>，表示任何argument都可接受，若你要單獨mock每一個argument，可以使用<code>with()</code>或<code>withArgs()</code>。不過一般來說，我們mock重視的是<code>method</code>與<code>回傳值</code>，所以使用<code>withAnyArgs()</code>即可。</p>
<p><code>andReture()</code>用來mock<code>回傳值</code>，<code>UserRepository</code>的<code>getAll()</code>回傳的是collection，所以我們也要mock一個collection，否則PHPUnit會報錯。</p>
<p>經過這樣的mock之後，unit test就不會去資料庫撈資料了，而是執行我們自己mock的<code>UserRepository</code>的<code>getAll()</code>。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>關於Mockery提供的method詳細用法，請參考<a href="http://docs.mockery.io/en/latest/reference/expectations.html" target="_blank" rel="external">Mockery Docs:Expectation Declarations</a></span></span></span></p>
<p>62行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// act</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@var</span> View $view */</span></span><br><span class="line"><span class="variable">$view</span> = <span class="variable">$this</span>-&gt;target-&gt;index();</span><br><span class="line"><span class="variable">$actual</span> = <span class="variable">$view</span>-&gt;users;</span><br></pre></td></tr></table></figure></p>
<p>再來談<code>act</code>部分 :<br><code>act</code>就是要實際的去戳<code>待測物件</code>的method，並將執行結果傳回<code>$actual</code>。</p>
<p>以我們要測試<code>UserController@index</code>為例，就是要實際執行<code>$this-&gt;target-&gt;index()</code>，因為該controller的結果是傳回view，所以<code>$view</code>實際上是一個View型別的變數。</p>
<p>至於我們要驗證的<code>$actual</code>並不是view，而是view裡面的<code>users</code>，也就是我們透過<code>compact(&#39;users&#39;)</code>傳進去的collection。<br><div class="alert alert-info"><i class="fa fa-info"></i>  為什麼要替$view加上PHPDoc block描述型別為View?</div></p>
<p>理論上不加也可，但PHPStorm會將<code>$view-&gt;users</code>的<code>users</code>反白，因為PHPStorm不知道<code>$view</code>的型別為何，所以認為<code>users</code>為非法，不過加了也沒有完全解決問題，只是從反白的<code>error</code>，變成<code>warning</code>，因為<code>users</code>是magic method所產生的，所以PHPStorm一樣無能為力。</p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  不過在此學到一個技巧，若在PHPStorm反白了一個property或method，而你確定這個method沒問題，只是PHPStorm不知道該變數型別而已，可以在該變數上面馬上補上PHPDoc block描述該變數型別，就可解掉反白問題。</div>
<p>67行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// assert</span></span><br><span class="line"><span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br></pre></td></tr></table></figure></p>
<p>最後是<code>assert</code>部分 :<br>確認view所收到的collection與我們mock的collection是否相同。</p>
<p><img src="/images/tdd/tdd-isolated-test/iso000.png" alt=""></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  測試controller只測試這樣而已嗎？感覺與期待有落差...</div>
<p>在回答這個問題前，要先釐清一件事情，到底對controller的unit test<code>該</code>測試哪些事情，在Jeferry Way的<a href="https://leanpub.com/laravel-testing-decoded" target="_blank" rel="external">Laravel Testing Decoded</a>這本書的第10章 : <strong><em>Testing Controllers</em></strong>，對controller的unit test做了以下的定義 : </p>
<blockquote><p>Controller tests should verify responses, ensure that the correct database access methods are triggered, and assert that the appropriate instance variables are sent to the view.</p>
<footer><strong>Jeffery Way &nbsp;- Laravel Testing Decoded</strong></footer></blockquote>
<p>在之前的unit test中，我們mock了<code>UserRepository</code>的<code>getAll()</code>，也定義了<code>once()</code>，所以確定<code>database access method</code>已經被trigger。</p>
<p>也使用了<code>assertEqual()</code>確定了我們的<code>$expected</code>已經送到了view。</p>
<p>由於controller主要在放<code>商業邏輯</code>，由於商業邏輯的不同，會呼叫不同的repository的<code>資料庫邏輯</code>，所以controller的unit test最主要的就是要確認不同的<code>測試案例</code>下，repository的method是否有被正確trigger，並將預期的資料送到view。</p>
<p>至於user在瀏覽器的操作，那已經屬於integration test的事情，不算controller的unit test範圍。</p>
<h3 id="OOP反璞歸真方法">OOP反璞歸真方法</h3><p>DI與service container的方式，透過constructor與type hint，讓我們完成了isolated test，但若是legacy code，可能constructor另有用途，如傳進初始值，因此不太方便再使用constructor注入相依物件，此時我們該怎麼做isolated test呢？在<a href="https://www.facebook.com/91agile/?fref=ts" target="_blank" rel="external">91哥陳仕節</a>在<a href="https://skilltree.my" target="_blank" rel="external">SkillTree</a>開的<a href="https://skilltree.my/events/mbh" target="_blank" rel="external">自動測試與TDD開發實務(使用C#)第四梯</a>與<a href="http://www.amazon.com/The-Art-Unit-Testing-examples/dp/1617290890" target="_blank" rel="external">The Art of Unit Testing:with examples in C#</a>中，提到一個絕妙的測試方法，可以套用在所有的OOP語言中，當然也包括PHP在內，91哥稱之為<code>OOP反璞歸真方法</code>。<br>原本的controller長這樣 :<br><figure class="highlight php"><figcaption><span>app/Http/Controllers/UserController.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$users</span> = User::all();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'users.index'</span>, compact(<span class="string">'users'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>為了能加上unit test，我們將controller動點手腳，但是這次我們不使用repository pattern，也不使用service controller，只將無法測試的<code>User::all()</code>，利用重構的<code>extract method</code>提出來。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>在PhpStorm可將滑鼠放在<code>User::all()</code>之後，使用<strong><em>&#8963; + t</em></strong>，呼叫<code>Refactor This</code>，所有重構的工具都在這裡。</span></span></span></p>
<p><img src="/images/tdd/tdd-isolated-test/iso001.png" alt=""></p>
<p>輸入要重構的method名稱:<code>getAll</code>。<br><img src="/images/tdd/tdd-isolated-test/iso002.png" alt=""></p>
<p>PhpStorm將替我們重構成如下的程式。<br><figure class="highlight php"><figcaption><span>app/Http/Controllers/UserController.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Display a listing of the resource.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> \Illuminate\Http\Response</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$users</span> = <span class="variable">$this</span>-&gt;getAll();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'users.index'</span>, compact(<span class="string">'users'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Collection|static[]</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> User::all();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>我們可以發現<code>UserController</code>並沒有被大改，沒用到repository pattern，也沒用到constructor，僅使用重構手法將<code>User::all()</code>提到<code>getAll()</code>裡面而已。<br><figure class="highlight php"><figcaption><span>tests/UserControllTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">UserController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">View</span>\<span class="title">View</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> StubUserController</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Setup the test environment.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Clean up the testing environment before the next test.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tearDown</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">parent</span>::tearDown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Test UserController<span class="doctag">@index</span></span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@group</span> UserController</span><br><span class="line">     * <span class="doctag">@group</span> UserController0</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testIndex</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// arrange</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="keyword">new</span> Collection([</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'oomusou'</span>, <span class="string">'email'</span> =&gt; <span class="string">'oomusou@gmail.com'</span>],</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'sam'</span>,     <span class="string">'email'</span> =&gt; <span class="string">'sam@gmail.com'</span>],</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'sunny'</span>,   <span class="string">'email'</span> =&gt; <span class="string">'sunny@gmail.com'</span>],</span><br><span class="line">        ]);</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = <span class="keyword">new</span> StubUserController(<span class="variable">$expected</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// act</span></span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> View $view */</span></span><br><span class="line">        <span class="variable">$view</span> = <span class="variable">$this</span>-&gt;target-&gt;index();</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$view</span>-&gt;users;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// assert</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StubUserController</span> <span class="keyword">extends</span> <span class="title">UserController</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$users</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * StubUserController constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Collection $users</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Collection <span class="variable">$users</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;users = <span class="variable">$users</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;users;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>59行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StubUserController</span> <span class="keyword">extends</span> <span class="title">UserController</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$users</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * StubUserController constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Collection $users</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Collection <span class="variable">$users</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;users = <span class="variable">$users</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;users;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>關鍵就在這裡啦，我們在unit test內自己產生一個<code>StubUserController</code>，繼承於<code>UserController</code>，並在constructor內允許我們去注入<code>假資料</code>，由於<code>StubUserController</code>是寫在<code>UserControllerTest</code>內，並不是寫在<code>UserController</code>，因此不會影響到原來production code的constructor。</p>
<p>另外一個關鍵就是我們去<code>override</code> <code>UserController</code>的<code>getAll()</code>，將其改成<code>return $this-&gt;users</code>，也就是不再是原本的<code>return User::all()</code>，這樣就會將<code>getAll()</code>改成回傳我們自己傳進去的<code>假資料</code>，而沒透過<code>資料庫</code>。<span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>PHP可能對OOP的<code>virtual</code>與<code>override</code>比較無感，別忘了PHP每個method天生就是virtual，每個method都可以被override。詳細請參考<a href="/php/php-cs/#Virtual_/_Override">PHP與C#語法快速導覽之virtual與orverride</a></span></span></span></p>
<p>至於原本的<code>index()</code>因為會被繼承下來，所以可以拿此<code>index()</code>來測試，只是<code>index()</code>內所呼叫的<code>$this-&gt;getAll()</code>已經被我們<code>override</code>掉了。</p>
<p>41行<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// arrange</span><br><span class="line"><span class="variable">$expected</span> = new Collection([</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'oomusou'</span>, <span class="string">'email'</span> =&gt; <span class="string">'oomusou@gmail.com'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'sam'</span>,     <span class="string">'email'</span> =&gt; <span class="string">'sam@gmail.com'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'sunny'</span>,   <span class="string">'email'</span> =&gt; <span class="string">'sunny@gmail.com'</span>],</span><br><span class="line">]);</span><br><span class="line"><span class="variable">$this-</span>&gt;target = new StubUserController(<span class="variable">$expected</span>);</span><br></pre></td></tr></table></figure></p>
<p>若能看懂之前靠<code>繼承</code>的stub class的手法，現在要測試就很容易了，待測物件只要去new我們剛剛建立的stub class即可，並將假資料透過constructor送進去。<br>之後的<code>act</code>與<code>assert</code>都完全不變。<br><div class="alert alert-info"><i class="fa fa-info"></i>  這是一個OOP語言的通用手法，只要程式語言支援<b>繼承</b>，有<b>virtual</b>與<b>override</b>機制，
就可以使用這個技巧，所以C#也能用，PHP一樣也能用。</div><div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  OOP其實有2招可以<b>封裝</b>變化，一招是用interface，也就是用<b>多型</b>，一招就是用<b>繼承</b>，將變化封裝在<b>virtual</b>內，由子類別去<b>override</b>，只是因為design pattern的盛行，強調『多用組合，少用繼承』，大家漸漸不敢用繼承，事實上繼承只要用的巧，還是很妙的，所以91哥稱此為『OOP反璞歸真方法』。</div></p>
<p><img src="/images/tdd/tdd-isolated-test/iso003.png" alt=""></p>
<h3 id="PHP邪惡方法">PHP邪惡方法</h3><p>回想之前的<code>OOP反璞歸真方式</code>，其實說白了，就是想去改掉<code>UserController</code>的<code>getAll()</code>，改成不要從<code>資料庫</code>抓資料，希望直接傳回<code>假資料</code>，但是<code>靜態語言</code>不允許我們<code>直接</code>去修改<code>method</code>，所以我們只能透過<code>繼承</code>的方式去<code>override</code>掉<code>getAll()</code>，但問題來了，因為是<code>繼承</code>，所以<code>getAll()</code>還是在<code>StubUserController</code>內，而不是在<code>UserControllerTest</code>內，所以我們只好透過contructor將<code>假資料</code>傳進去。</p>
<p>但別忘了PHP是<code>動態語言</code>，只要我們能在<code>UserControllerTest</code>去直接改掉<code>UserController</code>物件的<code>getAll()</code>，並在修改的時候，直接將<code>假資料</code>一起放進去，這樣就連<code>繼承</code>也不用使用了。<br><figure class="highlight php"><figcaption><span>app/Http/Controller/UserController.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@var</span> Closure</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$getAll</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * UserController constructor.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;getAll = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> User::all();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Display a listing of the resource.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> \Illuminate\Http\Response</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$users</span> = <span class="variable">$this</span>-&gt;getAll-&gt;__invoke();</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'users.index'</span>, compact(<span class="string">'users'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第9行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@var</span> Closure</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$getAll</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * UserController constructor.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;getAll = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> User::all();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在<code>OOP反璞歸真方法</code>時，我們是將<code>getAll()</code>直接定義成class的method，但這種方式只要定下去，就無法在改了，除非使用<code>繼承</code>與<code>virtual/override</code>方式。為了讓<code>getAll()</code>可以被動態修改，我們改使用closure，將<code>getAll()</code>成為property，並且註解為<code>Closure</code>型別。<br>將原本<code>getAll()</code> method改在constructor去定義<code>getAll</code> closure。</p>
<p>在此我們雖然使用了constructor，但並沒有去使用constructor的argument，因此對legacy code完全沒有影響。</p>
<p>24行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Display a listing of the resource.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> \Illuminate\Http\Response</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$users</span> = <span class="variable">$this</span>-&gt;getAll-&gt;__invoke();</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">'users.index'</span>, compact(<span class="string">'users'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>原本<code>$this-&gt;getAll()</code>改成<code>$this-&gt;getAll-&gt;__invoke()</code>，因為PHP的function並非如JavaScript的<code>一級函式</code>，<code>$this-&gt;getAll()</code>是呼叫method的語法，而目前<code>getAll</code>已經成為closure，是物件，需採用closure本身的method:<code>__invoke()</code>來執行。</p>
<figure class="highlight php"><figcaption><span>tests/UserControllerTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">UserController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">View</span>\<span class="title">View</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Test UserController<span class="doctag">@index</span></span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@group</span> UserController</span><br><span class="line">     * <span class="doctag">@group</span> UserController0</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testIndex</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// arrange</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="keyword">new</span> Collection([</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'oomusou'</span>, <span class="string">'email'</span> =&gt; <span class="string">'oomusou@gmail.com'</span>],</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'sam'</span>,     <span class="string">'email'</span> =&gt; <span class="string">'sam@gmail.com'</span>],</span><br><span class="line">            [<span class="string">'name'</span> =&gt; <span class="string">'sunny'</span>,   <span class="string">'email'</span> =&gt; <span class="string">'sunny@gmail.com'</span>],</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$target</span> = <span class="keyword">new</span> UserController();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$closure</span> = <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">(<span class="variable">$expected</span>)</span> </span>&#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;getAll = <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">(<span class="variable">$expected</span>)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$expected</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable">$closure</span> = <span class="variable">$closure</span>-&gt;bindTo(<span class="variable">$target</span>, <span class="variable">$target</span>);</span><br><span class="line">        <span class="variable">$closure</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// act</span></span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> View $view */</span></span><br><span class="line">        <span class="variable">$view</span> = <span class="variable">$target</span>-&gt;index();</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$view</span>-&gt;users;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// assert</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>22行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$target</span> = <span class="keyword">new</span> UserController();</span><br><span class="line"></span><br><span class="line"><span class="variable">$closure</span> = <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">(<span class="variable">$expected</span>)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;getAll = <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">(<span class="variable">$expected</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$expected</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable">$closure</span> = <span class="variable">$closure</span>-&gt;bindTo(<span class="variable">$target</span>, <span class="variable">$target</span>);</span><br><span class="line"><span class="variable">$closure</span>();</span><br></pre></td></tr></table></figure></p>
<p>待測物件<code>$target</code>直接new <code>UserController</code>，而不使用stub class。</p>
<p>重點在這裡，定義<code>$closure</code>，其目的就是去修改<code>getAll</code> closure，將其<code>return User::all()</code>改成<code>return $expected</code>，但問題來了，<code>$expected</code>是<code>外部資料</code>，PHP並無法如JavaScript一樣可以直接取用<code>外部資料</code>，所以必須使用use，一層一層將<code>$expected</code>傳進去。</p>
<p>另一個問題，closure內的<code>$this</code>是什麼？我們希望的是<code>$this</code>就是<code>UserController</code>，沒問題，我們使用<code>bindTo()</code>將<code>UserController</code>直接取代掉<code>$this</code>。</p>
<p>最後使用<code>$closure()</code>自己執行自己，執行完之後，<code>UserController</code>的<code>getAll()</code>就被我們取代掉了。<span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>關於bindTo()的玄妙，詳細請參考<a href="/ph/php-bindTo/">深入探討bindTo()</a></span></span></span></p>
<p>之後的<code>act</code>與<code>assert</code>都完全不變。<br><div class="alert alert-info"><i class="fa fa-info"></i>  PHP的<b>bindTo()</b>，最<b>邪惡</b>的地方在於它可以打破物件的封裝，直接去改變內部的private與protected變數，所以我稱為『PHP邪惡方法』，不過它的限制就是只能改變property，不能改變method，所以特別將method改成closure，讓bindTo()可以將手伸進來去改變<b>$this</b>，進而改變其closure，這樣就可以不用透過繼承與virtual/override，直接將getAll()改掉。</div></p>
<p><img src="/images/tdd/tdd-isolated-test/iso004.png" alt=""></p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>本篇重點雖然是在解決函式內有<code>相依物件</code>而無法寫<code>unit test</code>的問題，不過因為是拿controller來當範例，所以事實上也學到了controller的unit test寫法，不過實務上若使用TDD，會先寫controller的unit test，而非如本篇先寫controller再補unit test。</li>
<li>實務上該使用哪種方法呢？<code>DI + service container</code>的方法是首選，這是最<code>主流</code>的方法，若是legacy code，使用constructor注入有執行上的困難時，則<code>OOP反璞歸真方法</code>也很棒，至於<code>PHP邪惡方法</code>，因為<code>bindTo()</code>太玄妙，懂得人並不多，這種寫法恐有維護上的考量。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的<a href="https://github.com/oomusou/" target="_blank" rel="external">GitHub</a>上找到。</p>
<ol>
<li><a href="https://github.com/oomusou/Isolated_traditional_demo" target="_blank" rel="external">傳統寫法</a> </li>
<li><a href="https://github.com/oomusou/Isolated_DI_demo" target="_blank" rel="external">依賴注入方法</a></li>
<li><a href="https://github.com/oomusou/Laravel51RepositoryInterfaceDeffered_demo" target="_blank" rel="external">OOP反璞歸真方法</a></li>
<li><a href="https://github.com/oomusou/Isolated_bindto_demo" target="_blank" rel="external">PHP邪惡方法</a></li>
</ol>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/laravel/laravel-clone-from-github/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/laravel/laravel-package-hello-world/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2015-11-14 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Laravel/">Laravel<span>32</span></a></li> <li><a href="/tags/Mockery/">Mockery<span>4</span></a></li> <li><a href="/tags/PHP/">PHP<span>13</span></a></li> <li><a href="/tags/PHPUnit/">PHPUnit<span>10</span></a></li> <li><a href="/tags/TDD/">TDD<span>12</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
