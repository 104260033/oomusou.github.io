<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>深入探討依賴注入 | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="從測試角度探討依賴注入">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="從測試角度探討依賴注入">
<meta property="og:type" content="article">
<meta property="og:title" content="深入探討依賴注入">
<meta property="og:url" content="http://oomusou.io/tdd/tdd-di/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="從測試角度探討依賴注入">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2016-04-26T04:12:01.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入探討依賴注入">
<meta name="twitter:description" content="從測試角度探討依賴注入">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
     <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		<li><a  href="/">點燈坊</a></li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 深入探討依賴注入</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 從測試角度探討依賴注入			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#實際案例"><span class="toc-article-text">實際案例</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#傳統寫法"><span class="toc-article-text">傳統寫法</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#使用_Interface"><span class="toc-article-text">使用 Interface</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#工廠模式"><span class="toc-article-text">工廠模式</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#程式的可測試性"><span class="toc-article-text">程式的可測試性</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#依賴反轉"><span class="toc-article-text">依賴反轉</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#依賴注入"><span class="toc-article-text">依賴注入</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Constructor_Injection"><span class="toc-article-text">Constructor Injection</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Service_Container"><span class="toc-article-text">Service Container</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Method_Injection"><span class="toc-article-text">Method Injection</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#再談可測試性"><span class="toc-article-text">再談可測試性</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#生活中的依賴反轉"><span class="toc-article-text">生活中的依賴反轉</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>依賴反轉原則是 SOLID 中最難理解的原則，而依賴注入則是單元測試的基石，本文將從測試角度探討依賴反轉與依賴注入，並將 Laravel 的 service container、constructor injection 與 method injection 應用在實務上。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.0<br>Laravel 5.2.29</p>
<h2 id="實際案例">實際案例</h2><hr>
<p>假設目前有 3 家貨運公司，每家公司的計費方式不同，使用者可以動態選擇不同的貨運公司，將一步步的重構成依賴注入方式。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>本範例靈感來自於91哥的<a href="https://dotblogs.com.tw/hatelove/archive/2013/01/02/learning-tdd-in-30-days-day17-refactoring-with-strategy-pattern.aspx" target="_blank" rel="external">30天快速上手TDD Day 17:Refactoring - Stagegy Pattern</a></span></span></span></p>
<h2 id="傳統寫法">傳統寫法</h2><hr>
<p>傳統我們會使用 <code>if else</code> 與 <code>new</code> 來建立物件。</p>
<p><strong>BlackCat.php</strong><span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/4862ffd79ac52e74a245010760662932839fb68d" target="_blank" rel="external">新增BlackCat.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/BlackCat.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackCat</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>黑貓的計費方式。</p>
<p><strong>Hsinchu.php</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/2a7fe354bf337b7b74332c6cafb9dd1a4c02fce4" target="_blank" rel="external">新增Hsinchu.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/Hsinchu.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hsinchu</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">80</span> + <span class="variable">$weight</span> * <span class="number">15</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新竹貨運的計費方式。</p>
<p><strong>PostOffice.php</strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/fa4b0f8cfc82f554b5f671cad2ff467e7e8c16a9" target="_blank" rel="external">新增PostOffice.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostOffice.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostOffice</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">70</span> + <span class="variable">$weight</span> * <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>郵局的計費方式。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/038eecfcabbcb867a6505456cfba78587d1c26bc" target="_blank" rel="external">新增ShippingService.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     * <span class="doctag">@throws</span> Exception</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$companyName</span>, <span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$companyName</span> == <span class="string">'BlackCat'</span>) &#123;</span><br><span class="line">            <span class="variable">$blackCat</span> = <span class="keyword">new</span> BlackCat();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$blackCat</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span> (<span class="variable">$companyName</span> == <span class="string">'Hsinchu'</span>) &#123;</span><br><span class="line">            <span class="variable">$hsinchu</span> = <span class="keyword">new</span> Hsinchu();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$hsinchu</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span> (<span class="variable">$companyName</span> == <span class="string">'PostOffice'</span>) &#123;</span><br><span class="line">            <span class="variable">$postOffice</span> = <span class="keyword">new</span> PostOffice();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$postOffice</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'No company exception'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>calculateFee()</code> 傳入 2 個參數 : <code>$companyName</code> 與 <code>$weight</code>。</p>
<p>使用者可自行由 <code>$companyName</code> 挑選貨運公司，並傳入 <code>$weight</code> 計算運費。</p>
<p>使用 <code>if else</code> 判斷 <code>$companyName</code> 字串，並 <code>new</code>出相對應物件，這是初學者學習物件導向時的寫法。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/cd5306243c8416ada62beb8fc3540cf20e79d55e" target="_blank" rel="external">將if else重構成switch</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@param</span> string $companyName</span><br><span class="line"> * <span class="doctag">@param</span> int $weight</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> * <span class="doctag">@throws</span> Exception</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$companyName</span>, <span class="variable">$weight</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$companyName</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'BlackCat'</span>:</span><br><span class="line">            <span class="variable">$blackCat</span> = <span class="keyword">new</span> BlackCat();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$blackCat</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'Hsinchu'</span>:</span><br><span class="line">            <span class="variable">$hsinchu</span> = <span class="keyword">new</span> Hsinchu();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$hsinchu</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'PostOffice'</span>:</span><br><span class="line">            <span class="variable">$postOffice</span> = <span class="keyword">new</span> PostOffice();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$postOffice</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'No company exception'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>將 <code>if else</code> 重構成 <code>switch</code>，可稍微改善程式碼的可讀性。<span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>將 <code>if else</code> 重構成 <code>switch</code>，請參考<a href="/phpstorm/phpstorm-if-switch/">如何在PhpStorm將if else重構成switch case?</a></span></span></span></p>
<h2 id="使用_Interface">使用 Interface</h2><hr>
<p>目前的寫法，執行上沒有什麼問題，若以 TDD 開發，我們將得到第一個 <span class="label label-success">綠燈</span>。</p>
<p>我們將繼續重構成更好的程式。</p>
<p>目前我們是實際去 <code>new Blackcat()</code>、<code>new Hsinchu()</code> 與 <code>new PostOffice()</code>，也就是說<code>ShippingService</code>將直接<strong>相依</strong>於<code>BlackCat</code>、<code>Hshinchu</code> 與 <code>PostOffice</code> 3 個 class。</p>
<p>物件導向就是希望達到<strong>高內聚，低耦合</strong>的設計。所謂的低耦合，就是希望能減少<strong>相依</strong>於外部的 class 的數量。</p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  何謂<strong>相依</strong>?</div>
<p>簡單的說，有 2 種寫法會產生相依 :</p>
<ol>
<li>去 new 其他 class。</li>
<li>去 extends 其他 class。</li>
</ol>
<p>由於 PHP 不用編譯，所以可能較無法體會相依的嚴重性，但若是需要編譯的程式語言，若你相依的 class 的 property 或 method 改變，可能導致你的程式無法編譯成功，也就是你必須配合相依的 class 做相對應的修改才能通過編譯，因此我們希望降低對其他 class 的相依程度與數量。</p>
<p>GoF 四人幫在設計模式曾說 : <strong>Program to an Interface, not an Implementation</strong>。也就是程式應該只相依於 interface，而不是相依於實際 class，目的就是要藉由 interface，降低對於實際 class 的相依程度。</p>
<p>若我們能將 <code>BlackCat</code>、 <code>Hshinchu</code> 與 <code>PostOffice</code> 3 個 class抽象化為 1 個 interface，則 <code>ShippingService</code>將從相依 3 個 class，降低成只相依於 1 個interface，將大大降低 <code>ShippingService</code> 與其他 class 的相依程度。</p>
<p>若以編譯的角度，由於 <code>ShippingService</code> 只相依於 interface，因此 <code>BlackCat</code>、 <code>Hshinchu</code> 與 <code>PostOffice</code> 做任何修改都不會影響我 <code>ShippingService</code> 的編譯。</p>
<p><strong>LogisticsInterface.php</strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/c627e8ad2e73df8f0631521eb8d66f416013c83d" target="_blank" rel="external">抽取出LogisticsInterface</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/LogisticsInterface.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$weight</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>從 <code>BlackCat</code> 抽取出 <code>LogisticsInterface</code>，將 <code>BlackCat</code>、 <code>Hsinchu</code> 與 <code>PostOffice</code> 抽象化成 <code>LogisticsInterface</code>。</p>
<p><strong>BlackCat.php</strong><span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/7e611c3948d68b6e5226ea922b6748f97518ea6f" target="_blank" rel="external">BlackCat實現LogisticsInterface</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/BlackCat.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackCat</span> <span class="keyword">implements</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span> * <span class="variable">$weight</span> * <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>BlackCat</code> 實現 <code>LogisticsInterface</code>。</p>
<p><strong>Hsinchu.php</strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/dcf284c298cf6c9ac1b0615ed9cadcc0ef22c36b" target="_blank" rel="external">Hsinchu實現LogisticsInterface</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/Hsinchu.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hsinchu</span> <span class="keyword">implements</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">80</span> * <span class="variable">$weight</span> * <span class="number">15</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>Hsinchu</code> 實現 <code>LogisticsInterface</code>。</p>
<p><strong>PostOffice.php</strong><span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/c627e8ad2e73df8f0631521eb8d66f416013c83d" target="_blank" rel="external">PostOffice實現LogisticsInterface</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/PostOffice.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostOffice</span> <span class="keyword">implements</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">70</span> * <span class="variable">$weight</span> * <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>PostOffice</code> 實現 <code>LogisticsInterface</code>。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/24656ced564f230198248350c25676ca57e98c2c" target="_blank" rel="external">ShippingService只相依於LogisticsInterface</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     * <span class="doctag">@throws</span> Exception</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$companyName</span>, <span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$companyName</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BlackCat'</span>:</span><br><span class="line">                <span class="variable">$logistics</span> = <span class="keyword">new</span> BlackCat();</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Hsinchu'</span>:</span><br><span class="line">                <span class="variable">$logistics</span> = <span class="keyword">new</span> Hsinchu();</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PostOffice'</span>:</span><br><span class="line">                <span class="variable">$logistics</span> = <span class="keyword">new</span> PostOffice();</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'No company exception'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>$logistics</code> 的型別都是 <code>LogisticsInterface</code>，目前 PHP 7 對於變數還沒有支援 type hint，所以程式碼看起來差異不大，但藉由 PHPDoc，在 PhpStorm 打 <code>$logistics-&gt;</code>，已經可以得到語法提示: <code>calculateFee()</code>，表示 PhpStorm 已經知道<code>BlackCat</code>、 <code>Hsinchu</code> 與 <code>PostOffice</code> 都是 <code>LogisticsInterface</code> 型別的物件，也就是對於 <code>ShippingService</code> 來說，<code>BlackCat</code>、<code>Hsinchu</code> 與 <code>PostOffice</code> 都已經抽象化成 <code>LogisticsInterface</code>。</p>
<h2 id="工廠模式">工廠模式</h2><hr>
<p>雖然已經將 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>PostOffice</code> 抽象化成 <code>LogisticsInterface</code>，但是在 <code>ShoppingService</code> 中，仍看到 <code>new Blackcat()</code>、 <code>new Hsinchu()</code> 與 <code>new PostOffice()</code>，對於 <code>ShoppingService</code> 而言，我們看到了 3 個問題 :</p>
<ol>
<li><strong>違反單一職責原則</strong> : <code>calculateFee()</code> 原本應該只負責計算運費，現在卻還要負責建立貨運公司物件。</li>
<li><strong>違反開放封閉原則</strong> : 將來若有新的貨運公司供使用者選擇，勢必修改 <code>switch</code>。</li>
<li><strong>實質相依數為 3</strong> : 雖然已經重構出 interface，但實際上卻還必須 <code>new</code> 3 個class。</li>
</ol>
<p>比較好的方式是將 <code>new</code> 封裝在 <code>LogisticsFactory</code> 中。</p>
<p><strong>LogisticsFactory.php</strong><span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/9da99ca17a25ba8c65d852007ebc34a4558f8306" target="_blank" rel="external">新增LogisticsFactory.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/LogisticsFactory.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogisticsFactory</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@return</span> LogisticsInterface</span><br><span class="line">     * <span class="doctag">@throws</span> Exception</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(string <span class="variable">$companyName</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$companyName</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BlackCat'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> BlackCat();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Hsinchu'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Hsinchu();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PostOffice'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PostOffice();</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'No company exception'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Simple Factory模式使用了<code>static create()</code>，專門負責建立貨運公司物件:</p>
<ol>
<li>專門負責建立貨運公司的邏輯，符合單一職責原則。</li>
</ol>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>14</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">14</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/eb7a53f55a3a4bd625ce2f0b65b436dd6073b05f" target="_blank" rel="external">ShippingService只相依於LogisticsFactory</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     * <span class="doctag">@throws</span> Exception</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$companyName</span>, <span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$logistics</span> = LogisticsFactory::create(<span class="variable">$companyName</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>將來有新的貨運公司，也只要統一修改<code>LogisticsFactory</code>即可，將其變化封裝在<code>LogisticsFactory</code>，對於 <code>ShoppingService</code>開放封閉。</li>
<li><code>ShoppingService</code> 從相依於 3 個 class 降低成僅相依於 <code>LogisticsInterface</code> 與 <code>LogisticsFactory</code>，實質相依數降為 2。</li>
</ol>
<h2 id="程式的可測試性">程式的可測試性</h2><hr>
<p>符合 spec 的程式，並不代表是好的程式，一個好的程式還要符合 5 個要求 :</p>
<ol>
<li><strong> 容易維護 </strong>。</li>
<li><strong> 容易新增功能 </strong>。</li>
<li><strong> 容易重複使用 </strong>。</li>
<li><strong> 容易上Git，不易與其他人衝突 </strong>。</li>
<li><strong> 容易寫測試 </strong>。</li>
</ol>
<p>使用 interface + 工廠模式，已經達到以上前4點要求，算是很棒的程式。</p>
<p>根據單元測試的定義 :<span class="margin-note-marker"><sup>15</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">15</span>單元測試的定義來自於<a href="https://dotblogs.com.tw/hatelove/archive/2012/11/13/learning-tdd-in-30-days-day5-how-to-isolate-dependency-the-basic-testability.aspx" target="_blank" rel="external">30天快速上手TDD Day 5:如何隔離相依性 - 基本的可測試性</a></span></span></span><br><div class="alert alert-info"><i class="fa fa-info"></i>  單元測試必須與外部環境、類別、資源、服務獨立，而不能直接相依。這樣才是單純的測試目標物件本身的邏輯是否符合預期。</div></p>
<p>若要對 <code>ShippingService</code> 進行單元測試，勢必將 <code>BlackCat</code>、 <code>Hsinchu</code> 與 <code>PostOffice</code> 加以抽換隔離，但使用了工廠模式之後，<code>ShippingService</code> 依然直接相依了 <code>LogisticsFactory</code>，而 <code>LogisticsFactory</code> 又直接相依 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>PostOffice</code>，當我們對 <code>ShippingService</code> 做單元測試時，由於無法對 <code>LogisticsFactory</code> 做抽換隔離，因此無法對<code>ShippingService</code> 做單元測試。</p>
<p>簡單的說，interface + 工廠模式，仍然無法達到可測試性的要求，我們必須繼續重構。</p>
<h2 id="依賴反轉">依賴反轉</h2><hr>
<p>為了可測試性，單元測試必須可決定待測物件的相依物件，如此才可由單元測試將待測物件的相依物件加以抽換隔離。</p>
<p>換句話說，我們不能讓待測物件直接相依其他 class，而應該由單元測試訂出 interface，讓待測物件僅能相依於interface，而實際相依的物件可由單元測試來決定，如此我們才能對相依物件加以抽換隔離。</p>
<p>這也就是所謂的依賴反轉原則 :<br><div class="alert alert-info"><i class="fa fa-info"></i>  高階模組不該依賴低階模組，兩者都應該要依賴其抽象。</div></p>
<div class="alert alert-info"><i class="fa fa-info"></i>  抽象不要依賴細節，細節要依賴抽象。</div>
<p>好像越講越抽象 XDD。</p>
<p>其中<strong>相依</strong>與<strong>依賴</strong>是相同的，只是翻譯用字的問題。</p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  何謂高階模組? 何謂低階模組?</div>
<p>高階與低階是相對的。</p>
<p>簡單的說:</p>
<ul>
<li>當A class 去 <code>new</code> B class，A 就是高階模組，B就是低階模組。 </li>
</ul>
<p>若以本例而言 :</p>
<ol>
<li><code>ShippingService</code> 相對於 <code>BlackCat</code>，<code>ShippingService</code> 是高階模組，<code>BlackCat</code> 是低階模組，</li>
<li>單元測試相對於 <code>ShippingService</code>，單元測試是高階模組，<code>ShippingService</code> 是低階模組。</li>
<li><code>ShippingController</code> 相對於 <code>ShippingService</code>，<code>ShippingController</code> 是高階模組，<code>ShippingService</code> 是低階模組。</li>
</ol>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  何謂抽象? 何謂細節?</div>
<ul>
<li>interface 為抽象, abstract class 為抽象。</li>
<li>class 為細節去 implement interface，class 為細節去 extends abstract class。</li>
</ul>
<p>若以本例而言 :</p>
<img src="/images/tdd/tdd-di/di000.svg" width="550">
<p>在沒有使用 interface 前 :</p>
<ul>
<li><code>ShippingService</code> 直接 <code>new BlackCat()</code>。</li>
<li><code>ShippingService</code> 直接相依於 <code>BlackCat</code>。</li>
<li>也就是高階模組依賴低階模組。</li>
</ul>
<img src="/images/tdd/tdd-di/di001.svg" width="550">
<p>使用了 interface 之後 : </p>
<ul>
<li><code>ShippingService</code> 沒有相依於 <code>BlackCat</code>，也就是高階模組沒有依賴於低階模組。</li>
<li><code>ShippingService</code> 改成相依於 <code>LogisticsInterface</code>，也就是高階模組依賴其抽象(因為 <code>new</code> 而相依)。</li>
<li><code>BlackCat</code> 改成相依於 <code>LogisticsInterface</code>，也就是低階模組也依賴其抽象(因為 <code>implements</code> 而相依)。</li>
<li>也就是目前高階模組與低階模組都改成依賴其抽象。</li>
<li>高階模組<code>ShippingService</code> 原本依賴的是低階模組 <code>BlackCat</code> 的 <code>calculateFee()</code>，有了 interface 之後，變成<strong>反過來</strong>低階模組 <code>BlackCat</code> 要依賴高階模組所定義 <code>LogisticsInterface</code> 的 <code>calculateFee()</code>，所以稱為<strong>依賴反轉</strong>。</li>
</ul>
<p>更簡單的說，依賴反轉就是要你使用 interface 來寫程式，而不要直接相依於 class。</p>
<p>我們之前已經重構出 <code>LogisticsInterface</code>，事實上已經符合依賴反轉。</p>
<h2 id="依賴注入">依賴注入</h2><hr>
<p>有了依賴反轉還不足以達成可測試性，依賴反轉只確保了待測物件的相依物件相依於 interface。</p>
<p>既然相依物件相依於 interface，若單元測試可以產生該 interface 的物件，並加以注入，就可以將相依物件加以抽換隔離，這就是依賴注入。</p>
<h2 id="Constructor_Injection">Constructor Injection</h2><hr>
<p><strong> ShippingService.php </strong><span class="margin-note-marker"><sup>16</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">16</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/b3b66a2cbbe3276d833aa0c655420938da465ec3" target="_blank" rel="external">ShippingService重構成constructor injection</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> LogisticsInterface */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$logistics</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * ShippingService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> LogisticsInterface $logistics</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(LogisticsInterface <span class="variable">$logistics</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;logistics = <span class="variable">$logistics</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;logistics-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>12行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> LogisticsInterface */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$logistics</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * ShippingService constructor.</span><br><span class="line"> * <span class="doctag">@param</span> LogisticsInterface $logistics</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(LogisticsInterface <span class="variable">$logistics</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;logistics = <span class="variable">$logistics</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>原本相依的 <code>LogisticsInterface</code> 型別的物件，改由 constructor 注入，藉由 PHP 的 type hint，描述要注入的物件型別為 <code>LogisticsInterface</code>。</p>
<p>原本使用 interface + 工廠模式，實質相依數為 2，改用 constructor injection 之後，連 <code>LogisticsFactory</code>都不需要了，僅相依於 <code>LogisticsInterface</code>，實質相依數降為 1。</p>
<p>17行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@param</span> int $weight</span><br><span class="line"> * <span class="doctag">@return</span> int</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(<span class="variable">$weight</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;logistics-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將原本的 <code>logistics</code> 物件改成 field。</p>
<h2 id="Service_Container">Service Container</h2><hr>
<p>我們目前已經有了依賴注入，對於可測試性只剩下最後一哩路，若我們能將 mock 出的假物件，透過依賴注入取代掉原來的相依物件，就能將相依物件加以抽換隔離，達成隔離測試的要求，service container 就是要幫我們將相依物件抽換隔離。</p>
<p>Laravel 4 稱為 IoC container，Laravel 5 稱為 service container。<span class="margin-note-marker"><sup>17</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">17</span>以下句子來自於<a href="https://dotblogs.com.tw/hatelove/archive/2012/11/13/learning-tdd-in-30-days-day5-how-to-isolate-dependency-the-basic-testability.aspx" target="_blank" rel="external">30天快速上手TDD Day 5:如何隔離相依性 - 基本的可測試性</a></span></span></span>事實上 IoC (Inversion of Conttrol) 與 DI (Dependency Inversion) 講的是同一件事情，也就是由單元測試決定待測物件的相依物件。</p>
<p><strong> 單元測試 </strong><br><strong> ShippingService.php </strong><span class="margin-note-marker"><sup>18</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">18</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/21260f19a09380370f13c26934107ce954d5114c" target="_blank" rel="external">新增ShippingService的單元測試</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">BlackCat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">LogisticsInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓單元測試<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line">        <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$mock</span> = Mockery::mock(BlackCat::class);</span><br><span class="line">        <span class="variable">$mock</span>-&gt;shouldReceive(<span class="string">'calculateFee'</span>)</span><br><span class="line">            -&gt;once()</span><br><span class="line">            -&gt;withAnyArgs()</span><br><span class="line">            -&gt;andReturn(<span class="variable">$expected</span>);</span><br><span class="line"></span><br><span class="line">        App::instance(LogisticsInterface::class, <span class="variable">$mock</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$target</span> = App::make(ShippingService::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>14行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$mock</span> = Mockery::mock(BlackCat::class);</span><br><span class="line"><span class="variable">$mock</span>-&gt;shouldReceive(<span class="string">'calculateFee'</span>)</span><br><span class="line">    -&gt;once()</span><br><span class="line">    -&gt;withAnyArgs()</span><br><span class="line">    -&gt;andReturn(<span class="variable">$expected</span>);</span><br></pre></td></tr></table></figure></p>
<p>因為單元測試，我們只想測試 <code>ShippingService</code>，因此想將其相依的 <code>LogisticsInterface</code> 物件抽換隔離，因此利用 <code>Mockery</code> 根據 <code>BlackCat</code>建立假物件 <code>$mock</code>，並定義 <code>calculateFee()</code> 回傳的期望值為 <code>$expected</code>。</p>
<p><code>once()</code> 為預期 <code>calculateFee()</code>會被執行一次，且只會被執行一次，若完全沒被執行，或執行超過一次，PHPUnit 會顯示 <span class="label label-danger">紅燈</span>。</p>
<p><code>withAngArgs()</code> 為不特別在乎 <code>calculateFee()</code> 的參數型別與個數，一般來說，單元測試在乎的是被 mock method 是否被正確執行，以及其回傳值是否如預期，至於參數則不太重要。</p>
<p>20行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">App::instance(LogisticsInterface::class, <span class="variable">$mock</span>);</span><br></pre></td></tr></table></figure></p>
<p>mock 物件已經建立好，接著要告訴 service container，當 constructor injection 的 type hint 遇到 <code>LogisticsInterface</code>時，該使用我們剛建立的 <code>$mock</code> 物件抽換隔離，而不是原來的相依物件。</p>
<p><code>App::instance()</code> 用到的地方不多，一般就是用在需要 mock 時。</p>
<p>22行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$target</span> = App::make(ShippingService::class);</span><br></pre></td></tr></table></figure></p>
<p>當 mock 與 service container 都準備好時，接著要建立待測物件準備測試，這裡不能再使用 <code>new</code> 建立物件，而必須使用 service container 提供的 <code>App::make()</code> 來建立物件，因為我們就是希望靠 service container 幫我們將 mock 物件抽換隔離原來的相依物件，因此必須改用 service container 提供的 <code>App::make()</code>。</p>
<p><strong> 整合測試 </strong><br><strong> ShippingService.php </strong><span class="margin-note-marker"><sup>19</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">19</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/f736ffff42969a5e958b3d9d5340cb6acc8f5973" target="_blank" rel="external">新增ShippingService的整合測試</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓整合測試<span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line">    <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line">    <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    App::bind(LogisticsInterface::class, BlackCat::class);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target</span> = App::make(ShippingService::class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>當執行整合測試時，我們會希望實際執行相依物件的功能，而不再使用 mock 將其相依物件抽換隔離。</p>
<p>第8行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">App::bind(LogisticsInterface::class, BlackCat::class);</span><br></pre></td></tr></table></figure></p>
<p>當 constructor injection 配合 type hint 時，若是 class，Laravel 的 service container 會自動幫我們注入其相依物件，但若 type hint 為 interface 時，因為可能有很多 class implements 該 interface，所以必須先使用 <code>App::bind()</code> 告訴 service container，當 type hint 遇到 <code>LogisticsInterface</code> 時，實際上要注入的是 <code>BlackCat</code> 物件。</p>
<p>10行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$target</span> = App::make(ShippingService::class);</span><br></pre></td></tr></table></figure></p>
<p>當 <code>App::bind()</code> 完成後，就可以使用 <code>App::make()</code> 建立待測物件，service container 也會根據剛剛 <code>App::bind()</code> 的設定，自動依賴注入 <code>BlackCat</code> 物件。</p>
<h2 id="Method_Injection">Method Injection</h2><hr>
<p>Laravel 4 提出了 constructor injection 實現了依賴注入，而 Laravel 5 更進一步提出了 method injection。</p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  有 constructor injection 不就已經可測試了嗎? 為什麼還需要 method injection 呢?</div>
<p>由於 Laravel 4 只有 constructor injection，所以只要 class 要實現依賴注入，唯一的管道就是 constructor injection，若有些相依物件只有單一 method 使用一次，也必須使用 constructor injection，這將導致最後 constructor 的參數爆炸而難以維護。</p>
<p>對於一些只有單一 method 使用的相依物件，若能只在 method 的參數加上 type hint，就可自動依賴注入，而不需要動用 constructor，那就太好了，這就是 method injection。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(StoreBlogPostRequest <span class="variable">$request</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// The incoming request is valid...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如大家熟悉的form request，就是使用 method injection，相依的 <code>StoreBlogPostRequest</code> 物件並不是透過 constructor 注入，而是在 <code>store()</code> 注入。</p>
<p><strong> ShippingService.php </strong><span class="margin-note-marker"><sup>20</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">20</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/be1a98426347564503a41e6c114d9c317f4491ac" target="_blank" rel="external">ShippingService重構成method injection</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> LogisticsInterface $logistics</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(LogisticsInterface <span class="variable">$logistics</span>, <span class="variable">$weight</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重構成 method injection 後，就不必再使用 constructor 與 field，程式更加精簡。<span class="margin-note-marker"><sup>21</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">21</span>要注入的物件參數位置並不一定要排第一個，可以依實際需求調整。</span></span></span></p>
<p>第 1 個參數為我們要注入的 <code>LogisticsInterface</code> 物件，第 2 個參數為我們原本要傳的 <code>$weight</code> 參數。</p>
<p><strong> 單元測試 </strong><br><strong> ShippingService.php </strong><span class="margin-note-marker"><sup>22</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">22</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/ebb25ee69a994070c4781415ebe8663d994b64e7" target="_blank" rel="external">ShippingService method injection的單元測試</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">BlackCat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">LogisticsInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓單元測試<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line">        <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$mock</span> = Mockery::mock(BlackCat::class);</span><br><span class="line">        <span class="variable">$mock</span>-&gt;shouldReceive(<span class="string">'calculateFee'</span>)</span><br><span class="line">            -&gt;once()</span><br><span class="line">            -&gt;withAnyArgs()</span><br><span class="line">            -&gt;andReturn(<span class="variable">$expected</span>);</span><br><span class="line"></span><br><span class="line">        App::instance(LogisticsInterface::class, <span class="variable">$mock</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">            <span class="string">'weight'</span> =&gt; <span class="variable">$weight</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>20行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/** act */</span></span><br><span class="line"><span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">    <span class="string">'weight'</span> =&gt; <span class="variable">$weight</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>之前 mock 的部分，與 constructor injection 相同，就不再解釋。</p>
<p>關鍵在於 <code>App::call()</code>，這是一個在 Laravel 官方文件沒有介紹的 method，但 Laravel 內部卻到處在用。<span class="margin-note-marker"><sup>23</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">23</span>method injection 的介紹，始見於 Matt Stauffer Blog 的 <a href="https://mattstauffer.co/blog/laravel-5.0-method-injection" target="_blank" rel="external">Laravel 5.0 - Method Injection</a></span></span></span></p>
<p>之前我們使用 constructor injection，就要搭配 <code>App::make()</code> 才能自動依賴注入。</p>
<p>現在我們使用 method injection，就要搭配 <code>App::call()</code> 才能自動依賴注入。</p>
<p>第 1 個參數要傳的字串，是 class 完整名稱，加上 <code>@</code> 與 method名稱。</p>
<p>第 2 個參數要傳的是陣列，也就是我們自己要傳的參數，其中參數名稱為 key，參數值為 value。</p>
<p><strong> 整合測試 </strong><br><strong> ShippingService.php </strong><span class="margin-note-marker"><sup>24</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">24</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52DI_demo/commit/57fc7d2e6de9e52a070c327866d195c272f29ee3" target="_blank" rel="external">新增ShippingService method injection的整合測試</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓整合測試<span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line">    <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line">    <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    App::bind(LogisticsInterface::class, BlackCat::class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">        <span class="string">'weight'</span> =&gt; <span class="variable">$weight</span></span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>10行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">    <span class="string">'weight'</span> =&gt; <span class="variable">$weight</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>關鍵一樣是使用 <code>App::call()</code>。</p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  為什麼只能在 controller 使用 method injection，而無法在自己的 presenter、service 或 repository 使用 method injection?</div>
<p>當初學習 method injection時，我也非常興奮，總算可以解決 Laravel 4 的 constructor 參數爆炸的問題，但發現只能用在 controller，但無法用在自己的 presenter、service 或 repository，一直學習到 <code>App::call()</code> 時，問題才迎刃而解。</p>
<p>因為 Laravel 內部使用 <code>App::call()</code> 呼叫 controller 的 method，因此你可以在 controller 無痛使用 method injection，但若你自己的 presenter、service 或 repository 要使用 method injection，就必須在 controller 搭配 <code>App::call()</code>，如此 service containter 才會幫你自動依賴注入相依物件。</p>
<h2 id="再談可測試性">再談可測試性</h2><hr>
<p>本文從頭到尾，都是以<strong>可測試性</strong>的角度去談依賴注入，而我個人也的確是在寫單元測試之後，才領悟依賴反轉與依賴注入的重要性。</p>
<p>若是不寫測試，是否就不需要依賴反轉與依賴注入呢?</p>
<p>之前曾經提到 :</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  IoC (Inversion of Conttrol) 與 DI (Dependency Inversion) 講的是同一件事情，也就是由單元測試決定待測物件的相依物件。</div>
<p>根據之前的經驗，我們可以發現待測物件的相依物件都是在測試的 <code>App::bind()</code> 所決定。</p>
<p>之前有提到所謂的高階模組與低階模組是相對的，單元測試相對於 service，單元測試是高階模組，而 service 是低階模組。</p>
<p>對照於實際狀況，controller 相對於 service，controller是高階模組，而 service 是低階模組。</p>
<p>我們可以在單元測試以 <code>App::bind()</code> 決定 service 的相依物件，同樣的，我們也可以在 controller 以 <code>App::bind()</code> 去決定 service 的相依物件。</p>
<p>既然我們可以由 controller 去決定，去注入 service 的相依物件，我們就不再被底層綁死，不再依賴底層 service，而是由低階模組去依賴高階模組所制定的 interface，再由 controller 的 <code>App::bind()</code> 來決定低階模組的相依物件，這就是所謂的依賴反轉。</p>
<p>也就是說，若高層模組可以決定低階模組的相依物件，那整個設計的彈性與擴充性會非常好，因為需求都來自於人，而人所面對的是高階模組，而高階模組可以透過依賴注入去決定低階模組的相依物件，而不是被低階模組綁死，可彈性地依照需求而改變。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  若程式符合可測試性的要求，表示其具有低耦合的特性，也就是物件導向強調的高內聚，低耦合，因此程式將更容易維護，更容易新增功能，更容易重複使用，更容易上Git，不易與其他人衝突，也就是說我們可以將程式的可測試性，當成是否為好程式的指標之一。</div>
<h2 id="生活中的依賴反轉">生活中的依賴反轉</h2><hr>
<p>舉個生活上實際的例子，事實上硬體產業就大量使用依賴反轉。</p>
<p>比如電腦需要將畫面送到顯示器，系統廠對 design house 發出需求，此時系統廠相當於高階模組，而 design house 相當於低階模組。</p>
<p>Design house 當然可以設計出 IC 符合系統廠需求，但由於系統廠沒有規定任何傳輸介面規格，只提出顯示需求，因此 design house 可以使用自己設計的專屬傳輸介面，系統廠的電路板只要符合 design house 的專屬傳輸介面規格，就可以將電腦畫面傳送到顯示器。</p>
<p>這樣雖然可以達成需求，但有幾個問題：</p>
<ol>
<li>傳輸介面由 design house 規定，只要 design house 傳輸介面更改，系統廠的電路板就得跟著修改。</li>
<li>Design house 的專屬傳輸介面，需要搭該公司的控制 IC，因此系統廠還被綁死要使用該 design house 的控制 IC。</li>
<li>由於使用專屬傳輸介面，因此系統廠無法使用替代料，只能乖乖使用該 design house 的 IC，沒有議價空間，且備料時間也被綁死。</li>
</ol>
<p>這就是典型的高階模組依賴低階模組，也就是系統廠被 design house 綁死了。</p>
<p>所以系統廠很聰明，會聯絡各大系統廠一起制定傳輸介面規格，如VGA、HDMI、Display Port…等，如此 deisgn house 就得乖乖的依照系統廠制定的傳輸介面規格來設計 IC，這樣系統廠就不再被單一 design house 綁死，可以自行選擇控制 IC，還可以找替代料，增加議價空間，備料時間也更加彈性，這就是典型的低階模組反過來依賴高階模組所制定的規格，也就是依賴反轉。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Interface + 工廠模式無法達成可測試性的要求，因此才有了依賴注入與 service container。</li>
<li>若很多 method 都使用相同相依物件，可使用 constructor injection，若只有單一 method 使用的相依物件，建議改用 method injection。</li>
<li>Method Injection 必須搭配 <code>App::call()</code>，除了自動依賴注入相依物件外，也可以自行傳入其他參數。</li>
<li>可測試性與物件導向是相通的，我們可以藉由程式的可測試性，當成是否為好程式的指標之一。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的<a href="https://github.com/oomusou/Laravel52DI_demo" target="_blank" rel="external">GitHub</a>上找到。</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/tdd/tdd-repository-testing-mysql/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/laravel/laravel-route-pass-parameter-to-controller/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2016-04-16 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/LaraDiner/">LaraDiner<span>17</span></a></li> <li><a href="/tags/Laravel/">Laravel<span>37</span></a></li> <li><a href="/tags/Mockery/">Mockery<span>4</span></a></li> <li><a href="/tags/PHPUnit/">PHPUnit<span>10</span></a></li> <li><a href="/tags/TDD/">TDD<span>14</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
