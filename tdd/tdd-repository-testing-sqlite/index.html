<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>如何測試 Repository 模式 (使用 SQLite)? | 點燈坊</title>
  <meta name="author" content="真 OO無双">
  
  <meta name="description" content="使用 SQLite In-Memory 、Test Factory Generator 與 DatabaseMigration Trait 測試 Repository">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <meta name="description" content="使用 SQLite In-Memory 、Test Factory Generator 與 DatabaseMigration Trait 測試 Repository">
<meta property="og:type" content="article">
<meta property="og:title" content="如何測試 Repository 模式 (使用 SQLite)?">
<meta property="og:url" content="http://oomusou.io/tdd/tdd-repository-testing-sqlite/index.html">
<meta property="og:site_name" content="點燈坊">
<meta property="og:description" content="使用 SQLite In-Memory 、Test Factory Generator 與 DatabaseMigration Trait 測試 Repository">
<meta property="og:image" content="http://oomusou.io/images/feature/logo.png">
<meta property="og:updated_time" content="2016-05-04T03:26:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何測試 Repository 模式 (使用 SQLite)?">
<meta name="twitter:description" content="使用 SQLite In-Memory 、Test Factory Generator 與 DatabaseMigration Trait 測試 Repository">
 

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">點燈坊</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">		
			<h1> 如何測試 Repository 模式 (使用 SQLite)?</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

	
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 使用 SQLite In-Memory 、Test Factory Generator 與 DatabaseMigration Trait 測試 Repository			
		</div> <!-- alert -->
		

	<!-- toc -->
	<div id="postTOC">
		<span class="tocHeading">Contents</span>
		<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Version"><span class="toc-article-text">Version</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Repository_模式"><span class="toc-article-text">Repository 模式</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Test_Factory_Generator"><span class="toc-article-text">Test Factory Generator</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#安裝套件"><span class="toc-article-text">安裝套件</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#新增_Service_Provider"><span class="toc-article-text">新增 Service Provider</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#建立_Model_與_Migration"><span class="toc-article-text">建立 Model 與 Migration</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#確認資料庫連線"><span class="toc-article-text">確認資料庫連線</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#建立_Model_Factory"><span class="toc-article-text">建立 Model Factory</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#新增_SQLite_In-Memory_連線"><span class="toc-article-text">新增 SQLite In-Memory 連線</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#新增資料庫連線"><span class="toc-article-text">新增資料庫連線</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#修改phpunit-xml"><span class="toc-article-text">修改phpunit.xml</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#測試_SQLite_In-Memory_連線"><span class="toc-article-text">測試 SQLite In-Memory 連線</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#DatabaseMigration_Trait"><span class="toc-article-text">DatabaseMigration Trait</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#以_TDD_建立_Repository"><span class="toc-article-text">以 TDD 建立 Repository</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#建立單元測試"><span class="toc-article-text">建立單元測試</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#測試案例"><span class="toc-article-text">測試案例</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#執行測試"><span class="toc-article-text">執行測試</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Conclusion"><span class="toc-article-text">Conclusion</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sample_Code"><span class="toc-article-text">Sample Code</span></a></li></ol>
    </div>

	<!-- content -->
	<div class="mypage">		
	    <p>一般我們會把資料庫邏輯寫在 repository，只要有邏輯，就需要去寫測試，畢竟我們寫的程式，可能跟我們想的不一樣。由於 repository 寫的是資料庫邏輯，所以勢必要真的去讀寫資料庫。但若真的去讀寫 MySQL，速度會比較慢，且資料庫本來就有一些資料，可能會影響測試的結果，因此比較理想的方式是測試時改讀寫 <a href="https://www.sqlite.org/inmemorydb.html" target="_blank" rel="external">SQLite In-Memory Database</a>。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Laravel 5.2.29<br>PHPUnit 4.8.24<br>PhpStorm 2016.1</p>
<h2 id="Repository_模式">Repository 模式</h2><hr>
<p>初學者常會商業邏輯與資料庫邏輯同時寫在 controller 內，如我們想將最新的 3 筆文章顯示在 view。<br><figure class="highlight php"><figcaption><span>app/Http/Controllers/PostsController.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostsController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$posts</span> = Post::orderBy(<span class="string">'id'</span>, <span class="string">'desc'</span>)</span><br><span class="line">        -&gt;take(<span class="number">3</span>)</span><br><span class="line">        -&gt;get();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = compact(<span class="variable">$posts</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> View(<span class="string">'posts.index'</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>這段程式碼在執行上沒有問題，但在設計上有幾個問題 : </p>
<ol>
<li><p>違反 SOLID 的單一職責原則，controller 原本該有的職責應該是商業邏輯，但現在卻將資料庫邏輯直接寫在 controller 內，這已經超出原本 controller 的職責，將會導致日後 controller 過於肥大而難以維護。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>單一職責原則 : 應該且僅有一個原因引起 class 的變更。</span></span></span></p>
</li>
<li><p>將資料庫邏輯直接寫在 controller 內，將來若有不同 controller 使用相同的資料庫邏輯，將無法重複使用。</p>
</li>
<li><p>由於 controller 內直接使用 Eloquent，表示 controller 直接相依於<code>Post</code> model，若我們要對 controller 做單元測試，必須直接存取資料庫，這違反了隔離測試 ( isolated test ) 原則。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>Isolated Test : 1.執行速度快 2.關注點分離 3.單一職責 4.可測試性 5.測試程式的健壯性</span></span></span></p>
</li>
<li><p>為了隔離測試，我們會希望 mock 掉資料庫邏輯，然後透過依賴注入將 mock 物件注入 contoller，但在 controller 直接使用 model，導致無法使用依賴注入，因此無法執行單元測試。</p>
</li>
</ol>
<p>比較好的方式是使用 repository 模式，將資料庫邏輯從 controller 中獨立出來寫在 repository，透過依賴注入將 repository注入controller。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>詳細請參考<a href="/laravel/laravel-repository/">如何使用 Repository 模式?</a></span></span></span></p>
<p>使用 repository 模式有以下好處 : </p>
<ol>
<li><p>Repository 專心負責資料庫邏輯，符合單一職責原則，可避免 controller 過於肥大而難以維護。</p>
</li>
<li><p>資料庫邏輯從 controller 搬到 repository，因此不同的 controller 可以重複使用。</p>
</li>
<li><p>controller 不再直接相依於 model，而是透過依賴注入將 repository 注入 controller，符合依賴反轉原則，且測試時不用直接存取資料庫，達到隔離測試要求。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>依賴反轉原則 : 高階模組不該依賴低階模組，兩者都該依賴其抽象。抽象不要依賴細節，細節要依賴抽象。</span></span></span></p>
</li>
<li><p>單元測試時直接 mock 掉 repository 即可，並透過依賴注入將 repository 注入到 controller，不用特別去 mock Eloquent model。</p>
</li>
</ol>
<p>將資料庫邏輯從 controller 搬到 repository 之後，本文的重點就是討論該如何測試 repository 內的資料庫邏輯。</p>
<h2 id="Test_Factory_Generator">Test Factory Generator</h2><hr>
<p>Laravel 5 提出了 model factory，直接整合了 faker，讓我們在 seeding 與 testing 時更為方便，而 Test Factory Generator 會自動根據 migration 產生 model factory，讓我們連 model factory 都不用寫。</p>
<h3 id="安裝套件">安裝套件</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ composer require mpociot/laravel-test-factory-helper --dev</span><br></pre></td></tr></table></figure>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo000.png" alt=""></p>
<p>使用 composer 安裝 Test Factory Generator，因為此套件只會在開發使用，可以加上 <code>--dev</code> 參數。<span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>關於 <code>--dev</code> 參數，詳細請參考<a href="/laravel/laravel-debugbar/#使用Composer安裝">如何使用 Laravel Debugbar #使用 Composer 安裝</a></span></span></span></p>
<h3 id="新增_Service_Provider">新增 Service Provider</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mpociot\LaravelTestFactoryHelper\TestFactoryHelperServiceProvider::class,</span><br></pre></td></tr></table></figure>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo001.png" alt=""></p>
<p>在 <code>config/app.php</code> 中加入 <code>TestFactoryHelperServiceProvider</code>。<span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/6ebe075d59e3b930302ab422d38e8dbcf0dc15f6" target="_blank" rel="external">安裝 Laravel Test Factory Generator</a></span></span></span></p>
<h2 id="建立_Model_與_Migration">建立 Model 與 Migration</h2><hr>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan make:model Post -m</span><br></pre></td></tr></table></figure>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo002.png" alt=""></p>
<p>建立 <code>Post</code> model 與 migration，<code>-m</code> 讓我們在建立 model 時一併建立 migrarion。</p>
<p>會在 <code>app</code> 目錄下建立 <code>Post.php</code>，並在 <code>database/migrations</code> 目錄建立 migration 檔。</p>
<p><strong> Post.php </strong><span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/0c9456104b2c8053267bd7e7d668202365964706" target="_blank" rel="external">建立Post.php</a></span></span></span></p>
<figure class="highlight php"><figcaption><span>app/Post.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$fillable</span> = [</span><br><span class="line">        <span class="string">'title'</span>,</span><br><span class="line">        <span class="string">'description'</span>,</span><br><span class="line">        <span class="string">'content'</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 
<p>第7行<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="variable">$fillable</span> = [</span><br><span class="line">    <span class="string">'title'</span>,</span><br><span class="line">    <span class="string">'description'</span>,</span><br><span class="line">    <span class="string">'content'</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure></p>
<p>定義當使用 mass assignment 時可以被修改的欄位，進而保護其他欄位不被修改。</p>
<p><strong> create_posts_table.php </strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/ce3b7a7b14c7e06f73bb41921b08d4044c92f530" target="_blank" rel="external">建立create_posts_table.php</a></span></span></span></p>
<figure class="highlight php"><figcaption><span>database/migrations/2015_10_14_113810_create_posts_table.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">Blueprint</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Migrations</span>\<span class="title">Migration</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreatePostsTable</span> <span class="keyword">extends</span> <span class="title">Migration</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Run the migrations.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        Schema::create(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint <span class="variable">$table</span>)</span> </span>&#123;</span><br><span class="line">            <span class="variable">$table</span>-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;string(<span class="string">'title'</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;string(<span class="string">'description'</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;text(<span class="string">'content'</span>);</span><br><span class="line">            <span class="variable">$table</span>-&gt;timestamps();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Reverse the migrations.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">down</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        Schema::drop(<span class="string">'posts'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> Schema::create(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint <span class="variable">$table</span>)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$table</span>-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">    <span class="variable">$table</span>-&gt;string(<span class="string">'title'</span>);</span><br><span class="line">    <span class="variable">$table</span>-&gt;string(<span class="string">'description'</span>);</span><br><span class="line">    <span class="variable">$table</span>-&gt;text(<span class="string">'content'</span>);</span><br><span class="line">    <span class="variable">$table</span>-&gt;timestamps();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>加入 <code>title</code>、<code>description</code> 與 <code>content</code> 3 個欄位。 </p>
<h3 id="確認資料庫連線">確認資料庫連線</h3><p><img src="/images/tdd/tdd-repository-testing-sqlite/repo003.png" alt=""></p>
<p>將來 Test Factory Generator 必須連上資料庫才能產生 model factory，必須西確定專案已經與資料庫順利連線。</p>
<p><strong> 執行 Migrate </strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan migrate</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo004.png" alt=""></p>
<p>執行 migrate 將 table 建立在 MySQL。</p>
<h2 id="建立_Model_Factory">建立 Model Factory</h2><hr>
<p>測試 repository 時，將使用 model factory 幫我們建立測試資料。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan test-factory-helper:generate</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo005.png" alt=""></p>
<p>Test Factory Generator 幫我們自動建立 model factory。<span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/36ae5827b19db9d82f2681267b89aa8dbe6b3696" target="_blank" rel="external">建立Model Factory</a></span></span></span></p>
<h2 id="新增_SQLite_In-Memory_連線">新增 SQLite In-Memory 連線</h2><hr>
<p>因為實際讀寫 MySQL 較慢，所以在單元測試時，會改用 SQLite In-Memory，速度快很多。</p>
<h3 id="新增資料庫連線">新增資料庫連線</h3><p><strong>database.php</strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/55deb06485331b3ca622d14cac3cdebee57f9237" target="_blank" rel="external">新增sqlite_testing資料庫連線</a></span></span></span><br><figure class="highlight php"><figcaption><span>config/database.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'sqlite_testing'</span> =&gt; [</span><br><span class="line">    <span class="string">'driver'</span> =&gt; <span class="string">'sqlite'</span>,</span><br><span class="line">    <span class="string">'database'</span> =&gt; <span class="string">':memory:'</span>,</span><br><span class="line">    <span class="string">'prefix'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo006.png" alt=""></p>
<h3 id="修改phpunit-xml">修改phpunit.xml</h3><p><strong>phpunit.xml</strong><span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/924cf3e87e2adb8d92af61e42fadb94877855b26" target="_blank" rel="external">在 phpunit.xml 新增 DB_CONNECTION</a></span></span></span><br><figure class="highlight xml"><figcaption><span>phpunit.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">phpunit</span> <span class="attribute">backupGlobals</span>=<span class="value">"false"</span></span><br><span class="line">         <span class="attribute">backupStaticAttributes</span>=<span class="value">"false"</span></span><br><span class="line">         <span class="attribute">bootstrap</span>=<span class="value">"bootstrap/autoload.php"</span></span><br><span class="line">         <span class="attribute">colors</span>=<span class="value">"true"</span></span><br><span class="line">         <span class="attribute">convertErrorsToExceptions</span>=<span class="value">"true"</span></span><br><span class="line">         <span class="attribute">convertNoticesToExceptions</span>=<span class="value">"true"</span></span><br><span class="line">         <span class="attribute">convertWarningsToExceptions</span>=<span class="value">"true"</span></span><br><span class="line">         <span class="attribute">processIsolation</span>=<span class="value">"false"</span></span><br><span class="line">         <span class="attribute">stopOnFailure</span>=<span class="value">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">testsuites</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">testsuite</span> <span class="attribute">name</span>=<span class="value">"Application Test Suite"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">directory</span> <span class="attribute">suffix</span>=<span class="value">"Test.php"</span>&gt;</span>./tests<span class="tag">&lt;/<span class="title">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">testsuite</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">testsuites</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">whitelist</span> <span class="attribute">processUncoveredFilesFromWhitelist</span>=<span class="value">"true"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">directory</span> <span class="attribute">suffix</span>=<span class="value">".php"</span>&gt;</span>./app<span class="tag">&lt;/<span class="title">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">file</span>&gt;</span>./app/Http/routes.php<span class="tag">&lt;/<span class="title">file</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">whitelist</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">php</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"APP_ENV"</span> <span class="attribute">value</span>=<span class="value">"testing"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"CACHE_DRIVER"</span> <span class="attribute">value</span>=<span class="value">"array"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"SESSION_DRIVER"</span> <span class="attribute">value</span>=<span class="value">"array"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"QUEUE_DRIVER"</span> <span class="attribute">value</span>=<span class="value">"sync"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"DB_CONNECTION"</span> <span class="attribute">value</span>=<span class="value">"sqlite_testing"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">php</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">phpunit</span>&gt;</span></span><br></pre></td></tr></table></figure> </p>
<p>24行<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">php</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"APP_ENV"</span> <span class="attribute">value</span>=<span class="value">"testing"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"CACHE_DRIVER"</span> <span class="attribute">value</span>=<span class="value">"array"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"SESSION_DRIVER"</span> <span class="attribute">value</span>=<span class="value">"array"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"QUEUE_DRIVER"</span> <span class="attribute">value</span>=<span class="value">"sync"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"DB_CONNECTION"</span> <span class="attribute">value</span>=<span class="value">"sqlite_testing"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">php</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>可在此建立 <code>APP_ENV</code> 為 <code>testing</code> 時的全域變數。</p>
<p>設定 <code>DB_CONNECTION</code> 為 <code>sqlite_testing</code>，當跑測試時，將會使用 <code>sqlite_testing</code> 資料庫連線。</p>
<h2 id="測試_SQLite_In-Memory_連線">測試 SQLite In-Memory 連線</h2><hr>
<p><code>ExampleTest.php</code> 為 Laravel 預設的測試範例，其中包含了 <code>testBasicExample()</code>，示範了如何測試預設的 <code>welcome.blade.php</code> 是否正確執行。</p>
<h3 id="DatabaseMigration_Trait">DatabaseMigration Trait</h3><p><strong>ExampleTest.php</strong><span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/922880c7be2f19c9efe1d5b1a89f27a71e335a64" target="_blank" rel="external">測試 SQLite In-Memory 連線</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/ExampleTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * A basic functional test example.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBasicExample</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;visit(<span class="string">'/'</span>)</span><br><span class="line">             -&gt;see(<span class="string">'Laravel 5'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@test</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 測試<span class="title">SQLiteInMemory</span>連線<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = Post::all();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertCount(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>第6行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br></pre></td></tr></table></figure></p>
<p>因為目前測試使用的是 SQLite In-Memory，每個測試案例行完後，SQLite 就會釋放在記憶體中的資料庫，因此每個測試案例執行前，都必須重新執行一次 migration。</p>
<p>以前 Laravel 4.2 時代，需要寫在 <code>setUp()</code> 去執行 <code>Artisan::call(&#39;migrate&#39;)</code>。</p>
<p>但在 Laravel 5 提供了很方便的 trait，只要在 class 內加上 <code>use DatabaseMigrations;</code> 即可，Laravel 會自動幫你執行 migration。</p>
<p>24行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@test</span></span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 測試<span class="title">SQLiteInMemory</span>連線<span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line">    <span class="variable">$expected</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="variable">$actual</span> = Post::all();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    <span class="variable">$this</span>-&gt;assertCount(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由於只是測試連線是否成功，尚未跑 model factory，因此預期 <code>Post</code> model 的資料筆數為 <code>0</code>。</p>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo007.png" alt=""></p>
<p>實際跑測試，<span class="label label-success">綠燈</span> 表示連線成功。<span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>關於如何在 PhpStorm 跑單元測試，詳細請參考<a href="/phpstorm/phpstorm-debug-testing/">如何使用 PhpStorm 測試與除錯?</a></span></span></span></p>
<h2 id="以_TDD_建立_Repository">以 TDD 建立 Repository</h2><hr>
<p>之前的所有動作都只是為了建立 repository 的測試環境，接下來將以 TDD 的方式建立 <code>PostRepository</code>。</p>
<h3 id="建立單元測試">建立單元測試</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan make:test Unit/Repositories/PostRepositoryTest</span><br></pre></td></tr></table></figure>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo008.png" alt=""></p>
<p><strong>PostRepositoryTest.php</strong><span class="margin-note-marker"><sup>14</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">14</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/9087fa67c626e0890a31434633cfbb2ef6b2c395" target="_blank" rel="external">建立PostRepositoyTest.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Unit/Repositories/PostRepositoryTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">WithoutMiddleware</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseTransactions</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepositoryTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * A basic test example.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExample</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertTrue(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p>將 <code>PostRepositoryTest.php</code> 建立在 <code>tests/Unit/Repositories</code> 目錄下。</p>
<p>實務上測試分 3 種，有<strong>單元測試</strong>，<strong>整合測試</strong>與<strong>驗收測試</strong>。</p>
<p>Repository 測試屬於單元測試，故建立在 <code>Unit</code> 目錄下，將來還有 <code>Integration</code> 目錄放整合測試，與 <code>Acceptance</code> 放驗收測試。</p>
<p>所建立的 <code>PostRepositoryTest</code> 也繼承於 <code>TestCase</code>。</p>
<h3 id="測試案例">測試案例</h3><p>TDD 要我們先寫測試再寫程式，在 <code>PostRepository</code> 實作抓最新的 3 筆文章前，必須先將其測試先寫好。</p>
<p><strong>PostRepositoryTest.php</strong><span class="margin-note-marker"><sup>15</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">15</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/df5da88d044072b0b0ea64ef2e217c86c03c4980" target="_blank" rel="external">建立最新3筆文章</a></span></span></span></p>
<figure class="highlight php"><figcaption><span>tests/Unit/Repositories/PostRepositoryTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepositoryTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@test</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 最新3筆文章<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        factory(Post::class, <span class="number">100</span>)-&gt;create();</span><br><span class="line">        <span class="variable">$target</span> = App::make(PostRepository::class);</span><br><span class="line">        <span class="variable">$expected</span> = <span class="keyword">new</span> Collection([</span><br><span class="line">            <span class="number">100</span>,</span><br><span class="line">            <span class="number">99</span>,</span><br><span class="line">            <span class="number">98</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;getLatest3Posts()-&gt;pluck(<span class="string">'id'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 
<p>第6行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</span><br></pre></td></tr></table></figure></p>
<p>一樣使用 <code>DatabaseMigrations</code> trait，讓 Laravel 自動幫我們執行 migration。</p>
<p><strong>Arrange</strong><br>負責建立要測試的資料，因為我們想要抓最新 3 筆文章，所以先使用 model factory 新增 100 筆測試資料進 SQLite in-Memory。</p>
<p>建立 <code>$target</code> 待測物件，一律使用 <code>App::make()</code> 建立物件，不再使用<code>new</code>建立物件。</p>
<p>建立 <code>$expected</code>，也就我們預期會傳回最新 3 筆文章的結果，因為要測試的重點在於最新 3 筆文章，其他欄位如 <code>title</code>、<code>sub_title</code> 與 <code>content</code> 因為都是使用 <code>faker</code> 建立，無法測試，所以我們只在乎 <code>id</code> 欄位是否如我們預期。</p>
<p><strong>Act</strong><br>實際執行 <code>$target</code> 的 <code>getLatest3Posts()</code>，由於我們只想測試 <code>id</code> 欄位的值，所以使用 <code>pluck()</code> 只傳回 <code>id</code> 欄位的資料進 <code>$actual</code>。</p>
<p><strong>Assert</strong><br>使用 PHPUnit 的 <code>assertEquals()</code>，判斷 <code>$expected</code> 與 <code>$actual</code> 是否相等，若相等則 <span class="label label-success">綠燈</span>，不相等則 <span class="label label-danger">紅燈</span>。</p>
<h3 id="執行測試">執行測試</h3><p><img src="/images/tdd/tdd-repository-testing-sqlite/repo009.png" alt=""></p>
<p>得到第 1 個 <span class="label label-danger">紅燈</span> : <code>PostRepository</code> 不存在，因為我們還沒有建立。</p>
<p>事實上 PhpStorm 也將 <code>PostRepository</code> 反白，警告我們 <code>PostRepository</code> 並不存在。</p>
<p><strong>PostRepository.php</strong><span class="margin-note-marker"><sup>16</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">16</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/a139dd31761967e5f61c036ff0ad5976bf71e041" target="_blank" rel="external">建立PostRepository.php</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/PostRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo010.png" alt=""></p>
<p>補上 <code>PostRepository.php</code> 後，繼續執行測試。</p>
<p>得到第 2 個 <span class="label label-danger">紅燈</span> : <code>getLatest3Posts()</code> 不存在，因為我們還沒有建立。</p>
<p>事實上 PhpStorm 也將 <code>getLatest3Posts()</code> 反白，警告我們 <code>getLatest3Posts()</code> 並不存在。</p>
<p><strong>PostRepository.php</strong><span class="margin-note-marker"><sup>17</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">17</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/e0ffcb142eb91c8f068fb9095e1251e75a505488" target="_blank" rel="external">建立 getLatest3Posts()</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/PostRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLatest3Posts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo011.png" alt=""></p>
<p>補上 <code>getLatest3Posts()</code> 後，繼續執行測試。</p>
<p>得到第 3 個 <span class="label label-danger">紅燈</span> : 對 <code>null</code> 物件呼叫 <code>pluck()</code>，因為我們還沒回傳 collection。</p>
<p>事實上 PhpStorm也將<code>pluck()</code> 反白，警告我們 <code>getLatest3Posts()</code> 並不是回傳 collection。</p>
<p><strong>PostRepository.php</strong><span class="margin-note-marker"><sup>18</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">18</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo/commit/a06819d67f0899e053012a787df81d72edce6865" target="_blank" rel="external">回傳 collection</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Repositories/PostRepository.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRepository</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLatest3Posts</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Post::orderBy(<span class="string">'id'</span>, <span class="string">'desc'</span>)</span><br><span class="line">            -&gt;take(<span class="number">3</span>)</span><br><span class="line">            -&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> </p>
<p><img src="/images/tdd/tdd-repository-testing-sqlite/repo012.png" alt=""></p>
<p>在 <code>getLatest3Posts()</code> 補上 query 後回傳 collection 後，繼續執行測試。</p>
<p>得到第 1 個 <span class="label label-success">綠燈</span>。</p>
<p>隨著 <span class="label label-success">綠燈</span> 的出現，我們也完成了 repository。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>TDD 的開發流程就是 寫測試 -&gt; <span class="label label-danger">紅燈</span> -&gt; 寫程式 -&gt; <span class="label label-success">綠燈</span> -&gt; 重構 -&gt;<span class="label label-success">綠燈</span> -&gt; 重構…-&gt; <span class="label label-success">綠燈</span>，所以測試時看到 <span class="label label-danger">紅燈</span> 不要怕，只要趕快寫程式讓他 <span class="label label-success">綠燈</span> 即可。</li>
<li>本文結合 Laravel 與 PHPUnit，以 TDD 方式建立 repository，並搭配 Test Factory Generator、SQLite In-Memory 與 PhpStorm，讓 repository 測試更為簡單。</li>
<li>使用 Laravel 5 的 <code>DatabaseMigrations</code> trait 之後，就不用在 <code>setUp()</code> 寫 <code>Artisan::call(&#39;migrate&#39;)</code> 了，程式更加精簡。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52RepositoryTesting_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/phpstorm/phpstorm-save-strip-whitespace/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/tags"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/phpstorm/phpstorm-if-switch/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2016-04-04 
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Laravel/">Laravel<span>35</span></a></li> <li><a href="/tags/PHPUnit/">PHPUnit<span>10</span></a></li> <li><a href="/tags/PhpStorm/">PhpStorm<span>20</span></a></li> <li><a href="/tags/SQLite/">SQLite<span>2</span></a></li> <li><a href="/tags/TDD/">TDD<span>13</span></a></li>
    </ul>
	</div>
		

    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hAXbiVYFC92XF16_EhCh','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
